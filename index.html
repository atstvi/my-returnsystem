<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>나의 돌아오는 시스템</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f5f2ed;--surface:#fff;--border:#e0dbd2;
  --accent:#7c5c38;--accentL:#b8956a;--accentDim:#ede7dc;--accentDim2:#f7f3ee;
  --text:#1e1a16;--textDim:#5a5048;--textF:#9e9288;
  --green:#4a7a50;--greenBg:#eaf2eb;--yellow:#7a6030;--red:#8a3a3a;--redBg:#f5eaea;
  --radius:12px;--shadow:0 2px 12px rgba(0,0,0,.07);
}
body{font-family:-apple-system,'Apple SD Gothic Neo','Noto Sans KR',system-ui,sans-serif;font-weight:300;background:var(--bg);color:var(--text);font-size:15px;min-height:100vh}
.tab-bar{display:flex;border-bottom:1px solid var(--border);background:var(--surface);position:sticky;top:0;z-index:100;box-shadow:0 1px 8px rgba(0,0,0,.06)}
.tab-btn{flex:1;padding:13px 2px;background:none;border:none;border-bottom:2px solid transparent;font-family:inherit;font-size:12px;font-weight:300;color:var(--textF);cursor:pointer;transition:all .2s}
.tab-btn.active{border-bottom-color:var(--accent);color:var(--accent);font-weight:500}
.inner{max-width:540px;margin:0 auto;padding-bottom:80px}
.inner-wide{max-width:1200px;margin:0 auto;padding:0 20px 80px}
.page{display:none}.page.active{display:block}

/* 홈 */
.hero{padding:44px 24px 28px;border-bottom:1px solid var(--border)}
.eyebrow{font-size:10px;letter-spacing:4px;color:var(--accentL);text-transform:uppercase;margin-bottom:14px}
.hero h1{font-family:Georgia,serif;font-size:26px;font-weight:400;line-height:1.5;margin-bottom:22px}
.motto{background:var(--accentDim);border-radius:var(--radius);padding:18px 20px;font-size:14px;color:var(--textDim);line-height:2.2}
.motto strong{color:var(--accent);font-weight:500}
.sec-lbl{font-size:10px;letter-spacing:4px;color:var(--textF);text-transform:uppercase;padding:28px 24px 12px}
.phil-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;padding:0 24px;margin-bottom:24px}
.phil-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px 18px;box-shadow:var(--shadow)}
.phil-tag{font-size:10px;color:var(--accentL);font-weight:600;margin-bottom:5px;letter-spacing:1px;text-transform:uppercase}
.phil-title{font-size:14px;font-weight:500;color:var(--text);margin-bottom:6px;line-height:1.4}
.phil-body{font-size:13px;color:var(--textDim);line-height:1.9}
.start-btn{display:block;margin:0 24px;padding:17px;background:var(--accent);border:none;color:#fff;font-family:inherit;font-size:15px;border-radius:var(--radius);cursor:pointer;text-align:center;width:calc(100% - 48px);transition:opacity .2s}
.start-btn:hover{opacity:.88}

/* 체크 */
.q-outer{max-width:540px;margin:0 auto;padding-bottom:80px}
.q-header{padding:28px 24px 0}
.prog-row{display:flex;align-items:center;gap:12px;margin-bottom:24px}
.prog-bar{flex:1;height:3px;background:var(--border);border-radius:2px;overflow:hidden}
.prog-fill{height:100%;background:var(--accent);transition:width .5s cubic-bezier(.4,0,.2,1)}
.prog-lbl{font-size:11px;color:var(--textF);white-space:nowrap}
.q-cat{font-size:10px;color:var(--accentL);letter-spacing:3px;text-transform:uppercase;margin-bottom:8px;font-weight:600}
.q-text{font-family:Georgia,serif;font-size:21px;font-weight:400;line-height:1.5;margin-bottom:8px}
.q-sub{font-size:12px;color:var(--textF);line-height:1.9;margin-bottom:20px}
.opts{padding:0 24px;display:flex;flex-direction:column;gap:9px;margin-bottom:12px}
.opt-btn{padding:14px 17px;background:var(--surface);border:1px solid var(--border);color:var(--textDim);font-family:inherit;font-size:14px;font-weight:300;cursor:pointer;border-radius:var(--radius);text-align:left;transition:all .2s}
.opt-btn:hover{border-color:var(--accentL)}
.opt-btn.selected{background:var(--accentDim);border-color:var(--accent);color:var(--accent);font-weight:500}
.ta-wrap{padding:0 24px;margin-bottom:12px}
textarea{width:100%;background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:14px;font-weight:300;padding:14px 16px;resize:none;min-height:110px;border-radius:var(--radius);line-height:1.9;transition:border-color .2s}
textarea:focus{outline:none;border-color:var(--accentL)}
.insight-box{margin:0 24px 14px;border-radius:var(--radius);border:1px solid var(--border);overflow:hidden}
.insight-row{display:flex}
.insight-tag{background:var(--accentDim);padding:12px 14px;font-size:10px;color:var(--accent);font-weight:600;letter-spacing:1px;text-transform:uppercase;white-space:nowrap;border-right:1px solid var(--border);display:flex;align-items:center;writing-mode:vertical-rl}
.insight-txt{padding:12px 15px;font-size:13px;color:var(--textDim);line-height:1.9;flex:1}
.nav-row{display:flex;gap:10px;padding:14px 24px 0}
.btn-next{flex:1;padding:16px;background:var(--accent);border:none;color:#fff;font-family:inherit;font-size:14px;border-radius:var(--radius);cursor:pointer;transition:opacity .2s}
.btn-next:disabled{opacity:.35;cursor:not-allowed}
.btn-back{padding:16px 18px;background:var(--surface);border:1px solid var(--border);color:var(--textF);font-family:inherit;font-size:14px;cursor:pointer;border-radius:var(--radius)}
.loading-wrap{padding:70px 24px;text-align:center}
.spinner{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 14px}
.loading-txt{font-size:13px;color:var(--textF);line-height:1.9}
@keyframes spin{to{transform:rotate(360deg)}}

/* 결과 — 4단 */
.res-header{padding:32px 0 20px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px}
.res-header h2{font-family:Georgia,serif;font-size:24px;font-weight:400}
.res-time{font-size:12px;color:var(--textF);margin-top:3px}
.save-result-btn{padding:10px 18px;background:var(--accent);border:none;color:#fff;font-family:inherit;font-size:13px;border-radius:10px;cursor:pointer;transition:opacity .2s;white-space:nowrap}
.save-result-btn:hover{opacity:.85}
.res-grid{display:grid;grid-template-columns:0.75fr 1fr 1fr 1fr;gap:14px;align-items:start}
@media(max-width:900px){.res-grid{grid-template-columns:1fr 1fr}}
@media(max-width:560px){.res-grid{grid-template-columns:1fr}}
.res-col{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow)}
.res-col-head{padding:12px 16px;border-bottom:1px solid var(--border);background:var(--accentDim2)}
.res-col-title{font-size:10px;letter-spacing:2.5px;color:var(--accent);text-transform:uppercase;font-weight:600}
.res-col-body{padding:16px}
.ans-item{margin-bottom:13px;padding-bottom:13px;border-bottom:1px solid var(--border)}
.ans-item:last-child{margin:0;padding:0;border:none}
.ans-q{font-size:11px;color:var(--textF);margin-bottom:4px}
.ans-dot-row{display:flex;align-items:flex-start;gap:8px}
.dot{width:7px;height:7px;border-radius:50%;margin-top:5px;flex-shrink:0}
.dot.ok{background:var(--green)}.dot.warn{background:var(--yellow)}.dot.bad{background:var(--red)}
.ans-v{font-size:13px;color:var(--text);line-height:1.8;white-space:pre-wrap}
.analysis-txt{font-size:13px;color:var(--textDim);line-height:2.1}

/* 행동강령 — 3단계 연결 구조 */
.act-card{margin-bottom:13px;padding-bottom:13px;border-bottom:1px solid var(--border)}
.act-card:last-child{margin:0;padding:0;border:none}
.act-step{font-size:9px;letter-spacing:2px;text-transform:uppercase;font-weight:700;margin-bottom:5px;padding:3px 8px;border-radius:20px;display:inline-block}
.act-step.s1{background:#e8f0fe;color:#3c5a9a}
.act-step.s2{background:#e8f4ea;color:#2d6a35}
.act-step.s3{background:#fef3e2;color:#8a5a00}
.act-title{font-size:14px;font-weight:500;color:var(--text);line-height:1.4;margin-bottom:5px}
.act-logic{font-size:12px;color:var(--accentL);line-height:1.7;margin-bottom:5px;font-style:italic}
.act-how{font-size:13px;color:var(--textDim);line-height:1.8;background:var(--accentDim2);padding:8px 12px;border-radius:8px}

/* 생각강령 */
.thought-item{margin-bottom:13px;padding-bottom:13px;border-bottom:1px solid var(--border)}
.thought-item:last-child{margin:0;padding:0;border:none}
.thought-tag{font-size:10px;color:var(--accentL);font-weight:600;letter-spacing:1px;text-transform:uppercase;margin-bottom:5px}
.thought-txt{font-size:13px;color:var(--textDim);line-height:1.9;margin-bottom:4px}
.thought-origin{font-size:11px;color:var(--textF);font-style:italic;line-height:1.6}

/* 결과 하단 */
.res-bottom{margin-top:16px}
.memo-save-area{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:14px}
.memo-save-lbl{font-size:10px;letter-spacing:2px;color:var(--accent);text-transform:uppercase;font-weight:600;margin-bottom:8px}
.memo-save-sub{font-size:13px;color:var(--textDim);margin-bottom:10px;line-height:1.75}
.save-m-btn{padding:11px 18px;background:var(--accentDim);border:1px solid var(--accentL);color:var(--accent);font-family:inherit;font-size:13px;font-weight:500;border-radius:10px;cursor:pointer;margin-top:10px}
.final-box{background:var(--accentDim);border-radius:var(--radius);padding:22px;text-align:center;margin-bottom:14px}
.final-box p{font-family:Georgia,serif;font-size:15px;color:var(--textDim);line-height:2.3}
.final-box strong{color:var(--accent)}
.restart-btn{display:block;padding:15px;background:transparent;border:1px solid var(--border);color:var(--textF);font-family:inherit;font-size:13px;cursor:pointer;border-radius:var(--radius);text-align:center;width:100%}
.restart-btn:hover{border-color:var(--accentL)}

/* 기록 */
.memo-h{padding:28px 24px 18px;border-bottom:1px solid var(--border)}
.memo-h h2{font-family:Georgia,serif;font-size:21px;font-weight:400;margin-bottom:5px}
.memo-sub{font-size:12px;color:var(--textF);line-height:1.75}
.memo-add{padding:18px 24px;border-bottom:1px solid var(--border)}
.memo-add-btn{padding:11px 18px;background:var(--accent);border:none;color:#fff;font-family:inherit;font-size:13px;border-radius:10px;cursor:pointer;margin-top:10px}
.memo-list{padding:16px 24px}
.memo-empty{font-size:13px;color:var(--textF);text-align:center;padding:48px 0;line-height:2.2}
.memo-item{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;margin-bottom:9px;position:relative}
.memo-item.result-item{border-left:3px solid var(--accent)}
.memo-date{font-size:11px;color:var(--textF);margin-bottom:5px}
.memo-type{font-size:10px;color:var(--accentL);font-weight:600;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px}
.memo-text{font-size:13px;color:var(--textDim);line-height:1.85;padding-right:28px;white-space:pre-wrap}
.memo-del{position:absolute;top:12px;right:14px;background:none;border:none;color:var(--textF);font-size:17px;cursor:pointer}
.memo-expand-btn{font-size:12px;color:var(--accentL);background:none;border:none;cursor:pointer;margin-top:6px;padding:0;font-family:inherit}

/* 설정 */
.settings-wrap{padding:24px}
.settings-title{font-family:Georgia,serif;font-size:20px;font-weight:400;margin-bottom:6px}
.settings-sub{font-size:13px;color:var(--textF);line-height:1.7;margin-bottom:24px}
.set-section{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:14px;overflow:hidden}
.set-section-head{padding:14px 18px;border-bottom:1px solid var(--border);background:var(--accentDim2);display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none}
.set-section-title{font-size:11px;letter-spacing:2px;color:var(--accent);text-transform:uppercase;font-weight:600}
.set-section-arrow{font-size:12px;color:var(--textF);transition:transform .2s}
.set-section-arrow.open{transform:rotate(180deg)}
.set-section-body{padding:18px;display:none}
.set-section-body.open{display:block}
.setting-lbl{font-size:11px;color:var(--textDim);font-weight:500;margin-bottom:8px;margin-top:16px;letter-spacing:.5px}
.setting-lbl:first-child{margin-top:0}
.setting-inp{width:100%;padding:11px 13px;border:1px solid var(--border);border-radius:10px;font-family:inherit;font-size:13px;background:var(--bg);color:var(--text);transition:border-color .2s}
.setting-inp:focus{outline:none;border-color:var(--accentL)}
.setting-ta{width:100%;padding:11px 13px;border:1px solid var(--border);border-radius:10px;font-family:inherit;font-size:13px;background:var(--bg);color:var(--text);resize:none;line-height:1.8;min-height:80px}
.setting-ta:focus{outline:none;border-color:var(--accentL)}
.setting-hint{font-size:12px;color:var(--textF);margin-top:5px;line-height:1.6}
.setting-hint a{color:var(--accentL);text-decoration:none}
.api-status{display:flex;align-items:center;gap:8px;margin-top:8px;font-size:12px}
.status-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.status-dot.ok{background:var(--green)}.status-dot.none{background:var(--textF)}
.btn-row{display:flex;gap:10px;margin-top:12px}
.btn-primary{flex:1;padding:11px;background:var(--accent);border:none;color:#fff;font-family:inherit;font-size:13px;border-radius:10px;cursor:pointer}
.btn-secondary{padding:11px 16px;background:var(--surface);border:1px solid var(--border);color:var(--textDim);font-family:inherit;font-size:13px;border-radius:10px;cursor:pointer}
.btn-ghost{padding:11px 16px;background:transparent;border:1px solid var(--border);color:var(--textF);font-family:inherit;font-size:13px;border-radius:10px;cursor:pointer}
.test-result{margin-top:10px;padding:11px 14px;border-radius:8px;font-size:13px;line-height:1.7;display:none}
.test-result.ok{background:var(--greenBg);color:#2d5a33}.test-result.err{background:var(--redBg);color:#6b2020}
.divider{height:1px;background:var(--border);margin:16px 0}
.danger-btn{padding:11px 16px;background:transparent;border:1px solid #d0a0a0;color:var(--red);font-family:inherit;font-size:13px;border-radius:10px;cursor:pointer}
.phil-edit-item{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:10px}
.phil-edit-row{display:flex;gap:8px;margin-bottom:8px}
.phil-edit-tag{width:110px;flex-shrink:0;padding:9px 10px;border:1px solid var(--border);border-radius:8px;font-family:inherit;font-size:12px;background:var(--surface);color:var(--accent)}
.phil-edit-title{flex:1;padding:9px 10px;border:1px solid var(--border);border-radius:8px;font-family:inherit;font-size:13px;background:var(--surface);color:var(--text)}
.phil-edit-body{width:100%;padding:9px 10px;border:1px solid var(--border);border-radius:8px;font-family:inherit;font-size:12px;background:var(--surface);color:var(--textDim);resize:none;min-height:70px;line-height:1.8}
.phil-edit-del{padding:6px 10px;background:transparent;border:1px solid #d0a0a0;color:var(--red);font-family:inherit;font-size:12px;border-radius:8px;cursor:pointer;margin-top:6px}
.q-edit-item{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:10px}
.q-edit-row{display:flex;gap:8px;margin-bottom:8px;align-items:center}
.q-edit-cat{width:90px;flex-shrink:0;padding:9px 10px;border:1px solid var(--border);border-radius:8px;font-family:inherit;font-size:12px;background:var(--surface);color:var(--accent)}
.q-edit-text{flex:1;padding:9px 10px;border:1px solid var(--border);border-radius:8px;font-family:inherit;font-size:13px;background:var(--surface);color:var(--text)}
.q-edit-sub{width:100%;padding:9px 10px;border:1px solid var(--border);border-radius:8px;font-family:inherit;font-size:12px;background:var(--surface);color:var(--textDim);resize:none;min-height:50px;line-height:1.7}
.sel{padding:9px 10px;border:1px solid var(--border);border-radius:8px;font-family:inherit;font-size:12px;background:var(--surface);color:var(--textDim)}
.q-edit-del{padding:6px 10px;background:transparent;border:1px solid #d0a0a0;color:var(--red);font-family:inherit;font-size:12px;border-radius:8px;cursor:pointer;margin-top:6px}
.add-item-btn{padding:10px 16px;background:var(--accentDim);border:1px solid var(--accentL);color:var(--accent);font-family:inherit;font-size:13px;border-radius:10px;cursor:pointer;margin-top:4px}

.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%);background:var(--text);color:#fff;font-size:13px;padding:11px 22px;border-radius:22px;z-index:999;opacity:0;transition:opacity .25s;pointer-events:none;white-space:nowrap}
.toast.show{opacity:1}
</style>
</head>
<body>
<div class="tab-bar">
  <button class="tab-btn active" onclick="goTab('home')">홈</button>
  <button class="tab-btn" onclick="startCheck()">체크</button>
  <button class="tab-btn" onclick="goTab('memo')">기록</button>
  <button class="tab-btn" onclick="goTab('settings')">설정</button>
</div>

<!-- 홈 -->
<div id="page-home" class="page active">
  <div class="inner">
    <div class="hero">
      <div class="eyebrow">나의 돌아오는 시스템</div>
      <h1>길을 잃었을 때<br>다시 나에게 돌아오는 곳</h1>
      <div class="motto">
        이건 나를 통제하려는 게 아니다. 완벽하게 지키지 못해도 된다.<br>
        <strong>지금 이걸 열었다는 것 자체가 이미 돌아오는 중이다.</strong>
      </div>
    </div>
    <div class="sec-lbl">내가 경험으로 알게 된 것들</div>
    <div class="phil-grid" id="philList"></div>
    <button class="start-btn" onclick="startCheck()">지금 내 상태 확인하기 →</button>
    <div style="height:36px"></div>
  </div>
</div>

<!-- 체크 -->
<div id="page-check" class="page">
  <div class="q-outer" id="checkContent"></div>
</div>

<!-- 결과 -->
<div id="page-result" class="page">
  <div class="inner-wide" id="resultContent"></div>
</div>

<!-- 기록 -->
<div id="page-memo" class="page">
  <div class="inner">
    <div class="memo-h">
      <h2>나의 기록</h2>
      <p class="memo-sub">메모와 저장된 결과지를 모아두는 곳.<br>기록이 매번 AI 분석에 반영된다.</p>
    </div>
    <div class="memo-add">
      <textarea id="newMemoTa" style="min-height:80px" placeholder="오늘 새롭게 알게 된 것, 효과 있었던 것, 느낀 점..."></textarea>
      <button class="memo-add-btn" onclick="addMemoFromId('newMemoTa')">저장</button>
    </div>
    <div class="memo-list" id="memoList"></div>
  </div>
</div>

<!-- 설정 -->
<div id="page-settings" class="page">
  <div class="inner" style="padding-top:8px">
    <div class="settings-wrap">
      <h2 class="settings-title">설정</h2>
      <p class="settings-sub">시스템의 모든 부분을 직접 수정할 수 있어.</p>

      <!-- API -->
      <div class="set-section">
        <div class="set-section-head" onclick="toggleSection('sec-api')">
          <div class="set-section-title">API 키</div>
          <div class="set-section-arrow open" id="arr-sec-api">▼</div>
        </div>
        <div class="set-section-body open" id="sec-api">
          <div class="setting-lbl">Groq API 키</div>
          <input id="apiKeyInp" class="setting-inp" type="password" placeholder="gsk_...로 시작하는 키">
          <div class="setting-hint">
            <a href="https://console.groq.com" target="_blank">console.groq.com</a>에서 무료로 발급받을 수 있어. 키는 이 기기에만 저장돼.
          </div>
          <div class="api-status" id="apiStatus"></div>
          <div class="btn-row">
            <button class="btn-primary" onclick="saveApiKey()">저장</button>
            <button class="btn-secondary" onclick="testApiKey()">연결 테스트</button>
          </div>
          <div class="test-result" id="testResult"></div>
        </div>
      </div>

      <!-- AI 스타일 -->
      <div class="set-section">
        <div class="set-section-head" onclick="toggleSection('sec-ai')">
          <div class="set-section-title">AI 응답 스타일</div>
          <div class="set-section-arrow" id="arr-sec-ai">▼</div>
        </div>
        <div class="set-section-body" id="sec-ai">
          <div class="setting-lbl">분석 스타일</div>
          <select id="setAnalysisStyle" class="sel setting-inp" onchange="saveSettings()">
            <option value="pattern">패턴 분석 (답변들 사이의 연결고리 짚기)</option>
            <option value="direct">직접적 (보이는 것 그대로)</option>
            <option value="gentle">부드럽게 (따뜻한 톤으로)</option>
          </select>
          <div class="setting-lbl">행동강령 스타일</div>
          <select id="setActionStyle" class="sel setting-inp" onchange="saveSettings()">
            <option value="step">3단계 연결 (인지→행동→습관)</option>
            <option value="simple">단순 명확 (바로 할 것만)</option>
            <option value="why">이유 중심 (왜 해야 하는지 먼저)</option>
          </select>
          <div class="setting-lbl">추가 프롬프트 (선택)</div>
          <textarea id="setExtraPrompt" class="setting-ta" placeholder="AI에게 추가로 지시하고 싶은 내용. 예: '항상 구체적인 시간을 포함해줘'" oninput="saveSettings()"></textarea>
        </div>
      </div>

      <!-- 가치관 카드 편집 -->
      <div class="set-section">
        <div class="set-section-head" onclick="toggleSection('sec-phil')">
          <div class="set-section-title">가치관 카드 편집</div>
          <div class="set-section-arrow" id="arr-sec-phil">▼</div>
        </div>
        <div class="set-section-body" id="sec-phil">
          <div id="philEditList"></div>
          <button class="add-item-btn" onclick="addPhilCard()">+ 가치관 추가</button>
          <div class="btn-row" style="margin-top:14px">
            <button class="btn-primary" onclick="savePhilCards()">저장</button>
            <button class="btn-ghost" onclick="resetPhilCards()">기본값으로</button>
          </div>
        </div>
      </div>

      <!-- 질문 편집 -->
      <div class="set-section">
        <div class="set-section-head" onclick="toggleSection('sec-q')">
          <div class="set-section-title">질문 편집</div>
          <div class="set-section-arrow" id="arr-sec-q">▼</div>
        </div>
        <div class="set-section-body" id="sec-q">
          <div id="qEditList"></div>
          <button class="add-item-btn" onclick="addQuestion()">+ 질문 추가</button>
          <div class="btn-row" style="margin-top:14px">
            <button class="btn-primary" onclick="saveQuestionSet()">저장</button>
            <button class="btn-ghost" onclick="resetQuestions()">기본값으로</button>
          </div>
        </div>
      </div>

      <!-- 데이터 -->
      <div class="set-section">
        <div class="set-section-head" onclick="toggleSection('sec-data')">
          <div class="set-section-title">데이터 관리</div>
          <div class="set-section-arrow" id="arr-sec-data">▼</div>
        </div>
        <div class="set-section-body" id="sec-data">
          <p class="setting-hint" style="margin-bottom:14px">기록은 브라우저 localStorage에 저장돼. 캐시를 지우면 사라지니 중요한 내용은 따로 백업해둬.</p>
          <button class="danger-btn" onclick="clearAllData()">모든 기록 삭제</button>
        </div>
      </div>

    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ── 기본 데이터 ───────────────────────────────────────────
const BASE_PHIL=[
  {tag:"중심 가치",title:"행복하게 살자",body:"원하는 대로만 살아봤더니 행복하지 않았다. 한두 달 해보니 나가는 일이 없을수록 몸이 망가지고 피곤해졌다. 어차피 살 거라면 행복하게 살겠다."},
  {tag:"가짜 보상",title:"끌린다고 진짜 원하는 게 아닐 수 있다",body:"전자기기를 오래 해봤다. 끝은 항상 몸이 아프거나 더 우울했다. 하지 말라고 하니까 스트레스·회피·보상 심리로 하고 있었던 것이다. 직접 해봤을 때 끝이 어땠는지가 기준이다."},
  {tag:"생각의 실체",title:"꺼내야 실체가 생긴다",body:"머릿속에서 논문처럼 느껴지는 생각도 꺼내보면 두 줄이 된다. 실망이 아니다. 실체가 생긴 것이다. 실체가 있어야 다룰 수 있다."},
  {tag:"불안",title:"불안은 미래에 있고, 나는 지금 여기 있다",body:"걱정의 99%는 일어나지 않는다. 미래 걱정에 쓰는 에너지를 차라리 지금 할 수 있는 것에 쓰는 게 낫다."},
  {tag:"나를 대하는 방식",title:"나는 평생 나와 함께 산다",body:"아이돌 매니저처럼 냉철하게 파악하되, 그 정보는 나를 발전시키는 데 쓴다. 부족한 점은 나를 공격하기 위한 게 아니라 성장시키기 위해 있는 것이다."},
  {tag:"노력",title:"노력은 배신하지 않는다",body:"안 좋은 일이 생기거나 당장 변화가 없어도 쌓이고 있다. 치열하게 1분 1초 고민하는 것도 나를 성장시키고 있다."},
];
const BASE_QUESTIONS=[
  {id:'mood',cat:'지금 상태',text:'지금 기분이나 상태를 솔직하게 표현하면?',sub:'좋다, 무기력하다, 불안하다, 모르겠다 — 뭐든 괜찮아.',type:'ta'},
  {id:'body',cat:'몸 상태',text:'지금 몸은 어때?',sub:'잠, 피로도, 아픈 곳, 밥은 먹었는지.',type:'opts',opts:['괜찮아','좀 피곤하거나 찌뿌둥해','확실히 안 좋아']},
  {id:'avoidance',cat:'행동 패턴',text:'지금 피하거나 오래 붙잡고 있는 게 있어?',sub:'전자기기, 유튜브, 게임, 해야 할 일 미루기 등. 있으면 뭔지, 얼마나 했는지도.',type:'ta'},
  {id:'anxiety',cat:'불안·걱정',text:'지금 머릿속을 맴도는 걱정이나 생각이 있어?',sub:'있다면 꺼내봐. 머릿속에 두면 계속 커진다.',type:'ta'},
  {id:'compare',cat:'비교·자책',text:'요즘 타인과 비교하거나 스스로를 자책하는 일이 있어?',sub:'어떤 상황에서 그런 생각이 드는지.',type:'ta'},
];
const Q_INSIGHTS={
  mood:{tag:"생각의 실체",text:"머릿속에서 논문처럼 느껴지는 것도 꺼내보면 두 줄이 된다. 지금 상태를 말로 꺼낸 것 자체가 이미 절반이다."},
  body:{
    ok:{tag:"중심 가치",text:"몸이 받쳐줄 때 할 수 있는 것들이 다르다. 지금이 그 때다."},
    warn:{tag:"중심 가치",text:"지금 느끼는 것의 일부가 몸에서 오는 것일 수 있다. 몸과 마음은 이어져 있다."},
    bad:{tag:"중심 가치",text:"몸이 먼저다. 몸이 망가진 채로 억지로 하는 건 효율이 없다는 걸 경험으로 알잖아."}
  },
  avoidance:{tag:"가짜 보상",text:"끌린다고 원하는 게 아닐 수 있다. 직접 해봤을 때 끝이 어땠는지 기억하면 답이 나온다."},
  anxiety:{tag:"불안",text:"걱정의 99%는 일어나지 않는다. 꺼내보면 생각보다 단순한 경우가 많아."},
  compare:{tag:"나를 대하는 방식",text:"비교할 때 내가 왜 지금 이 노력을 하고 있는지 근본적인 이유를 다시 떠올려봐."},
};

// ── 상태 ─────────────────────────────────────────────────
let API_KEY=localStorage.getItem('groq_key')||'';
let memos=JSON.parse(localStorage.getItem('memos_v5')||'[]');
let philCards=JSON.parse(localStorage.getItem('phil_cards')||'null')||JSON.parse(JSON.stringify(BASE_PHIL));
let questionSet=JSON.parse(localStorage.getItem('question_set')||'null')||JSON.parse(JSON.stringify(BASE_QUESTIONS));
let aiSettings=JSON.parse(localStorage.getItem('ai_settings')||'{}');
let questions=[],curQ=0,answers={};
let lastResult=null; // 결과 저장용

window.onload=()=>{renderPhil();renderMemos();renderApiStatus();loadSavedKey();loadAiSettings();renderPhilEdit();renderQEdit();};

// ── 탭 ───────────────────────────────────────────────────
function goTab(t){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+t).classList.add('active');
  ['home','check','memo','settings'].forEach((n,i)=>{if(n===t)document.querySelectorAll('.tab-btn')[i].classList.add('active');});
}

// ── 설정 섹션 토글 ────────────────────────────────────────
function toggleSection(id){
  const body=document.getElementById(id);
  const arr=document.getElementById('arr-'+id);
  body.classList.toggle('open');
  arr.classList.toggle('open');
}

// ── 홈 ───────────────────────────────────────────────────
function renderPhil(){
  document.getElementById('philList').innerHTML=philCards.map(p=>`
    <div class="phil-card">
      <div class="phil-tag">${p.tag}</div>
      <div class="phil-title">${p.title}</div>
      <div class="phil-body">${p.body}</div>
    </div>`).join('');
}

// ── API ───────────────────────────────────────────────────
function loadSavedKey(){const i=document.getElementById('apiKeyInp');if(i&&API_KEY)i.value=API_KEY;}
function renderApiStatus(){
  const el=document.getElementById('apiStatus');if(!el)return;
  el.innerHTML=API_KEY
    ?`<div class="status-dot ok"></div><span style="color:var(--green)">키 저장됨</span>`
    :`<div class="status-dot none"></div><span style="color:var(--textF)">키 없음</span>`;
}
function saveApiKey(){
  const v=document.getElementById('apiKeyInp').value.trim();
  if(!v){showToast('키를 입력해줘');return;}
  if(!v.startsWith('gsk_')){showToast('gsk_...로 시작하는 키를 입력해줘');return;}
  API_KEY=v;localStorage.setItem('groq_key',v);renderApiStatus();showToast('저장됐어');
}
async function testApiKey(){
  const inp=document.getElementById('apiKeyInp').value.trim()||API_KEY;
  const resEl=document.getElementById('testResult');resEl.style.display='none';
  if(!inp){showToast('먼저 키를 입력해줘');return;}
  showToast('테스트 중...');
  try{
    const txt=await callAI('안녕. 한 문장으로만 답해줘.',200,inp);
    resEl.className='test-result ok';resEl.textContent='✓ 연결 성공: '+txt.trim().slice(0,80);resEl.style.display='block';
  }catch(e){resEl.className='test-result err';resEl.textContent='✗ 오류: '+e.message;resEl.style.display='block';}
}

// ── AI 설정 ───────────────────────────────────────────────
function loadAiSettings(){
  const s=aiSettings;
  const aStyle=document.getElementById('setAnalysisStyle');
  const acStyle=document.getElementById('setActionStyle');
  const extra=document.getElementById('setExtraPrompt');
  if(aStyle&&s.analysisStyle)aStyle.value=s.analysisStyle;
  if(acStyle&&s.actionStyle)acStyle.value=s.actionStyle;
  if(extra&&s.extraPrompt)extra.value=s.extraPrompt;
}
function saveSettings(){
  aiSettings={
    analysisStyle:document.getElementById('setAnalysisStyle')?.value||'pattern',
    actionStyle:document.getElementById('setActionStyle')?.value||'step',
    extraPrompt:document.getElementById('setExtraPrompt')?.value||''
  };
  localStorage.setItem('ai_settings',JSON.stringify(aiSettings));
}

// ── 가치관 편집 ───────────────────────────────────────────
function renderPhilEdit(){
  document.getElementById('philEditList').innerHTML=philCards.map((p,i)=>`
    <div class="phil-edit-item">
      <div class="phil-edit-row">
        <input class="phil-edit-tag" value="${esc(p.tag)}" oninput="philCards[${i}].tag=this.value" placeholder="태그">
        <input class="phil-edit-title" value="${esc(p.title)}" oninput="philCards[${i}].title=this.value" placeholder="제목">
      </div>
      <textarea class="phil-edit-body" oninput="philCards[${i}].body=this.value" placeholder="내용">${esc(p.body)}</textarea>
      <button class="phil-edit-del" onclick="delPhilCard(${i})">삭제</button>
    </div>`).join('');
}
function addPhilCard(){
  philCards.push({tag:'새 가치관',title:'',body:''});
  renderPhilEdit();
}
function delPhilCard(i){philCards.splice(i,1);renderPhilEdit();}
function savePhilCards(){
  localStorage.setItem('phil_cards',JSON.stringify(philCards));
  renderPhil();showToast('가치관 저장됐어');
}
function resetPhilCards(){
  philCards=JSON.parse(JSON.stringify(BASE_PHIL));
  localStorage.setItem('phil_cards',JSON.stringify(philCards));
  renderPhil();renderPhilEdit();showToast('기본값으로 되돌렸어');
}

// ── 질문 편집 ─────────────────────────────────────────────
function renderQEdit(){
  document.getElementById('qEditList').innerHTML=questionSet.map((q,i)=>`
    <div class="q-edit-item">
      <div class="q-edit-row">
        <input class="q-edit-cat" value="${esc(q.cat)}" oninput="questionSet[${i}].cat=this.value" placeholder="카테고리">
        <input class="q-edit-text" value="${esc(q.text)}" oninput="questionSet[${i}].text=this.value" placeholder="질문">
      </div>
      <textarea class="q-edit-sub" oninput="questionSet[${i}].sub=this.value" placeholder="보조 설명">${esc(q.sub||'')}</textarea>
      <button class="q-edit-del" onclick="delQuestion(${i})">삭제</button>
    </div>`).join('');
}
function addQuestion(){
  questionSet.push({id:'q'+Date.now(),cat:'새 카테고리',text:'',sub:'',type:'ta'});
  renderQEdit();
}
function delQuestion(i){questionSet.splice(i,1);renderQEdit();}
function saveQuestionSet(){
  localStorage.setItem('question_set',JSON.stringify(questionSet));
  showToast('질문 저장됐어');
}
function resetQuestions(){
  questionSet=JSON.parse(JSON.stringify(BASE_QUESTIONS));
  localStorage.setItem('question_set',JSON.stringify(questionSet));
  renderQEdit();showToast('기본값으로 되돌렸어');
}

// ── 데이터 ───────────────────────────────────────────────
function clearAllData(){
  if(!confirm('모든 기록을 삭제할까? 되돌릴 수 없어.'))return;
  localStorage.removeItem('memos_v5');
  memos=[];renderMemos();showToast('삭제됐어');
}

// ── 체크 ─────────────────────────────────────────────────
function startCheck(){
  if(!API_KEY){goTab('settings');showToast('먼저 API 키를 설정해줘');return;}
  curQ=0;answers={};
  questions=JSON.parse(JSON.stringify(questionSet));
  goTab('check');renderQ();
}
function insightHtml(tag,txt){
  return `<div class="insight-box"><div class="insight-row">
    <div class="insight-tag">${tag}</div>
    <div class="insight-txt">${txt}</div>
  </div></div>`;
}
function renderQ(){
  const q=questions[curQ];
  const pct=Math.round((curQ/questions.length)*100);
  const isLast=curQ===questions.length-1;
  const hasAns=q.type==='opts'?!!answers[q.id]:(answers[q.id]||'').trim().length>0;
  let html=`<div class="q-header">
    <div class="prog-row">
      <div class="prog-bar"><div class="prog-fill" style="width:${pct}%"></div></div>
      <div class="prog-lbl">${curQ+1} / ${questions.length}</div>
    </div>
    <div class="q-cat">${q.cat}</div>
    <div class="q-text">${q.text}</div>
    <div class="q-sub">${q.sub||''}</div>
  </div>`;
  if(q.type==='opts'){
    const opts=q.opts||['괜찮아','좀 피곤하거나 찌뿌둥해','확실히 안 좋아'];
    html+=`<div class="opts">`+opts.map(o=>
      `<button class="opt-btn${answers[q.id]===o?' selected':''}" onclick="selectOpt(this,'${o.replace(/'/g,"&#39;")}')">${o}</button>`
    ).join('')+`</div>`;
    if(answers[q.id]&&Q_INSIGHTS[q.id]){
      const k=answers[q.id]==='괜찮아'?'ok':answers[q.id]==='확실히 안 좋아'?'bad':'warn';
      const ins=Q_INSIGHTS[q.id][k]||Q_INSIGHTS[q.id];
      if(ins&&ins.tag)html+=insightHtml(ins.tag,ins.text);
    }
  } else {
    const ev=(answers[q.id]||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    html+=`<div class="ta-wrap"><textarea id="taMain" placeholder="그냥 뱉어봐. 잘 쓰려고 하지 않아도 돼." oninput="onTaInput(this)">${ev}</textarea></div>`;
    if((answers[q.id]||'').trim().length>2&&Q_INSIGHTS[q.id]){
      const ins=Q_INSIGHTS[q.id];
      if(ins.tag)html+=insightHtml(ins.tag,ins.text);
    }
  }
  html+=`<div class="nav-row">
    ${curQ>0?`<button class="btn-back" onclick="prevQ()">←</button>`:''}
    <button class="btn-next" id="btnNext" onclick="nextQ()" ${hasAns?'':'disabled'}>${isLast?'결과 보기 →':'다음'}</button>
  </div>`;
  document.getElementById('checkContent').innerHTML=html;
}
function onTaInput(el){
  answers[questions[curQ].id]=el.value;
  const btn=document.getElementById('btnNext');if(btn)btn.disabled=el.value.trim().length===0;
  const q=questions[curQ];
  if(Q_INSIGHTS[q.id]&&el.value.trim().length>2&&!document.querySelector('.insight-box')){
    const ins=Q_INSIGHTS[q.id];
    if(ins.tag)document.querySelector('.ta-wrap').insertAdjacentHTML('afterend',insightHtml(ins.tag,ins.text));
  }
}
function selectOpt(btn,val){
  answers[questions[curQ].id]=val;
  document.querySelectorAll('.opt-btn').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');
  document.getElementById('btnNext').disabled=false;
  const ex=document.querySelector('.insight-box');if(ex)ex.remove();
  if(Q_INSIGHTS.body){
    const k=val==='괜찮아'?'ok':val==='확실히 안 좋아'?'bad':'warn';
    const ins=Q_INSIGHTS.body[k];
    document.querySelector('.opts').insertAdjacentHTML('afterend',insightHtml(ins.tag,ins.text));
  }
}
function prevQ(){if(curQ>0){curQ--;renderQ();}}
function nextQ(){if(curQ<questions.length-1){curQ++;renderQ();}else showResult();}

// ── 결과 ─────────────────────────────────────────────────
function showResult(){
  const now=new Date();
  const ts=`${now.getFullYear()}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-result').classList.add('active');
  document.getElementById('resultContent').innerHTML=`
    <div class="res-header">
      <div><h2>지금 나의 상태</h2><div class="res-time">${ts}</div></div>
      <button class="save-result-btn" onclick="saveResult()">결과지 저장</button>
    </div>
    <div class="res-grid">
      <div class="res-col">
        <div class="res-col-head"><div class="res-col-title">내가 한 말</div></div>
        <div class="res-col-body" id="col1"></div>
      </div>
      <div class="res-col">
        <div class="res-col-head"><div class="res-col-title">지금 나를 읽어보면</div></div>
        <div class="res-col-body"><div id="col2"><div class="spinner" style="margin:8px 0"></div></div></div>
      </div>
      <div class="res-col">
        <div class="res-col-head"><div class="res-col-title">지금 필요한 생각강령</div></div>
        <div class="res-col-body" id="col4"><div class="spinner" style="margin:8px 0"></div></div>
      </div>
      <div class="res-col">
        <div class="res-col-head"><div class="res-col-title">지금 당장 할 것</div></div>
        <div class="res-col-body" id="col3"><div class="spinner" style="margin:8px 0"></div></div>
      </div>
    </div>
    <div class="res-bottom">
      <div class="memo-save-area">
        <div class="memo-save-lbl">오늘의 메모</div>
        <div class="memo-save-sub">오늘 새롭게 알게 된 것이나 느낀 점.<br>이 기록이 다음 분석에 반영된다.</div>
        <textarea id="resMemoTa" style="min-height:70px;margin-top:4px" placeholder="오늘의 깨달음..."></textarea>
        <button class="save-m-btn" onclick="addMemoFromId('resMemoTa')">기록에 저장</button>
      </div>
      <div class="final-box" style="margin-top:14px">
        <p>완벽하지 않아도 된다.<br><strong>이걸 열었다는 것 자체가 이미 돌아오는 중이다.</strong></p>
      </div>
      <button class="restart-btn" style="margin-top:12px" onclick="startCheck()">처음부터 다시</button>
    </div>`;
  renderCol1();
  runAnalysis();
}

function renderCol1(){
  const dotCls=id=>id!=='body'?'warn':(answers[id]==='괜찮아'?'ok':answers[id]==='확실히 안 좋아'?'bad':'warn');
  document.getElementById('col1').innerHTML=questions
    .filter(q=>answers[q.id]&&answers[q.id].trim())
    .map(q=>`<div class="ans-item"><div class="ans-dot-row">
      <div class="dot ${dotCls(q.id)}"></div>
      <div><div class="ans-q">${q.text}</div><div class="ans-v">${answers[q.id]}</div></div>
    </div></div>`).join('');
}

// ── AI 분석 — 시스템 프롬프트 동적 생성 ──────────────────
function buildSYS(){
  const philTxt=philCards.map(p=>`- ${p.tag}: ${p.title} — ${p.body}`).join('\n');
  return `너는 이 사람의 상태를 파악하고, 지금 필요한 것을 짚어주는 역할이다.
이 사람이 직접 경험으로 얻은 가치관이 아래에 있다. 반드시 이것을 근거로, 이것의 표현을 살려서 답변하라.

[가치관 및 경험]
${philTxt}

[원칙]
- 한국어. 구어체. 특수문자(**,#,*,_) 절대 금지.
- 반드시 위 가치관의 표현을 그대로 살려서 쓸 것.
- 일반론적인 심리 조언 금지. 이 사람이 직접 경험한 것만 근거로 삼을 것.
- 행동강령은 지금 바로 실행 가능한 것으로. 추상적 표현 금지.
${aiSettings.extraPrompt?`\n[추가 지시]\n${aiSettings.extraPrompt}`:''}`;
}

async function runAnalysis(){
  const ctx=questions.filter(q=>answers[q.id]&&answers[q.id].trim())
    .map(q=>`[${q.text}]\n${answers[q.id]}`).join('\n\n');
  const memCtx=memos.filter(m=>m.type==='memo').length>0
    ?`\n\n[이 사람의 이전 기록/깨달음]\n${memos.filter(m=>m.type==='memo').slice(0,5).map(m=>m.text).join('\n')}`:'';

  const aStyle=aiSettings.analysisStyle||'pattern';
  const analysisInstr=aStyle==='pattern'
    ?'답변들 사이의 패턴·연결고리·숨겨진 맥락을 짚어라. 단순 요약 금지.'
    :aStyle==='direct'?'보이는 것 그대로 직접적으로 써라.'
    :'따뜻한 톤으로, 이 사람 편에서 써라.';

  const acStyle=aiSettings.actionStyle||'step';

  // 호출 1: 분석
  const p1=`오늘 상태:\n${ctx}${memCtx}\n\n3~4문장으로 지금 상태를 써라.\n규칙: ${analysisInstr} 특수문자 금지.`;
  try{
    const t1=await callAI(p1,400);
    document.getElementById('col2').innerHTML=`<div class="analysis-txt">${t1.trim().replace(/[*_#`]/g,'').replace(/\n/g,'<br>')}</div>`;
  }catch(e){
    document.getElementById('col2').innerHTML=`<div class="analysis-txt" style="color:var(--red)">${e.message}</div>`;
  }

  // 호출 2+3 병렬
  const p2=`오늘 상태:\n${ctx}${memCtx}\n\n지금 이 상태에 맞는 생각강령 3가지. 일반론 금지. 경험으로 얻은 표현 그대로. 특수문자(**,#,*) 금지.\nJSON 배열만 출력:\n[{"tag":"가치관이름","content":"한두 문장","reason":"지금 왜 필요한지 한 줄"},{"tag":"...","content":"...","reason":"..."},{"tag":"...","content":"...","reason":"..."}]`;

  const stepLabels={
    step:['STEP 1 — 생각 전환','STEP 2 — 즉각 행동','STEP 3 — 습관 연결'],
    simple:['','',''],
    why:['WHY','HOW','HABIT']
  };
  const labels=stepLabels[acStyle]||stepLabels.step;
  const actionInstr=acStyle==='step'
    ?`3가지를 순서대로 써라: (1) 인지 재구성 — 지금 왜곡된 생각을 바로잡는 것, (2) 즉각 행동 — 지금 당장 몸을 움직이는 것, (3) 습관 연결 — 이것이 왜 장기적으로 연결되는지. 3가지가 이어지는 하나의 흐름이어야 한다.`
    :acStyle==='simple'?`지금 당장 바로 할 수 있는 행동 3가지. 군더더기 없이 심플하게.`
    :`각 행동마다 왜 해야 하는지 이유를 먼저 제시하고, 그 다음 어떻게 할지 써라.`;

  const p3=`오늘 상태:\n${ctx}${memCtx}\n\n${actionInstr} 이 사람의 경험과 가치관 기반으로. 특수문자(**,#,*) 금지.\nJSON 배열만 출력:\n[{"title":"행동 이름","logic":"가치관 근거와 논리적 이유 한 줄","how":"지금 당장 구체적으로. 동사로 시작"},{"title":"...","logic":"...","how":"..."},{"title":"...","logic":"...","how":"..."}]`;

  const [r2,r3]=await Promise.allSettled([callAI(p2,700),callAI(p3,700)]);

  // 생각강령
  try{
    const raw2=(r2.status==='fulfilled'?r2.value:'').replace(/[*_#`]/g,'').replace(/```json|```/g,'').trim();
    const arr2=JSON.parse(raw2.slice(raw2.indexOf('['),raw2.lastIndexOf(']')+1));
    document.getElementById('col4').innerHTML=arr2.map(it=>`<div class="thought-item">
        <div class="thought-tag">${it.tag||''}</div>
        <div class="thought-txt">${it.content||''}</div>
        ${it.reason?`<div class="thought-origin">↳ ${it.reason}</div>`:''}
      </div>`).join('');
  }catch(e){
    document.getElementById('col4').innerHTML=`<div class="analysis-txt" style="color:var(--red)">오류: ${r2.reason?.message||e.message}</div>`;
  }

  // 행동강령
  try{
    const raw3=(r3.status==='fulfilled'?r3.value:'').replace(/[*_#`]/g,'').replace(/```json|```/g,'').trim();
    const arr3=JSON.parse(raw3.slice(raw3.indexOf('['),raw3.lastIndexOf(']')+1));
    document.getElementById('col3').innerHTML=arr3.map((a,i)=>`<div class="act-card">
        ${labels[i]?`<div class="act-step s${i+1}">${labels[i]}</div>`:''}
        <div class="act-title">${a.title||''}</div>
        ${a.logic?`<div class="act-logic">${a.logic}</div>`:''}
        ${a.how?`<div class="act-how">${a.how}</div>`:''}
      </div>`).join('');
    // lastResult 저장
    lastResult={ts:new Date().toLocaleString('ko-KR'),answers:{...answers},thoughts:r2.status==='fulfilled'?r2.value:'',actions:r3.status==='fulfilled'?r3.value:''};
  }catch(e){
    document.getElementById('col3').innerHTML=`<div class="analysis-txt" style="color:var(--red)">오류: ${r3.reason?.message||e.message}</div>`;
  }
}

// ── 결과지 저장 ───────────────────────────────────────────
function saveResult(){
  if(!lastResult){showToast('저장할 결과가 없어');return;}
  const ansText=questions.filter(q=>answers[q.id]&&answers[q.id].trim())
    .map(q=>`${q.text}: ${answers[q.id]}`).join(' / ');
  const col2txt=document.getElementById('col2')?.innerText||'';
  const col3txt=document.getElementById('col3')?.innerText||'';
  const col4txt=document.getElementById('col4')?.innerText||'';
  const fullText=`[${lastResult.ts}]\n내 답변: ${ansText}\n\n분석: ${col2txt}\n\n생각강령: ${col4txt}\n\n행동강령: ${col3txt}`;
  memos=[{id:Date.now(),type:'result',date:new Date().toLocaleDateString('ko-KR'),ts:lastResult.ts,text:fullText,short:ansText.slice(0,60)+'...'},...memos];
  localStorage.setItem('memos_v5',JSON.stringify(memos));
  renderMemos();
  showToast('기록 탭에 저장됐어');
}

// ── AI 호출 (Groq) ────────────────────────────────────────
async function callAI(prompt,maxTokens=800,keyOverride=null){
  const key=keyOverride||API_KEY;
  if(!key)throw new Error('API 키가 없어. 설정 탭에서 입력해줘.');
  const res=await fetch('https://api.groq.com/openai/v1/chat/completions',{
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':`Bearer ${key}`},
    body:JSON.stringify({
      model:'llama-3.3-70b-versatile',
      max_tokens:maxTokens,
      temperature:0.7,
      messages:[{role:'system',content:buildSYS()},{role:'user',content:prompt}]
    })
  });
  const d=await res.json();
  if(d.error)throw new Error(d.error.message||JSON.stringify(d.error));
  return d.choices?.[0]?.message?.content||'';
}

// ── 메모 ─────────────────────────────────────────────────
function addMemoFromId(taId){
  const el=document.getElementById(taId);if(!el||!el.value.trim())return;
  memos=[{id:Date.now(),type:'memo',text:el.value.trim(),date:new Date().toLocaleDateString('ko-KR')},...memos];
  localStorage.setItem('memos_v5',JSON.stringify(memos));
  el.value='';renderMemos();showToast('저장됐어');
}
function deleteMemo(id){memos=memos.filter(m=>m.id!==id);localStorage.setItem('memos_v5',JSON.stringify(memos));renderMemos();}
function renderMemos(){
  const el=document.getElementById('memoList');if(!el)return;
  if(memos.length===0){el.innerHTML=`<div class="memo-empty">아직 기록이 없어.<br>오늘 느낀 것 한 줄이라도 남겨두자.</div>`;return;}
  el.innerHTML=memos.map(m=>{
    if(m.type==='result'){
      return `<div class="memo-item result-item">
        <div class="memo-type">저장된 결과지</div>
        <div class="memo-date">${m.ts||m.date}</div>
        <div class="memo-text" id="rt-${m.id}" style="max-height:60px;overflow:hidden">${m.short||m.text.slice(0,80)+'...'}</div>
        <button class="memo-expand-btn" onclick="toggleExpand(${m.id})">전체 보기 ▼</button>
        <button class="memo-del" onclick="deleteMemo(${m.id})">×</button>
      </div>`;
    }
    return `<div class="memo-item">
      <div class="memo-date">${m.date}</div>
      <div class="memo-text">${m.text}</div>
      <button class="memo-del" onclick="deleteMemo(${m.id})">×</button>
    </div>`;
  }).join('');
}
function toggleExpand(id){
  const el=document.getElementById('rt-'+id);
  const m=memos.find(x=>x.id===id);
  if(!el||!m)return;
  const isCollapsed=el.style.maxHeight==='60px';
  el.style.maxHeight=isCollapsed?'none':'60px';
  el.textContent=isCollapsed?m.text:(m.short||m.text.slice(0,80)+'...');
  el.nextElementSibling.textContent=isCollapsed?'접기 ▲':'전체 보기 ▼';
}

// ── 유틸 ─────────────────────────────────────────────────
function esc(s){return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function showToast(msg){
  const el=document.getElementById('toast');
  el.textContent=msg;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),2200);
}
</script>
</body>
</html>
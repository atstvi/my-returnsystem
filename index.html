<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>나의 돌아오는 시스템</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Share+Tech+Mono&family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ════════════════════════════════════════════════════════════
   CYBERPUNK / GLITCH DESIGN SYSTEM
   "High-Tech, Low-Life" — blade runner × hacker terminal
   
   bg:#0a0a0f  accent:#00ff88  secondary:#ff00ff  tertiary:#00d4ff
════════════════════════════════════════════════════════════ */

/* ──────────────────────────────────────────
   DESIGN TOKENS (The DNA)
────────────────────────────────────────── */
:root {
  /* Backgrounds */
  --background:       #0a0a0f;
  --card:             #12121a;
  --muted:            #1c1c2e;
  --muted-2:          #252535;
  --input-bg:         #12121a;

  /* Foregrounds */
  --foreground:       #e0e0e0;
  --foreground-2:     #a0a0b0;
  --foreground-muted: #6b7280;

  /* Borders */
  --border:           #2a2a3a;
  --border-subtle:    rgba(42,42,58,.6);

  /* Neon Accents */
  --accent:           #00ff88;
  --accent-secondary: #ff00ff;
  --accent-tertiary:  #00d4ff;
  --destructive:      #ff3366;
  --warning:          #ffe600;

  /* Semantic aliases (backward compat) */
  --bg:               var(--background);
  --fg:               var(--foreground);
  --fg2:              var(--foreground-2);
  --fg3:              var(--foreground-muted);
  --green:            var(--accent);
  --pink:             var(--accent-secondary);
  --cyan:             var(--accent-tertiary);
  --red:              var(--destructive);
  --yellow:           var(--warning);
  --pk:               var(--accent-secondary);
  --cy:               var(--accent-tertiary);
  --pu:               #a855f7;
  --sur:              var(--card);
  --sur2:             var(--muted);
  --sur3:             var(--muted-2);

  /* Glow Shadows — multi-layer for physical neon effect */
  --glow-sm:    0 0 3px var(--accent), 0 0 6px rgba(0,255,136,.3);
  --glow:       0 0 5px var(--accent), 0 0 10px rgba(0,255,136,.4), 0 0 20px rgba(0,255,136,.2);
  --glow-lg:    0 0 10px var(--accent), 0 0 20px rgba(0,255,136,.6), 0 0 40px rgba(0,255,136,.3);
  --glow-pink:  0 0 5px var(--accent-secondary), 0 0 20px rgba(255,0,255,.6);
  --glow-cyan:  0 0 5px var(--accent-tertiary), 0 0 20px rgba(0,212,255,.6);
  --glow-red:   0 0 5px var(--destructive), 0 0 10px rgba(255,51,102,.4);

  /* Chamfered corners — 10px per spec */
  --chamfer:    polygon(0 10px, 10px 0, calc(100% - 10px) 0, 100% 10px, 100% calc(100% - 10px), calc(100% - 10px) 100%, 10px 100%, 0 calc(100% - 10px));
  --chamfer-sm: polygon(0 6px, 6px 0, calc(100% - 6px) 0, 100% 6px, 100% calc(100% - 6px), calc(100% - 6px) 100%, 6px 100%, 0 calc(100% - 6px));
  --chamfer-xs: polygon(0 4px, 4px 0, calc(100% - 4px) 0, 100% 4px, 100% calc(100% - 4px), calc(100% - 4px) 100%, 4px 100%, 0 calc(100% - 4px));

  /* Transitions — digital/stepped for snappy feel */
  --t-snap: all 100ms steps(4);
  --t-base: all 150ms cubic-bezier(0.4, 0, 0.2, 1);

  /* Typography */
  --font-head:  'Orbitron', 'Share Tech Mono', monospace;
  --font-label: 'Share Tech Mono', monospace;
  --font-mono:  'JetBrains Mono', 'Fira Code', 'Consolas', monospace;

  --radius: 2px;
}

/* ──────────────────────────────────────────
   GLOBAL RESET & BASE
────────────────────────────────────────── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
input, select, textarea, button { font-family: inherit; }

html { scroll-behavior: smooth; }

body {
  font-family: var(--font-mono);
  font-weight: 400;
  background: var(--background);
  color: var(--foreground);
  font-size: 14px;
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
  /* Circuit grid pattern */
  background-image:
    linear-gradient(rgba(0,255,136,.025) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,255,136,.025) 1px, transparent 1px);
  background-size: 50px 50px;
}

/* Scanline overlay — CRT effect */
body::after {
  content: '';
  position: fixed; inset: 0;
  pointer-events: none; z-index: 9997;
  background: repeating-linear-gradient(
    0deg,
    transparent 0px,
    transparent 2px,
    rgba(0,0,0,.28) 2px,
    rgba(0,0,0,.28) 4px
  );
}

/* Global headings */
h1, h2, h3, h4 {
  font-family: var(--font-head);
  text-transform: uppercase;
  letter-spacing: .08em;
}

/* ──────────────────────────────────────────
   LOCK SCREEN
────────────────────────────────────────── */
#lockScreen {
  position: fixed; inset: 0;
  background: var(--background);
  z-index: 9999;
  display: flex; align-items: center; justify-content: center;
  background-image:
    linear-gradient(rgba(0,255,136,.04) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,255,136,.04) 1px, transparent 1px);
  background-size: 40px 40px;
}

.lock-box {
  width: 100%; max-width: 320px;
  padding: 36px 28px;
  text-align: center;
  background: var(--card);
  border: 1px solid var(--accent);
  clip-path: var(--chamfer);
  box-shadow: var(--glow), inset 0 0 40px rgba(0,255,136,.04);
  position: relative;
}

/* Corner bracket decorations */
.lock-box::before, .lock-box::after {
  content: '';
  position: absolute;
  width: 14px; height: 14px;
  border-color: var(--accent); border-style: solid;
}
.lock-box::before { top: 8px; left: 8px; border-width: 1px 0 0 1px; }
.lock-box::after  { bottom: 8px; right: 8px; border-width: 0 1px 1px 0; }

.lock-icon {
  font-size: 28px; margin-bottom: 16px;
  filter: drop-shadow(0 0 12px var(--accent));
}
.lock-title {
  font-family: var(--font-head);
  font-size: 12px; font-weight: 700;
  color: var(--accent);
  letter-spacing: 4px; text-transform: uppercase;
  margin-bottom: 6px;
  text-shadow: var(--glow-sm);
}
.lock-sub {
  font-size: 11px; color: var(--foreground-muted);
  margin-bottom: 24px; line-height: 1.8;
  font-family: var(--font-label); letter-spacing: 1px;
}

/* Input with > prefix */
.lock-inp-wrap { position: relative; margin-bottom: 10px; }
.lock-inp-wrap::before {
  content: '>';
  position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
  color: var(--accent); font-family: var(--font-label);
  font-size: 14px; pointer-events: none;
  text-shadow: var(--glow-sm); z-index: 1;
}
.lock-inp {
  width: 100%; padding: 12px 16px 12px 32px;
  border: 1px solid var(--border);
  background: rgba(0,255,136,.04);
  color: var(--accent); text-align: left; letter-spacing: 8px; font-size: 18px;
  font-family: var(--font-label);
  clip-path: var(--chamfer-xs);
  transition: var(--t-base);
}
.lock-inp:focus {
  outline: none; border-color: var(--accent);
  box-shadow: var(--glow);
}
.lock-btn {
  width: 100%; padding: 13px;
  background: transparent;
  border: 1px solid var(--accent);
  color: var(--accent);
  font-family: var(--font-label); font-size: 11px;
  letter-spacing: 3px; text-transform: uppercase;
  clip-path: var(--chamfer-xs);
  cursor: pointer; transition: var(--t-snap);
}
.lock-btn:hover {
  background: var(--accent); color: var(--background);
  box-shadow: var(--glow-lg);
}
.lock-err {
  font-size: 11px; color: var(--destructive);
  margin-top: 10px; min-height: 18px;
  font-family: var(--font-label); letter-spacing: 1px;
}

/* ──────────────────────────────────────────
   TAB BAR
────────────────────────────────────────── */
.tab-bar {
  display: flex;
  border-bottom: 1px solid var(--border);
  background: rgba(10,10,15,.97);
  position: sticky; top: 0; z-index: 100;
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
}
.tab-btn {
  flex: 1; padding: 13px 2px;
  background: none; border: none;
  border-bottom: 2px solid transparent;
  font-family: var(--font-label); font-size: 9px;
  color: var(--foreground-muted);
  cursor: pointer; transition: var(--t-snap);
  letter-spacing: 2px; text-transform: uppercase;
}
.tab-btn.active {
  border-bottom-color: var(--accent);
  color: var(--accent);
  text-shadow: var(--glow);
}
.tab-btn:hover:not(.active) {
  color: var(--foreground-2);
  border-bottom-color: rgba(0,255,136,.3);
}

/* ──────────────────────────────────────────
   LAYOUT
────────────────────────────────────────── */
.inner       { max-width: 540px; margin: 0 auto; padding-bottom: 80px; }
.inner-wide  { max-width: 1200px; margin: 0 auto; padding: 0 20px 80px; }
.page        { display: none; }
.page.active { display: block; }

/* ──────────────────────────────────────────
   HOME HERO
────────────────────────────────────────── */
.hero {
  padding: 40px 24px 28px;
  border-bottom: 1px solid var(--border);
}

.eyebrow {
  font-family: var(--font-label);
  font-size: 9px; letter-spacing: 5px;
  color: var(--accent-tertiary);
  text-transform: uppercase;
  margin-bottom: 14px;
  display: flex; align-items: center; gap: 8px;
}
.eyebrow::before { content: '>'; color: var(--accent); animation: blink 1s step-end infinite; }

.hero h1 {
  font-family: var(--font-head);
  font-size: 20px; font-weight: 700;
  line-height: 1.5; margin-bottom: 20px;
  color: var(--foreground);
  letter-spacing: .08em;
}

.motto {
  background: rgba(0,255,136,.04);
  border: 1px solid rgba(0,255,136,.2);
  padding: 16px 18px;
  font-size: 13px; color: var(--foreground-2);
  line-height: 2.1;
  clip-path: var(--chamfer-sm);
  position: relative;
}
.motto::before {
  content: 'SYSTEM.MANIFEST';
  font-family: var(--font-label);
  font-size: 8px; letter-spacing: 3px;
  color: var(--accent);
  position: absolute; top: -8px; left: 16px;
  background: var(--background); padding: 0 6px;
}
.motto strong { color: var(--accent); font-weight: 700; }

.sec-lbl {
  font-family: var(--font-label);
  font-size: 9px; letter-spacing: 5px;
  color: var(--accent-tertiary);
  text-transform: uppercase;
  padding: 28px 24px 12px;
  display: flex; align-items: center; gap: 6px;
}
.sec-lbl::before { content: '//'; color: var(--accent); margin-right: 4px; }

/* Philosophy cards */
.phil-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 1px; padding: 0 24px; margin-bottom: 24px;
  background: var(--border);
}
.phil-card {
  background: var(--card); padding: 16px;
  transition: var(--t-base); position: relative; overflow: hidden;
}
.phil-card:hover {
  background: var(--muted);
  box-shadow: inset 0 0 20px rgba(0,255,136,.06);
}
.phil-tag {
  font-family: var(--font-label); font-size: 9px;
  color: var(--accent-tertiary); font-weight: 700;
  margin-bottom: 6px; letter-spacing: 3px; text-transform: uppercase;
}
.phil-title { font-size: 13px; font-weight: 600; color: var(--foreground); margin-bottom: 5px; line-height: 1.4; }
.phil-body  { font-size: 12px; color: var(--foreground-2); line-height: 1.9; }

/* ──────────────────────────────────────────
   BUTTONS
────────────────────────────────────────── */
.start-btn {
  display: block; margin: 0 24px; padding: 15px;
  background: transparent;
  border: 1px solid var(--accent); color: var(--accent);
  font-family: var(--font-label); font-size: 11px;
  letter-spacing: 3px; text-transform: uppercase;
  clip-path: var(--chamfer-sm);
  cursor: pointer; text-align: center;
  width: calc(100% - 48px); transition: var(--t-snap);
}
.start-btn:hover { background: var(--accent); color: var(--background); box-shadow: var(--glow-lg); }

.btn-row { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }

.btn-primary {
  padding: 9px 16px;
  background: var(--accent); border: 1px solid var(--accent); color: var(--background);
  font-family: var(--font-label); font-size: 10px;
  letter-spacing: 2px; text-transform: uppercase;
  clip-path: var(--chamfer-xs); cursor: pointer; font-weight: 700;
  transition: var(--t-snap);
}
.btn-primary:hover { box-shadow: var(--glow-lg); filter: brightness(1.1); }

.btn-secondary {
  padding: 9px 16px;
  background: transparent; border: 1px solid var(--accent-secondary); color: var(--accent-secondary);
  font-family: var(--font-label); font-size: 10px;
  letter-spacing: 2px; text-transform: uppercase;
  clip-path: var(--chamfer-xs); cursor: pointer;
  transition: var(--t-snap);
}
.btn-secondary:hover { background: var(--accent-secondary); color: var(--background); box-shadow: var(--glow-pink); }

.btn-ghost {
  padding: 9px 16px;
  background: none; border: 1px solid var(--border); color: var(--foreground-2);
  font-family: var(--font-label); font-size: 10px;
  letter-spacing: 2px; text-transform: uppercase;
  clip-path: var(--chamfer-xs); cursor: pointer;
  transition: var(--t-snap);
}
.btn-ghost:hover { border-color: var(--accent); color: var(--accent); }

.btn-danger-outline {
  padding: 9px 16px;
  background: none; border: 1px solid var(--destructive); color: var(--destructive);
  font-family: var(--font-label); font-size: 10px;
  letter-spacing: 2px; text-transform: uppercase;
  clip-path: var(--chamfer-xs); cursor: pointer;
  transition: var(--t-snap);
}
.btn-danger-outline:hover { background: var(--destructive); color: #fff; }

/* ──────────────────────────────────────────
   INPUTS (with > prefix)
────────────────────────────────────────── */
.input-wrap { position: relative; }
.input-wrap::before {
  content: '>';
  position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
  color: var(--accent); font-family: var(--font-label);
  font-size: 12px; pointer-events: none;
  text-shadow: var(--glow-sm); z-index: 1;
}
.input-wrap input,
.input-wrap textarea {
  padding-left: 28px;
}

/* Base input style */
.setting-inp, .nds-inp, .ws-inp {
  width: 100%;
  padding: 9px 12px 9px 28px;
  border: 1px solid var(--border);
  background: var(--input-bg); color: var(--foreground);
  font-family: var(--font-mono); font-size: 13px;
  clip-path: var(--chamfer-xs);
  transition: var(--t-base);
}
.setting-inp:focus, .nds-inp:focus, .ws-inp:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: var(--glow);
}
.setting-inp::placeholder, .nds-inp::placeholder, .ws-inp::placeholder { color: var(--foreground-muted); }

.setting-ta, .nds-ta, .ws-ta {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--border);
  background: var(--input-bg); color: var(--foreground);
  font-family: var(--font-mono); font-size: 13px;
  resize: none; line-height: 1.8;
  clip-path: var(--chamfer-sm);
  transition: var(--t-base);
}
.setting-ta:focus, .nds-ta:focus { outline: none; border-color: var(--accent); }

textarea {
  width: 100%;
  background: var(--card); border: 1px solid var(--border);
  color: var(--foreground);
  font-family: var(--font-mono); font-size: 13px;
  padding: 12px 15px; resize: none; min-height: 110px;
  line-height: 1.9;
  clip-path: var(--chamfer-sm);
  transition: var(--t-base);
}
textarea:focus { outline: none; border-color: var(--accent); box-shadow: var(--glow); }

/* ──────────────────────────────────────────
   PRECHECK
────────────────────────────────────────── */
.precheck-wrap { max-width: 540px; margin: 0 auto; padding: 32px 24px 80px; }
.precheck-title {
  font-family: var(--font-head); font-size: 17px; font-weight: 700;
  margin-bottom: 6px; color: var(--foreground);
  text-transform: uppercase; letter-spacing: .08em;
}
.precheck-sub { font-size: 13px; color: var(--foreground-muted); line-height: 1.75; margin-bottom: 28px; }
.precheck-section { margin-bottom: 20px; }
.precheck-lbl {
  font-family: var(--font-label); font-size: 9px; letter-spacing: 4px;
  color: var(--accent-tertiary); text-transform: uppercase; font-weight: 700;
  margin-bottom: 10px;
  display: flex; align-items: center; gap: 6px;
}
.precheck-lbl::before { content: '>'; color: var(--accent); }
.precheck-lbl-sub { font-size: 12px; color: var(--foreground-muted); margin-bottom: 8px; line-height: 1.6; }

.task-list { display: flex; flex-direction: column; gap: 6px; margin-bottom: 8px; }
.task-item {
  display: flex; align-items: center; gap: 8px;
  background: var(--card); border: 1px solid var(--border);
  padding: 9px 12px; clip-path: var(--chamfer-xs);
}
.task-item input[type=text] {
  flex: 1; border: none; background: transparent;
  font-family: var(--font-mono); font-size: 13px; color: var(--foreground); outline: none;
}
.task-item input[type=text]::placeholder { color: var(--foreground-muted); }
.task-urgency {
  padding: 3px 8px; border: 1px solid var(--border);
  font-family: var(--font-label); font-size: 9px; letter-spacing: 1px;
  background: var(--background); color: var(--foreground-2); cursor: pointer;
  clip-path: var(--chamfer-xs); transition: var(--t-snap);
}
.task-urgency:hover { border-color: var(--accent); color: var(--accent); }
.task-del { background: none; border: none; color: var(--foreground-muted); font-size: 14px; cursor: pointer; padding: 0 2px; transition: color .15s; }
.task-del:hover { color: var(--destructive); }
.task-add-btn {
  padding: 7px 14px;
  background: rgba(0,255,136,.06); border: 1px solid rgba(0,255,136,.3); color: var(--accent);
  font-family: var(--font-label); font-size: 10px; letter-spacing: 1px;
  clip-path: var(--chamfer-xs); cursor: pointer; transition: var(--t-snap);
}
.task-add-btn:hover { background: rgba(0,255,136,.12); }
.precheck-skip { font-size: 11px; color: var(--foreground-muted); text-align: center; margin-top: 16px; cursor: pointer; text-decoration: underline; }

.schedule-block { margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); }
.schedule-lbl   { font-family: var(--font-label); font-size: 9px; color: var(--foreground-muted); margin-bottom: 6px; letter-spacing: 3px; text-transform: uppercase; }
.schedule-item  { display: flex; align-items: flex-start; gap: 7px; margin-bottom: 5px; font-size: 13px; color: var(--foreground-2); line-height: 1.6; }

.urgency-badge  { font-family: var(--font-label); font-size: 9px; padding: 1px 7px; flex-shrink: 0; margin-top: 2px; letter-spacing: 1px; }
.urgency-badge.high { background: rgba(255,51,102,.12); color: var(--destructive); border: 1px solid rgba(255,51,102,.3); }
.urgency-badge.mid  { background: rgba(255,230,0,.08);  color: var(--warning);     border: 1px solid rgba(255,230,0,.25); }
.urgency-badge.low  { background: rgba(0,255,136,.07);  color: var(--accent);      border: 1px solid rgba(0,255,136,.2); }

/* ──────────────────────────────────────────
   CHECK-IN QUESTIONS
────────────────────────────────────────── */
.q-header { padding: 24px 24px 0; }
.prog-row { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; }
.prog-bar { flex: 1; height: 2px; background: rgba(0,255,136,.1); overflow: hidden; }
.prog-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), var(--accent-tertiary));
  transition: width .4s steps(10);
  box-shadow: var(--glow);
}
.prog-lbl { font-family: var(--font-label); font-size: 10px; color: var(--foreground-muted); white-space: nowrap; letter-spacing: 2px; }

.q-cat {
  font-family: var(--font-label); font-size: 9px; color: var(--accent-tertiary);
  letter-spacing: 4px; text-transform: uppercase; margin-bottom: 8px; font-weight: 700;
  display: flex; align-items: center; gap: 4px;
}
.q-cat::before { content: '['; color: var(--accent); }
.q-cat::after  { content: ']'; color: var(--accent); }

.q-text {
  font-family: var(--font-head); font-size: 17px; font-weight: 600;
  line-height: 1.5; margin-bottom: 8px; color: var(--foreground);
  text-transform: uppercase; letter-spacing: .06em;
}
.q-sub { font-size: 12px; color: var(--foreground-muted); line-height: 1.9; margin-bottom: 20px; }

.opts { padding: 0 24px; display: flex; flex-direction: column; gap: 7px; margin-bottom: 12px; }
.opt-btn {
  padding: 11px 16px;
  background: var(--card); border: 1px solid var(--border);
  color: var(--foreground-2);
  font-family: var(--font-mono); font-size: 13px;
  cursor: pointer; clip-path: var(--chamfer-xs); text-align: left;
  transition: var(--t-snap);
}
.opt-btn:hover  { border-color: rgba(0,255,136,.5); color: var(--foreground); }
.opt-btn.selected {
  background: rgba(0,255,136,.07); border-color: var(--accent);
  color: var(--accent); font-weight: 500;
  box-shadow: inset 0 0 20px rgba(0,255,136,.05), var(--glow);
}

.ta-wrap { padding: 0 24px; margin-bottom: 12px; }

.insight-box { margin: 0 24px 14px; border: 1px solid rgba(0,212,255,.25); overflow: hidden; clip-path: var(--chamfer-sm); }
.insight-row { display: flex; }
.insight-tag {
  background: rgba(0,212,255,.06); padding: 12px 13px;
  font-family: var(--font-label); font-size: 9px; color: var(--accent-tertiary);
  font-weight: 700; letter-spacing: 3px; text-transform: uppercase;
  white-space: nowrap;
  border-right: 1px solid rgba(0,212,255,.2);
  display: flex; align-items: center; writing-mode: vertical-rl;
}
.insight-txt { padding: 12px 14px; font-size: 13px; color: var(--foreground-2); line-height: 1.9; flex: 1; }

.nav-row { display: flex; gap: 10px; padding: 14px 24px 0; }
.btn-next {
  flex: 1; padding: 14px;
  background: var(--accent); border: 1px solid var(--accent); color: var(--background);
  font-family: var(--font-label); font-size: 11px;
  letter-spacing: 3px; text-transform: uppercase;
  clip-path: var(--chamfer-sm); cursor: pointer; font-weight: 700;
  transition: var(--t-snap); box-shadow: var(--glow);
}
.btn-next:hover { filter: brightness(1.1); box-shadow: var(--glow-lg); }
.btn-next:disabled { opacity: .2; cursor: not-allowed; box-shadow: none; }

.btn-back {
  padding: 14px 18px;
  background: transparent; border: 1px solid var(--border);
  color: var(--foreground-muted);
  font-family: var(--font-label); font-size: 11px;
  letter-spacing: 2px; text-transform: uppercase;
  clip-path: var(--chamfer-sm); cursor: pointer; transition: var(--t-snap);
}
.btn-back:hover { border-color: var(--foreground-2); color: var(--foreground-2); }

/* ──────────────────────────────────────────
   LOADING
────────────────────────────────────────── */
.loading-wrap { padding: 70px 24px; text-align: center; }
.spinner {
  width: 20px; height: 20px;
  border: 2px solid rgba(0,255,136,.15);
  border-top-color: var(--accent); border-radius: 50%;
  animation: spin .6s linear infinite;
  margin: 0 auto 14px; box-shadow: var(--glow);
}
.loading-txt {
  font-family: var(--font-label); font-size: 11px;
  color: var(--foreground-muted); line-height: 1.9; letter-spacing: 2px;
}
.loading-txt::after { content: '_'; color: var(--accent); animation: blink 1s step-end infinite; }

/* ──────────────────────────────────────────
   RESULT SCREEN
────────────────────────────────────────── */
.res-header { padding: 20px 24px 14px; border-bottom: 1px solid var(--border); }
.res-header h2, .res-title, .result-title {
  font-family: var(--font-head); font-size: 16px; font-weight: 700;
  margin-bottom: 4px; color: var(--accent);
  text-transform: uppercase; letter-spacing: .1em;
  text-shadow: var(--glow);
}
.res-time { font-family: var(--font-label); font-size: 10px; color: var(--foreground-muted); letter-spacing: 2px; }

.save-result-btn {
  margin-top: 10px; padding: 7px 16px;
  background: transparent; border: 1px solid var(--accent); color: var(--accent);
  font-family: var(--font-label); font-size: 9px; letter-spacing: 3px; text-transform: uppercase;
  clip-path: var(--chamfer-xs); cursor: pointer; transition: var(--t-snap);
}
.save-result-btn:hover { background: var(--accent); color: var(--background); box-shadow: var(--glow); }

.res-grid { display: grid; grid-template-columns: 1fr 1.4fr 1fr; min-height: calc(100vh - 200px); }
@media(max-width:760px) { .res-grid { grid-template-columns: 1fr; } }
.res-col { border-right: 1px solid var(--border); overflow-y: auto; padding: 16px; }
.res-col:last-child { border-right: none; }
.res-col-head { padding-bottom: 10px; margin-bottom: 12px; border-bottom: 1px solid var(--border); }
.res-col-title { font-family: var(--font-label); font-size: 9px; letter-spacing: 4px; color: var(--accent-tertiary); text-transform: uppercase; margin-bottom: 14px; font-weight: 700; }
.res-col-body  { font-size: 13px; color: var(--foreground-2); line-height: 1.8; }

.ans-item { padding: 8px 0; border-bottom: 1px solid rgba(0,255,136,.07); }
.ans-item:last-child { border-bottom: none; }
.ans-q    { font-family: var(--font-label); font-size: 10px; color: var(--foreground-muted); margin-bottom: 4px; letter-spacing: 1px; }
.ans-dot-row { display: flex; gap: 4px; margin-bottom: 3px; }
.dot    { width: 7px; height: 7px; background: var(--border); }
.dot.ok { background: var(--accent); box-shadow: 0 0 5px rgba(0,255,136,.8); }
.ans-v  { font-size: 13px; color: var(--foreground); line-height: 1.6; }

.analysis-txt { font-size: 13px; color: var(--foreground-2); line-height: 1.9; }

/* Action cards — terminal variant */
.act-card {
  background: var(--card); border: 1px solid var(--border);
  clip-path: var(--chamfer-xs); padding: 13px 15px; margin-bottom: 8px;
  position: relative;
}
.act-card::before {
  content: ''; display: block;
  height: 3px; margin: -13px -15px 10px;
  background: linear-gradient(90deg, var(--accent) 0%, var(--accent-tertiary) 100%);
  opacity: .15;
}
.act-card:last-child { margin-bottom: 0; }
.act-step {
  font-family: var(--font-label); font-size: 8px; letter-spacing: 3px; text-transform: uppercase;
  font-weight: 700; margin-bottom: 5px; padding: 2px 8px; display: inline-block;
}
.act-step.s1 { background: rgba(0,255,136,.1);  color: var(--accent);           border: 1px solid rgba(0,255,136,.3); }
.act-step.s2 { background: rgba(255,0,255,.08); color: var(--accent-secondary); border: 1px solid rgba(255,0,255,.25); }
.act-step.s3 { background: rgba(0,212,255,.08); color: var(--accent-tertiary);  border: 1px solid rgba(0,212,255,.25); }
.act-title  { font-size: 13px; font-weight: 600; color: var(--foreground); margin-bottom: 4px; line-height: 1.4; }
.act-logic  { font-size: 12px; color: var(--foreground-2); line-height: 1.7; margin-bottom: 6px; }
.act-how    { font-size: 12px; color: var(--accent-tertiary); line-height: 1.7; }

.thought-item { padding: 8px 0; border-bottom: 1px solid rgba(0,212,255,.08); }
.thought-item:last-child { border-bottom: none; }
.thought-tag    { font-family: var(--font-label); font-size: 9px; color: var(--accent-tertiary); font-weight: 700; margin-bottom: 3px; letter-spacing: 2px; }
.thought-txt    { font-size: 13px; color: var(--foreground); line-height: 1.7; }
.thought-origin { font-size: 11px; color: var(--foreground-muted); margin-top: 3px; }

.res-bottom      { padding: 20px 24px; border-top: 1px solid var(--border); }
.memo-save-area  { margin-bottom: 16px; }
.memo-save-lbl   { font-family: var(--font-label); font-size: 9px; letter-spacing: 3px; color: var(--accent-tertiary); margin-bottom: 6px; }
.memo-save-sub   { font-size: 12px; color: var(--foreground-muted); margin-bottom: 10px; line-height: 1.6; }
.save-m-btn {
  padding: 8px 16px; background: transparent;
  border: 1px solid var(--accent-tertiary); color: var(--accent-tertiary);
  font-family: var(--font-label); font-size: 9px; letter-spacing: 3px; text-transform: uppercase;
  clip-path: var(--chamfer-xs); cursor: pointer; transition: var(--t-snap);
}
.save-m-btn:hover { background: var(--accent-tertiary); color: var(--background); box-shadow: var(--glow-cyan); }

.final-box {
  background: var(--card); border: 1px solid var(--border);
  clip-path: var(--chamfer-sm); padding: 16px 18px; margin-bottom: 16px;
}
.final-box p      { font-size: 13px; color: var(--foreground-2); line-height: 1.9; }
.final-box strong { color: var(--accent); font-weight: 700; }

.restart-btn {
  display: block; padding: 12px;
  background: transparent; border: 1px solid var(--border);
  color: var(--foreground-muted);
  font-family: var(--font-label); font-size: 10px; letter-spacing: 2px;
  cursor: pointer; clip-path: var(--chamfer-sm); text-align: center; width: 100%;
  transition: var(--t-snap);
}
.restart-btn:hover { border-color: var(--accent); color: var(--accent); }

/* ──────────────────────────────────────────
   MEMO / RECORDS
────────────────────────────────────────── */
.memo-h { padding: 20px 24px 12px; }
.memo-h h2 { font-family: var(--font-head); font-size: 16px; font-weight: 700; color: var(--foreground); margin-bottom: 4px; }
.memo-sub  { font-size: 12px; color: var(--foreground-muted); line-height: 1.7; }

.memo-add     { padding: 0 24px; margin-bottom: 8px; }
.memo-add-btn {
  display: block; width: 100%; padding: 10px;
  border: 1px dashed rgba(0,255,136,.25); background: transparent;
  color: var(--foreground-muted); font-family: var(--font-mono); font-size: 13px;
  clip-path: var(--chamfer-xs); cursor: pointer; transition: var(--t-snap); text-align: center;
}
.memo-add-btn:hover { border-color: var(--accent); color: var(--accent); }

.memo-list  { padding: 0 24px; display: flex; flex-direction: column; gap: 1px; background: var(--border); }
.memo-empty { padding: 40px 24px; text-align: center; font-size: 12px; color: var(--foreground-muted); line-height: 1.9; font-family: var(--font-label); }

.memo-item {
  background: var(--card); padding: 11px 14px;
  display: flex; align-items: flex-start; gap: 10px;
  cursor: pointer; transition: var(--t-snap);
}
.memo-item:hover        { background: var(--muted); }
.memo-item.result-item  { border-left: 2px solid rgba(0,212,255,.4); }
.memo-date { font-family: var(--font-label); font-size: 10px; color: var(--foreground-muted); white-space: nowrap; margin-top: 2px; }
.memo-type { font-family: var(--font-label); font-size: 9px; padding: 2px 6px; font-weight: 700; letter-spacing: 2px; }
.memo-text { font-size: 13px; color: var(--foreground-2); flex: 1; line-height: 1.5; min-width: 0; }
.memo-del  { background: none; border: none; color: var(--foreground-muted); font-size: 16px; cursor: pointer; padding: 0; flex-shrink: 0; transition: color .15s; }
.memo-del:hover   { color: var(--destructive); }
.memo-expand-btn  { background: none; border: none; color: var(--accent-tertiary); font-size: 11px; cursor: pointer; padding: 0; font-family: var(--font-label); }

.seg-ctrl { display: flex; gap: 1px; padding: 0 24px 16px; }
.seg-btn {
  flex: 1; padding: 7px;
  background: var(--card); border: none;
  font-family: var(--font-label); font-size: 9px; color: var(--foreground-muted);
  cursor: pointer; transition: var(--t-snap);
  letter-spacing: 2px; text-transform: uppercase;
  border-bottom: 2px solid transparent;
}
.seg-btn.active  { background: var(--muted); border-bottom-color: var(--accent); color: var(--accent); }
.seg-btn:hover:not(.active) { color: var(--foreground-2); border-bottom-color: rgba(0,255,136,.3); }
.seg-panel        { display: none; }
.seg-panel.active { display: block; }

/* ──────────────────────────────────────────
   SETTINGS
────────────────────────────────────────── */
.settings-wrap { padding: 24px; }
.settings-title {
  font-family: var(--font-head); font-size: 16px; font-weight: 700;
  margin-bottom: 6px; color: var(--accent); letter-spacing: .1em;
  text-transform: uppercase; text-shadow: var(--glow);
}
.settings-sub { font-size: 12px; color: var(--foreground-muted); line-height: 1.7; margin-bottom: 24px; }

/* Terminal card style for settings sections */
.set-section { margin-bottom: 2px; position: relative; }
.set-section-head {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0; cursor: pointer;
  border: 1px solid var(--border); border-bottom: none;
  transition: var(--t-snap); overflow: hidden;
}
/* Traffic light terminal bar */
.set-section-head::before {
  content: '● ● ●';
  font-size: 7px; letter-spacing: 3px;
  padding: 6px 10px;
  background: var(--muted); color: transparent;
  text-shadow: 0 0 0 #ff3366, 14px 0 0 var(--warning), 28px 0 0 var(--accent);
  border-right: 1px solid var(--border);
  flex-shrink: 0; white-space: nowrap;
}
.set-section-head:hover { background: rgba(0,255,136,.03); border-color: rgba(0,255,136,.3); }
.set-section-title {
  font-family: var(--font-label); font-size: 11px; font-weight: 500; color: var(--foreground);
  letter-spacing: 2px; padding: 11px 14px; flex: 1;
}
.set-section-arrow { font-size: 10px; color: var(--foreground-muted); transition: transform .15s; font-family: var(--font-mono); padding-right: 14px; }
.set-section-arrow.open { transform: rotate(180deg); }
.set-section-body {
  display: none; padding: 16px;
  border: 1px solid var(--border); border-top: none;
  background: rgba(18,18,26,.9);
}
.set-section-body.open { display: block; }

.setting-lbl { font-family: var(--font-label); font-size: 10px; color: var(--foreground-2); font-weight: 600; margin-bottom: 6px; margin-top: 14px; letter-spacing: 2px; }
.setting-lbl:first-child { margin-top: 0; }

/* setting-inp — inside .input-wrap so left-pad handled by parent */
.setting-inp { padding: 9px 12px 9px 28px; }

.setting-hint   { font-size: 12px; color: var(--foreground-muted); margin-top: 5px; line-height: 1.6; }
.setting-hint a { color: var(--accent-tertiary); text-decoration: none; }
.setting-hint a:hover { text-decoration: underline; }

.api-status { display: flex; align-items: center; gap: 8px; margin: 10px 0; font-family: var(--font-label); font-size: 12px; color: var(--foreground-2); }
.status-dot { width: 6px; height: 6px; background: var(--foreground-muted); }
.status-dot.ok { background: var(--accent); box-shadow: 0 0 6px rgba(0,255,136,.8); }

.test-result     { font-family: var(--font-label); font-size: 12px; margin-top: 8px; padding: 8px 12px; }
.test-result.ok  { background: rgba(0,255,136,.07); color: var(--accent); border: 1px solid rgba(0,255,136,.25); }
.divider         { height: 1px; background: var(--border); margin: 14px 0; }
.add-item-btn {
  display: block; width: 100%; padding: 9px;
  border: 1px dashed rgba(0,255,136,.25); background: transparent;
  color: var(--foreground-muted); font-family: var(--font-mono); font-size: 13px;
  cursor: pointer; transition: var(--t-snap); text-align: center;
}
.add-item-btn:hover { border-color: var(--accent); color: var(--accent); }

.phil-edit-item, .q-edit-item { background: var(--muted); border: 1px solid var(--border); padding: 12px; margin-bottom: 8px; }
.phil-edit-row,  .q-edit-row  { display: flex; gap: 8px; margin-bottom: 6px; align-items: center; }
.phil-edit-tag, .phil-edit-title, .phil-edit-body,
.q-edit-cat, .q-edit-text, .q-edit-sub {
  width: 100%; padding: 7px 10px;
  border: 1px solid var(--border); background: var(--background); color: var(--foreground);
  font-family: var(--font-mono); font-size: 12px; outline: none; transition: border-color .15s;
}
.phil-edit-tag:focus, .phil-edit-title:focus, .phil-edit-body:focus,
.q-edit-cat:focus, .q-edit-text:focus, .q-edit-sub:focus { border-color: var(--accent); }
.phil-edit-del, .q-edit-del { background: none; border: none; color: var(--foreground-muted); font-size: 16px; cursor: pointer; padding: 0 4px; transition: color .15s; }
.phil-edit-del:hover, .q-edit-del:hover { color: var(--destructive); }
.sel { padding: 4px 10px; border: 1px solid var(--border); background: var(--background); color: var(--foreground); font-family: var(--font-mono); font-size: 13px; outline: none; }
.export-import-row { display: flex; gap: 8px; flex-wrap: wrap; }

/* Firebase login */
.fb-login-btn {
  display: flex; align-items: center; gap: 10px; padding: 10px 16px;
  background: var(--muted); border: 1px solid var(--border);
  cursor: pointer; font-family: var(--font-label); font-size: 11px; color: var(--foreground);
  transition: var(--t-snap); width: 100%; letter-spacing: 1px;
}
.fb-login-btn:hover { border-color: rgba(0,255,136,.4); background: rgba(0,255,136,.04); }
.fb-login-btn svg   { flex-shrink: 0; }

/* ──────────────────────────────────────────
   SYNC BAR / TOAST
────────────────────────────────────────── */
.sync-bar {
  display: flex; align-items: center; gap: 8px;
  padding: 5px 16px;
  background: rgba(0,255,136,.03); border-bottom: 1px solid var(--border);
  font-family: var(--font-label); font-size: 9px; color: var(--foreground-muted); letter-spacing: 2px;
}
.sync-dot           { width: 6px; height: 6px; background: var(--foreground-muted); }
.sync-dot.connected, .sync-dot.ok { background: var(--accent); box-shadow: 0 0 6px rgba(0,255,136,.8); }
.sync-dot.syncing   { background: var(--warning); animation: pulse 1s infinite; }
.sync-dot.error     { background: var(--destructive); }
.firebase-user      { margin-left: auto; font-size: 10px; color: var(--foreground-muted); }

.toast {
  position: fixed; bottom: 24px; left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--card); color: var(--accent);
  border: 1px solid rgba(0,255,136,.4);
  padding: 8px 20px;
  font-family: var(--font-label); font-size: 11px; letter-spacing: 2px;
  opacity: 0; transition: all .2s steps(4);
  pointer-events: none; z-index: 9999; white-space: nowrap;
  box-shadow: var(--glow); clip-path: var(--chamfer-xs);
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* ──────────────────────────────────────────
   MODAL (bottom sheet)
────────────────────────────────────────── */
.nds-modal {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.85); z-index: 1000;
  display: flex; align-items: flex-end; justify-content: center;
  backdrop-filter: blur(8px);
}
.nds-modal-box {
  background: var(--card);
  border-top: 1px solid rgba(0,255,136,.35);
  border-left: 1px solid var(--border); border-right: 1px solid var(--border);
  padding: 0 0 40px; width: 100%; max-width: 540px;
  box-shadow: 0 -4px 40px rgba(0,0,0,.8), var(--glow);
  animation: slideUp .2s steps(6);
}
/* Terminal header on modal */
.nds-modal-box::before {
  content: '● ● ●';
  display: block; padding: 7px 14px;
  font-size: 7px; letter-spacing: 3px;
  background: var(--muted); border-bottom: 1px solid var(--border);
  color: transparent;
  text-shadow: 0 0 0 #ff3366, 14px 0 0 var(--warning), 28px 0 0 var(--accent);
}
.nds-modal-handle { display: none; } /* replaced by terminal header */
.nds-modal-inner  { padding: 16px 20px 0; }
.nds-modal-title  {
  font-family: var(--font-head); font-size: 13px; font-weight: 700;
  color: var(--accent); margin-bottom: 16px; letter-spacing: 2px; text-transform: uppercase;
  text-shadow: var(--glow-sm);
}

.nds-field       { margin-bottom: 14px; }
.nds-field-label { font-family: var(--font-label); font-size: 9px; color: var(--foreground-2); font-weight: 600; margin-bottom: 6px; letter-spacing: 2px; }

.nds-inp  { padding: 10px 12px; }
.nds-inp::placeholder { color: var(--foreground-muted); }
.nds-ta   { min-height: 80px; }

.nds-file-btn {
  padding: 8px 14px; background: transparent;
  border: 1px solid var(--border); color: var(--foreground-2);
  font-family: var(--font-label); font-size: 10px;
  clip-path: var(--chamfer-xs); cursor: pointer; transition: var(--t-snap);
}
.nds-file-btn:hover { border-color: var(--accent); color: var(--accent); }

.nds-btn-row { display: flex; gap: 8px; margin-top: 16px; }
.nds-btn-primary {
  flex: 1; padding: 12px;
  background: var(--accent); border: 1px solid var(--accent); color: var(--background);
  font-family: var(--font-label); font-size: 10px; letter-spacing: 2px; text-transform: uppercase;
  clip-path: var(--chamfer-xs); cursor: pointer; font-weight: 700; transition: var(--t-snap);
}
.nds-btn-primary:hover { box-shadow: var(--glow-lg); filter: brightness(1.1); }
.nds-btn-primary.charge { background: var(--accent-tertiary); border-color: var(--accent-tertiary); }
.nds-btn-primary.drain  { background: var(--destructive);     border-color: var(--destructive); }

.nds-btn-ghost {
  flex: 1; padding: 12px; background: none;
  border: 1px solid var(--border); color: var(--foreground-muted);
  font-family: var(--font-label); font-size: 10px; letter-spacing: 1px; text-transform: uppercase;
  clip-path: var(--chamfer-xs); cursor: pointer; transition: var(--t-snap);
}
.nds-btn-ghost:hover { border-color: rgba(0,255,136,.3); color: var(--foreground-2); }

.nds-btn-danger {
  flex: 1; padding: 12px; background: none;
  border: 1px solid var(--destructive); color: var(--destructive);
  font-family: var(--font-label); font-size: 10px;
  clip-path: var(--chamfer-xs); cursor: pointer; transition: var(--t-snap);
}
.nds-btn-danger:hover { background: var(--destructive); color: #fff; }
.nds-photo-preview { max-width: 100%; margin-top: 8px; border: 1px solid var(--border); }

/* ──────────────────────────────────────────
   ME TAB — PROFILE HEADER
────────────────────────────────────────── */
.me-header {
  background: linear-gradient(160deg, var(--background) 0%, #0d0d1a 60%, var(--background) 100%);
  padding: 20px 24px 18px; border-bottom: 1px solid var(--border);
  position: relative; overflow: hidden;
}
/* Ghost watermark */
.me-header::before {
  content: 'SYSTEM ONLINE';
  position: absolute; right: -20px; top: 50%; transform: translateY(-50%) rotate(90deg);
  font-family: var(--font-label); font-size: 8px; letter-spacing: 6px;
  color: rgba(0,255,136,.05); pointer-events: none; white-space: nowrap;
}
.me-header-inner { max-width: 1400px; margin: 0 auto; display: flex; align-items: center; gap: 20px; }
.me-avatar-zone  { position: relative; flex-shrink: 0; }
.me-avatar-ring  {
  width: 84px; height: 84px;
  background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
  padding: 2px; cursor: pointer;
  clip-path: var(--chamfer);
  box-shadow: var(--glow-lg), var(--glow-pink);
}
.me-avatar-ring canvas, .me-avatar-ring img {
  display: block; width: 100%; height: 100%;
  clip-path: var(--chamfer);
}
.me-level {
  position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%);
  background: var(--accent); color: var(--background);
  font-family: var(--font-label); font-size: 8px; font-weight: 700;
  letter-spacing: 2px; padding: 2px 8px; white-space: nowrap;
  box-shadow: var(--glow);
}
.me-identity { flex: 1; min-width: 0; }
.me-class {
  display: inline-block; font-family: var(--font-label); font-size: 9px;
  letter-spacing: 4px; text-transform: uppercase; color: var(--accent-tertiary);
  border: 1px solid rgba(0,212,255,.3); padding: 2px 10px; margin-bottom: 6px;
}
.me-name-inp {
  display: block; width: 100%;
  background: transparent; border: none; border-bottom: 1px solid transparent; outline: none;
  font-family: var(--font-head); font-size: 18px; color: var(--foreground);
  margin-bottom: 2px; letter-spacing: .06em; text-transform: uppercase;
  transition: border-color .15s;
}
.me-name-inp::placeholder { color: rgba(224,224,224,.1); }
.me-name-inp:focus { border-bottom-color: rgba(0,255,136,.5); }
.me-tagline-inp {
  display: block; width: 100%;
  background: transparent; border: none; border-bottom: 1px solid transparent; outline: none;
  font-family: var(--font-mono); font-size: 12px; color: var(--foreground-muted);
  resize: none; line-height: 1.5; transition: border-color .15s;
}
.me-tagline-inp:focus { border-bottom-color: rgba(0,212,255,.3); }
.me-stat-row  { display: flex; gap: 20px; margin-top: 12px; }
.me-stat      { display: flex; flex-direction: column; align-items: center; }
.me-stat-v    { font-family: var(--font-head); font-size: 16px; font-weight: 700; color: var(--accent); line-height: 1; text-shadow: var(--glow-sm); }
.me-stat-l    { font-family: var(--font-label); font-size: 8px; letter-spacing: 3px; text-transform: uppercase; color: var(--foreground-muted); margin-top: 2px; }
.me-check-btn {
  padding: 10px 18px;
  background: transparent; border: 1px solid var(--accent); color: var(--accent);
  font-family: var(--font-label); font-size: 9px; font-weight: 700;
  letter-spacing: 3px; text-transform: uppercase;
  clip-path: var(--chamfer-sm); cursor: pointer; flex-shrink: 0; transition: var(--t-snap);
}
.me-check-btn:hover { background: var(--accent); color: var(--background); box-shadow: var(--glow-lg); }

/* ──────────────────────────────────────────
   ME GRID
────────────────────────────────────────── */
.me-grid { display: grid; grid-template-columns: 1fr 1.4fr 1fr; grid-template-rows: auto calc(100vh - 380px) auto; gap: 0; }
@media(max-width:900px) { .me-grid { grid-template-columns: 1fr 1fr; grid-template-rows: auto; } }
@media(max-width:560px) { .me-grid { grid-template-columns: 1fr; } }

.me-card { border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); overflow: hidden; display: flex; flex-direction: column; min-height: 0; }
.me-card:last-child, .me-phil-card { border-right: none; }
.me-card-head {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0; flex-shrink: 0;
  background: rgba(0,255,136,.04); border-bottom: 1px solid var(--border);
}
/* Terminal traffic-light strip on card heads */
.me-card-head::before {
  content: '● ● ●';
  font-size: 6px; letter-spacing: 2px;
  padding: 8px 10px;
  background: rgba(0,0,0,.3); color: transparent;
  text-shadow: 0 0 0 #ff3366, 10px 0 0 var(--warning), 20px 0 0 var(--accent);
  border-right: 1px solid var(--border);
  flex-shrink: 0; white-space: nowrap;
}
.me-card-head > span:first-of-type {
  font-family: var(--font-label); font-size: 9px; font-weight: 700;
  color: var(--accent); letter-spacing: 3px; text-transform: uppercase;
  padding: 8px 10px; flex: 1;
}
.me-card-action {
  background: none; border: 1px solid rgba(0,212,255,.3); color: var(--accent-tertiary);
  font-family: var(--font-label); font-size: 9px; padding: 3px 9px;
  letter-spacing: 1px; cursor: pointer; transition: var(--t-snap);
  margin: 4px 8px;
}
.me-card-action:hover { border-color: var(--accent-tertiary); background: rgba(0,212,255,.08); box-shadow: var(--glow-cyan); }

.me-rpg-card    { grid-column: 1/-1; border-bottom: 1px solid var(--border); border-right: none; }
.me-charge-card { grid-column: 1/-1; border-bottom: 1px solid var(--border); border-right: none; }
.me-phil-card   { grid-column: 1/-1; border-bottom: none; overflow: visible; }

.me-phil-mini-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1px; padding: 12px 14px; background: var(--border); }
.me-phil-mini     { padding: 10px 13px; background: var(--card); }
.me-phil-mini-tag   { font-family: var(--font-label); font-size: 9px; letter-spacing: 3px; text-transform: uppercase; color: var(--accent-tertiary); font-weight: 700; margin-bottom: 3px; }
.me-phil-mini-title { font-size: 12px; font-weight: 600; color: var(--foreground); margin-bottom: 4px; line-height: 1.4; }
.me-phil-mini-body  { font-size: 12px; color: var(--foreground-2); line-height: 1.7; }

/* Today charge chips */
.charge-chip {
  display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px;
  font-family: var(--font-label); font-size: 10px; letter-spacing: 1px;
  background: rgba(0,255,136,.06); border: 1px solid rgba(0,255,136,.25); color: var(--accent);
}
.charge-chip.done { background: rgba(0,212,255,.06); border-color: rgba(0,212,255,.25); color: var(--accent-tertiary); }
.charge-chip-del  { background: none; border: none; font-size: 13px; color: var(--foreground-muted); cursor: pointer; padding: 0; margin-left: 2px; line-height: 1; }
.charge-list-btn {
  padding: 4px 10px; border: 1px solid var(--border); background: var(--card);
  font-family: var(--font-label); font-size: 10px; color: var(--foreground-muted);
  cursor: pointer; transition: var(--t-snap); letter-spacing: 1px;
}
.charge-list-btn:hover { background: rgba(0,212,255,.06); border-color: var(--accent-tertiary); color: var(--accent-tertiary); }

/* ──────────────────────────────────────────
   RPG STATS
────────────────────────────────────────── */
.rpg-stat-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 0; }
@media(max-width:700px) { .rpg-stat-grid { grid-template-columns: repeat(2,1fr); } }
.rpg-stat-col { padding: 12px 16px; border-right: 1px solid var(--border); }
.rpg-stat-col:last-child { border-right: none; }
.rpg-stat-header { display: flex; align-items: center; gap: 7px; margin-bottom: 8px; }
.rpg-stat-icon  { font-size: 14px; line-height: 1; }
.rpg-stat-name  { font-family: var(--font-label); font-size: 9px; font-weight: 700; letter-spacing: 3px; text-transform: uppercase; color: var(--accent); }
.rpg-stat-ema   { font-family: var(--font-label); font-size: 10px; color: var(--foreground-muted); margin-left: auto; font-variant-numeric: tabular-nums; }

.rpg-bar-track { height: 3px; background: rgba(255,255,255,.07); overflow: hidden; margin-bottom: 10px; }
.rpg-bar-fill  { height: 100%; transition: width .6s steps(20); }
.rpg-bar-fill.body   { background: linear-gradient(90deg, #5b9cf6, #3d7de0); box-shadow: 0 0 8px rgba(91,156,246,.8); }
.rpg-bar-fill.energy { background: linear-gradient(90deg, var(--warning), #c98a00); box-shadow: 0 0 8px rgba(255,230,0,.8); }
.rpg-bar-fill.mind   { background: linear-gradient(90deg, var(--accent-secondary), #9d00ff); box-shadow: 0 0 8px rgba(255,0,255,.8); }
.rpg-bar-fill.bond   { background: linear-gradient(90deg, var(--accent), #00b070); box-shadow: var(--glow); }

.rpg-checks { display: flex; flex-direction: column; gap: 5px; }
.rpg-check-item { display: flex; align-items: center; gap: 7px; cursor: pointer; padding: 3px 4px; transition: var(--t-snap); }
.rpg-check-item:hover { background: rgba(0,255,136,.05); }
.rpg-check-btn {
  width: 16px; height: 16px; border: 1px solid var(--border); flex-shrink: 0;
  display: flex; align-items: center; justify-content: center; font-size: 9px;
  transition: all .1s steps(3); background: transparent; color: transparent;
}
.rpg-check-btn.yes       { background: var(--accent);           border-color: var(--accent);           color: var(--background); box-shadow: var(--glow-sm); }
.rpg-check-btn.no        { background: var(--destructive);      border-color: var(--destructive);      color: #fff; }
.rpg-check-btn.body.yes  { background: #3d7de0;                 border-color: #3d7de0;                 color: #fff; box-shadow: 0 0 5px rgba(61,125,224,.7); }
.rpg-check-btn.energy.yes{ background: #c98a00;                 border-color: #c98a00;                 color: #fff; box-shadow: 0 0 5px rgba(201,138,0,.7); }
.rpg-check-btn.mind.yes  { background: var(--accent-secondary); border-color: var(--accent-secondary); color: #fff; box-shadow: var(--glow-pink); }
.rpg-check-btn.bond.yes  { background: var(--accent);           border-color: var(--accent);           color: var(--background); box-shadow: var(--glow); }
.rpg-check-label { font-size: 12px; color: var(--foreground-2); line-height: 1.3; flex: 1; }
.rpg-check-item.checked .rpg-check-label { color: var(--foreground); }
.rpg-ema-trend  { font-size: 9px; margin-left: 2px; }
.rpg-date-label { font-family: var(--font-label); font-size: 9px; color: var(--foreground-muted); letter-spacing: 2px; }

/* ──────────────────────────────────────────
   TODO LIST
────────────────────────────────────────── */
.me-todo-list { flex: 1; overflow-y: auto; padding: 8px 10px; }
.me-todo-item {
  display: flex; align-items: flex-start; gap: 9px; padding: 8px 9px;
  margin-bottom: 3px; cursor: pointer; transition: var(--t-snap);
  background: transparent; border: 1px solid var(--border);
}
.me-todo-item:hover    { border-color: rgba(0,255,136,.3); background: rgba(0,255,136,.02); }
.me-todo-item.done     { opacity: .3; }
.me-todo-item.expanded { border-color: rgba(0,255,136,.4); background: rgba(0,255,136,.03); }

.me-todo-check {
  width: 15px; height: 15px; border: 1px solid var(--border); flex-shrink: 0;
  display: flex; align-items: center; justify-content: center; font-size: 10px;
  transition: all .1s steps(3); margin-top: 2px;
}
.me-todo-item.done .me-todo-check { background: var(--accent); border-color: var(--accent); color: var(--background); }
.me-todo-text { font-size: 13px; color: var(--foreground); flex: 1; line-height: 1.5; }
.me-todo-item.done .me-todo-text { text-decoration: line-through; color: var(--foreground-muted); }
.me-todo-del  { background: none; border: none; color: var(--foreground-muted); font-size: 14px; cursor: pointer; flex-shrink: 0; padding: 0 2px; transition: color .15s; }
.me-todo-del:hover { color: var(--destructive); }
.me-todo-edit-btn { background: none; border: none; color: var(--foreground-muted); font-size: 11px; cursor: pointer; padding: 0 2px; opacity: 0; transition: opacity .15s; flex-shrink: 0; }
.me-todo-item:hover .me-todo-edit-btn { opacity: 1; }
.me-todo-empty { padding: 20px; text-align: center; font-size: 11px; color: var(--foreground-muted); line-height: 1.9; font-family: var(--font-label); letter-spacing: 2px; }

.me-todo-tag { font-family: var(--font-label); font-size: 9px; padding: 1px 6px; flex-shrink: 0; margin-top: 2px; font-weight: 700; letter-spacing: 1px; }
.me-todo-tag.high { background: rgba(255,51,102,.1);  color: var(--destructive); border: 1px solid rgba(255,51,102,.3); }
.me-todo-tag.mid  { background: rgba(255,230,0,.08);  color: var(--warning);     border: 1px solid rgba(255,230,0,.25); }
.me-todo-tag.low  { background: rgba(0,255,136,.07);  color: var(--accent);      border: 1px solid rgba(0,255,136,.2); }

.me-todo-meta        { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 4px; }
.me-todo-trigger     { font-size: 11px; color: var(--accent-tertiary); margin-top: 4px; line-height: 1.4; }
.me-todo-block-tag   { font-family: var(--font-label); font-size: 9px; padding: 2px 7px; background: rgba(255,0,255,.08); color: var(--accent-secondary); border: 1px solid rgba(255,0,255,.2); }
.me-todo-energy-tag  { font-family: var(--font-label); font-size: 9px; padding: 2px 7px; }
.me-todo-energy-tag.high { background: rgba(255,51,102,.1); color: var(--destructive); }
.me-todo-energy-tag.mid  { background: rgba(255,230,0,.08); color: var(--warning); }
.me-todo-energy-tag.low  { background: rgba(0,255,136,.07); color: var(--accent); }

.me-todo-subitems { padding: 5px 0 2px; display: flex; flex-direction: column; gap: 3px; }
.me-todo-subitem { display: flex; align-items: flex-start; gap: 6px; padding: 3px 5px; cursor: pointer; transition: background .1s; }
.me-todo-subitem:hover { background: rgba(0,255,136,.04); }
.me-todo-subitem.done .me-todo-subtext { text-decoration: line-through; color: var(--foreground-muted); }
.me-todo-subcheck { width: 12px; height: 12px; border: 1px solid var(--border); flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 8px; margin-top: 2px; transition: all .1s steps(3); }
.me-todo-subitem.done .me-todo-subcheck { background: var(--accent-tertiary); border-color: var(--accent-tertiary); color: var(--background); }
.me-todo-subtext { font-size: 12px; color: var(--foreground-2); flex: 1; line-height: 1.5; }
.me-todo-subdel  { background: none; border: none; color: var(--foreground-muted); font-size: 11px; cursor: pointer; padding: 0; opacity: 0; transition: opacity .1s; flex-shrink: 0; }
.me-todo-subitem:hover .me-todo-subdel { opacity: 1; }
.me-todo-add-sub {
  display: flex; align-items: center; gap: 5px; padding: 3px 5px; margin-top: 2px;
  background: none; border: 1px dashed rgba(0,255,136,.15);
  font-family: inherit; font-size: 11px; color: var(--foreground-muted);
  cursor: pointer; width: 100%; transition: var(--t-snap);
}
.me-todo-add-sub:hover { border-color: rgba(0,255,136,.4); color: var(--accent); }
.me-todo-sub-count     { font-family: var(--font-label); font-size: 9px; color: var(--foreground-muted); background: var(--muted); border: 1px solid var(--border); padding: 0 5px; margin-left: 3px; flex-shrink: 0; letter-spacing: 1px; }
.me-todo-sub-count.has { background: rgba(0,255,136,.08); border-color: rgba(0,255,136,.3); color: var(--accent); }
.me-todo-retro { font-size: 11px; color: var(--foreground-2); margin-top: 5px; padding: 5px 8px; background: var(--muted); border-left: 2px solid var(--accent-tertiary); line-height: 1.5; }

/* Todo edit */
.todo-edit-section       { margin-bottom: 14px; }
.todo-edit-section-title { font-family: var(--font-label); font-size: 9px; color: var(--foreground-2); font-weight: 600; margin-bottom: 8px; letter-spacing: 2px; }
.todo-block-opts, .todo-energy-opts { display: flex; flex-wrap: wrap; gap: 6px; }
.todo-block-opt, .todo-energy-opt   { padding: 5px 11px; border: 1px solid var(--border); background: transparent; font-family: var(--font-mono); font-size: 12px; color: var(--foreground-2); cursor: pointer; transition: var(--t-snap); }
.todo-block-opt.sel           { background: rgba(255,0,255,.08);  border-color: var(--accent-secondary); color: var(--accent-secondary); }
.todo-energy-opt.sel.high     { background: rgba(255,51,102,.08); border-color: var(--destructive);       color: var(--destructive); }
.todo-energy-opt.sel.mid      { background: rgba(255,230,0,.06);  border-color: var(--warning);           color: var(--warning); }
.todo-energy-opt.sel.low      { background: rgba(0,255,136,.06);  border-color: var(--accent);            color: var(--accent); }
.retro-modal-title   { font-family: var(--font-head); font-size: 15px; font-weight: 700; color: var(--accent); margin-bottom: 8px; text-transform: uppercase; letter-spacing: .08em; }
.retro-modal-task    { font-size: 12px; color: var(--foreground-muted); margin-bottom: 16px; }
.todo-ai-btn {
  width: 100%; padding: 9px; background: transparent;
  border: 1px solid rgba(0,255,136,.3); color: var(--accent);
  font-family: var(--font-label); font-size: 10px; letter-spacing: 2px; text-transform: uppercase;
  clip-path: var(--chamfer-xs); cursor: pointer; transition: var(--t-snap);
}
.todo-ai-btn:hover { background: rgba(0,255,136,.07); border-color: var(--accent); box-shadow: var(--glow); }
.todo-ai-result { background: var(--muted); border: 1px solid var(--border); clip-path: var(--chamfer-xs); padding: 12px; margin-top: 10px; }
.todo-ai-result-loading { display: flex; align-items: center; gap: 8px; font-family: var(--font-label); font-size: 11px; color: var(--foreground-muted); }
.todo-ai-block { margin-bottom: 10px; }
.todo-ai-block:last-child { margin-bottom: 0; }
.todo-ai-block-label { font-family: var(--font-label); font-size: 9px; color: var(--accent-tertiary); letter-spacing: 3px; text-transform: uppercase; margin-bottom: 5px; }
.todo-ai-block-text  { font-size: 13px; color: var(--foreground-2); line-height: 1.7; }
.todo-ai-step { display: flex; align-items: flex-start; gap: 8px; padding: 5px 0; border-bottom: 1px solid rgba(0,255,136,.07); }
.todo-ai-step:last-child { border-bottom: none; }
.todo-ai-step-num  { width: 18px; height: 18px; background: rgba(0,255,136,.08); border: 1px solid rgba(0,255,136,.3); display: flex; align-items: center; justify-content: center; font-family: var(--font-label); font-size: 9px; color: var(--accent); flex-shrink: 0; }
.todo-ai-step-text { font-size: 12px; color: var(--foreground); line-height: 1.6; flex: 1; }
.todo-ai-apply-btn { padding: 6px 14px; background: transparent; border: 1px solid var(--accent-tertiary); color: var(--accent-tertiary); font-family: var(--font-label); font-size: 9px; letter-spacing: 2px; cursor: pointer; margin-top: 8px; transition: var(--t-snap); }
.todo-ai-apply-btn:hover { background: rgba(0,212,255,.08); box-shadow: var(--glow-cyan); }

/* ──────────────────────────────────────────
   METRICS
────────────────────────────────────────── */
.me-metrics-list   { flex: 1; overflow-y: auto; padding: 8px 10px; display: flex; flex-direction: column; gap: 8px; }
.me-metric-mini    { background: var(--muted); border: 1px solid var(--border); clip-path: var(--chamfer-xs); padding: 10px 12px; }
.me-metric-mini-header  { display: flex; align-items: center; gap: 6px; margin-bottom: 6px; }
.me-metric-mini-name    { font-size: 12px; font-weight: 500; color: var(--foreground); flex: 1; }
.me-metric-mini-val     { font-family: var(--font-head); font-size: 16px; font-weight: 700; color: var(--accent); text-shadow: var(--glow-sm); }
.me-metric-mini-unit    { font-size: 11px; color: var(--foreground-muted); margin-left: 2px; }
.me-metric-mini-goal    { font-size: 10px; color: var(--foreground-muted); }
.me-bar-chart  { display: flex; gap: 3px; height: 32px; align-items: flex-end; }
.me-bar-col    { display: flex; flex-direction: column; align-items: center; gap: 2px; flex: 1; }
.me-bar-seg    { width: 100%; transition: height .3s; }
.me-bar-lbl    { font-family: var(--font-label); font-size: 9px; color: var(--foreground-muted); }
.me-prog-bg    { width: 100%; height: 3px; background: rgba(255,255,255,.07); overflow: hidden; margin: 5px 0; }
.me-prog-fill  { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent-tertiary)); transition: width .4s steps(10); }
.me-prog-info  { display: flex; justify-content: space-between; font-family: var(--font-label); font-size: 10px; color: var(--foreground-muted); }
.me-metric-mini-actions { display: flex; gap: 5px; margin-top: 6px; }
.me-metric-log-btn  { padding: 4px 10px; border: 1px solid rgba(0,212,255,.3); background: transparent; color: var(--accent-tertiary); font-family: var(--font-label); font-size: 9px; letter-spacing: 1px; cursor: pointer; transition: var(--t-snap); }
.me-metric-log-btn:hover  { border-color: var(--accent-tertiary); background: rgba(0,212,255,.07); }
.me-metric-edit-btn { padding: 4px 8px; border: 1px solid var(--border); background: transparent; color: var(--foreground-muted); font-family: var(--font-label); font-size: 9px; cursor: pointer; transition: var(--t-snap); }
.me-metric-edit-btn:hover { border-color: rgba(0,255,136,.3); color: var(--accent); }
.me-metrics-empty { padding: 20px; text-align: center; font-size: 11px; color: var(--foreground-muted); line-height: 1.9; font-family: var(--font-label); letter-spacing: 2px; }

.me-result-list  { flex: 1; overflow-y: auto; padding: 8px 10px; display: flex; flex-direction: column; gap: 4px; }
.me-result-mini  { background: var(--muted); border: 1px solid var(--border); clip-path: var(--chamfer-xs); padding: 9px 12px; cursor: pointer; transition: var(--t-snap); }
.me-result-mini:hover { border-color: rgba(0,212,255,.4); box-shadow: inset 0 0 16px rgba(0,212,255,.04); }
.me-result-mini-date    { font-family: var(--font-label); font-size: 9px; color: var(--foreground-muted); margin-bottom: 3px; letter-spacing: 2px; }
.me-result-mini-title   { font-size: 12px; color: var(--foreground); font-weight: 500; margin-bottom: 2px; }
.me-result-mini-preview { font-size: 11px; color: var(--foreground-muted); line-height: 1.5; }
.me-result-empty { padding: 20px; text-align: center; font-size: 11px; color: var(--foreground-muted); line-height: 1.9; font-family: var(--font-label); letter-spacing: 2px; }
.me-linechart-wrap svg { overflow: visible; }

/* ──────────────────────────────────────────
   COMMITMENTS / RESULT SHEETS
────────────────────────────────────────── */
.me-commitment-box    { background: var(--card); border: 1px solid var(--border); clip-path: var(--chamfer-xs); padding: 12px 14px; margin: 8px 0; }
.me-commitment-label  { font-family: var(--font-label); font-size: 9px; color: var(--accent-tertiary); letter-spacing: 3px; text-transform: uppercase; margin-bottom: 5px; }
.me-commitment-text   { font-size: 13px; color: var(--foreground); line-height: 1.7; }
.me-commitment-date   { font-family: var(--font-label); font-size: 10px; color: var(--foreground-muted); margin-top: 5px; }

.res-commitment-area  { padding: 16px 0 0; }
.res-commitment-lbl   { font-family: var(--font-label); font-size: 9px; color: var(--accent-tertiary); letter-spacing: 3px; margin-bottom: 6px; }
.res-commitment-ta    { width: 100%; padding: 10px 13px; border: 1px solid var(--border); background: var(--card); color: var(--foreground); font-family: var(--font-mono); font-size: 13px; resize: none; min-height: 80px; outline: none; transition: var(--t-base); clip-path: var(--chamfer-sm); }
.res-commitment-ta:focus { border-color: var(--accent); }
.res-commitment-save  { margin-top: 8px; padding: 7px 14px; background: var(--accent); border: none; color: var(--background); font-family: var(--font-label); font-size: 9px; letter-spacing: 2px; text-transform: uppercase; cursor: pointer; font-weight: 700; clip-path: var(--chamfer-xs); }
.res-commitment-saved { font-family: var(--font-label); font-size: 11px; color: var(--accent); margin-top: 8px; letter-spacing: 1px; }

.rs-commitment        { background: var(--card); border: 1px solid rgba(0,212,255,.2); clip-path: var(--chamfer-xs); padding: 12px 14px; margin-top: 8px; }
.rs-commitment-label  { font-family: var(--font-label); font-size: 9px; color: var(--accent-tertiary); letter-spacing: 3px; text-transform: uppercase; margin-bottom: 6px; }
.rs-commitment-text   { font-size: 13px; color: var(--foreground); line-height: 1.7; }
.rs-commitment-ta     { width: 100%; padding: 8px 12px; border: 1px solid var(--border); background: var(--background); color: var(--foreground); font-family: var(--font-mono); font-size: 13px; resize: none; min-height: 70px; outline: none; transition: var(--t-base); }
.rs-commitment-ta:focus { border-color: var(--accent); }
.rs-commitment-btn    { margin-top: 6px; padding: 6px 14px; background: var(--accent); border: none; color: var(--background); font-family: var(--font-label); font-size: 9px; letter-spacing: 2px; text-transform: uppercase; cursor: pointer; font-weight: 700; clip-path: var(--chamfer-xs); }

/* Result sheets */
.result-sheet         { background: var(--card); border: 1px solid var(--border); margin-bottom: 1px; overflow: hidden; }
.result-sheet-header  { padding: 12px 14px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: var(--t-snap); }
.result-sheet-header:hover { background: var(--muted); }
.result-sheet-date    { font-family: var(--font-label); font-size: 10px; color: var(--foreground-muted); letter-spacing: 2px; }
.result-sheet-title   { font-family: var(--font-mono); font-size: 13px; color: var(--foreground); font-weight: 500; }
.result-sheet-toggle  { font-family: var(--font-label); font-size: 10px; color: var(--foreground-muted); }
.result-sheet-grid    { display: grid; grid-template-columns: 1fr 1fr; border-top: 1px solid var(--border); }
@media(max-width:540px) { .result-sheet-grid { grid-template-columns: 1fr; } }
.result-sheet-col     { padding: 12px 14px; border-right: 1px solid var(--border); }
.result-sheet-col:last-child { border-right: none; }
.result-sheet-col-head   { font-family: var(--font-label); font-size: 9px; color: var(--accent-tertiary); letter-spacing: 3px; text-transform: uppercase; margin-bottom: 10px; }
.result-sheet-ans        { padding: 6px 0; border-bottom: 1px solid rgba(0,255,136,.07); }
.result-sheet-ans:last-child { border-bottom: none; }
.result-sheet-q  { font-family: var(--font-label); font-size: 9px; color: var(--foreground-muted); margin-bottom: 3px; letter-spacing: 1px; }
.result-sheet-v  { font-size: 13px; color: var(--foreground); }
.result-sheet-txt{ font-size: 12px; color: var(--foreground-2); line-height: 1.7; }
.result-sheet-card       { padding: 8px 0; border-bottom: 1px solid rgba(0,212,255,.07); }
.result-sheet-card:last-child { border-bottom: none; }
.result-sheet-card-tag   { font-family: var(--font-label); font-size: 9px; color: var(--accent-tertiary); font-weight: 700; margin-bottom: 3px; letter-spacing: 2px; }
.result-sheet-card-title { font-size: 13px; color: var(--foreground); font-weight: 500; margin-bottom: 3px; }
.result-sheet-card-sub   { font-size: 12px; color: var(--foreground-2); line-height: 1.7; }
.result-sheet-choice     { padding: 6px 0; border-bottom: 1px solid rgba(0,255,136,.07); }
.result-sheet-choice:last-child { border-bottom: none; }
.result-sheet-choice-title { font-size: 13px; color: var(--foreground); font-weight: 500; margin-bottom: 3px; }
.result-sheet-choice-how   { font-size: 12px; color: var(--accent-tertiary); line-height: 1.7; }

/* Worksheet result sections */
.res-ws-section       { padding: 12px 0; border-bottom: 1px solid var(--border); }
.res-ws-section:last-child { border-bottom: none; }
.res-ws-section-title { font-family: var(--font-label); font-size: 9px; color: var(--accent-tertiary); letter-spacing: 3px; text-transform: uppercase; margin-bottom: 8px; }
.res-ws-section-icon  { margin-right: 6px; }
.res-ws-field         { padding: 5px 0; display: flex; gap: 10px; }
.res-ws-label         { font-family: var(--font-label); font-size: 9px; color: var(--foreground-muted); width: 80px; flex-shrink: 0; padding-top: 2px; letter-spacing: 1px; }
.res-ws-val           { font-size: 13px; color: var(--foreground); flex: 1; line-height: 1.5; }
.res-ws-opts          { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 2px; }
.res-ws-opt-chip      { font-family: var(--font-label); font-size: 10px; padding: 2px 8px; background: rgba(0,255,136,.07); color: var(--accent); border: 1px solid rgba(0,255,136,.25); letter-spacing: 1px; }
.res-ai-panel         { padding: 12px 0; }
.res-ai-loading       { display: flex; align-items: center; gap: 10px; padding: 8px 0; }
.res-ai-loading .spinner { margin: 0; width: 14px; height: 14px; }
.res-ai-loading-txt   { font-family: var(--font-label); font-size: 11px; color: var(--foreground-muted); letter-spacing: 2px; }
.res-ai-summary       { font-size: 13px; color: var(--foreground-2); line-height: 1.9; margin-bottom: 14px; }
.res-ai-phil-label    { font-family: var(--font-label); font-size: 9px; color: var(--accent-tertiary); letter-spacing: 3px; text-transform: uppercase; margin-bottom: 8px; }
.res-ai-phil-item     { padding: 8px 0; border-bottom: 1px solid rgba(0,212,255,.08); }
.res-ai-phil-item:last-child { border-bottom: none; }
.res-ai-phil-tag      { font-family: var(--font-label); font-size: 9px; color: var(--accent-tertiary); font-weight: 700; margin-bottom: 3px; letter-spacing: 2px; }
.res-ai-phil-content  { font-size: 13px; color: var(--foreground); font-weight: 500; margin-bottom: 3px; }
.res-ai-phil-why      { font-size: 12px; color: var(--foreground-2); line-height: 1.7; }

#memoList .memo-item { margin: 0 24px 1px; }

/* ──────────────────────────────────────────
   METRIC GRAPHS
────────────────────────────────────────── */
.metric-graph-wrap    { padding: 16px 24px; }
.metric-graph-item    { background: var(--card); border: 1px solid var(--border); clip-path: var(--chamfer-xs); padding: 14px 16px; margin-bottom: 8px; }
.metric-graph-item:last-child { margin-bottom: 0; }
.metric-graph-header  { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
.metric-graph-name    { font-size: 13px; font-weight: 600; color: var(--foreground); flex: 1; }
.metric-graph-val     { font-family: var(--font-head); font-size: 20px; font-weight: 700; color: var(--accent); text-shadow: var(--glow-sm); }
.metric-graph-unit    { font-size: 12px; color: var(--foreground-muted); }
.metric-graph-goal    { font-size: 11px; color: var(--foreground-muted); }
.metric-sparkline     { width: 100%; height: 36px; display: block; margin-bottom: 4px; }
.metric-bar-chart     { display: flex; gap: 5px; height: 60px; align-items: flex-end; padding: 0 0 4px; }
.metric-bar-col       { display: flex; flex-direction: column; align-items: center; gap: 2px; flex: 1; }
.metric-bar-fill-wrap { flex: 1; width: 100%; display: flex; flex-direction: column; justify-content: flex-end; gap: 1px; }
.metric-bar-seg       { width: 100%; min-height: 2px; }
.metric-bar-seg.charge-bar  { background: var(--accent); }
.metric-bar-seg.neutral-bar { background: var(--warning); }
.metric-bar-lbl  { font-family: var(--font-label); font-size: 8px; color: var(--foreground-muted); }
.metric-progress-wrap   { padding: 6px 0; }
.metric-progress-bg     { width: 100%; height: 3px; background: rgba(255,255,255,.07); overflow: hidden; }
.metric-progress-fill   { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent-tertiary)); transition: width .4s steps(10); }
.metric-progress-pct    { font-family: var(--font-label); font-size: 10px; color: var(--foreground-2); text-align: right; margin-top: 4px; letter-spacing: 1px; }
.metric-note-row { margin-top: 8px; }
.metric-note     { font-size: 12px; color: var(--foreground-2); line-height: 1.6; }
.metric-edit-btn { padding: 4px 10px; border: 1px solid var(--border); background: transparent; color: var(--foreground-muted); font-family: var(--font-label); font-size: 9px; cursor: pointer; transition: var(--t-snap); }
.metric-edit-btn:hover { border-color: rgba(0,255,136,.3); color: var(--accent); }

.result-title, .res-title { font-family: var(--font-head); }

/* ──────────────────────────────────────────
   REWARD / CHARGE TAB
────────────────────────────────────────── */
.reward-page-header { padding: 20px 20px 12px; }
.reward-page-header h2 { font-family: var(--font-head); font-size: 16px; font-weight: 700; color: var(--foreground); margin-bottom: 4px; }
.reward-page-header p  { font-size: 12px; color: var(--foreground-muted); line-height: 1.7; }

.rw-section { margin: 0; border-bottom: 1px solid var(--border); }
.rw-sec-title { display: flex; align-items: center; gap: 8px; padding: 11px 16px; font-family: var(--font-label); font-size: 10px; font-weight: 700; letter-spacing: 2px; }
.rw-sec-title.charge    { color: var(--accent);           background: rgba(0,255,136,.04);  border-bottom: 1px solid rgba(0,255,136,.15); }
.rw-sec-title.drain     { color: var(--destructive);      background: rgba(255,51,102,.04); border-bottom: 1px solid rgba(255,51,102,.15); }
.rw-sec-title.real-need { color: var(--accent-tertiary);  background: rgba(0,212,255,.04);  border-bottom: 1px solid rgba(0,212,255,.15); }
.rw-sec-title.real-need span { flex: 1; }
.rw-sec-sub { font-size: 10px; font-weight: 400; color: var(--foreground-muted); margin-left: 4px; font-family: var(--font-mono); }
.rw-new-btn {
  padding: 4px 12px; font-family: var(--font-label); font-size: 9px;
  letter-spacing: 2px; text-transform: uppercase; cursor: pointer;
  border: 1px solid; transition: var(--t-snap); margin-left: auto; background: transparent;
  clip-path: var(--chamfer-xs);
}
.rw-new-btn.charge    { border-color: rgba(0,255,136,.35);  color: var(--accent); }
.rw-new-btn.charge:hover { background: rgba(0,255,136,.08); }
.rw-new-btn.drain     { border-color: rgba(255,51,102,.35); color: var(--destructive); }
.rw-new-btn.drain:hover  { background: rgba(255,51,102,.08); }
.rw-new-btn.real-need { border-color: rgba(0,212,255,.35);  color: var(--accent-tertiary); }
.rw-new-btn.real-need:hover { background: rgba(0,212,255,.07); }

.rw-cards    { display: flex; flex-direction: column; }
.rw-card     { background: var(--card); border-bottom: 1px solid var(--border); }
.rw-card.charge { border-left: 2px solid rgba(0,255,136,.5); }
.rw-card.drain  { border-left: 2px solid rgba(255,51,102,.5); }
.rw-card-main   { display: flex; align-items: flex-start; gap: 10px; padding: 12px 14px; cursor: pointer; transition: var(--t-snap); }
.rw-card-main:hover { background: var(--muted); }
.rw-card-emoji  { font-size: 18px; flex-shrink: 0; }
.rw-card-info   { flex: 1; min-width: 0; }
.rw-card-name   { font-size: 13px; font-weight: 500; color: var(--foreground); margin-bottom: 2px; }
.rw-card-feeling{ font-size: 12px; color: var(--foreground-2); line-height: 1.5; }
.rw-card-meta   { font-family: var(--font-label); font-size: 9px; color: var(--foreground-muted); margin-top: 3px; letter-spacing: 1px; }
.rw-card-actions{ display: flex; gap: 5px; padding: 0 14px 10px; }
.rw-log-btn {
  padding: 4px 10px; font-family: var(--font-label); font-size: 9px; letter-spacing: 1px;
  cursor: pointer; border: 1px solid; transition: var(--t-snap); background: transparent;
  clip-path: var(--chamfer-xs);
}
.rw-log-btn.charge { border-color: rgba(0,255,136,.3); color: var(--accent); }
.rw-log-btn.charge:hover { background: rgba(0,255,136,.07); }
.rw-log-btn.drain  { border-color: rgba(255,51,102,.3); color: var(--destructive); }
.rw-log-btn.drain:hover  { background: rgba(255,51,102,.07); }
.rw-del-btn { padding: 4px 8px; border: 1px solid var(--border); background: transparent; color: var(--foreground-muted); font-family: var(--font-label); font-size: 9px; clip-path: var(--chamfer-xs); cursor: pointer; transition: var(--t-snap); }
.rw-del-btn:hover { border-color: var(--destructive); color: var(--destructive); }
.rw-log-panel { padding: 0 14px 14px; }
.rw-log-empty { font-family: var(--font-label); font-size: 11px; color: var(--foreground-muted); padding: 8px 0; letter-spacing: 2px; }
.rw-log-entry { padding: 8px 0; border-bottom: 1px solid rgba(0,255,136,.07); display: flex; align-items: flex-start; gap: 10px; }
.rw-log-entry:last-child { border-bottom: none; }
.rw-log-date  { font-family: var(--font-label); font-size: 9px; color: var(--foreground-muted); white-space: nowrap; margin-top: 2px; letter-spacing: 1px; }
.rw-log-note  { font-size: 13px; color: var(--foreground-2); flex: 1; line-height: 1.5; }
.rw-log-photo { max-width: 60px; flex-shrink: 0; border: 1px solid var(--border); }
.rw-log-del   { background: none; border: none; color: var(--foreground-muted); font-size: 13px; cursor: pointer; padding: 0; transition: color .15s; }
.rw-log-del:hover { color: var(--destructive); }
.rw-empty     { padding: 20px 16px; text-align: center; font-size: 11px; color: var(--foreground-muted); line-height: 1.9; font-family: var(--font-label); letter-spacing: 2px; }

.real-need-area        { padding: 4px 16px 12px; }
.real-need-hint        { font-size: 13px; color: var(--foreground-muted); line-height: 1.9; }
.real-need-hint em     { color: var(--accent-tertiary); font-style: normal; }
.real-need-entry       { padding: 8px 0; border-bottom: 1px solid rgba(0,212,255,.08); display: flex; align-items: flex-start; gap: 8px; }
.real-need-entry:last-child { border-bottom: none; }
.real-need-entry-text  { font-size: 13px; color: var(--foreground); flex: 1; line-height: 1.6; }
.real-need-entry-date  { font-family: var(--font-label); font-size: 9px; color: var(--foreground-muted); letter-spacing: 1px; }
.real-need-del         { background: none; border: none; color: var(--foreground-muted); font-size: 13px; cursor: pointer; padding: 0; transition: color .15s; }
.real-need-del:hover   { color: var(--destructive); }
.rw-edit-btn  { background: none; border: none; color: var(--foreground-muted); font-size: 11px; cursor: pointer; padding: 2px 5px; transition: var(--t-snap); font-family: var(--font-label); }
.rw-edit-btn:hover { color: var(--accent); }

/* ──────────────────────────────────────────
   INBOX
────────────────────────────────────────── */
.inbox-wrap    { display: flex; flex-direction: column; height: calc(100vh - 44px); max-width: 640px; margin: 0 auto; }
.inbox-header  { padding: 14px 16px 10px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
.inbox-header h2 {
  font-family: var(--font-head); font-size: 15px; font-weight: 700;
  margin-bottom: 3px; color: var(--accent);
  text-transform: uppercase; letter-spacing: .1em; text-shadow: var(--glow);
}
.inbox-sub    { font-size: 12px; color: var(--foreground-muted); line-height: 1.7; }
.inbox-ai-btn {
  padding: 5px 11px; background: rgba(0,255,136,.06);
  border: 1px solid rgba(0,255,136,.3); color: var(--accent);
  font-family: var(--font-label); font-size: 9px; letter-spacing: 2px;
  clip-path: var(--chamfer-xs); cursor: pointer; transition: var(--t-snap);
}
.inbox-ai-btn:hover { border-color: var(--accent); box-shadow: var(--glow); }

.inbox-cat-tabs { display: flex; gap: 4px; padding: 8px 12px; overflow-x: auto; flex-shrink: 0; }
.inbox-cat-tabs::-webkit-scrollbar { display: none; }
.inbox-cat-tab  {
  padding: 4px 10px; border: 1px solid var(--border); background: none;
  font-family: var(--font-label); font-size: 9px; color: var(--foreground-muted);
  cursor: pointer; white-space: nowrap; transition: var(--t-snap); letter-spacing: 2px; text-transform: uppercase;
}
.inbox-cat-tab.active { background: rgba(0,255,136,.07); border-color: var(--accent); color: var(--accent); }
.inbox-cat-tab:hover:not(.active) { border-color: rgba(0,255,136,.3); color: var(--foreground-2); }

.inbox-messages { flex: 1; overflow-y: auto; padding: 8px 14px 12px; display: flex; flex-direction: column; gap: 8px; }
.inbox-msg { display: flex; flex-direction: column; align-items: flex-end; animation: msgIn .15s steps(4); }
/* Message bubble — chamfered asymmetric */
.inbox-bubble {
  max-width: 84%; padding: 9px 13px;
  background: rgba(0,255,136,.07); color: var(--foreground);
  border: 1px solid rgba(0,255,136,.2);
  clip-path: polygon(0 0, calc(100% - 8px) 0, 100% 8px, 100% 100%, 8px 100%, 0 calc(100% - 8px));
  font-size: 13px; line-height: 1.7; word-break: break-word;
}
.inbox-bubble.processed { background: var(--card); color: var(--foreground-2); border: 1px solid var(--border); }
.inbox-bubble.high-prio { background: rgba(255,51,102,.08); border-color: rgba(255,51,102,.3); }

.inbox-msg-meta    { display: flex; align-items: center; gap: 6px; margin-top: 3px; }
.inbox-msg-time    { font-family: var(--font-label); font-size: 9px; color: var(--foreground-muted); letter-spacing: 1px; }
.inbox-msg-cat     { font-family: var(--font-label); font-size: 8px; padding: 1px 6px; font-weight: 700; letter-spacing: 2px; }
.inbox-msg-actions { display: flex; gap: 4px; margin-top: 4px; flex-wrap: wrap; }
.inbox-action-btn  {
  padding: 3px 9px; font-family: var(--font-label); font-size: 9px;
  border: 1px solid var(--border); background: var(--card); color: var(--foreground-2);
  cursor: pointer; transition: var(--t-snap); letter-spacing: 1px;
}
.inbox-action-btn:hover { border-color: rgba(0,255,136,.4); color: var(--accent); }
.inbox-action-btn.done  { background: rgba(0,255,136,.07); border-color: rgba(0,255,136,.3); color: var(--accent); text-decoration: line-through; }
.inbox-action-btn.sub   { background: rgba(0,212,255,.06); border-color: rgba(0,212,255,.25); color: var(--accent-tertiary); }
.inbox-priority-badge   { font-family: var(--font-label); font-size: 9px; padding: 1px 6px; font-weight: 700; letter-spacing: 1px; }
.inbox-priority-badge.high { background: rgba(255,51,102,.1); color: var(--destructive); border: 1px solid rgba(255,51,102,.3); }
.inbox-priority-badge.mid  { background: rgba(255,230,0,.08); color: var(--warning);     border: 1px solid rgba(255,230,0,.2); }
.inbox-priority-badge.low  { background: rgba(0,255,136,.07); color: var(--accent);      border: 1px solid rgba(0,255,136,.2); }
.inbox-ai-result   { padding: 8px 14px; background: rgba(0,212,255,.04); border-top: 1px solid rgba(0,212,255,.15); font-size: 12px; color: var(--foreground-2); line-height: 1.8; }
.inbox-empty       { padding: 40px 20px; text-align: center; font-size: 11px; color: var(--foreground-muted); line-height: 1.9; font-family: var(--font-label); letter-spacing: 2px; }

.inbox-input-bar   { border-top: 1px solid var(--border); padding: 10px 12px; background: var(--card); display: flex; align-items: flex-end; gap: 8px; flex-shrink: 0; }
.inbox-cat-select  { padding: 7px 10px; border: 1px solid var(--border); font-family: var(--font-label); font-size: 10px; background: var(--background); color: var(--foreground-2); outline: none; letter-spacing: 1px; }
.inbox-input-ta    {
  flex: 1; padding: 8px 12px; border: 1px solid var(--border);
  background: var(--background); color: var(--foreground);
  font-family: var(--font-mono); font-size: 13px;
  resize: none; line-height: 1.7; outline: none; transition: var(--t-base); max-height: 120px;
}
.inbox-input-ta:focus { border-color: var(--accent); box-shadow: var(--glow); }
.inbox-send-btn {
  padding: 8px 14px; background: var(--accent); border: none;
  color: var(--background); font-family: var(--font-label); font-size: 12px;
  clip-path: var(--chamfer-xs); cursor: pointer; flex-shrink: 0;
  transition: var(--t-snap); font-weight: 700; letter-spacing: 1px;
}
.inbox-send-btn:hover  { box-shadow: var(--glow-lg); filter: brightness(1.1); }
.inbox-send-btn:active { opacity: .8; }

/* ──────────────────────────────────────────
   WORKSHEET
────────────────────────────────────────── */
.ws-wrap        { max-width: 600px; margin: 0 auto; padding: 0 20px 80px; }
.ws-prog-row    { display: flex; align-items: center; gap: 12px; padding: 16px 0 8px; }
.ws-prog-bg     { flex: 1; height: 2px; background: rgba(0,255,136,.1); overflow: hidden; }
.ws-prog-fill   { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent-tertiary)); transition: width .4s steps(10); box-shadow: var(--glow); }
.ws-prog-lbl    { font-family: var(--font-label); font-size: 9px; color: var(--foreground-muted); letter-spacing: 2px; }
.ws-page-header { margin-bottom: 20px; }
.ws-page-icon   { font-size: 28px; margin-bottom: 10px; display: block; }
.ws-page-title  { font-family: var(--font-head); font-size: 17px; font-weight: 600; color: var(--foreground); margin-bottom: 6px; line-height: 1.4; text-transform: uppercase; letter-spacing: .06em; }
.ws-page-sub    { font-size: 13px; color: var(--foreground-muted); line-height: 1.75; }
.ws-fields      { display: flex; flex-direction: column; gap: 16px; }
.ws-field       { display: flex; flex-direction: column; gap: 6px; }
.ws-field-label { font-family: var(--font-label); font-size: 9px; color: var(--accent-tertiary); font-weight: 700; letter-spacing: 4px; text-transform: uppercase; }
.ws-field-hint  { font-size: 12px; color: var(--foreground-muted); line-height: 1.6; }
.ws-inp         { padding: 10px 13px; }
.ws-inp::placeholder { color: var(--foreground-muted); }

.ws-opts-row    { display: flex; flex-wrap: wrap; gap: 7px; }
.ws-opt {
  padding: 6px 13px; border: 1px solid var(--border); background: transparent;
  font-family: var(--font-mono); font-size: 12px; color: var(--foreground-2);
  cursor: pointer; transition: var(--t-snap);
}
.ws-opt:hover { border-color: rgba(0,255,136,.4); color: var(--foreground); }
.ws-opt.sel   { background: rgba(0,255,136,.07); border-color: var(--accent); color: var(--accent); font-weight: 600; }

.ws-reward-opt { padding: 7px 13px; border: 1px solid rgba(0,212,255,.2); background: transparent; font-family: var(--font-mono); font-size: 12px; color: var(--foreground-2); cursor: pointer; transition: var(--t-snap); }
.ws-reward-opt:hover, .ws-reward-opt.sel { background: rgba(0,212,255,.07); border-color: var(--accent-tertiary); color: var(--accent-tertiary); }
.ws-reward-empty { font-size: 12px; color: var(--foreground-muted); padding: 8px 0; }
.ws-nav         { display: flex; gap: 10px; padding: 20px 0 0; }
.ws-btn-next    {
  flex: 1; padding: 14px; background: var(--accent); border: 1px solid var(--accent); color: var(--background);
  font-family: var(--font-label); font-size: 10px; letter-spacing: 3px; text-transform: uppercase;
  clip-path: var(--chamfer-sm); cursor: pointer; font-weight: 700; transition: var(--t-snap); box-shadow: var(--glow);
}
.ws-btn-next:hover { filter: brightness(1.1); box-shadow: var(--glow-lg); }
.ws-btn-back {
  padding: 14px 18px; background: transparent; border: 1px solid var(--border);
  color: var(--foreground-muted); font-family: var(--font-label); font-size: 10px; letter-spacing: 2px;
  clip-path: var(--chamfer-sm); cursor: pointer; transition: var(--t-snap);
}
.ws-btn-back:hover { border-color: var(--foreground-2); color: var(--foreground-2); }
.ws-task-meta      { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-top: 6px; }
.ws-task-toggle    { padding: 4px 10px; border: 1px solid var(--border); font-family: var(--font-label); font-size: 9px; background: transparent; color: var(--foreground-muted); cursor: pointer; transition: var(--t-snap); letter-spacing: 1px; }
.ws-task-toggle:hover  { border-color: rgba(0,255,136,.3); color: var(--foreground-2); }
.ws-task-toggle.active { background: rgba(0,255,136,.07); border-color: var(--accent); color: var(--accent); }
.ws-task-long-badge    { font-family: var(--font-label); font-size: 9px; color: var(--accent); background: rgba(0,255,136,.08); padding: 2px 7px; border: 1px solid rgba(0,255,136,.2); letter-spacing: 1px; }

.ws-ai-sort-row   { display: flex; align-items: center; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
.ws-ai-sort-btn   { padding: 5px 12px; border: 1px solid rgba(0,212,255,.3); font-family: var(--font-label); font-size: 9px; background: transparent; color: var(--accent-tertiary); cursor: pointer; transition: var(--t-snap); letter-spacing: 1px; }
.ws-ai-sort-btn:hover { border-color: var(--accent-tertiary); background: rgba(0,212,255,.07); }
.ws-ai-sorted      { margin-top: 12px; }
.ws-ai-sorted-title{ font-family: var(--font-label); font-size: 9px; color: var(--accent-tertiary); letter-spacing: 3px; text-transform: uppercase; margin-bottom: 10px; }
.ws-ai-task-order  { display: flex; flex-direction: column; gap: 6px; }
.ws-ai-task-item   { display: flex; align-items: flex-start; gap: 10px; padding: 8px 10px; background: var(--muted); border: 1px solid var(--border); }
.ws-ai-task-num    { width: 18px; height: 18px; background: rgba(0,255,136,.08); border: 1px solid rgba(0,255,136,.3); display: flex; align-items: center; justify-content: center; font-family: var(--font-label); font-size: 9px; color: var(--accent); flex-shrink: 0; }
.ws-ai-task-text   { font-size: 13px; color: var(--foreground); flex: 1; line-height: 1.5; }
.ws-ai-task-reason { font-size: 11px; color: var(--foreground-muted); line-height: 1.6; margin-top: 2px; }
.ws-ai-task-tag    { font-family: var(--font-label); font-size: 9px; padding: 2px 6px; flex-shrink: 0; margin-top: 2px; letter-spacing: 1px; }
.ws-ai-task-tag.long  { background: rgba(0,255,136,.07);  color: var(--accent);          border: 1px solid rgba(0,255,136,.2); }
.ws-ai-task-tag.short { background: rgba(0,212,255,.07); color: var(--accent-tertiary); border: 1px solid rgba(0,212,255,.2); }

/* ──────────────────────────────────────────
   GLITCH / CYBER EFFECTS CLASSES
────────────────────────────────────────── */
.cyber-glitch {
  position: relative;
  animation: rgbShift 4s ease-in-out infinite;
}
.cyber-glitch::before {
  content: attr(data-text);
  position: absolute; inset: 0;
  color: rgba(255,0,255,.4);
  clip-path: polygon(0 20%, 100% 20%, 100% 40%, 0 40%);
  transform: translate(-2px, 0);
  animation: glitch 7s steps(1) infinite;
}
.cyber-glitch::after {
  content: attr(data-text);
  position: absolute; inset: 0;
  color: rgba(0,212,255,.4);
  clip-path: polygon(0 60%, 100% 60%, 100% 80%, 0 80%);
  transform: translate(2px, 0);
  animation: glitch 7s steps(1) infinite reverse;
}
.blink-cursor::after {
  content: '_'; color: var(--accent);
  animation: blink 1s step-end infinite;
}

/* ──────────────────────────────────────────
   KEYFRAMES
────────────────────────────────────────── */
@keyframes spin    { to { transform: rotate(360deg); } }
@keyframes blink   { 50% { opacity: 0; } }
@keyframes pulse   { 0%, 100% { opacity: 1; } 50% { opacity: .4; } }
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
@keyframes msgIn   { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: none; } }

@keyframes glitch {
  0%,90%,100% { transform: translate(0); clip-path: none; }
  91% { transform: translate(-3px, 2px); clip-path: polygon(0 30%, 100% 30%, 100% 50%, 0 50%); }
  93% { transform: translate(3px,-2px); clip-path: polygon(0 55%, 100% 55%, 100% 75%, 0 75%); }
  95% { transform: translate(-1px, 0); clip-path: none; }
  97% { transform: translate(1px, 1px); clip-path: polygon(0 10%, 100% 10%, 100% 25%, 0 25%); }
}

@keyframes rgbShift {
  0%,100% { text-shadow: -2px 0 rgba(255,0,255,.6), 2px 0 rgba(0,212,255,.6), 0 0 10px rgba(0,255,136,.4); }
  50%      { text-shadow:  2px 0 rgba(255,0,255,.6),-2px 0 rgba(0,212,255,.6), 0 0 10px rgba(0,255,136,.4); }
}

@keyframes scanPulse {
  0%,100% { opacity: .06; } 50% { opacity: .1; }
}

/* ──────────────────────────────────────────
   ADDITIONAL POLISH
────────────────────────────────────────── */

/* input-wrap for textarea too */
.input-wrap.ta::before { top: 12px; transform: none; }

/* Firebase info box — kill old broken var refs */
.firebase-info-box {
  margin-top: 14px; padding: 12px 14px;
  background: rgba(0,255,136,.04);
  border: 1px solid rgba(0,255,136,.15);
  clip-path: var(--chamfer-xs);
}
.firebase-info-box-title {
  font-family: var(--font-label); font-size: 10px;
  color: var(--accent); font-weight: 700;
  margin-bottom: 6px; letter-spacing: 2px;
}
.firebase-info-box p,
.firebase-info-box div { font-size: 12px; color: var(--foreground-2); line-height: 2; }

/* Holographic corner brackets — reusable */
.holo-corners { position: relative; }
.holo-corners::before,
.holo-corners::after {
  content: '';
  position: absolute;
  width: 12px; height: 12px;
  border-color: var(--accent); border-style: solid;
}
.holo-corners::before { top: 6px; left: 6px; border-width: 1px 0 0 1px; }
.holo-corners::after  { bottom: 6px; right: 6px; border-width: 0 1px 1px 0; }

/* Result sheet — polish */
.result-sheet-grid { border-top: 1px solid var(--border); }

/* Me-todo retro text */
.me-todo-retro {
  font-size: 11px; color: var(--foreground-2); margin-top: 5px;
  padding: 5px 8px; background: var(--muted);
  border-left: 2px solid var(--accent-tertiary); line-height: 1.5;
}

/* Scrollbar — neon style */
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: var(--background); }
::-webkit-scrollbar-thumb { background: rgba(0,255,136,.25); }
::-webkit-scrollbar-thumb:hover { background: rgba(0,255,136,.5); }

/* Code inline */
code {
  background: var(--muted);
  color: var(--accent);
  font-family: var(--font-mono);
  font-size: 11px;
  padding: 2px 6px;
  border: 1px solid rgba(0,255,136,.2);
}

/* Select element — neon style */
select {
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath fill='none' stroke='%2300ff88' stroke-width='1.5' d='M1 1l4 4 4-4'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  padding-right: 28px !important;
}

/* Scan line on cards on hover for holographic feel */
.me-card:hover > .me-card-head {
  background: rgba(0,255,136,.07);
}

/* Inbox header flex fix */
.inbox-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
}
.inbox-header > div { flex: 1; }

/* me-todo-list scroll neon */
.me-todo-list::-webkit-scrollbar-thumb,
.me-metrics-list::-webkit-scrollbar-thumb,
.me-result-list::-webkit-scrollbar-thumb {
  background: rgba(0,255,136,.2);
}

/* RPG check label done state */
.rpg-check-item.checked .rpg-check-label { color: var(--foreground); }

/* Commitment boxes */
.me-commitment-box,
.rs-commitment {
  background: var(--card);
  border: 1px solid rgba(0,212,255,.2);
  clip-path: var(--chamfer-xs);
  padding: 12px 14px; margin: 8px 0;
}
.me-commitment-label,
.rs-commitment-label {
  font-family: var(--font-label); font-size: 9px;
  color: var(--accent-tertiary); letter-spacing: 3px;
  text-transform: uppercase; margin-bottom: 5px;
}
.me-commitment-text,
.rs-commitment-text { font-size: 13px; color: var(--foreground); line-height: 1.7; }
.me-commitment-date,
.rs-commitment-date { font-family: var(--font-label); font-size: 9px; color: var(--foreground-muted); margin-top: 5px; letter-spacing: 1px; }

/* Reduced motion */
@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after {
    animation-duration: .01ms !important;
    transition-duration: .01ms !important;
  }
}
</style>
</head>
<body>
<!-- 잠금 화면 -->
<div id="lockScreen">
  <div class="lock-box">
    <div class="lock-icon">🔒</div>
    <div class="lock-title">나의 돌아오는 시스템</div>
    <div class="lock-sub">비밀번호를 입력해야 들어올 수 있어.</div>
    <div class="lock-inp-wrap">
      <input id="lockInp" class="lock-inp" type="password" placeholder="••••••" maxlength="20"
        onkeydown="if(event.key==='Enter')tryUnlock()">
    </div>
    <button class="lock-btn" onclick="tryUnlock()">들어가기</button>
    <div class="lock-err" id="lockErr"></div>
  </div>
</div>

<div class="tab-bar">
  <button class="tab-btn active" onclick="goTab('me')">나</button>
  <button class="tab-btn" onclick="goTab('memo')">기록</button>
  <button class="tab-btn" onclick="goTab('inbox')">인박스</button>
  <button class="tab-btn" onclick="goTab('reward')">충전</button>
  <button class="tab-btn" onclick="startCheck()">체크</button>
  <button class="tab-btn" onclick="goTab('settings')">설정</button>
</div>
<div class="sync-bar" id="syncBar">
  <div class="sync-dot" id="syncDot"></div>
  <span id="syncStatus">Firebase 미연결 — 기기 간 동기화 안 됨</span>
  <span class="firebase-user" id="fbUserLabel"></span>
</div>

<!-- 나 탭 (홈 겸용, active) -->
<div id="page-me" class="page active">
  <!-- 프로필 헤더 — 풀 화면 너비 -->
  <div class="me-header">
    <div class="me-header-inner">
      <div class="me-avatar-zone">
        <div class="me-avatar-ring" onclick="document.getElementById('avatarInp').click()">
          <canvas id="meAvatarCanvas" width="80" height="80"></canvas>
          <img id="meAvatarImg" style="display:none;width:80px;height:80px;border-radius:50%;object-fit:cover" alt="">
        </div>
        <input type="file" id="avatarInp" accept="image/*" style="display:none" onchange="onAvatarUpload(event)">
        <div class="me-level" id="meLevelBadge">Lv.1</div>
      </div>
      <div class="me-identity">
        <div class="me-class" id="meClassTag">관찰자</div>
        <input id="meNameInp" class="me-name-inp" placeholder="이름" oninput="saveProfileData()">
        <textarea id="meTaglineInp" class="me-tagline-inp" rows="1" placeholder="나를 한 줄로..." oninput="saveProfileData()"></textarea>
        <div class="me-stat-row" id="meStatRow"></div>
      </div>
      <button class="me-check-btn" onclick="startCheck()">체크 →</button>
    </div>
  </div>

  <!-- 메인 그리드 -->
  <div class="me-grid">

    <!-- RPG 스탯 패널 — 전체 너비 -->
    <div class="me-card me-rpg-card">
      <div class="me-card-head">
        <span>◉ 오늘의 상태</span>
        <span id="rpgDateLabel" class="rpg-date-label"></span>
      </div>
      <div class="rpg-stat-grid" id="rpgStatGrid"></div>
    </div>

    <!-- 오늘의 충전 카드 — 전체 너비 -->
    <div class="me-card me-charge-card">
      <div class="me-card-head">
        <span>💙 오늘의 충전</span>
        <button class="me-card-action" onclick="openTodayChargeAdd()">+ 직접 입력</button>
      </div>
      <div id="todayChargeArea" style="padding:10px 16px;display:flex;flex-wrap:wrap;gap:8px;align-items:flex-start;min-height:54px;"></div>
    </div>

    <!-- 왼쪽: 집중할일 Todo -->
    <div class="me-card me-todo-card">
      <div class="me-card-head">
        <span>◎ 지금 집중할 것</span>
        <button class="me-card-action" onclick="openTodoModal()">+ 추가</button>
      </div>
      <div id="meTodoList" class="me-todo-list"></div>
    </div>

    <!-- 중간: 성장 지표 그래프 -->
    <div class="me-card me-metrics-card">
      <div class="me-card-head">
        <span>◆ 성장 지표</span>
        <button class="me-card-action" onclick="openMetricModal(-1)">+ 추가</button>
      </div>
      <div id="meMiniMetrics" class="me-metrics-list"></div>
    </div>

    <!-- 오른쪽: 최근 결과지 + 가치관 -->
    <div class="me-card me-results-card">
      <div class="me-card-head">
        <span>▣ 최근 체크 결과</span>
        <button class="me-card-action" onclick="goTab('memo');switchSeg('seg-results',document.querySelectorAll('.seg-btn')[1])">전체 →</button>
      </div>
      <div id="meResultPreview" class="me-result-list"></div>
    </div>

    <!-- 가치관 카드들 -->
    <div class="me-card me-phil-card">
      <div class="me-card-head"><span>◈ 내 가치관</span></div>
      <div id="mePhilGrid" class="me-phil-mini-grid"></div>
    </div>

  </div>
</div>

<!-- 기록 — 세그먼트 컨트롤 -->
<div id="page-memo" class="page">
  <div class="inner">
    <div class="memo-h">
      <h2 class="cyber-glitch" data-text="나의 기록">나의 기록</h2>
      <p class="memo-sub">가치관, 깨달음, 오늘 느낀 것을 메모하는 곳.<br>기록이 매번 AI 분석에 반영된다.</p>
    </div>
    <!-- 세그먼트 -->
    <div class="seg-ctrl">
      <button class="seg-btn active" onclick="switchSeg('seg-notes',this)">메모</button>
      <button class="seg-btn" onclick="switchSeg('seg-results',this)">결과지</button>
      <button class="seg-btn" onclick="switchSeg('seg-metrics',this)">성장 지표</button>
    </div>

    <!-- 메모 패널 -->
    <div class="seg-panel active" id="seg-notes">
      <div class="memo-add">
        <textarea id="newMemoTa" style="min-height:80px" placeholder="오늘 새롭게 알게 된 것, 가치관, 깨달음..."></textarea>
        <button class="memo-add-btn" onclick="addMemoFromId('newMemoTa')">저장</button>
      </div>
      <div class="memo-list" id="memoList"></div>
    </div>

    <!-- 결과지 패널 -->
    <div class="seg-panel" id="seg-results">
      <div class="memo-list" id="resultList" style="padding-top:8px"></div>
    </div>

    <!-- 성장 지표 패널 -->
    <div class="seg-panel" id="seg-metrics">
      <div style="padding:16px 0 8px;display:flex;justify-content:flex-end">
        <button class="memo-add-btn" style="margin-top:0" onclick="openMetricModal(-1)">+ 지표 추가</button>
      </div>
      <div id="metricsPanel"></div>
    </div>
  </div>
</div>

<!-- 충전 탭 -->
<div id="page-reward" class="page">
  <div class="reward-wrap">
    <div class="reward-page-header">
      <h2 class="cyber-glitch" data-text="충전 시스템">충전 시스템</h2>
      <p>직접 해보고 알게 된 것들. 끝이 어땠는지가 기준이야.</p>
    </div>

    <!-- 진짜 원하는 것 섹션 -->
    <div class="rw-section">
      <div class="rw-sec-title real-need">
        <span>✦ 지금 진짜 필요한 게 뭐야?</span>
        <button class="rw-new-btn real-need" onclick="openRealNeedPrompt()">성찰하기</button>
      </div>
      <div id="real-need-area" class="real-need-area">
        <div class="real-need-hint">
          끌린다고 원하는 게 아닐 수 있어.<br>
          지금 내가/내 몸이 <em>진짜로</em> 필요한 게 뭔지 물어봐.
        </div>
      </div>
    </div>

    <!-- 충전 섹션 -->
    <div class="rw-section">
      <div class="rw-sec-title charge">
        <span>💙 충전 LIST</span>
        <span class="rw-sec-sub">해보니 실제로 좋았던 것</span>
        <button class="rw-new-btn charge" onclick="openRewardModal('charge')">+ 추가</button>
      </div>
      <div class="rw-cards" id="charge-items"></div>
    </div>

    <!-- 방전 섹션 -->
    <div class="rw-section">
      <div class="rw-sec-title drain">
        <span>🔴 방전 LIST</span>
        <span class="rw-sec-sub">끝이 안 좋았던 것</span>
        <button class="rw-new-btn drain" onclick="openRewardModal('drain')">+ 추가</button>
      </div>
      <div class="rw-cards" id="drain-items"></div>
    </div>
  </div>
</div>

<!-- 인박스 탭 -->
<div id="page-inbox" class="page">
  <div class="inbox-wrap">
    <div class="inbox-header">
      <div>
        <h2 class="cyber-glitch" data-text="인박스">인박스</h2>
        <p class="inbox-sub">머릿속에 넘치는 것들을 던져두는 곳.<br>나중에 정리하면 돼.</p>
      </div>
      <button class="inbox-ai-btn" onclick="runInboxAI()">✦ AI 정리</button>
    </div>

    <!-- 카테고리 필터 탭 -->
    <div class="inbox-cat-tabs" id="inboxCatTabs"></div>

    <!-- 메시지 리스트 -->
    <div class="inbox-messages" id="inboxMessages"></div>

    <!-- 입력창 — 카톡형 -->
    <div class="inbox-input-bar">
      <div class="inbox-cat-select-wrap">
        <select id="inboxCatSelect" class="inbox-cat-select"></select>
      </div>
      <textarea id="inboxInputTa" class="inbox-input-ta" rows="1"
        placeholder="지금 머릿속에 있는 것..."
        oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"
        onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendInboxItem();}"></textarea>
      <button class="inbox-send-btn" onclick="sendInboxItem()">→</button>
    </div>
  </div>
</div>

<!-- 체크 -->
<div id="page-check" class="page">
  <div class="q-outer" id="checkContent"></div>
</div>

<!-- 결과 -->
<div id="page-result" class="page">
  <div class="inner-wide" id="resultContent"></div>
</div>

<!-- 설정 -->
<div id="page-settings" class="page">
  <div class="inner" style="padding-top:8px">
    <div class="settings-wrap">
      <h2 class="settings-title cyber-glitch" data-text="설정">설정</h2>
      <p class="settings-sub">시스템의 모든 부분을 직접 수정할 수 있어.</p>

      <!-- API -->
      <div class="set-section">
        <div class="set-section-head" onclick="toggleSection('sec-api')">
          <div class="set-section-title">API 키</div>
          <div class="set-section-arrow open" id="arr-sec-api">▼</div>
        </div>
        <div class="set-section-body open" id="sec-api">
          <div class="setting-lbl">Groq API 키</div>
          <div class="input-wrap">
            <input id="apiKeyInp" class="setting-inp" type="password" placeholder="gsk_...로 시작하는 키">
          </div>
          <div class="setting-hint">
            <a href="https://console.groq.com" target="_blank">console.groq.com</a>에서 무료로 발급받을 수 있어. 키는 이 기기에만 저장돼.
          </div>
          <div class="api-status" id="apiStatus"></div>
          <div class="btn-row">
            <button class="btn-primary" onclick="saveApiKey()">저장</button>
            <button class="btn-secondary" onclick="testApiKey()">연결 테스트</button>
          </div>
          <div class="test-result" id="testResult"></div>
        </div>
      </div>

      <!-- AI 스타일 -->
      <div class="set-section">
        <div class="set-section-head" onclick="toggleSection('sec-ai')">
          <div class="set-section-title">AI 응답 스타일</div>
          <div class="set-section-arrow" id="arr-sec-ai">▼</div>
        </div>
        <div class="set-section-body" id="sec-ai">
          <div class="setting-lbl">분석 스타일</div>
          <select id="setAnalysisStyle" class="sel setting-inp" onchange="saveSettings()">
            <option value="pattern">패턴 분석 (답변들 사이의 연결고리 짚기)</option>
            <option value="direct">직접적 (보이는 것 그대로)</option>
            <option value="gentle">부드럽게 (따뜻한 톤으로)</option>
          </select>
          <div class="setting-lbl">행동강령 스타일</div>
          <select id="setActionStyle" class="sel setting-inp" onchange="saveSettings()">
            <option value="step">3단계 연결 (인지→행동→습관)</option>
            <option value="simple">단순 명확 (바로 할 것만)</option>
            <option value="why">이유 중심 (왜 해야 하는지 먼저)</option>
          </select>
          <div class="setting-lbl">추가 프롬프트 (선택)</div>
          <textarea id="setExtraPrompt" class="setting-ta" placeholder="AI에게 추가로 지시하고 싶은 내용. 예: '항상 구체적인 시간을 포함해줘'" oninput="saveSettings()"></textarea>
        </div>
      </div>

      <!-- 가치관 카드 편집 -->
      <div class="set-section">
        <div class="set-section-head" onclick="toggleSection('sec-phil')">
          <div class="set-section-title">가치관 카드 편집</div>
          <div class="set-section-arrow" id="arr-sec-phil">▼</div>
        </div>
        <div class="set-section-body" id="sec-phil">
          <div id="philEditList"></div>
          <button class="add-item-btn" onclick="addPhilCard()">+ 가치관 추가</button>
          <div class="btn-row" style="margin-top:14px">
            <button class="btn-primary" onclick="savePhilCards()">저장</button>
            <button class="btn-ghost" onclick="resetPhilCards()">기본값으로</button>
          </div>
        </div>
      </div>

      <!-- 질문 편집 -->
      <div class="set-section">
        <div class="set-section-head" onclick="toggleSection('sec-q')">
          <div class="set-section-title">질문 편집</div>
          <div class="set-section-arrow" id="arr-sec-q">▼</div>
        </div>
        <div class="set-section-body" id="sec-q">
          <div id="qEditList"></div>
          <button class="add-item-btn" onclick="addQuestion()">+ 질문 추가</button>
          <div class="btn-row" style="margin-top:14px">
            <button class="btn-primary" onclick="saveQuestionSet()">저장</button>
            <button class="btn-ghost" onclick="resetQuestions()">기본값으로</button>
          </div>
        </div>
      </div>

      <!-- 오늘의 상태 항목 편집 -->
      <div class="set-section">
        <div class="set-section-head" onclick="toggleSection('sec-rpg')">
          <div class="set-section-title">오늘의 상태 항목 편집</div>
          <div class="set-section-arrow" id="arr-sec-rpg">▼</div>
        </div>
        <div class="set-section-body" id="sec-rpg">
          <p class="setting-hint" style="margin-bottom:14px;line-height:1.75">나 탭의 체크 항목을 직접 수정할 수 있어. 카테고리 이름·아이콘·각 항목 텍스트를 바꾸거나, 항목을 추가/삭제할 수 있어.</p>
          <div id="rpgEditList"></div>
          <div class="btn-row" style="margin-top:14px">
            <button class="btn-primary" onclick="saveRpgStatsEdit()">저장</button>
            <button class="btn-ghost" onclick="resetRpgStats()">기본값으로</button>
          </div>
        </div>
      </div>

      <!-- 비밀번호 -->
      <div class="set-section">
        <div class="set-section-head" onclick="toggleSection('sec-pw')">
          <div class="set-section-title">🔒 비밀번호 변경</div>
          <div class="set-section-arrow" id="arr-sec-pw">▼</div>
        </div>
        <div class="set-section-body" id="sec-pw">
          <div class="setting-lbl">새 비밀번호</div>
          <div class="input-wrap">
            <input id="newPwInp" class="setting-inp" type="password" placeholder="새 비밀번호 입력">
          </div>
          <div class="setting-lbl" style="margin-top:12px">새 비밀번호 확인</div>
          <div class="input-wrap">
            <input id="newPwInp2" class="setting-inp" type="password" placeholder="한 번 더 입력">
          </div>
          <div class="btn-row" style="margin-top:12px">
            <button class="btn-primary" onclick="changePassword()">변경</button>
          </div>
          <div class="setting-hint" style="margin-top:10px">비밀번호는 이 기기 브라우저에 저장돼. 잊어버리면 아래 방법으로 초기화할 수 있어.<br><br>
          초기화: 브라우저 콘솔(F12)에서 <code style="background:var(--bg);padding:2px 6px;border-radius:4px;font-size:11px">localStorage.removeItem('app_pw')</code> 실행</div>
        </div>
      </div>

      <!-- Firebase 동기화 -->
      <div class="set-section">
        <div class="set-section-head" onclick="toggleSection('sec-firebase')">
          <div class="set-section-title">☁️ Firebase 동기화 (기기 연동)</div>
          <div class="set-section-arrow" id="arr-sec-firebase">▼</div>
        </div>
        <div class="set-section-body" id="sec-firebase">
          <p class="setting-hint" style="margin-bottom:14px;line-height:1.75">Firebase를 연결하면 폰·패드·컴퓨터 어디서든 같은 데이터를 볼 수 있어. 구글 계정으로 로그인하면 자동으로 동기화돼. <a href="https://console.firebase.google.com" target="_blank" style="color:var(--accent)">Firebase 콘솔</a>에서 프로젝트를 만들고 아래에 설정값을 넣어줘.</p>

          <div id="fbConfigForm">
            <div class="setting-lbl">Firebase 설정값</div>
            <div class="setting-hint" style="margin-bottom:10px">Firebase 콘솔 → 프로젝트 설정 → 내 앱 → 웹 앱 추가 → firebaseConfig 안의 값들</div>
            <input id="fbApiKey" class="setting-inp" type="password" placeholder="apiKey" style="margin-bottom:6px">
            <input id="fbAuthDomain" class="setting-inp" type="text" placeholder="authDomain (예: myapp.firebaseapp.com)" style="margin-bottom:6px">
            <input id="fbProjectId" class="setting-inp" type="text" placeholder="projectId" style="margin-bottom:6px">
            <div class="btn-row" style="margin-top:10px">
              <button class="btn-primary" onclick="saveFbConfig()">저장 및 연결</button>
              <button class="btn-ghost" onclick="clearFbConfig()">연결 해제</button>
            </div>
          </div>

          <div style="margin-top:16px" id="fbLoginSection" style="display:none">
            <div class="setting-lbl">로그인</div>
            <div id="fbLoginArea">
              <button class="fb-login-btn" onclick="fbGoogleLogin()">
                <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.5 0 6.6 1.2 9.1 3.2l6.8-6.8C35.8 2.5 30.2 0 24 0 14.7 0 6.8 5.4 3.1 13.4l7.9 6.2C12.9 13.2 18 9.5 24 9.5z"/><path fill="#4285F4" d="M46.5 24.5c0-1.6-.1-3.1-.4-4.5H24v8.5h12.7c-.6 3-2.3 5.5-4.8 7.2l7.5 5.8C43.6 37.4 46.5 31.4 46.5 24.5z"/><path fill="#FBBC05" d="M11 28.6C10.3 26.8 10 24.9 10 23s.4-3.8 1-5.6L3.1 11.2C1.1 15 0 19.4 0 24s1.1 9 3.1 12.8l7.9-6.2z"/><path fill="#34A853" d="M24 48c6.2 0 11.4-2 15.2-5.5l-7.5-5.8c-2 1.4-4.6 2.2-7.7 2.2-6 0-11.1-3.7-13-9.1L3.1 36.1C6.8 43.6 14.7 48 24 48z"/></svg>
                Google 계정으로 로그인
              </button>
            </div>
          </div>

          <div id="fbStatusArea" style="display:none;margin-top:12px">
            <div class="api-status">
              <div class="status-dot ok"></div>
              <span id="fbLoggedUser" style="color:var(--green)"></span>
            </div>
            <div class="btn-row" style="margin-top:10px">
              <button class="btn-secondary" onclick="fbForceSync()">지금 동기화</button>
              <button class="btn-ghost" onclick="fbLogout()">로그아웃</button>
            </div>
          </div>

          <div style="margin-top:14px;padding:12px 14px;background:rgba(0,255,136,.04);border-radius:10px">
            <div style="font-size:11px;color:var(--accent);font-weight:600;margin-bottom:6px;letter-spacing:1px">설정 방법 요약</div>
            <div style="font-size:12px;color:var(--foreground-2);line-height:2">
              1. <a href="https://console.firebase.google.com" target="_blank" style="color:var(--accent)">Firebase 콘솔</a>에서 프로젝트 새로 만들기<br>
              2. Authentication → Google 로그인 활성화<br>
              3. Firestore Database 만들기 (테스트 모드)<br>
              4. 프로젝트 설정 → 웹 앱 추가 → apiKey, authDomain, projectId 복사<br>
              5. 위 칸에 붙여넣기 후 저장 → Google 로그인
            </div>
          </div>
        </div>
      </div>

      <!-- 데이터 -->
      <div class="set-section">
        <div class="set-section-head" onclick="toggleSection('sec-data')">
          <div class="set-section-title">데이터 관리 · 백업</div>
          <div class="set-section-arrow" id="arr-sec-data">▼</div>
        </div>
        <div class="set-section-body" id="sec-data">
          <p class="setting-hint" style="margin-bottom:14px">기록을 파일로 내보내거나, 다른 기기에서 가져올 수 있어. Firebase 없이 수동 백업할 때 유용해.</p>
          <div class="export-import-row">
            <button class="btn-primary" onclick="exportData()">📥 내보내기 (JSON)</button>
            <label class="btn-secondary" style="cursor:pointer;padding:11px 16px;display:inline-block">
              📤 가져오기
              <input type="file" accept=".json" onchange="importData(event)" style="display:none">
            </label>
          </div>
          <div class="divider"></div>
          <button class="btn-danger-outline" onclick="clearAllData()">모든 기록 삭제</button>
        </div>
      </div>

    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ── 비밀번호 잠금 ─────────────────────────────────────────
const DEFAULT_PW = 'myreturn2024'; // ← 여기서 기본 비밀번호 변경 가능
const SALT = 'nds_v1_';

async function hashPw(pw){
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(SALT+pw));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

async function initLock(){
  // 저장된 해시가 없으면 기본 비밀번호로 초기화
  if(!localStorage.getItem('app_pw')){
    localStorage.setItem('app_pw', await hashPw(DEFAULT_PW));
  }
  // 세션 중 이미 인증됐으면 바로 통과
  if(sessionStorage.getItem('unlocked')==='1'){
    document.getElementById('lockScreen').style.display='none';
    return;
  }
  document.getElementById('lockInp').focus();
}

async function tryUnlock(){
  const val = document.getElementById('lockInp').value;
  const err = document.getElementById('lockErr');
  if(!val){err.textContent='비밀번호를 입력해줘';return;}
  const hash = await hashPw(val);
  const saved = localStorage.getItem('app_pw');
  if(hash === saved){
    sessionStorage.setItem('unlocked','1');
    document.getElementById('lockScreen').style.display='none';
    err.textContent='';
  } else {
    err.textContent='비밀번호가 틀렸어';
    document.getElementById('lockInp').value='';
    document.getElementById('lockInp').focus();
  }
}

async function changePassword(){
  const p1 = document.getElementById('newPwInp').value;
  const p2 = document.getElementById('newPwInp2').value;
  if(!p1){showToast('새 비밀번호를 입력해줘');return;}
  if(p1 !== p2){showToast('두 비밀번호가 달라');return;}
  if(p1.length < 4){showToast('4자 이상으로 해줘');return;}
  localStorage.setItem('app_pw', await hashPw(p1));
  document.getElementById('newPwInp').value='';
  document.getElementById('newPwInp2').value='';
  showToast('비밀번호 변경됐어!');
}

// ── 기본 데이터 ───────────────────────────────────────────
const BASE_PHIL=[
  {tag:"중심 가치",title:"행복하게 살자",body:"원하는 대로만 살아봤더니 행복하지 않았다. 한두 달 해보니 나가는 일이 없을수록 몸이 망가지고 피곤해졌다. 어차피 살 거라면 행복하게 살겠다."},
  {tag:"가짜 보상",title:"끌린다고 진짜 원하는 게 아닐 수 있다",body:"전자기기를 오래 해봤다. 끝은 항상 몸이 아프거나 더 우울했다. 하지 말라고 하니까 스트레스·회피·보상 심리로 하고 있었던 것이다. 직접 해봤을 때 끝이 어땠는지가 기준이다."},
  {tag:"생각의 실체",title:"꺼내야 실체가 생긴다",body:"머릿속에서 논문처럼 느껴지는 생각도 꺼내보면 두 줄이 된다. 실망이 아니다. 실체가 생긴 것이다. 실체가 있어야 다룰 수 있다."},
  {tag:"불안",title:"불안은 미래에 있고, 나는 지금 여기 있다",body:"걱정의 99%는 일어나지 않는다. 미래 걱정에 쓰는 에너지를 차라리 지금 할 수 있는 것에 쓰는 게 낫다."},
  {tag:"나를 대하는 방식",title:"나는 평생 나와 함께 산다",body:"아이돌 매니저처럼 냉철하게 파악하되, 그 정보는 나를 발전시키는 데 쓴다. 부족한 점은 나를 공격하기 위한 게 아니라 성장시키기 위해 있는 것이다."},
  {tag:"노력",title:"노력은 배신하지 않는다",body:"안 좋은 일이 생기거나 당장 변화가 없어도 쌓이고 있다. 치열하게 1분 1초 고민하는 것도 나를 성장시키고 있다."},
];
const BASE_QUESTIONS=[
  {id:'mood',cat:'지금 상태',text:'지금 기분이나 상태를 솔직하게 표현하면?',sub:'좋다, 무기력하다, 불안하다, 모르겠다 — 뭐든 괜찮아.',type:'ta'},
  {id:'body',cat:'몸 상태',text:'지금 몸은 어때?',sub:'잠, 피로도, 아픈 곳, 밥은 먹었는지.',type:'opts',opts:['괜찮아','좀 피곤하거나 찌뿌둥해','확실히 안 좋아']},
  {id:'reality',cat:'현실 상황',text:'지금 현실에서 내 상황은 어때?',sub:'요즘 어떻게 지내고 있는지. 생활 루틴, 사람들과의 관계, 학교나 일, 돈, 뭐든. 지금 내 포지션이 어디쯤인지 꺼내봐.',type:'ta'},
  {id:'tasks',cat:'해야 할 것들',text:'지금 해야 하는데 못 하고 있거나 다가오는 일이 있어?',sub:'급한 것, 미루고 있는 것, 곧 닥칠 일정. 작은 거라도 머릿속에 걸려 있으면 꺼내봐.',type:'ta'},
  {id:'avoidance',cat:'행동 패턴',text:'지금 피하거나 오래 붙잡고 있는 게 있어?',sub:'전자기기, 유튜브, 게임, 해야 할 일 미루기 등. 있으면 뭔지, 얼마나 했는지도.',type:'ta'},
  {id:'anxiety',cat:'불안·걱정',text:'지금 머릿속을 맴도는 걱정이나 생각이 있어?',sub:'있다면 꺼내봐. 머릿속에 두면 계속 커진다.',type:'ta'},
  {id:'compare',cat:'비교·자책',text:'요즘 타인과 비교하거나 스스로를 자책하는 일이 있어?',sub:'어떤 상황에서 그런 생각이 드는지.',type:'ta'},
];
const Q_INSIGHTS={
  mood:{tag:"생각의 실체",text:"머릿속에서 논문처럼 느껴지는 것도 꺼내보면 두 줄이 된다. 지금 상태를 말로 꺼낸 것 자체가 이미 절반이다."},
  body:{
    ok:{tag:"중심 가치",text:"몸이 받쳐줄 때 할 수 있는 것들이 다르다. 지금이 그 때다."},
    warn:{tag:"중심 가치",text:"지금 느끼는 것의 일부가 몸에서 오는 것일 수 있다. 몸과 마음은 이어져 있다."},
    bad:{tag:"중심 가치",text:"몸이 먼저다. 몸이 망가진 채로 억지로 하는 건 효율이 없다는 걸 경험으로 알잖아."}
  },
  reality:{tag:"생각의 실체",text:"지금 내 상황을 꺼내보는 것 자체가 이미 현실을 직시하는 거야. 머릿속에서 흐릿하게 두면 실체가 없다."},
  tasks:{tag:"불안",text:"머릿속에 걸려 있는 것들은 꺼내야 크기가 보인다. 해야 할 일은 생각 속에선 항상 실제보다 크게 느껴져."},
  avoidance:{tag:"가짜 보상",text:"끌린다고 원하는 게 아닐 수 있다. 직접 해봤을 때 끝이 어땠는지 기억하면 답이 나온다."},
  anxiety:{tag:"불안",text:"걱정의 99%는 일어나지 않는다. 꺼내보면 생각보다 단순한 경우가 많아."},
  compare:{tag:"나를 대하는 방식",text:"비교할 때 내가 왜 지금 이 노력을 하고 있는지 근본적인 이유를 다시 떠올려봐."},
};

// ── 상태 ─────────────────────────────────────────────────
let API_KEY=localStorage.getItem('groq_key')||'';
let memos=JSON.parse(localStorage.getItem('memos_v5')||'[]');
let philCards=JSON.parse(localStorage.getItem('phil_cards')||'null')||JSON.parse(JSON.stringify(BASE_PHIL));
let questionSet=JSON.parse(localStorage.getItem('question_set')||'null')||JSON.parse(JSON.stringify(BASE_QUESTIONS));
let aiSettings=JSON.parse(localStorage.getItem('ai_settings')||'{}');
let questions=[],curQ=0,answers={};
let lastResult=null; // 결과 저장용

window.onload=()=>{renderMemos();renderResultList();renderApiStatus();loadSavedKey();loadAiSettings();renderPhilEdit();renderQEdit();initRewardData();renderRewards();renderMetricsPanel();initMeTab();renderMeTab();renderInboxCatSelect&&renderInboxCatSelect();};

// ── 탭 ───────────────────────────────────────────────────
function goTab(t){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+t).classList.add('active');
  ['me','memo','inbox','reward','check','settings'].forEach((n,i)=>{
    if(n===t)document.querySelectorAll('.tab-btn')[i].classList.add('active');
  });
  if(t==='me'){
    // todoItems 최신화 후 렌더
    todoItems=JSON.parse(localStorage.getItem('todo_items')||'[]');
    renderMeTab();
  }
  if(t==='memo'){renderMemos();renderResultList();renderMetricsPanel();}
  if(t==='reward')renderRewards();
  if(t==='inbox'){renderInbox();}
  if(t==='settings'){renderRpgStatsEdit&&renderRpgStatsEdit();}
}

// ── 나 탭 ────────────────────────────────────────────────
let profileData=JSON.parse(localStorage.getItem('profile_data')||'{}');


// ══════════════════════════════════════════════════════════════
// RPG 스탯 시스템 — 관찰 기반 EMA
// ══════════════════════════════════════════════════════════════
const RPG_STATS_DEFAULT = [
  {
    id:'body', label:'Body', icon:'💧', colorClass:'body',
    checks:[
      {id:'water',   label:'물 충분히 마셨나'},
      {id:'move',    label:'몸을 움직였나'},
      {id:'meal',    label:'밥 챙겨먹었나'},
    ]
  },
  {
    id:'energy', label:'Energy', icon:'⚡', colorClass:'energy',
    checks:[
      {id:'rest',    label:'진짜 쉰 시간이 있었나'},
      {id:'recharge',label:'충전되는 느낌이 들었나'},
    ]
  },
  {
    id:'mind', label:'Mind', icon:'🧠', colorClass:'mind',
    checks:[
      {id:'flow',    label:'뭔가에 몰입한 순간이 있었나'},
      {id:'start',   label:'미루던 걸 하나라도 시작했나'},
    ]
  },
  {
    id:'bond', label:'Bond', icon:'🤝', colorClass:'bond',
    checks:[
      {id:'talk',    label:'의미있는 대화를 했나'},
      {id:'connect', label:'연결감을 느꼈나'},
    ]
  },
];

function getRpgStats(){
  const saved = localStorage.getItem('rpg_stats_v1');
  if(saved){try{return JSON.parse(saved);}catch(e){}}
  return JSON.parse(JSON.stringify(RPG_STATS_DEFAULT));
}
function saveRpgStats(stats){
  localStorage.setItem('rpg_stats_v1', JSON.stringify(stats));
}

// 이하 코드에서 RPG_STATS 참조를 getRpgStats()로 대체할 수 없으므로
// 런타임에 사용하는 변수 RPG_STATS를 동적으로 유지
let RPG_STATS = getRpgStats();

// 저장 형식: { 'YYYY-MM-DD': { water: 1|0|-1, move: 1|0|-1, ... } }
// 1=예, 0=아니오, -1=모르겠음, undefined=미체크
function getRpgData(){
  return JSON.parse(localStorage.getItem('rpg_obs_v1')||'{}');
}
function saveRpgData(d){
  localStorage.setItem('rpg_obs_v1',JSON.stringify(d));
}
function getTodayKey(){
  const n=new Date();
  return n.getFullYear()+'-'+String(n.getMonth()+1).padStart(2,'0')+'-'+String(n.getDate()).padStart(2,'0');
}

// EMA 계산: 최근 30일 데이터 기반
// 오늘 체크 없으면 자연 감소(×0.92), 예=1, 아니오=0, 모르겠음=유지
function calcEma(checkId){
  const data=getRpgData();
  const today=getTodayKey();
  // 최근 30일 날짜 배열 (오늘 제외, 오래된 순)
  const days=[];
  for(let i=29;i>=1;i--){
    const d=new Date(); d.setDate(d.getDate()-i);
    days.push(d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0'));
  }
  let ema=0.5; // 초기값 50%
  days.forEach(day=>{
    const val=data[day]&&data[day][checkId];
    if(val===1)       ema=ema*0.75+0.25;      // 예 → 올라감
    else if(val===0)  ema=ema*0.75;            // 아니오 → 내려감
    else if(val===-1) /* 모르겠음 → 유지 */ {}
    else              ema=ema*0.92;            // 미체크 → 천천히 감소
  });
  // 오늘 체크 반영
  const todayVal=data[today]&&data[today][checkId];
  if(todayVal===1)      ema=ema*0.75+0.25;
  else if(todayVal===0) ema=ema*0.75;
  else if(todayVal===undefined) ema=ema*0.97; // 오늘 아직 미체크 — 약간만 감소
  return Math.min(1,Math.max(0,ema));
}

function calcStatEma(statId){
  const stat=RPG_STATS.find(s=>s.id===statId);
  if(!stat)return 0;
  const vals=stat.checks.map(c=>calcEma(c.id));
  return vals.reduce((a,b)=>a+b,0)/vals.length;
}

function rpgCycleCheck(checkId){
  const data=getRpgData();
  const today=getTodayKey();
  if(!data[today])data[today]={};
  const cur=data[today][checkId];
  // 순환: undefined → 1(예) → 0(아니오) → -1(모르겠음) → undefined
  if(cur===undefined)       data[today][checkId]=1;
  else if(cur===1)          data[today][checkId]=0;
  else if(cur===0)          data[today][checkId]=-1;
  else                      delete data[today][checkId];
  saveRpgData(data);
  renderRpgStats();
}

function renderRpgStats(){
  RPG_STATS=getRpgStats();
  const el=document.getElementById('rpgStatGrid');if(!el)return;
  const data=getRpgData();
  const today=getTodayKey();
  const todayData=data[today]||{};
  // 날짜 표시
  const dlbl=document.getElementById('rpgDateLabel');
  if(dlbl){
    const d=new Date();
    dlbl.textContent=d.getMonth()+1+'월 '+d.getDate()+'일 관찰';
  }

  el.innerHTML=RPG_STATS.map(stat=>{
    const ema=calcStatEma(stat.id);
    const pct=Math.round(ema*100);
    // 트렌드 아이콘
    const trend=pct>=70?'▲':pct>=40?'—':'▽';
    const trendColor=pct>=70?'#3dac60':pct>=40?'#c9a84c':'#e05555';

    const checksHtml=stat.checks.map(c=>{
      const val=todayData[c.id];
      let btnClass='rpg-check-btn '+stat.colorClass;
      let btnTxt='';
      let itemClass='rpg-check-item';
      if(val===1){btnClass+=' yes';btnTxt='✓';itemClass+=' checked';}
      else if(val===0){btnClass='rpg-check-btn no';btnTxt='✗';}
      else if(val===-1){btnTxt='?';}
      return `<div class="${itemClass}" onclick="rpgCycleCheck('${c.id}')">
        <div class="${btnClass}">${btnTxt}</div>
        <span class="rpg-check-label">${c.label}</span>
      </div>`;
    }).join('');

    return `<div class="rpg-stat-col">
      <div class="rpg-stat-header">
        <span class="rpg-stat-icon">${stat.icon}</span>
        <span class="rpg-stat-name">${stat.label}</span>
        <span class="rpg-stat-ema" style="color:${trendColor}">${pct}% <span class="rpg-ema-trend">${trend}</span></span>
      </div>
      <div class="rpg-bar-track"><div class="rpg-bar-fill ${stat.colorClass}" style="width:${pct}%"></div></div>
      <div class="rpg-checks">${checksHtml}</div>
    </div>`;
  }).join('');
}

function initMeTab(){
  profileData=JSON.parse(localStorage.getItem('profile_data')||'{}');
  const nameInp=document.getElementById('meNameInp');
  const tagInp=document.getElementById('meTaglineInp');
  if(nameInp)nameInp.value=profileData.name||'';
  if(tagInp)tagInp.value=profileData.tagline||'';
  // todoItems 최신화
  todoItems=JSON.parse(localStorage.getItem('todo_items')||'[]');
  if(profileData.avatar){
    const img=document.getElementById('meAvatarImg');
    const canvas=document.getElementById('meAvatarCanvas');
    if(img){img.src=profileData.avatar;img.style.display='block';}
    if(canvas)canvas.style.display='none';
  } else {
    drawMeAvatar(profileData.name||'나');
  }
}

function drawMeAvatar(name){
  const canvas=document.getElementById('meAvatarCanvas');
  if(!canvas)return;
  const ctx=canvas.getContext('2d');
  const colors=['#c9a84c','#b8956a','#a07850','#8a6040'];
  const bg=colors[(name.charCodeAt(0)||65)%colors.length];
  ctx.clearRect(0,0,72,72);
  ctx.fillStyle=bg;ctx.beginPath();ctx.arc(36,36,36,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='rgba(255,255,255,.15)';ctx.beginPath();ctx.arc(36,36,36,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#ff2d6b';ctx.font='bold 26px JetBrains Mono,monospace';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText((name||'나')[0],36,37);
}

function saveProfileData(){
  const nameEl=document.getElementById('meNameInp');
  const tagEl=document.getElementById('meTaglineInp');
  profileData.name=(nameEl?nameEl.value:'')||'나';
  profileData.tagline=tagEl?tagEl.value:'';
  localStorage.setItem('profile_data',JSON.stringify(profileData));
  // 아바타 이름 글자 즉시 갱신 (사진 없을 때만)
  if(!profileData.avatar) drawMeAvatar(profileData.name);
}

function onAvatarUpload(e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    profileData.avatar=ev.target.result;
    localStorage.setItem('profile_data',JSON.stringify(profileData));
    const img=document.getElementById('meAvatarImg');
    const canvas=document.getElementById('meAvatarCanvas');
    if(img){img.src=ev.target.result;img.style.display='block';}
    if(canvas)canvas.style.display='none';
  };
  reader.readAsDataURL(file);
}

function renderMeTab(){
  profileData=JSON.parse(localStorage.getItem('profile_data')||'{}');
  const results=memos.filter(m=>m.type==='result');
  const checkCount=results.length;

  // 레벨 & 직책
  const lv=Math.max(1,Math.floor(checkCount/5)+1);
  const lvEl=document.getElementById('meLevelBadge');
  if(lvEl)lvEl.textContent=`Lv.${lv}`;
  const titles=['관찰자','기록자','탐색자','각성자','귀환자'];
  const classEl=document.getElementById('meClassTag');
  if(classEl)classEl.textContent=titles[Math.min(Math.floor(checkCount/5),titles.length-1)];

  // 이름/태그라인 — 항상 저장된 값으로 동기화 (포커스 중인 필드 제외)
  const nameInp=document.getElementById('meNameInp');
  const tagInp=document.getElementById('meTaglineInp');
  if(nameInp&&document.activeElement!==nameInp)nameInp.value=profileData.name||'';
  if(tagInp&&document.activeElement!==tagInp)tagInp.value=profileData.tagline||'';

  // 아바타
  if(profileData.avatar){
    const img=document.getElementById('meAvatarImg');
    const canvas=document.getElementById('meAvatarCanvas');
    if(img){img.src=profileData.avatar;img.style.display='block';}
    if(canvas)canvas.style.display='none';
  } else {
    drawMeAvatar(profileData.name||'나');
  }

  // 스탯
  const statEl=document.getElementById('meStatRow');
  if(statEl){
    const md=JSON.parse(localStorage.getItem('metrics_v1')||'[]');
    const rd=JSON.parse(localStorage.getItem('reward_data')||'{"charge":[],"drain":[]}');
    const td=JSON.parse(localStorage.getItem('todo_items')||'[]');
    statEl.innerHTML=[
      {v:checkCount,l:'체크인'},
      {v:td.filter(t=>!t.done).length,l:'할 일'},
      {v:(rd.charge||[]).length,l:'충전'},
      {v:md.length,l:'지표'},
    ].map(s=>`<div class="me-stat"><div class="me-stat-v">${s.v}</div><div class="me-stat-l">${s.l}</div></div>`).join('');
  }

  renderMeTodo();
  renderMeMetrics();
  renderMeResults();
  renderMePhil();
  renderRpgStats();
  renderTodayCharge();
}

// ── Todo ────────────────────────────────────────────────
let todoItems=JSON.parse(localStorage.getItem('todo_items')||'[]');

function saveTodos(){
  localStorage.setItem('todo_items',JSON.stringify(todoItems));
}

function renderMeTodo(){
  const el=document.getElementById('meTodoList');if(!el)return;
  const active=todoItems.filter(t=>!t.done);
  const done=todoItems.filter(t=>t.done);
  const all=[...active,...done];
  if(all.length===0){
    el.innerHTML=`<div class="me-todo-empty">집중할 일이 없어.<br>체크 탭에서 Task를 입력하면<br>여기 자동으로 올라와.</div>`;
    return;
  }
  el.innerHTML=all.map(t=>{
    const realIdx=todoItems.indexOf(t);
    const tagClass=t.priority==='high'?'high':t.priority==='mid'?'mid':'low';
    const tagLabel=t.priority==='high'?'🔴 핵심':t.priority==='mid'?'🟡 일반':'🟢 여유';

    // 막힌 이유 태그
    const blockLabels={fear:'😨 두려움',boring:'😑 귀찮음',unclear:'❓ 불명확',energy:'🔋 에너지 없음',waiting:'⏸ 기다리는 것 있음'};
    const blockTag=t.blockReason?`<span class="me-todo-block-tag">${blockLabels[t.blockReason]||t.blockReason}</span>`:'';

    // 에너지 요구도
    const energyLabels={high:'⚡ 고집중',mid:'🔆 중간',low:'☁ 루틴'};
    const energyClass=t.energyReq||'';
    const energyTag=t.energyReq?`<span class="me-todo-energy-tag ${energyClass}">${energyLabels[t.energyReq]||''}</span>`:'';

    // 실행 트리거
    const triggerHtml=t.trigger?`<div class="me-todo-trigger">▷ ${esc(t.trigger)}</div>`:'';

    // 완료 회고
    const retroHtml=t.done&&t.retro?`<div class="me-todo-retro">💬 ${esc(t.retro)}</div>`:'';

    const metaHtml=(blockTag||energyTag)?`<div class="me-todo-meta">${blockTag}${energyTag}</div>`:'';

    // 하위항목
    const subs=t.subItems||[];
    const doneSubCount=subs.filter(s=>s.done).length;
    const subCountHtml=subs.length>0?`<span class="me-todo-sub-count has">${doneSubCount}/${subs.length}</span>`:'';
    const subItemsHtml=subs.length>0?`<div class="me-todo-subitems">${subs.map((s,si)=>`<div class="me-todo-subitem${s.done?' done':''}" onclick="event.stopPropagation();toggleSubItem(${realIdx},${si})"><div class="me-todo-subcheck">${s.done?'✓':''}</div><span class="me-todo-subtext">${esc(s.text)}</span><button class="me-todo-subdel" onclick="event.stopPropagation();deleteSubItem(${realIdx},${si})">×</button></div>`).join('')}</div>`:'';
    const addSubHtml=`<button class="me-todo-add-sub" onclick="event.stopPropagation();addSubItemInline(${realIdx},this)">＋ 하위 항목 추가</button>`;

    return `<div class="me-todo-item${t.done?' done':''}" onclick="toggleTodo(${realIdx})">
      <div class="me-todo-check">${t.done?'✓':''}</div>
      <div style="flex:1;min-width:0">
        <div style="display:flex;align-items:flex-start;gap:6px">
          <div class="me-todo-text" style="flex:1">${esc(t.text)}${t.longTask?'<span style="font-size:9px;margin-left:5px;opacity:.6">⏳</span>':''}</div>
          ${subCountHtml}
          ${t.priority?`<span class="me-todo-tag ${tagClass}">${tagLabel}</span>`:''}
        </div>
        ${metaHtml}
        ${triggerHtml}
        ${retroHtml}
        ${subItemsHtml}
        ${addSubHtml}
      </div>
      <button class="me-todo-edit-btn" onclick="event.stopPropagation();openTodoEdit(${realIdx})">✎</button>
      <button class="me-todo-del" onclick="event.stopPropagation();deleteTodo(${realIdx})">×</button>
    </div>`;
  }).join('');
}

function toggleTodo(idx){
  const t=todoItems[idx];
  if(!t)return;
  const wasActive=!t.done;
  t.done=!t.done;
  saveTodos();
  renderMeTodo();
  // 완료 전환 시 회고 팝업 (짧게)
  if(wasActive&&t.done){
    openRetroModal(idx);
  }
  // 스탯 갱신
  const statEl=document.getElementById('meStatRow');
  if(statEl){
    const activeCount=todoItems.filter(t=>!t.done).length;
    const vEls=statEl.querySelectorAll('.me-stat-v');
    if(vEls[1])vEls[1].textContent=activeCount;
  }
}

function openRetroModal(idx){
  const t=todoItems[idx];if(!t)return;
  makeModal(`
    <div class="retro-modal-title">✓ 완료!</div>
    <div class="retro-modal-task">${esc(t.text)}</div>
    <div class="todo-edit-section">
      <div class="todo-edit-section-title">어떻게 됐어?</div>
      <textarea id="retroTa" class="nds-ta" rows="2" placeholder="짧게 한 줄 — 어떻게 됐는지, 얼마나 걸렸는지..."></textarea>
    </div>
    <div class="nds-btn-row">
      <button class="nds-btn-primary" onclick="saveRetro(${idx})">기록하기</button>
      <button class="nds-btn-ghost" onclick="this.closest('.nds-modal').remove()">넘어가기</button>
    </div>
  `);
}

function saveRetro(idx){
  const val=document.getElementById('retroTa')?.value.trim();
  if(val&&todoItems[idx]){
    todoItems[idx].retro=val;
    saveTodos();
    renderMeTodo();
  }
  document.querySelector('.nds-modal')?.remove();
}

function deleteTodo(idx){
  todoItems.splice(idx,1);
  saveTodos();
  renderMeTodo();
}

// ── 하위항목 (Sub-items) ─────────────────────────────────────
function toggleSubItem(todoIdx,subIdx){
  const t=todoItems[todoIdx];if(!t||!t.subItems)return;
  t.subItems[subIdx].done=!t.subItems[subIdx].done;
  saveTodos();renderMeTodo();
}

function deleteSubItem(todoIdx,subIdx){
  const t=todoItems[todoIdx];if(!t||!t.subItems)return;
  t.subItems.splice(subIdx,1);
  saveTodos();renderMeTodo();
}

function addSubItemInline(todoIdx,btnEl){
  const existing=btnEl.parentNode.querySelector('.me-todo-sub-inline');
  if(existing){existing.querySelector('input')&&existing.querySelector('input').focus();return;}
  const wrap=document.createElement('div');
  wrap.className='me-todo-sub-inline';
  wrap.style.cssText='display:flex;gap:5px;margin-top:4px;';
  wrap.innerHTML='<input type="text" placeholder="하위 항목 입력 후 Enter" style="flex:1;padding:5px 8px;border:1px solid var(--accent);border-radius:6px;font-family:inherit;font-size:12px;background:var(--surface);color:var(--text);outline:none;"><button style="padding:4px 8px;background:var(--accent);color:#fff;border:none;border-radius:6px;font-size:11px;cursor:pointer;font-family:inherit;">추가</button>';
  btnEl.parentNode.insertBefore(wrap,btnEl);
  const inp=wrap.querySelector('input');
  const addBtn=wrap.querySelector('button');
  inp.focus();
  const commit=()=>{
    const text=inp.value.trim();if(!text){wrap.remove();return;}
    const t=todoItems[todoIdx];if(!t)return;
    if(!t.subItems)t.subItems=[];
    t.subItems.push({id:Date.now(),text:text,done:false});
    saveTodos();renderMeTodo();
  };
  inp.addEventListener('keydown',function(e){if(e.key==='Enter'){e.preventDefault();commit();}if(e.key==='Escape')wrap.remove();});
  addBtn.addEventListener('click',function(e){e.stopPropagation();commit();});
}

// 인박스 → 특정 할일의 하위항목으로 추가
function sendToSubItem(inboxIdx){
  todoItems=JSON.parse(localStorage.getItem('todo_items')||'[]');
  if(todoItems.length===0){showToast('먼저 할일을 만들어줘');return;}
  const m=inboxItems[inboxIdx];if(!m)return;
  const active=todoItems.filter(function(t){return !t.done;});
  // DOM으로 모달 생성 (따옴표 충돌 방지)
  const wrap=document.createElement('div');
  wrap.innerHTML='<div class="nds-modal-title">어떤 할일의 하위 항목으로?</div>'
    +'<div style="font-size:12px;color:var(--textF);margin-bottom:12px">「'+esc(m.text)+'」를 어디에 추가할까?</div>';
  const listDiv=document.createElement('div');
  listDiv.style.cssText='max-height:280px;overflow-y:auto;';
  if(active.length===0){
    listDiv.innerHTML='<div style="color:var(--textF);font-size:13px;padding:12px 0;text-align:center">완료되지 않은 할일이 없어</div>';
  } else {
    active.forEach(function(t){
      const realIdx=todoItems.indexOf(t);
      const btn=document.createElement('button');
      btn.style.cssText='display:flex;align-items:center;gap:8px;width:100%;padding:9px 12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;font-family:inherit;font-size:13px;text-align:left;cursor:pointer;margin-bottom:6px;transition:border-color .15s;';
      btn.innerHTML='<span style="font-size:16px">📌</span><span style="flex:1;color:var(--text)">'+esc(t.text)+'</span>';
      btn.onmouseover=function(){this.style.borderColor='var(--accent)';};
      btn.onmouseout=function(){this.style.borderColor='var(--border)';};
      btn.onclick=function(){confirmSendToSub(inboxIdx,realIdx);};
      listDiv.appendChild(btn);
    });
  }
  wrap.appendChild(listDiv);
  const btnRow=document.createElement('div');
  btnRow.className='nds-btn-row';
  btnRow.style.marginTop='8px';
  const cancelBtn=document.createElement('button');
  cancelBtn.className='nds-btn-ghost';
  cancelBtn.textContent='취소';
  cancelBtn.onclick=function(){document.querySelector('.nds-modal')&&document.querySelector('.nds-modal').remove();};
  btnRow.appendChild(cancelBtn);
  wrap.appendChild(btnRow);
  makeModal(wrap);
}

function confirmSendToSub(inboxIdx,todoIdx){
  const m=inboxItems[inboxIdx];if(!m)return;
  const t=todoItems[todoIdx];if(!t)return;
  if(!t.subItems)t.subItems=[];
  if(t.subItems.find(function(s){return s.text===m.text;})){
    showToast('이미 하위 항목에 있어');
    document.querySelector('.nds-modal')&&document.querySelector('.nds-modal').remove();
    return;
  }
  t.subItems.push({id:Date.now(),text:m.text,done:false});
  saveTodos();
  inboxItems[inboxIdx].done=true;
  saveInboxData();renderInboxMessages();renderInboxCatTabs();
  renderMeTodo();
  document.querySelector('.nds-modal')&&document.querySelector('.nds-modal').remove();
  showToast('「'+t.text+'」의 하위 항목으로 추가됐어!');
}


// ══════════════════════════════════════════════════════════════
// 오늘의 충전 (나 탭)
// ══════════════════════════════════════════════════════════════
function getTodayChargeKey(){
  const n=new Date();
  return 'todaycharge_'+n.getFullYear()+'_'+(n.getMonth()+1)+'_'+n.getDate();
}
function getTodayCharges(){
  return JSON.parse(localStorage.getItem(getTodayChargeKey())||'[]');
}
function saveTodayCharges(arr){
  localStorage.setItem(getTodayChargeKey(),JSON.stringify(arr));
}

function renderTodayCharge(){
  const el=document.getElementById('todayChargeArea');if(!el)return;
  const charges=getTodayCharges();
  const rewardData=JSON.parse(localStorage.getItem('reward_data')||'{"charge":[],"drain":[]}');
  const chargeList=(rewardData.charge||[]).map(function(c){return c.name;});

  el.innerHTML='';

  if(charges.length===0&&chargeList.length===0){
    const hint=document.createElement('span');
    hint.style.cssText='font-size:12px;color:var(--textF);padding:4px 0';
    hint.textContent='오늘 충전한 것을 추가해봐 — 충전탭의 목록에서 바로 고를 수 있어';
    el.appendChild(hint);
    return;
  }

  // 이미 추가된 것들 (칩)
  charges.forEach(function(c,i){
    const chip=document.createElement('span');
    chip.className='charge-chip done';
    chip.textContent=c;
    const del=document.createElement('button');
    del.className='charge-chip-del';
    del.textContent='×';
    del.onclick=(function(idx){return function(e){e.stopPropagation();removeTodayCharge(idx);};})(i);
    chip.appendChild(del);
    el.appendChild(chip);
  });

  // 충전 목록에서 아직 안 고른 것들
  const notAdded=chargeList.filter(function(n){return charges.indexOf(n)===-1;});
  notAdded.forEach(function(name){
    const btn=document.createElement('button');
    btn.className='charge-list-btn';
    btn.title='탭해서 추가';
    btn.textContent='+'+name;
    btn.onclick=(function(n){return function(){addTodayCharge(n);};})(name);
    el.appendChild(btn);
  });
}

function addTodayCharge(name){
  const arr=getTodayCharges();
  if(arr.indexOf(name)===-1)arr.push(name);
  saveTodayCharges(arr);
  renderTodayCharge();
}

function removeTodayCharge(idx){
  const arr=getTodayCharges();
  arr.splice(idx,1);
  saveTodayCharges(arr);
  renderTodayCharge();
}

function openTodayChargeAdd(){
  const wrap=document.createElement('div');
  wrap.innerHTML='<div class="nds-modal-title">오늘 충전한 것 추가</div>'
    +'<div class="nds-field"><div class="nds-field-label">뭘 했어?</div>'
    +'<input id="chargeAddInp" class="nds-inp" placeholder="예: 산책, 좋아하는 음악, 낮잠..."></div>';
  const btnRow=document.createElement('div');
  btnRow.className='nds-btn-row';
  const ok=document.createElement('button');
  ok.className='nds-btn-primary';ok.textContent='추가';
  ok.onclick=confirmTodayChargeAdd;
  const cancel=document.createElement('button');
  cancel.className='nds-btn-ghost';cancel.textContent='취소';
  cancel.onclick=function(){document.querySelector('.nds-modal')&&document.querySelector('.nds-modal').remove();};
  btnRow.appendChild(ok);btnRow.appendChild(cancel);
  wrap.appendChild(btnRow);
  makeModal(wrap);
}

function confirmTodayChargeAdd(){
  const val=document.getElementById('chargeAddInp')&&document.getElementById('chargeAddInp').value.trim();
  if(!val){showToast('내용을 입력해줘');return;}
  addTodayCharge(val);
  document.querySelector('.nds-modal')&&document.querySelector('.nds-modal').remove();
  showToast('추가됐어!');
}

// ══════════════════════════════════════════════════════════════
// 설정 탭 — RPG 상태 항목 편집
// ══════════════════════════════════════════════════════════════
function renderRpgStatsEdit(){
  const el=document.getElementById('rpgEditList');if(!el)return;
  const stats=getRpgStats();
  el.innerHTML=stats.map(function(stat,si){
    const checksHtml=stat.checks.map(function(c,ci){
      return '<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;">'
        +'<input class="setting-inp" style="flex:1;padding:7px 10px;font-size:12px;" value="'+esc(c.label)+'" id="rpgCheck_'+si+'_'+ci+'">'
        +'<button onclick="deleteRpgCheck('+si+','+ci+')" style="padding:5px 10px;border:1px solid var(--border);border-radius:6px;background:none;color:var(--textF);font-size:12px;cursor:pointer;">삭제</button>'
        +'</div>';
    }).join('');
    return '<div style="margin-bottom:20px;padding:14px;background:rgba(0,255,136,.04);border-radius:10px;border:1px solid var(--border);">'
      +'<div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">'
      +'<input class="setting-inp" style="width:40px;padding:5px 8px;font-size:16px;text-align:center;" value="'+esc(stat.icon)+'" id="rpgIcon_'+si+'" maxlength="2">'
      +'<input class="setting-inp" style="flex:1;padding:7px 10px;font-size:13px;font-weight:600;" value="'+esc(stat.label)+'" id="rpgLabel_'+si+'">'
      +'</div>'
      +'<div style="font-size:11px;color:var(--textF);margin-bottom:8px;letter-spacing:1px;">체크 항목</div>'
      +checksHtml
      +'<button onclick="addRpgCheck('+si+')" style="padding:5px 12px;border:1px dashed var(--border);border-radius:6px;background:none;font-family:inherit;font-size:11px;color:var(--textF);cursor:pointer;width:100%;">+ 항목 추가</button>'
      +'</div>';
  }).join('');
}

function addRpgCheck(si){
  const stats=getRpgStats();
  if(!stats[si])return;
  const newId='custom_'+Date.now();
  stats[si].checks.push({id:newId,label:'새 항목'});
  saveRpgStats(stats);
  RPG_STATS=stats;
  renderRpgStatsEdit();
  showToast('항목 추가됐어. 텍스트를 수정하고 저장해줘');
}

function deleteRpgCheck(si,ci){
  const stats=getRpgStats();
  if(!stats[si]||!stats[si].checks[ci])return;
  if(stats[si].checks.length<=1){showToast('항목이 최소 1개는 있어야 해');return;}
  stats[si].checks.splice(ci,1);
  saveRpgStats(stats);
  RPG_STATS=stats;
  renderRpgStatsEdit();
}

function saveRpgStatsEdit(){
  const stats=getRpgStats();
  stats.forEach(function(stat,si){
    const iconEl=document.getElementById('rpgIcon_'+si);
    const labelEl=document.getElementById('rpgLabel_'+si);
    if(iconEl)stat.icon=iconEl.value.trim()||stat.icon;
    if(labelEl)stat.label=labelEl.value.trim()||stat.label;
    stat.checks.forEach(function(c,ci){
      const inp=document.getElementById('rpgCheck_'+si+'_'+ci);
      if(inp)c.label=inp.value.trim()||c.label;
    });
  });
  saveRpgStats(stats);
  RPG_STATS=stats;
  renderRpgStats();
  showToast('저장됐어!');
}

function resetRpgStats(){
  if(!confirm('기본값으로 되돌릴까? 수정한 항목들이 사라져.'))return;
  localStorage.removeItem('rpg_stats_v1');
  RPG_STATS=getRpgStats();
  renderRpgStatsEdit();
  renderRpgStats();
  showToast('기본값으로 되돌렸어');
}

function _todoModalHtml(t, isEdit){
  const p=t.priority||'high';
  const br=t.blockReason||'';
  const er=t.energyReq||'';
  const blockOpts=[
    {k:'fear',l:'😨 두려움'},
    {k:'boring',l:'😑 귀찮음'},
    {k:'unclear',l:'❓ 불명확'},
    {k:'energy',l:'🔋 에너지 없음'},
    {k:'waiting',l:'⏸ 기다리는 것 있음'},
  ];
  const energyOpts=[
    {k:'high',l:'⚡ 고집중'},
    {k:'mid',l:'🔆 중간'},
    {k:'low',l:'☁ 루틴'},
  ];
  return `
    <div class="nds-modal-title">${isEdit?'할 일 편집':'할 일 추가'}</div>
    <div class="nds-field">
      <div class="nds-field-label">할 일</div>
      <input id="todoText" class="nds-inp" placeholder="오늘 해야 할 것" value="${esc(t.text||'')}">
    </div>
    <div class="todo-edit-section">
      <div class="todo-edit-section-title">우선순위</div>
      <div style="display:flex;gap:8px">
        <button class="ws-opt${p==='high'?' sel':''}" id="prio-high" onclick="selectPrio('high')">🔴 핵심</button>
        <button class="ws-opt${p==='mid'?' sel':''}" id="prio-mid" onclick="selectPrio('mid')">🟡 일반</button>
        <button class="ws-opt${p==='low'?' sel':''}" id="prio-low" onclick="selectPrio('low')">🟢 여유</button>
      </div>
    </div>
    <div class="todo-edit-section">
      <div class="todo-edit-section-title">에너지 요구도</div>
      <div class="todo-energy-opts">
        ${energyOpts.map(o=>`<button class="todo-energy-opt${er===o.k?' sel '+o.k:''}" data-energy="${o.k}" onclick="selectTodoOpt('todoEnergyReq','${o.k}',this,'todo-energy-opt','sel '+this.dataset.energy)">${o.l}</button>`).join('')}
      </div>
      <input type="hidden" id="todoEnergyReq" value="${er}">
    </div>
    <div class="todo-edit-section">
      <div class="todo-edit-section-title">막힌 이유 (선택)</div>
      <div class="todo-block-opts">
        ${blockOpts.map(o=>`<button class="todo-block-opt${br===o.k?' sel':''}" data-block="${o.k}" onclick="selectTodoOpt('todoBlockReason','${o.k}',this,'todo-block-opt','sel')">${o.l}</button>`).join('')}
      </div>
      <input type="hidden" id="todoBlockReason" value="${br}">
    </div>
    <div class="todo-edit-section">
      <div class="todo-edit-section-title">실행 트리거 — 지금 당장 시작하면 뭐부터?</div>
      <input id="todoTrigger" class="nds-inp" placeholder="예: 노션 열기 / 이메일 초안 작성 / 전화 한 통" value="${esc(t.trigger||'')}">
    </div>
    <div class="nds-field">
      <div style="display:flex;align-items:center;gap:8px;margin-top:2px">
        <input type="checkbox" id="todoLongTask"${t.longTask?' checked':''} style="width:16px;height:16px;accent-color:var(--accent)">
        <label for="todoLongTask" style="font-size:13px;color:var(--foreground-2);cursor:pointer">⏳ 시간이 많이 필요한 일</label>
      </div>
    </div>
    ${isEdit&&(t.blockReason||t.energyReq||t.text)?`
    <div class="todo-edit-section" style="padding-top:2px">
      <button class="todo-ai-btn" onclick="runTodoAI(${t._editIdx},this)">
        ✦ AI 돌파구 제안
      </button>
      <div id="todoAiResult_${t._editIdx}" class="todo-ai-result" style="display:none"></div>
    </div>`:''}
    <div class="nds-btn-row">
      <button class="nds-btn-primary" onclick="${isEdit?`saveTodoEdit(${t._editIdx})`:'saveTodoFromModal()'}">${isEdit?'저장':'추가'}</button>
      <button class="nds-btn-ghost" onclick="this.closest('.nds-modal').remove()">취소</button>
    </div>
  `;
}

function selectTodoOpt(inputId, val, btn, btnClass, selClass){
  const cur=document.getElementById(inputId)?.value;
  // 같은 거 다시 누르면 해제 (토글)
  const next=cur===val?'':val;
  if(document.getElementById(inputId))document.getElementById(inputId).value=next;
  btn.closest('.'+btnClass+'s, .todo-block-opts, .todo-energy-opts').querySelectorAll('.'+btnClass).forEach(b=>{
    b.classList.remove('sel');
    ['high','mid','low'].forEach(k=>b.classList.remove(k));
  });
  if(next){
    btn.classList.add('sel');
    if(next==='high'||next==='mid'||next==='low') btn.classList.add(next);
  }
}

function openTodoModal(){
  makeModal(_todoModalHtml({text:'',priority:'high',trigger:'',blockReason:'',energyReq:'',longTask:false}, false));
  window._selectedPrio='high';
}

function openTodoEdit(idx){
  const t=todoItems[idx];if(!t)return;
  t._editIdx=idx;
  makeModal(_todoModalHtml(t, true));
  window._selectedPrio=t.priority||'high';
}

function saveTodoEdit(idx){
  const text=document.getElementById('todoText')?.value.trim();
  if(!text){showToast('내용을 입력해줘');return;}
  const t=todoItems[idx];if(!t)return;
  t.text=text;
  t.priority=window._selectedPrio||t.priority||'mid';
  t.trigger=document.getElementById('todoTrigger')?.value.trim()||'';
  t.blockReason=document.getElementById('todoBlockReason')?.value||'';
  t.energyReq=document.getElementById('todoEnergyReq')?.value||'';
  t.longTask=document.getElementById('todoLongTask')?.checked||false;
  saveTodos();
  document.querySelector('.nds-modal')?.remove();
  renderMeTodo();showToast('수정됐어!');
}

// ── Todo AI 돌파구 분석 ─────────────────────────────────────
async function runTodoAI(idx, btnEl){
  if(!API_KEY){
    const res=document.getElementById('todoAiResult_'+idx);
    if(res){res.style.display='block';res.innerHTML='<div style="font-size:12px;color:var(--textF)">API 키가 없어. 설정 탭에서 추가해줘.</div>';}
    return;
  }
  const t=todoItems[idx];
  if(!t)return;

  const resEl=document.getElementById('todoAiResult_'+idx);
  if(!resEl)return;
  resEl.style.display='block';
  resEl.innerHTML=`<div class="todo-ai-result-loading"><div class="spinner" style="width:14px;height:14px"></div>분석 중...</div>`;
  if(btnEl){btnEl.disabled=true;btnEl.textContent='분석 중...';}

  // 오늘 체크인 상태 (있으면)
  const stateCtx=['mood','body','energy','avoidance']
    .map(k=>wsAnswers[k]?`${k}: ${wsAnswers[k]}`:'')
    .filter(Boolean).join(', ');

  const blockLabels={fear:'두려움 (하기 싫거나 결과가 무서워)',boring:'귀찮음 (동기 부족)',unclear:'불명확 (뭘 해야 할지 모르겠음)',energy:'에너지 없음 (몸·정신이 지쳐있음)',waiting:'기다리는 것 있음 (외부 의존)'};
  const energyLabels={high:'고집중 필요',mid:'보통',low:'루틴·저에너지 가능'};

  const taskInfo=`할 일: "${t.text}"
우선순위: ${t.priority==='high'?'핵심':t.priority==='mid'?'일반':'여유'}
에너지 요구도: ${energyLabels[t.energyReq]||'미입력'}
막힌 이유: ${blockLabels[t.blockReason]||'미입력'}
실행 트리거(기존): ${t.trigger||'없음'}
장기 작업: ${t.longTask?'예':'아니오'}`;

  const retroCtx=todoItems
    .filter(ti=>ti.done&&ti.retro&&ti.text)
    .slice(0,5)
    .map(ti=>`- "${ti.text}" → ${ti.retro}`)
    .join('\n');

  const prompt=`${stateCtx?`오늘 상태: ${stateCtx}\n\n`:''}${taskInfo}

${retroCtx?`[이 사람의 최근 완료 회고]\n${retroCtx}\n\n`:''}이 할 일을 지금 실행에 옮기도록 도와줘.

출력 형식 — JSON만:
{
  "diagnosis": "막힌 이유를 한 줄로 짚어줘. 구체적으로, 일반론 금지.",
  "approach": "이 상황에서 가장 현실적인 돌파 전략 1~2문장.",
  "steps": ["지금 당장 할 수 있는 첫 물리적 행동", "두 번째 스텝", "세 번째 스텝"],
  "trigger": "실행 트리거 한 줄 (기존 것 있으면 개선, 없으면 새로 제안)"
}

특수문자(**,#,*) 금지. 구어체. JSON만.`;

  try{
    const raw=await callAI(prompt,500);
    const clean=raw.replace(/```json|```/g,'').trim();
    const data=JSON.parse(clean.slice(clean.indexOf('{'),clean.lastIndexOf('}')+1));

    resEl.innerHTML=`
      <div class="todo-ai-block">
        <div class="todo-ai-block-label">진단</div>
        <div class="todo-ai-block-text">${esc(data.diagnosis||'')}</div>
      </div>
      <div class="todo-ai-block">
        <div class="todo-ai-block-label">돌파 전략</div>
        <div class="todo-ai-block-text">${esc(data.approach||'')}</div>
      </div>
      <div class="todo-ai-block">
        <div class="todo-ai-block-label">지금 바로 할 것</div>
        ${(data.steps||[]).map((s,i)=>`<div class="todo-ai-step">
          <div class="todo-ai-step-num">${i+1}</div>
          <div class="todo-ai-step-text">${esc(s)}</div>
        </div>`).join('')}
      </div>
      ${data.trigger?`<div class="todo-ai-block">
        <div class="todo-ai-block-label">실행 트리거 제안</div>
        <div class="todo-ai-block-text">${esc(data.trigger)}</div>
        <button class="todo-ai-apply-btn" onclick="applyAiTrigger(${idx},'${esc(data.trigger).replace(/'/g,'&#39;')}')">트리거로 저장</button>
      </div>`:''}`;

    if(btnEl){btnEl.disabled=false;btnEl.innerHTML='✦ AI 돌파구 제안';}
  }catch(e){
    resEl.innerHTML=`<div style="font-size:12px;color:var(--red)">${esc(e.message)}</div>`;
    if(btnEl){btnEl.disabled=false;btnEl.innerHTML='✦ AI 돌파구 제안';}
  }
}

function applyAiTrigger(idx, triggerText){
  // 트리거 input에 값 채워주기
  const inp=document.getElementById('todoTrigger');
  if(inp)inp.value=triggerText;
  // 즉시 저장하지 않고 사용자가 확인 후 저장하도록
  showToast('트리거 입력란에 채워줬어. 저장 버튼 눌러줘!');
}

function selectPrio(p){
  window._selectedPrio=p;
  ['high','mid','low'].forEach(k=>{
    const btn=document.getElementById('prio-'+k);
    if(btn)btn.classList.toggle('sel',k===p);
  });
}

function saveTodoFromModal(){
  const text=document.getElementById('todoText')?.value.trim();
  if(!text){showToast('내용을 입력해줘');return;}
  todoItems.unshift({
    id:Date.now(),text,
    priority:window._selectedPrio||'mid',
    trigger:document.getElementById('todoTrigger')?.value.trim()||'',
    blockReason:document.getElementById('todoBlockReason')?.value||'',
    energyReq:document.getElementById('todoEnergyReq')?.value||'',
    longTask:document.getElementById('todoLongTask')?.checked||false,
    done:false,date:new Date().toLocaleDateString('ko-KR')
  });
  saveTodos();
  document.querySelector('.nds-modal')?.remove();
  renderMeTodo();showToast('추가됐어!');
}

// 체크 워크시트에서 task 가져오기
function importTasksFromWs(wsAns){
  const taskKeys=['task1','task2','task3'];
  let added=0;
  taskKeys.forEach((key,ki)=>{
    const raw=wsAns[key];
    if(!raw)return;
    // task_item 객체 or 구버전 문자열 처리
    const text=typeof raw==='object'?(raw.text||'').trim():raw.trim();
    const longTask=typeof raw==='object'?!!raw.longTask:false;
    if(!text)return;
    if(todoItems.find(t=>t.text===text))return;
    const priority=ki===0?'high':ki===1?'high':'mid';
    todoItems.unshift({
      id:Date.now()+Math.random(),
      text,priority,longTask,done:false,
      date:new Date().toLocaleDateString('ko-KR')
    });
    added++;
  });
  if(added>0){
    saveTodos();
    // 나 탭이 현재 활성화된 경우에만 즉시 갱신
    if(document.getElementById('page-me')?.classList.contains('active')){
      renderMeTodo();
    }
    showToast(`${added}개 할 일이 나 탭에 추가됐어!`);
  }
}

// ── Task AI 정렬 ─────────────────────────────────────────
async function runTaskSort(){
  const resEl=document.getElementById('ws-ai-sorted-result');
  if(!API_KEY){resEl.innerHTML=`<div style="font-size:12px;color:var(--textF);margin-top:8px">API 키가 없어. 설정 탭에서 추가해줘.</div>`;return;}

  // 입력된 task 수집
  const tasks=[];
  ['task1','task2','task3'].forEach((key,i)=>{
    const raw=wsAnswers[key];
    const text=typeof raw==='object'?(raw.text||'').trim():((raw||'').trim());
    const longTask=typeof raw==='object'?!!raw.longTask:false;
    if(text)tasks.push({text,longTask,idx:i+1});
  });
  if(tasks.length===0){resEl.innerHTML=`<div style="font-size:12px;color:var(--textF);margin-top:8px">Task를 먼저 입력해줘.</div>`;return;}

  resEl.innerHTML=`<div style="font-size:12px;color:var(--textF);margin-top:10px;display:flex;align-items:center;gap:8px"><div class="spinner" style="width:14px;height:14px"></div>순서 분석 중...</div>`;

  // 상황 컨텍스트
  const stateCtx=['mood','body','energy','avoidance'].map(k=>wsAnswers[k]?`${k}: ${wsAnswers[k]}`:'').filter(Boolean).join(', ');
  const energyLabel={high:'고집중',mid:'중간',low:'루틴'};
  const blockLabel={fear:'두려움',boring:'귀찮음',unclear:'불명확',energy:'에너지 없음',waiting:'기다리는 것 있음'};
  const taskList=tasks.map((t,i)=>{
    const extras=[];
    if(t.longTask)extras.push('장기 작업');
    if(t.energyReq)extras.push(`에너지:${energyLabel[t.energyReq]||t.energyReq}`);
    if(t.blockReason)extras.push(`막힌이유:${blockLabel[t.blockReason]||t.blockReason}`);
    return `${i+1}. "${t.text}"${extras.length?' ['+extras.join(', ')+']':''}`;
  }).join('\n');

  const prompt=`지금 이 사람의 상태: ${stateCtx||'정보 없음'}

오늘 해야 할 Task:
${taskList}

Task 순서를 최적으로 정렬해라.
정렬 기준:
1. 장기 작업은 반드시 짧게 끝나는 작업 뒤에 배치해라. (질질 끌릴 위험 차단)
2. 단, 장기 작업은 가능한 한 이른 시간에 시작할 수 있도록 앞에 배치된 짧은 작업과 묶어라.
3. 에너지 상태에 따라 — 방전 상태면 쉬운 것 먼저, 충전 상태면 핵심부터
4. 인지 부하 순서 — 집중이 필요한 것은 앞에, 루틴적인 것은 뒤에
5. 각 순서마다 이유를 한 줄로 설명해라.

특수문자 금지. JSON만 출력:
[{"text":"task 내용","reason":"순서 이유 한 줄","tag":"long 또는 short"}]`;

  try{
    const raw=await callAI(prompt,500);
    const clean=raw.replace(/\`\`\`json|\`\`\`/g,'').trim();
    const arr=JSON.parse(clean.slice(clean.indexOf('['),clean.lastIndexOf(']')+1));
    resEl.innerHTML=`<div class="ws-ai-sorted">
      <div class="ws-ai-sorted-title">✦ AI 추천 순서</div>
      <div class="ws-ai-task-order">${arr.map((t,i)=>`<div class="ws-ai-task-item">
        <div class="ws-ai-task-num">${i+1}</div>
        <div style="flex:1">
          <div class="ws-ai-task-text">${esc(t.text||'')}</div>
          <div class="ws-ai-task-reason">${esc(t.reason||'')}</div>
        </div>
        ${t.tag?`<span class="ws-ai-task-tag ${t.tag==='long'?'long':'short'}">${t.tag==='long'?'⏳ 장기':'⚡ 단기'}</span>`:''}
      </div>`).join('')}
      </div>
    </div>`;
  }catch(e){
    resEl.innerHTML=`<div style="font-size:12px;color:var(--red);margin-top:8px">오류: ${esc(e.message)}</div>`;
  }
}

// ── 나 탭 — 미니 지표 그래프 ─────────────────────────────
function renderMeMetrics(){
  const el=document.getElementById('meMiniMetrics');if(!el)return;
  metricsData=JSON.parse(localStorage.getItem('metrics_v1')||'[]');
  if(metricsData.length===0){
    el.innerHTML=`<div class="me-metrics-empty">성장 지표가 없어.<br>기록 탭 → 성장 지표에서 추가해봐.</div>`;
    return;
  }
  el.innerHTML=metricsData.map((m,i)=>{
    const h=m.history||[];
    const curr=m.current||0;
    const goal=m.goal||0;
    const pct=goal>0?Math.min(100,Math.round((curr/goal)*100)):0;
    const chartHtml=h.length>=1?renderMetricChart(h,m.chartType,m.chartStyle,goal):'';
    const trend=h.length>=2?getTrend(h):'';
    return `<div class="me-metric-mini">
      <div class="me-metric-mini-header">
        <div>
          <div class="me-metric-mini-name">${esc(m.name)}</div>
          ${m.note?`<div style="font-size:10px;color:var(--textF);margin-top:1px">${esc(m.note)}</div>`:''}
        </div>
        <div style="text-align:right">
          <div>
            <span class="me-metric-mini-val">${curr}</span>
            <span class="me-metric-mini-unit"> ${esc(m.unit)}</span>
          </div>
          ${goal>0?`<div style="font-size:10px;color:var(--textF)">목표 ${goal} ${esc(m.unit)}</div>`:''}
          ${trend?`<div style="font-size:10px;color:${trend.color};margin-top:1px">${trend.label}</div>`:''}
        </div>
      </div>
      ${chartHtml}
      ${goal>0?`<div class="me-prog-bg" style="margin-top:6px"><div class="me-prog-fill" style="width:${pct}%"></div></div>
      <div class="me-prog-info" style="margin-top:3px"><span></span><span>${pct}% 달성</span></div>`:''}
      <div class="me-metric-mini-actions">
        <button class="me-metric-log-btn" onclick="openMetricLogModal(${i})">+ 기록</button>
        <button class="me-metric-edit-btn" onclick="openMetricModal(${i})">편집</button>
      </div>
    </div>`;
  }).join('');
}

function getTrend(history){
  if(history.length<2)return null;
  const last=history[history.length-1].val;
  const prev=history[history.length-2].val;
  const rawDiff=last-prev;
  if(rawDiff===0)return{label:'→ 유지',color:'var(--textF)'};
  // 부동소수점 오차 제거
  const diff=parseFloat(rawDiff.toPrecision(10));
  const sign=diff>0?'+':'';
  return diff>0
    ?{label:`▲ ${sign}${diff}`,color:'#4a7a50'}
    :{label:`▼ ${diff}`,color:'#c87070'};
}

function renderLineChart(history, goal, chartType, chartStyle){
  const type=chartType||'line';
  const style=chartStyle||'default';
  const pts=history.slice(-12);
  if(pts.length===0)return'';
  // 데이터 1개면 막대처럼 단일 점으로 표시
  if(pts.length===1){
    const isBold=style==='bold';
    const W=260,H=60,PAD_L=style==='minimal'?4:28;
    const unit=pts[0].unit||'';
    return `<div class="me-linechart-wrap"><svg viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">
      <circle cx="${PAD_L+10}" cy="${H/2}" r="${isBold?6:4}" fill="var(--accent)" stroke="var(--surface)" stroke-width="2"/>
      <text x="${PAD_L+22}" y="${H/2+4}" font-size="11" fill="var(--foreground-2)">${pts[0].val} ${unit}</text>
      <text x="${PAD_L+22}" y="${H/2+15}" font-size="9" fill="var(--textF)">${(pts[0].date||'').replace(/^\d{4}\./,'').replace(/\.$/,'')}</text>
    </svg></div>`;
  }
  const vals=pts.map(p=>p.val);
  const minV=Math.min(...vals);
  const maxV=Math.max(...vals,goal||0);
  const range=maxV-minV||1;

  // 스타일별 파라미터
  const isBold=style==='bold';
  const isMin=style==='minimal';
  const isGrad=style==='gradient';
  const strokeW=isBold?3:2;
  const dotR=isBold?3.5:2.5;
  const lastR=isBold?5:4;
  const PAD_L=isMin?4:28;

  const W=260, H=60, PAD_R=8, PAD_T=8, PAD_B=20;
  const iW=W-PAD_L-PAD_R;
  const iH=H-PAD_T-PAD_B;
  const n=pts.length;

  const cx=i=>PAD_L+Math.round((i/(n-1||1))*iW);
  const cy=v=>PAD_T+Math.round((1-(v-minV)/range)*iH);

  const lineD=pts.map((p,i)=>`${i===0?'M':'L'}${cx(i)},${cy(p.val)}`).join(' ');
  const fillD=`${lineD} L${cx(n-1)},${PAD_T+iH} L${cx(0)},${PAD_T+iH} Z`;

  // 목표선
  const goalLine=goal>0&&goal>=minV&&goal<=maxV
    ?`<line x1="${PAD_L}" y1="${cy(goal)}" x2="${W-PAD_R}" y2="${cy(goal)}" stroke="var(--accent)" stroke-width="1" stroke-dasharray="4,3" opacity=".6"/>
      <text x="${W-PAD_R-2}" y="${cy(goal)-3}" text-anchor="end" font-size="8" fill="var(--accent)" opacity=".8">목표</text>`
    :'';

  // Y축 레이블 (minimal 제외)
  const yLabels=!isMin?`
    <text x="${PAD_L-4}" y="${PAD_T+4}" text-anchor="end" font-size="8" fill="var(--textF)">${maxV}</text>
    <text x="${PAD_L-4}" y="${PAD_T+iH+4}" text-anchor="end" font-size="8" fill="var(--textF)">${minV}</text>`:'';

  // X축 레이블
  const d0=(pts[0].date||'').replace(/^\d{4}\./,'').replace(/\.$/,'');
  const d1=(pts[n-1].date||'').replace(/^\d{4}\./,'').replace(/\.$/,'');
  const xLabels=n>=2&&!isMin?`
    <text x="${cx(0)}" y="${H}" text-anchor="middle" font-size="8" fill="var(--textF)">${d0}</text>
    <text x="${cx(n-1)}" y="${H}" text-anchor="middle" font-size="8" fill="var(--textF)">${d1}</text>`:'';

  const gradId=`g${Math.random().toString(36).slice(2,7)}`;

  // 그래프 타입별 렌더
  let chartEl='';
  if(type==='dot'){
    // 점 전용 — 선 없음
    const allDots=pts.map((p,i)=>`<circle cx="${cx(i)}" cy="${cy(p.val)}" r="${dotR}" fill="var(--accent)" stroke="var(--surface)" stroke-width="1.5"/>`).join('');
    chartEl=`${allDots}<circle cx="${cx(n-1)}" cy="${cy(pts[n-1].val)}" r="${lastR}" fill="var(--accent)" stroke="var(--surface)" stroke-width="2"/>`;
  } else if(type==='area'){
    // 채움 강조 (영역)
    const fillOp=isGrad?'url(#'+gradId+'_area)':'rgba(0,255,136,.07)';
    const areaGrad=`<linearGradient id="${gradId}_area" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="var(--accent)" stop-opacity="${isBold?'.5':'.3'}"/>
      <stop offset="100%" stop-color="var(--accent)" stop-opacity="0.05"/>
    </linearGradient>`;
    chartEl=`<defs><linearGradient id="${gradId}" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="var(--accent)" stop-opacity=".25"/><stop offset="100%" stop-color="var(--accent)" stop-opacity="0"/></linearGradient>${areaGrad}</defs>
      <path d="${fillD}" fill="${fillOp}"/>
      <path d="${lineD}" fill="none" stroke="var(--accent)" stroke-width="${strokeW}" stroke-linejoin="round" stroke-linecap="round"/>
      <circle cx="${cx(n-1)}" cy="${cy(pts[n-1].val)}" r="${lastR}" fill="var(--accent)" stroke="var(--surface)" stroke-width="2"/>`;
  } else {
    // line (기본)
    const fillOp=isGrad
      ?'url(#'+gradId+')'
      :isMin?'none':'url(#'+gradId+')';
    chartEl=`<defs><linearGradient id="${gradId}" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="var(--accent)" stop-opacity="${isBold?'.35':'.2'}"/><stop offset="100%" stop-color="var(--accent)" stop-opacity="0"/></linearGradient></defs>
      ${fillOp!=='none'?`<path d="${fillD}" fill="${fillOp}"/>` :''}
      <path d="${lineD}" fill="none" stroke="var(--accent)" stroke-width="${strokeW}" stroke-linejoin="round" stroke-linecap="round"/>
      ${isMin?'':`${pts.map((p,i)=>`<circle cx="${cx(i)}" cy="${cy(p.val)}" r="${dotR}" fill="var(--accent)" stroke="var(--surface)" stroke-width="1.5"/>`).join('')}`}
      <circle cx="${cx(n-1)}" cy="${cy(pts[n-1].val)}" r="${lastR}" fill="var(--accent)" stroke="var(--surface)" stroke-width="2"/>`;
  }

  return `<div class="me-linechart-wrap">
    <svg viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">
      <line x1="${PAD_L}" y1="${PAD_T}" x2="${PAD_L}" y2="${PAD_T+iH}" stroke="var(--border)" stroke-width="1"/>
      <line x1="${PAD_L}" y1="${PAD_T+iH}" x2="${W-PAD_R}" y2="${PAD_T+iH}" stroke="var(--border)" stroke-width="1"/>
      ${yLabels}${goalLine}${chartEl}${xLabels}
    </svg>
  </div>`;
}

// ── 나 탭 — 결과지 미니 ──────────────────────────────────
function renderMeResults(){
  const el=document.getElementById('meResultPreview');if(!el)return;
  const results=memos.filter(m=>m.type==='result');
  if(results.length===0){
    el.innerHTML=`<div class="me-metrics-empty">저장된 결과지가 없어.<br>체크 후 저장해봐.</div>`;
    return;
  }
  // 가장 최근 다짐 찾기 (나탭 상단에 강조)
  const latestCommit=results.find(m=>m.commitment);
  let commitBox='';
  if(latestCommit){
    commitBox=`<div class="me-commitment-box">
      <div class="me-commitment-label">✦ 나의 다짐</div>
      <div class="me-commitment-text">${esc(latestCommit.commitment)}</div>
      <div class="me-commitment-date">${latestCommit.ts||latestCommit.date}</div>
    </div>`;
  }

  el.innerHTML=commitBox+results.slice(0,4).map(m=>`
    <div class="me-result-mini" onclick="goTab('memo');setTimeout(()=>switchSeg('seg-results',document.querySelectorAll('.seg-btn')[1]),100)">
      <div class="me-result-mini-date">${m.ts||m.date}</div>
      <div class="me-result-mini-title">${esc((m.short||'').slice(0,50))}${(m.short||'').length>50?'…':''}</div>
      ${m.commitment?`<div style="font-size:10px;color:var(--accent);margin-top:2px">✦ 다짐 있음</div>`:''}    </div>`).join('');
}

// ── 나 탭 — 가치관 미니 그리드 ──────────────────────────
function renderMePhil(){
  const el=document.getElementById('mePhilGrid');if(!el)return;
  el.innerHTML=philCards.map(p=>`
    <div class="me-phil-mini">
      <div class="me-phil-mini-tag">${esc(p.tag)}</div>
      <div class="me-phil-mini-title">${esc(p.title)}</div>
      <div class="me-phil-mini-body">${esc(p.body)}</div>
    </div>`).join('');
}


function switchSeg(id,btn){
  document.querySelectorAll('.seg-panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.seg-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  btn.classList.add('active');
  if(id==='seg-metrics')renderMetricsPanel();
}

// ── 설정 섹션 토글 ────────────────────────────────────────
function toggleSection(id){
  const body=document.getElementById(id);
  const arr=document.getElementById('arr-'+id);
  body.classList.toggle('open');
  arr.classList.toggle('open');
}

// ── 홈 ───────────────────────────────────────────────────
function renderPhil(){
  // philEditList와 동일하게 처리 (philList DOM 없음)
  renderPhilEdit();
}

// ── API ───────────────────────────────────────────────────
function loadSavedKey(){const i=document.getElementById('apiKeyInp');if(i&&API_KEY)i.value=API_KEY;}
function renderApiStatus(){
  const el=document.getElementById('apiStatus');if(!el)return;
  el.innerHTML=API_KEY
    ?`<div class="status-dot ok"></div><span style="color:var(--green)">키 저장됨</span>`
    :`<div class="status-dot none"></div><span style="color:var(--textF)">키 없음</span>`;
}
function saveApiKey(){
  const v=document.getElementById('apiKeyInp').value.trim();
  if(!v){showToast('키를 입력해줘');return;}
  if(!v.startsWith('gsk_')){showToast('gsk_...로 시작하는 키를 입력해줘');return;}
  API_KEY=v;localStorage.setItem('groq_key',v);renderApiStatus();showToast('저장됐어');
}
async function testApiKey(){
  const inp=document.getElementById('apiKeyInp').value.trim()||API_KEY;
  const resEl=document.getElementById('testResult');resEl.style.display='none';
  if(!inp){showToast('먼저 키를 입력해줘');return;}
  showToast('테스트 중...');
  try{
    const txt=await callAI('안녕. 한 문장으로만 답해줘.',200,inp);
    resEl.className='test-result ok';resEl.textContent='✓ 연결 성공: '+txt.trim().slice(0,80);resEl.style.display='block';
  }catch(e){resEl.className='test-result err';resEl.textContent='✗ 오류: '+e.message;resEl.style.display='block';}
}

// ── AI 설정 ───────────────────────────────────────────────
function loadAiSettings(){
  const s=aiSettings;
  const aStyle=document.getElementById('setAnalysisStyle');
  const acStyle=document.getElementById('setActionStyle');
  const extra=document.getElementById('setExtraPrompt');
  if(aStyle&&s.analysisStyle)aStyle.value=s.analysisStyle;
  if(acStyle&&s.actionStyle)acStyle.value=s.actionStyle;
  if(extra&&s.extraPrompt)extra.value=s.extraPrompt;
}
function saveSettings(){
  aiSettings={
    analysisStyle:document.getElementById('setAnalysisStyle')?.value||'pattern',
    actionStyle:document.getElementById('setActionStyle')?.value||'step',
    extraPrompt:document.getElementById('setExtraPrompt')?.value||''
  };
  localStorage.setItem('ai_settings',JSON.stringify(aiSettings));
  if(fbUser)fbSaveAll();
}

// ── 가치관 편집 ───────────────────────────────────────────
function renderPhilEdit(){
  document.getElementById('philEditList').innerHTML=philCards.map((p,i)=>`
    <div class="phil-edit-item">
      <div class="phil-edit-row">
        <input class="phil-edit-tag" value="${esc(p.tag)}" oninput="philCards[${i}].tag=this.value" placeholder="태그">
        <input class="phil-edit-title" value="${esc(p.title)}" oninput="philCards[${i}].title=this.value" placeholder="제목">
      </div>
      <textarea class="phil-edit-body" oninput="philCards[${i}].body=this.value" placeholder="내용">${esc(p.body)}</textarea>
      <button class="phil-edit-del" onclick="delPhilCard(${i})">삭제</button>
    </div>`).join('');
}
function addPhilCard(){
  philCards.push({tag:'새 가치관',title:'',body:''});
  renderPhilEdit();
}
function delPhilCard(i){philCards.splice(i,1);renderPhilEdit();}
function savePhilCards(){
  localStorage.setItem('phil_cards',JSON.stringify(philCards));
  renderPhil();showToast('가치관 저장됐어');
  if(fbUser)fbSaveAll();
}
function resetPhilCards(){
  philCards=JSON.parse(JSON.stringify(BASE_PHIL));
  localStorage.setItem('phil_cards',JSON.stringify(philCards));
  renderPhil();renderPhilEdit();showToast('기본값으로 되돌렸어');
}

// ── 질문 편집 ─────────────────────────────────────────────
function renderQEdit(){
  document.getElementById('qEditList').innerHTML=questionSet.map((q,i)=>`
    <div class="q-edit-item">
      <div class="q-edit-row">
        <input class="q-edit-cat" value="${esc(q.cat)}" oninput="questionSet[${i}].cat=this.value" placeholder="카테고리">
        <input class="q-edit-text" value="${esc(q.text)}" oninput="questionSet[${i}].text=this.value" placeholder="질문">
      </div>
      <textarea class="q-edit-sub" oninput="questionSet[${i}].sub=this.value" placeholder="보조 설명">${esc(q.sub||'')}</textarea>
      <button class="q-edit-del" onclick="delQuestion(${i})">삭제</button>
    </div>`).join('');
}
function addQuestion(){
  questionSet.push({id:'q'+Date.now(),cat:'새 카테고리',text:'',sub:'',type:'ta'});
  renderQEdit();
}
function delQuestion(i){questionSet.splice(i,1);renderQEdit();}
function saveQuestionSet(){
  localStorage.setItem('question_set',JSON.stringify(questionSet));
  showToast('질문 저장됐어');
  if(fbUser)fbSaveAll();
}
function resetQuestions(){
  questionSet=JSON.parse(JSON.stringify(BASE_QUESTIONS));
  localStorage.setItem('question_set',JSON.stringify(questionSet));
  renderQEdit();showToast('기본값으로 되돌렸어');
}

// ── 데이터 ───────────────────────────────────────────────
function clearAllData(){
  if(!confirm('모든 기록을 삭제할까? 되돌릴 수 없어.'))return;
  localStorage.removeItem('memos_v5');
  memos=[];renderMemos();showToast('삭제됐어');
}

// ── 체크 ─────────────────────────────────────────────────
// ── 체크 워크시트 ────────────────────────────────────────
// 워크시트 페이지 정의
const WS_PAGES=[
  {id:'ws_situation', title:'현실 상황 파악', sub:'지금 내 환경과 맥락을 정리해봐.', icon:'📍',
   fields:[
     {key:'relations', label:'인간관계', hint:'최근 신경 쓰이는 관계나 상황', type:'text'},
     {key:'schedule',  label:'다가오는 일정', hint:'이번 주, 이번 달 주요 일정', type:'text'},
     {key:'money',     label:'돈/생활', hint:'재정 상태, 생활 환경', type:'text'},
     {key:'work',      label:'일/학업', hint:'현재 진행 중인 것, 막힌 것', type:'text'},
     {key:'body_env',  label:'몸/환경', hint:'수면, 식사, 운동, 공간 상태', type:'text'},
   ]
  },
  {id:'ws_state', title:'지금 내 상태', sub:'지금 이 순간 나의 상태를 체크해봐.', icon:'🌡',
   fields:[
     {key:'mood',      label:'지금 기분', hint:'', type:'opts', opts:['좋아','보통','별로','모르겠어']},
     {key:'body',      label:'몸 상태', hint:'', type:'opts', opts:['괜찮아','좀 피곤해','확실히 안 좋아']},
     {key:'energy',    label:'에너지 레벨', hint:'', type:'opts', opts:['충전 완료','반정도','방전 직전']},
     {key:'mind',      label:'지금 머릿속', hint:'지금 맴도는 생각, 걱정, 감정을 짧게', type:'text'},
     {key:'avoidance', label:'피하고 있는 것', hint:'지금 안 하고 있는데 해야 할 것, 붙잡고 있는 것', type:'text'},
   ]
  },
  {id:'ws_tasks', title:'오늘 집중할 것', sub:'할 일을 꺼내고, 순서를 잡아봐.', icon:'✔',
   fields:[
     {key:'task1', label:'Task 1', hint:'오늘 해야 하는 것', type:'task_item'},
     {key:'task2', label:'Task 2', hint:'', type:'task_item'},
     {key:'task3', label:'Task 3', hint:'여유 있으면 하는 것', type:'task_item'},
     {key:'stuck', label:'막혀 있는 것', hint:'어디서 멈췄는지, 뭐가 막혔는지', type:'text'},
     {key:'reward_pick', label:'진짜 보상으로 뭘 할 거야?', hint:'', type:'reward_pick'},
   ]
  },
  {id:'ws_anxiety', title:'불안 · 비교 · 자책', sub:'머릿속에 두면 계속 커진다. 꺼내봐.', icon:'💭',
   fields:[
     {key:'anxiety',   label:'지금 걱정되는 것', hint:'일어날 것 같은 나쁜 일, 막연한 불안', type:'text'},
     {key:'compare',   label:'비교하고 있는 것', hint:'누구와, 무엇을 비교하고 있는지', type:'text'},
     {key:'self_crit', label:'자책하고 있는 것', hint:'스스로를 어떻게 공격하고 있는지', type:'text'},
     {key:'reality_check', label:'실제로 지금 일어나고 있는가?', hint:'아니라면 — 지금 당장 할 수 있는 것 한 가지', type:'text'},
   ]
  },
];

let wsAnswers={};
let wsPage=0;

function startCheck(){
  if(!API_KEY){goTab('settings');showToast('먼저 API 키를 설정해줘');return;}
  wsAnswers={};wsPage=0;
  goTab('check');renderWsPage();
}

function renderWsPage(){
  const page=WS_PAGES[wsPage];
  const isLast=wsPage===WS_PAGES.length-1;
  const pct=Math.round((wsPage/WS_PAGES.length)*100);

  const fieldsHtml=page.fields.map(f=>{
    const val=wsAnswers[f.key]||'';
    if(f.type==='opts'){
      return `<div class="ws-field">
        <div class="ws-field-label">${f.label}</div>
        <div class="ws-opts-row" id="opts_${f.key}">
          ${f.opts.map(o=>`<button class="ws-opt${val===o?' sel':''}"
            onclick="wsSelectOpt('${f.key}','${o.replace(/'/g,"&#39;")}')">${o}</button>`).join('')}
        </div>
      </div>`;
    }
    if(f.type==='task_item'){
      // task_item: 텍스트 입력 + 시간이 많이 필요한가 토글
      const taskData=wsAnswers[f.key]||{text:'',longTask:false};
      const taskText=typeof taskData==='string'?taskData:(taskData.text||'');
      const longTask=typeof taskData==='object'&&taskData.longTask;
      return `<div class="ws-field ws-task-field" id="tf_${f.key}">
        <div class="ws-field-label">${f.label}${f.hint?`<span class="ws-field-hint"> — ${f.hint}</span>`:''}</div>
        <input class="ws-inp" id="wsinp_${f.key}" value="${esc(taskText)}"
          placeholder="할 일 입력..."
          oninput="wsSetTask('${f.key}','text',this.value)">
        <div class="ws-task-meta">
          <button class="ws-task-toggle${longTask?' active':''}" onclick="wsToggleLong('${f.key}')">
            ⏳ 시간이 많이 필요한 일
          </button>
          ${longTask?'<span class="ws-task-long-badge">장기 작업 — 최대한 빨리 시작할수록 좋아</span>':''}
        </div>
      </div>`;
    }
    if(f.type==='reward_pick'){
      const rd=JSON.parse(localStorage.getItem('reward_data')||'{"charge":[],"drain":[]}');
      const charges=rd.charge||[];
      return `<div class="ws-field">
        <div class="ws-field-label">${f.label}</div>
        <div class="ws-field-hint">충전 LIST에서 선택해봐</div>
        ${charges.length===0
          ?`<div class="ws-reward-empty">보상 탭에서 충전 활동을 먼저 추가해줘</div>`
          :`<div class="ws-opts-row" id="opts_${f.key}">
            ${charges.map(c=>`<button class="ws-opt ws-reward-opt${val===c.name?' sel':''}"
              onclick="wsSelectOpt('${f.key}','${c.name.replace(/'/g,"&#39;")}')">${c.emoji||'🌿'} ${c.name}</button>`).join('')}
          </div>`
        }
      </div>`;
    }
    // text
    return `<div class="ws-field">
      <div class="ws-field-label">${f.label}${f.hint?`<span class="ws-field-hint"> — ${f.hint}</span>`:''}</div>
      <input class="ws-inp" id="wsinp_${f.key}" value="${esc(val)}"
        placeholder=""
        oninput="wsAnswers['${f.key}']=this.value">
    </div>`;
  }).join('');

  document.getElementById('checkContent').innerHTML=`
    <div class="ws-wrap">
      <div class="ws-prog-row">
        <div class="ws-prog-bg"><div class="ws-prog-fill" style="width:${pct}%"></div></div>
        <span class="ws-prog-lbl">${wsPage+1} / ${WS_PAGES.length}</span>
      </div>
      <div class="ws-page-header">
        <span class="ws-page-icon">${page.icon}</span>
        <div>
          <div class="ws-page-title">${page.title}</div>
          <div class="ws-page-sub">${page.sub}</div>
        </div>
      </div>
      <div class="ws-fields">${fieldsHtml}</div>
      ${page.id==='ws_tasks'?`<div class="ws-ai-sort-row">
        <button class="ws-ai-sort-btn" onclick="runTaskSort()">✦ AI 추천 순서 정렬</button>
        <div id="ws-ai-sorted-result"></div>
      </div>`:''}
      <div class="ws-nav">
        ${wsPage>0?`<button class="ws-btn-back" onclick="wsPrev()">← 이전</button>`:''}
        <button class="ws-btn-next" onclick="wsNext()">${isLast?'결과 보기 →':'다음 →'}</button>
      </div>
    </div>`;
}

function wsSelectOpt(key,val){
  wsAnswers[key]=val;
  // 버튼 상태 업데이트
  document.querySelectorAll(`#opts_${key} .ws-opt`).forEach(b=>{
    b.classList.toggle('sel', b.textContent.trim()===val||b.getAttribute('onclick')?.includes(val));
  });
}

function wsSetTask(key,field,val){
  if(!wsAnswers[key]||typeof wsAnswers[key]==='string'){
    wsAnswers[key]={text:typeof wsAnswers[key]==='string'?wsAnswers[key]:'',longTask:false};
  }
  wsAnswers[key][field]=val;
}
function wsToggleLong(key){
  if(!wsAnswers[key]||typeof wsAnswers[key]==='string'){
    wsAnswers[key]={text:typeof wsAnswers[key]==='string'?wsAnswers[key]:'',longTask:false};
  }
  wsAnswers[key].longTask=!wsAnswers[key].longTask;
  renderWsPage();
}
function wsPrev(){if(wsPage>0){wsPage--;renderWsPage();}}
function wsNext(){
  wsPage++;
  if(wsPage>=WS_PAGES.length){
    todoItems=JSON.parse(localStorage.getItem('todo_items')||'[]');
    importTasksFromWs(wsAnswers);
    showResult();
  }
  else renderWsPage();
}

// 구버전 호환 (renderQ 등 외부 참조 방어)
function renderQ(){}
function onTaInput(){}
function selectOpt(){}
function prevQ(){wsPrev();}
function nextQ(){wsNext();}



// ── 결과 ─────────────────────────────────────────────────
function showResult(){
  const now=new Date();
  const ts=`${now.getFullYear()}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-result').classList.add('active');

  document.getElementById('resultContent').innerHTML=`
    <div class="res-header">
      <div><h2>지금 나의 상태</h2><div class="res-time">${ts}</div></div>
      <button class="save-result-btn" onclick="saveResult()">결과지 저장</button>
    </div>
    <div class="res-grid">
      <!-- 왼쪽: 입력 내용 -->
      <div class="res-col">
        <div class="res-col-head"><div class="res-col-title">내가 입력한 것</div></div>
        <div class="res-col-body" id="col1"></div>
      </div>
      <!-- 오른쪽: AI 요약 -->
      <div class="res-col res-ai-panel">
        <div class="res-col-head"><div class="res-col-title">AI 읽기</div></div>
        <div class="res-col-body" id="col-ai">
          <div class="res-ai-loading">
            <div class="spinner"></div>
            <div class="res-ai-loading-txt">분석 중...</div>
          </div>
        </div>
      </div>
    </div>
    <div class="res-bottom">
      <div class="res-commitment-area">
        <div class="res-commitment-lbl">✦ 오늘의 다짐 · 생각</div>
        <textarea id="resCommitTa" class="res-commitment-ta" placeholder="이 결과를 읽고 나서 드는 생각, 오늘 다짐하고 싶은 것..."></textarea>
        <button class="res-commitment-save" onclick="saveCommitment()">저장</button>
      </div>
      <div class="memo-save-area" style="margin-top:16px">
        <div class="memo-save-lbl">오늘의 메모</div>
        <div class="memo-save-sub">오늘 새롭게 알게 된 것이나 느낀 점.<br>이 기록이 다음 분석에 반영된다.</div>
        <textarea id="resMemoTa" style="min-height:70px;margin-top:4px" placeholder="오늘의 깨달음..."></textarea>
        <button class="save-m-btn" onclick="addMemoFromId('resMemoTa')">기록에 저장</button>
      </div>
      <div class="final-box" style="margin-top:14px">
        <p>완벽하지 않아도 된다.<br><strong>이걸 열었다는 것 자체가 이미 돌아오는 중이다.</strong></p>
      </div>
      <button class="restart-btn" style="margin-top:12px" onclick="startCheck()">처음부터 다시</button>
    </div>`;

  renderWsResult();
  runAnalysis();
}

// 워크시트 입력 내용을 결과지 왼쪽에 표시
function renderWsResult(){
  const el=document.getElementById('col1');if(!el)return;

  // WS_PAGES 순서대로 섹션 렌더
  const html=WS_PAGES.map(page=>{
    const fields=page.fields;
    // 이 페이지에 입력된 내용이 하나라도 있는지 확인
    const hasAny=fields.some(f=>{
      const v=wsAnswers[f.key]||'';
      return f.type==='reward_pick'?!!v:v.trim()!=='';
    });
    if(!hasAny)return'';

    const fieldsHtml=fields.map(f=>{
      const val=wsAnswers[f.key]||'';
      if(f.type==='opts'){
        if(!val)return'';
        return `<div class="res-ws-field">
          <div class="res-ws-label">${esc(f.label)}</div>
          <div class="res-ws-opts"><span class="res-ws-opt-chip">${esc(val)}</span></div>
        </div>`;
      }
      if(f.type==='task_item'){
      // task_item: 텍스트 입력 + 시간이 많이 필요한가 토글
      const taskData=wsAnswers[f.key]||{text:'',longTask:false};
      const taskText=typeof taskData==='string'?taskData:(taskData.text||'');
      const longTask=typeof taskData==='object'&&taskData.longTask;
      return `<div class="ws-field ws-task-field" id="tf_${f.key}">
        <div class="ws-field-label">${f.label}${f.hint?`<span class="ws-field-hint"> — ${f.hint}</span>`:''}</div>
        <input class="ws-inp" id="wsinp_${f.key}" value="${esc(taskText)}"
          placeholder="할 일 입력..."
          oninput="wsSetTask('${f.key}','text',this.value)">
        <div class="ws-task-meta">
          <button class="ws-task-toggle${longTask?' active':''}" onclick="wsToggleLong('${f.key}')">
            ⏳ 시간이 많이 필요한 일
          </button>
          ${longTask?'<span class="ws-task-long-badge">장기 작업 — 최대한 빨리 시작할수록 좋아</span>':''}
        </div>
      </div>`;
    }
    if(f.type==='reward_pick'){
        if(!val)return'';
        return `<div class="res-ws-field">
          <div class="res-ws-label">${esc(f.label)}</div>
          <div class="res-ws-opts"><span class="res-ws-opt-chip">🌿 ${esc(val)}</span></div>
        </div>`;
      }
      // task_item 객체 처리
      const displayVal=typeof val==='object'?(val.text||'').trim():val.trim();
      const isLong=typeof val==='object'&&val.longTask;
      if(!displayVal)return'';
      return `<div class="res-ws-field">
        <div class="res-ws-label">${esc(f.label)}${isLong?' <span style="font-size:9px;color:var(--accent)">⏳ 장기</span>':''}</div>
        <div class="res-ws-val">${esc(displayVal)}</div>
      </div>`;
    }).filter(Boolean).join('');

    if(!fieldsHtml)return'';
    return `<div class="res-ws-section">
      <div class="res-ws-section-title">
        <span class="res-ws-section-icon">${page.icon}</span>
        <span>${page.title}</span>
      </div>
      ${fieldsHtml}
    </div>`;
  }).filter(Boolean).join('');

  el.innerHTML=html||'<div style="color:var(--textF);font-size:13px">입력된 내용이 없어.</div>';
}

// AI 분석 — 요약 + 관련 가치관만
async function runAnalysis(){
  // wsAnswers를 읽기 좋게 텍스트로 변환
  const ctx=WS_PAGES.map(page=>{
    const lines=page.fields
      .filter(f=>{
        const v=wsAnswers[f.key];
        if(!v)return false;
        if(typeof v==='object')return(v.text||'').trim()!=='';
        return v.toString().trim()!=='';
      })
      .map(f=>{
        const v=wsAnswers[f.key];
        const txt=typeof v==='object'?(v.text||''):v;
        const suffix=typeof v==='object'&&v.longTask?' [시간이 많이 필요한 장기 작업]':'';
        return `${f.label}: ${txt}${suffix}`;
      });
    if(!lines.length)return'';
    return `[${page.title}]\n${lines.join('\n')}`;
  }).filter(Boolean).join('\n\n');

  const memCtx=memos.filter(m=>m.type==='memo').length>0
    ?`\n\n[이 사람의 이전 기록]\n${memos.filter(m=>m.type==='memo').slice(0,5).map(m=>m.text).join('\n')}`:'';

  const philCtx=philCards.length>0
    ?`\n\n[이 사람의 가치관]\n${philCards.map(p=>`- ${p.tag}: ${p.title} — ${p.body}`).join('\n')}`:'';

  // aiSettings 반영
  const aStyle=aiSettings.analysisStyle||'pattern';
  const analysisInstr=aStyle==='pattern'
    ?'답변들 사이의 패턴·연결고리·숨겨진 맥락을 짚어라. 단순 요약 금지.'
    :aStyle==='direct'?'보이는 것 그대로 직접적으로 써라.'
    :'따뜻한 톤으로, 이 사람 편에서 써라.';
  const extraInstr=aiSettings.extraPrompt?`\n추가 지시: ${aiSettings.extraPrompt}`:'';

  const prompt=`이 사람이 오늘 체크인에서 입력한 내용이다:

${ctx}${memCtx}${philCtx}

할 일:
1. 지금 상태를 3~4문장으로 요약해라. ${analysisInstr} 일반론 금지.
2. 위 가치관 중 지금 상태에 가장 관련 있는 것 2~3개를 골라라. 가치관의 표현을 그대로 살려서, 각각 왜 지금 필요한지 한 줄로 써라.${extraInstr}

특수문자(**,#,*,_,\`) 절대 금지. 구어체.

JSON만 출력:
{"summary":"요약 3~4문장","phil":[{"tag":"가치관이름","content":"가치관 핵심 한 줄","why":"지금 왜 이게 필요한지"}]}`;

  try{
    const raw=await callAI(prompt,600);
    const clean=raw.replace(/[`]/g,'').replace(/```json|```/g,'').trim();
    const data=JSON.parse(clean.slice(clean.indexOf('{'),clean.lastIndexOf('}')+1));
    lastResult={ts:new Date().toLocaleString('ko-KR'),wsAnswers:{...wsAnswers},aiData:data};

    document.getElementById('col-ai').innerHTML=`
      <div class="res-ai-summary">${esc(data.summary||'').replace(/\n/g,'<br>')}</div>
      <div class="res-ai-phil-label">꺼내볼 가치관</div>
      ${(data.phil||[]).map(p=>`<div class="res-ai-phil-item">
        <div class="res-ai-phil-tag">${esc(p.tag||'')}</div>
        <div class="res-ai-phil-content">${esc(p.content||'')}</div>
        <div class="res-ai-phil-why">↳ ${esc(p.why||'')}</div>
      </div>`).join('')}`;
  }catch(e){
    document.getElementById('col-ai').innerHTML=`<div class="res-col-body"><div style="color:var(--red);font-size:13px">${esc(e.message)}</div></div>`;
  }
}
// saveResult — 아래 4컬럼 구조 버전 사용

// ── AI 호출 (Groq) ────────────────────────────────────────
async function callAI(prompt,maxTokens=800,keyOverride=null){
  const key=keyOverride||API_KEY;
  if(!key)throw new Error('API 키가 없어. 설정 탭에서 입력해줘.');
  const res=await fetch('https://api.groq.com/openai/v1/chat/completions',{
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':`Bearer ${key}`},
    body:JSON.stringify({
      model:'llama-3.3-70b-versatile',
      max_tokens:maxTokens,
      temperature:0.7,
      messages:[{role:'system',content:'한국어로 답하라. 구어체. 특수문자(**,#,*,_,`) 금지.'},{role:'user',content:prompt}]
    })
  });
  const d=await res.json();
  if(d.error)throw new Error(d.error.message||JSON.stringify(d.error));
  return d.choices?.[0]?.message?.content||'';
}

// ── 메모 ─────────────────────────────────────────────────
function addMemoFromId(taId){
  const el=document.getElementById(taId);if(!el||!el.value.trim())return;
  memos=[{id:Date.now(),type:'memo',text:el.value.trim(),date:new Date().toLocaleDateString('ko-KR')},...memos];
  localStorage.setItem('memos_v5',JSON.stringify(memos));
  el.value='';renderMemos();showToast('저장됐어');
  if(fbUser)fbSaveAll();
}
function deleteMemo(id){
  memos=memos.filter(m=>m.id!==id);
  localStorage.setItem('memos_v5',JSON.stringify(memos));
  renderMemos();renderResultList();
  if(fbUser)fbSaveAll();
}
function renderMemos(){
  const el=document.getElementById('memoList');if(!el)return;
  const notes=memos.filter(m=>m.type==='memo');
  if(notes.length===0){el.innerHTML=`<div class="memo-empty">아직 메모가 없어.<br>오늘 깨달은 것 한 줄이라도 남겨두자.</div>`;return;}
  el.innerHTML=notes.map(m=>`<div class="memo-item">
    <div class="memo-date">${m.date}</div>
    <div class="memo-text">${esc(m.text)}</div>
    <button class="memo-del" onclick="deleteMemo(${m.id})">×</button>
  </div>`).join('');
}

function renderResultList(){
  const el=document.getElementById('resultList');if(!el)return;
  const results=memos.filter(m=>m.type==='result');
  if(results.length===0){el.innerHTML=`<div class="memo-empty">저장된 결과지가 없어.<br>체크 탭에서 결과지를 저장해봐.</div>`;return;}
  el.innerHTML=results.map(m=>{
    const id='rs_'+m.id;
    const ws=m.wsAnswers||{};
    const hasWs=Object.keys(ws).length>0;

    // 왼쪽: 입력 내용 (새 구조) or 구버전 fallback
    let leftHtml='';
    if(hasWs){
      leftHtml=WS_PAGES.map(page=>{
        const lines=page.fields.filter(f=>{
          const v=ws[f.key]||'';
          return v.toString().trim()!=='';
        });
        if(!lines.length)return'';
        return `<div class="res-ws-section">
          <div class="res-ws-section-title">
            <span class="res-ws-section-icon">${page.icon}</span>
            <span>${page.title}</span>
          </div>
          ${lines.map(f=>{
            const v=ws[f.key]||'';
            if(f.type==='opts'||f.type==='reward_pick'){
              return `<div class="res-ws-field">
                <div class="res-ws-label">${esc(f.label)}</div>
                <div class="res-ws-opts"><span class="res-ws-opt-chip">${esc(v)}</span></div>
              </div>`;
            }
            return `<div class="res-ws-field">
              <div class="res-ws-label">${esc(f.label)}</div>
              <div class="res-ws-val">${esc(v)}</div>
            </div>`;
          }).join('')}
        </div>`;
      }).filter(Boolean).join('');
    } else {
      // 구버전 호환
      const ansData=m.ansData||[];
      leftHtml=ansData.map(a=>`<div class="res-ws-field">
        <div class="res-ws-label">${esc(a.cat||a.text||'')}</div>
        <div class="res-ws-val">${esc(a.val||'')}</div>
      </div>`).join('') || `<div class="res-ws-val">${esc(m.short||m.text||'')}</div>`;
    }

    // 오른쪽: AI 요약 (새 구조) or 구버전 fallback
    let rightHtml='';
    if(m.aiSummary){
      rightHtml=`<div class="res-ai-summary">${esc(m.aiSummary).replace(/\n/g,'<br>')}</div>
        ${m.aiPhil&&m.aiPhil.length?`<div class="res-ai-phil-label">꺼내볼 가치관</div>
        ${m.aiPhil.map(p=>`<div class="res-ai-phil-item">
          <div class="res-ai-phil-tag">${esc(p.tag||'')}</div>
          <div class="res-ai-phil-content">${esc(p.content||'')}</div>
          <div class="res-ai-phil-why">↳ ${esc(p.why||'')}</div>
        </div>`).join('')}`:''}`;
    } else {
      // 구버전
      rightHtml=`<div class="res-ai-summary">${esc(m.col2||m.analysis||'').replace(/\n/g,'<br>')}</div>`;
    }

    // 다짐 영역
    const commitHtml=m.commitment
      ?`<div class="rs-commitment">
          <div class="rs-commitment-label">✦ 나의 다짐</div>
          <div class="rs-commitment-text">${esc(m.commitment)}</div>
          <div class="rs-commitment-input" style="margin-top:8px">
            <textarea id="rsc_${m.id}" class="rs-commitment-ta" placeholder="수정...">${esc(m.commitment)}</textarea>
            <button class="rs-commitment-btn" onclick="saveResultCommitment(${m.id})">저장</button>
          </div>
        </div>`
      :`<div class="rs-commitment">
          <div class="rs-commitment-label">✦ 다짐 · 생각</div>
          <div class="rs-commitment-input">
            <textarea id="rsc_${m.id}" class="rs-commitment-ta" placeholder="이 결과를 읽고 드는 생각이나 다짐을 남겨봐..."></textarea>
            <button class="rs-commitment-btn" onclick="saveResultCommitment(${m.id})">저장</button>
          </div>
        </div>`;

    return `<div class="result-sheet" id="${id}">
      <div class="result-sheet-header">
        <div>
          <div class="result-sheet-date">${m.ts||m.date}</div>
          <div class="result-sheet-title">${esc((m.short||'').slice(0,50))}${(m.short||'').length>50?'…':''}</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="result-sheet-toggle" onclick="toggleResultSheet('${id}')">접기 ▲</button>
          <button class="memo-del" style="position:static" onclick="deleteMemo(${m.id})">×</button>
        </div>
      </div>
      <div class="result-sheet-grid" id="${id}_grid">
        <div class="result-sheet-col"><div class="result-sheet-col-head">내가 입력한 것</div>
          <div style="padding:14px">${leftHtml}</div>
        </div>
        <div class="result-sheet-col res-ai-panel"><div class="result-sheet-col-head">AI 읽기</div>
          <div style="padding:14px">${rightHtml}</div>
        </div>
      </div>
      ${commitHtml}
    </div>`;
  }).join('');
}

function toggleResultSheet(id){
  const grid=document.getElementById(id+'_grid');
  const btn=document.querySelector('#'+id+' .result-sheet-toggle');
  if(!grid)return;
  const isOpen=grid.style.display!=='none';
  grid.style.display=isOpen?'none':'grid';
  if(btn)btn.textContent=isOpen?'펼치기 ▼':'접기 ▲';
}

// ── 결과지 저장 (4컬럼 구조 저장) ────────────────────────
function saveResult(){
  if(!lastResult){showToast('저장할 결과가 없어');return;}
  const ws=lastResult.wsAnswers||{};
  const aiData=lastResult.aiData||{};
  // 제목: AI summary 첫 문장 (없으면 task1 텍스트)
  const summaryFirst=(aiData.summary||'').split(/[.。！!?？]/)[0].trim().slice(0,60);
  const task1Raw=ws['task1'];
  const task1Txt=typeof task1Raw==='object'?(task1Raw.text||''):task1Raw||'';
  const short=summaryFirst||task1Txt.slice(0,60)||'오늘의 체크인';
  const commitment=document.getElementById('resCommitTa')?.value.trim()||'';
  memos=[{
    id:Date.now(),type:'result',
    date:new Date().toLocaleDateString('ko-KR'),
    ts:lastResult.ts,short,
    wsAnswers:ws,
    aiSummary:aiData.summary||'',
    aiPhil:aiData.phil||[],
    commitment
  },...memos];
  localStorage.setItem('memos_v5',JSON.stringify(memos));
  renderMemos();renderResultList();renderMeResults();renderMeTab();
  showToast('결과지 저장됐어!');
  if(fbUser)fbSaveAll();
}

// 결과지 다짐 저장 (현재 결과지 페이지에서 바로 저장)
function saveCommitment(){
  const val=document.getElementById('resCommitTa')?.value.trim();
  if(!val){showToast('다짐을 입력해줘');return;}
  if(!lastResult){showToast('먼저 결과지를 저장해줘');return;}
  // 이미 저장된 결과지가 있으면 거기에 반영, 없으면 lastResult에만
  if(memos.length>0&&memos[0].type==='result'&&memos[0].ts===lastResult.ts){
    memos[0].commitment=val;
    localStorage.setItem('memos_v5',JSON.stringify(memos));
    renderResultList();renderMeResults();renderMeTab();
    if(fbUser)fbSaveAll();
    showToast('다짐 저장됐어!');
  } else {
    lastResult.commitment=val;
    showToast('다짐 메모됐어 (결과지 저장 시 함께 저장됨)');
  }
}

// 저장된 결과지에서 다짐 수정
function saveResultCommitment(memoId){
  const ta=document.getElementById('rsc_'+memoId);
  if(!ta)return;
  const val=ta.value.trim();
  const idx=memos.findIndex(m=>m.id===memoId);
  if(idx<0)return;
  memos[idx].commitment=val;
  localStorage.setItem('memos_v5',JSON.stringify(memos));
  renderResultList();renderMeResults();renderMeTab();
  if(fbUser)fbSaveAll();
  showToast('다짐 저장됐어!');
}

// ── 성장 지표 ─────────────────────────────────────────────
let metricsData=JSON.parse(localStorage.getItem('metrics_v1')||'[]');

function renderMetricsPanel(){
  metricsData=JSON.parse(localStorage.getItem('metrics_v1')||'[]');
  const el=document.getElementById('metricsPanel');if(!el)return;
  if(metricsData.length===0){
    el.innerHTML=`<div class="memo-empty">달리기 거리, 체중, 운동 횟수 같은<br>숫자 지표를 추가해봐. 성장이 보여.</div>`;
    return;
  }
  el.innerHTML=`<div class="metric-graph-wrap">${metricsData.map((m,i)=>{
    const history=m.history||[];
    const curr=m.current||0;
    const goal=m.goal||0;
    const pct=goal>0?Math.min(100,Math.round((curr/goal)*100)):0;
    // 히스토리 바 차트
    const barHtml=history.length>=1?renderMetricChart(history,m.chartType,m.chartStyle,goal):'';
    const goalHtml=goal>0?`
      <div class="metric-progress-wrap" style="margin-top:6px">
        <div class="metric-progress-bg"><div class="metric-progress-fill" style="width:${pct}%"></div></div>
        <div class="metric-progress-pct">${pct}% 달성</div>
      </div>`:'';
    return `<div class="metric-graph-item" style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px 16px">
      <div class="metric-graph-header">
        <span class="metric-graph-name">${esc(m.name)}</span>
        <span><span class="metric-graph-val">${curr}</span><span class="metric-graph-unit">${esc(m.unit)}</span>${goal>0?`<span class="metric-graph-goal"> / 목표 ${goal}${esc(m.unit)}</span>`:''}</span>
      </div>
      ${barHtml}
      ${goalHtml}
      <div class="metric-note-row" style="margin-top:6px">
        <span class="metric-note">${esc(m.note||'')}</span>
        <div style="display:flex;gap:8px">
          <button class="metric-edit-btn" onclick="openMetricLogModal(${i})">+ 기록</button>
          <button class="metric-edit-btn" onclick="openMetricModal(${i})">편집 ✎</button>
        </div>
      </div>
    </div>`;
  }).join('')}</div>`;
}

// ── 통합 그래프 렌더러 ────────────────────────────────────
function renderMetricChart(history, chartType, chartStyle, goal){
  if(!history||history.length<1)return'';
  const type=chartType||'line';
  const style=chartStyle||'default';
  if(type==='bar') return renderBarChart(history, style, goal);
  return renderLineChart(history, goal, type, style);
}

function renderBarChart(history, style, goal){
  if(!history||history.length<1)return'';
  if(history.length===1){
    const p=history[0];
    const W=260,H=52,PAD_L=style==='minimal'?4:28;
    const d=(p.date||'').replace(/^\d{4}\./,'').replace(/\.$/,'');
    const barH=Math.max(8,Math.round((p.val/(goal||p.val||1))*40));
    return `<div class="me-linechart-wrap" style="margin-bottom:6px"><svg viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">
      <rect x="${PAD_L}" y="${H-barH-12}" width="24" height="${barH}" rx="3" fill="var(--accent)" opacity=".85"/>
      <text x="${PAD_L+12}" y="${H-1}" text-anchor="middle" font-size="8" fill="var(--textF)">${d}</text>
      <text x="${PAD_L+36}" y="${H-12}" font-size="11" fill="var(--foreground-2)">${p.val}</text>
    </svg></div>`;
  }
  const pts=history.slice(-10);
  const maxV=Math.max(...pts.map(h=>h.val),goal||0,0.1);
  const H=52; // 차트 높이 px
  const isBold=style==='bold';
  const isMin=style==='minimal';
  const isGrad=style==='gradient';

  const barColor=isGrad?'url(#bg_'+style+')':'var(--accent)';
  const gradDef=isGrad?`<defs><linearGradient id="bg_${style}" x1="0" y1="0" x2="0" y2="1">
    <stop offset="0%" stop-color="var(--accent)" stop-opacity="1"/>
    <stop offset="100%" stop-color="var(--accent)" stop-opacity=".6"/>
  </linearGradient></defs>`:'';

  const W=260, PAD_L=isMin?4:28, PAD_R=8, PAD_T=6, PAD_B=18;
  const iW=W-PAD_L-PAD_R;
  const n=pts.length;
  const colW=Math.floor(iW/n);
  const barW=Math.max(4, colW-(isBold?2:6));
  const iH=H-PAD_T-PAD_B;

  const bars=pts.map((p,i)=>{
    const bh=Math.max(2,Math.round((p.val/maxV)*iH));
    const x=PAD_L+i*colW+(colW-barW)/2;
    const y=PAD_T+iH-bh;
    const d=(p.date||'').replace(/^\d{4}\./,'').replace(/\.$/,'');
    const r=isBold?3:2;
    return `<rect x="${x}" y="${y}" width="${barW}" height="${bh}" rx="${r}" fill="${barColor}" opacity="${isMin?'.6':'1'}"/>
      ${!isMin?`<text x="${x+barW/2}" y="${H}" text-anchor="middle" font-size="8" fill="var(--textF)">${d}</text>`:''}`;
  }).join('');

  // 목표선
  const goalY=goal>0?PAD_T+iH-Math.round((goal/maxV)*iH):null;
  const goalLine=goalY!==null?`<line x1="${PAD_L}" y1="${goalY}" x2="${W-PAD_R}" y2="${goalY}" stroke="var(--accent)" stroke-width="1" stroke-dasharray="4,3" opacity=".7"/>
    <text x="${W-PAD_R-2}" y="${goalY-3}" text-anchor="end" font-size="8" fill="var(--accent)">목표</text>`:'';

  // Y축 (minimal 제외)
  const yAxis=!isMin?`<line x1="${PAD_L}" y1="${PAD_T}" x2="${PAD_L}" y2="${PAD_T+iH}" stroke="var(--border)" stroke-width="1"/>
    <text x="${PAD_L-3}" y="${PAD_T+5}" text-anchor="end" font-size="8" fill="var(--textF)">${maxV}</text>`:'';

  return `<div class="me-linechart-wrap" style="margin-bottom:6px">
    <svg viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">
      ${gradDef}${yAxis}${goalLine}${bars}
    </svg>
  </div>`;
}

function openMetricModal(editIdx){
  const isEdit=typeof editIdx==='number'&&editIdx>=0;
  const m=isEdit?metricsData[editIdx]:{name:'',unit:'',current:0,goal:0,note:''};
  const curChart=m.chartType||'line';
  const curStyle=m.chartStyle||'default';
  makeModal(`
    <div class="nds-modal-title">${isEdit?'지표 편집':'새 지표 추가'}</div>
    <div class="nds-field">
      <div class="nds-field-label">이름</div>
      <input id="mName" class="nds-inp" placeholder="예: 달리기 거리, 체중, 운동 횟수" value="${esc(m.name)}">
    </div>
    <div class="nds-field" style="display:flex;gap:10px">
      <div style="flex:1">
        <div class="nds-field-label">단위</div>
        <input id="mUnit" class="nds-inp" placeholder="km, kg, 회" value="${esc(m.unit)}">
      </div>
      <div style="flex:1">
        <div class="nds-field-label">현재 값</div>
        <input id="mCurrent" class="nds-inp" type="number" value="${m.current||0}">
      </div>
      <div style="flex:1">
        <div class="nds-field-label">목표 (0=없음)</div>
        <input id="mGoal" class="nds-inp" type="number" value="${m.goal||0}">
      </div>
    </div>
    <div class="nds-field">
      <div class="nds-field-label">메모 (선택)</div>
      <input id="mNote" class="nds-inp" value="${esc(m.note||'')}" placeholder="짧은 메모">
    </div>
    <div class="nds-field">
      <div class="nds-field-label">그래프 유형</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="ws-opt${curChart==='line'?' sel':''}" onclick="selectChartOpt('mChartType','line',this)">📈 꺾은선</button>
        <button class="ws-opt${curChart==='bar'?' sel':''}" onclick="selectChartOpt('mChartType','bar',this)">📊 막대</button>
        <button class="ws-opt${curChart==='area'?' sel':''}" onclick="selectChartOpt('mChartType','area',this)">🏔 영역</button>
        <button class="ws-opt${curChart==='dot'?' sel':''}" onclick="selectChartOpt('mChartType','dot',this)">⚬ 점</button>
      </div>
      <input type="hidden" id="mChartType" value="${curChart}">
    </div>
    <div class="nds-field">
      <div class="nds-field-label">스타일</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="ws-opt${curStyle==='default'?' sel':''}" onclick="selectChartOpt('mChartStyle','default',this)">기본</button>
        <button class="ws-opt${curStyle==='bold'?' sel':''}" onclick="selectChartOpt('mChartStyle','bold',this)">굵게</button>
        <button class="ws-opt${curStyle==='minimal'?' sel':''}" onclick="selectChartOpt('mChartStyle','minimal',this)">미니멀</button>
        <button class="ws-opt${curStyle==='gradient'?' sel':''}" onclick="selectChartOpt('mChartStyle','gradient',this)">그라디언트</button>
      </div>
      <input type="hidden" id="mChartStyle" value="${curStyle}">
    </div>
    <div class="nds-btn-row">
      <button class="nds-btn-primary" onclick="saveMetricItem(${isEdit?editIdx:-1})">저장</button>
      ${isEdit?`<button class="nds-btn-danger" onclick="deleteMetricItem(${editIdx})">삭제</button>`:''}
      <button class="nds-btn-ghost" onclick="this.closest('.nds-modal').remove()">취소</button>
    </div>
  `);
}

function openMetricLogModal(idx){
  const m=metricsData[idx];if(!m)return;
  makeModal(`
    <div class="nds-modal-title">${esc(m.name)} 기록</div>
    <div class="nds-field">
      <div class="nds-field-label">오늘 값 (${esc(m.unit)})</div>
      <input id="logVal" class="nds-inp" type="number" placeholder="숫자 입력" style="font-size:22px;font-weight:700;text-align:center;color:var(--accent)">
    </div>
    ${m.goal>0?`<div style="font-size:12px;color:var(--textF);text-align:center;margin-top:-4px;margin-bottom:8px">현재 ${m.current}${esc(m.unit)} / 목표 ${m.goal}${esc(m.unit)}</div>`:''}
    <div class="nds-btn-row">
      <button class="nds-btn-primary" onclick="saveMetricLog(${idx})">기록하기</button>
      <button class="nds-btn-ghost" onclick="this.closest('.nds-modal').remove()">취소</button>
    </div>
  `);
}

function selectChartOpt(inputId, val, btn){
  document.getElementById(inputId).value=val;
  const row=btn.closest('div');
  row.querySelectorAll('.ws-opt').forEach(b=>b.classList.remove('sel'));
  btn.classList.add('sel');
}

function saveMetricItem(editIdx){
  const item={
    name:document.getElementById('mName').value.trim(),
    unit:document.getElementById('mUnit').value.trim(),
    current:parseFloat(document.getElementById('mCurrent').value)||0,
    goal:parseFloat(document.getElementById('mGoal').value)||0,
    note:document.getElementById('mNote').value.trim(),
    chartType:document.getElementById('mChartType')?.value||'line',
    chartStyle:document.getElementById('mChartStyle')?.value||'default',
    history:editIdx>=0?(metricsData[editIdx].history||[]):[]
  };
  if(!item.name){showToast('이름을 입력해줘');return;}
  if(editIdx>=0)metricsData[editIdx]=item;
  else metricsData.push(item);
  localStorage.setItem('metrics_v1',JSON.stringify(metricsData));
  document.querySelector('.nds-modal')?.remove();
  renderMetricsPanel();
  if(fbUser)fbSaveAll();
}

function saveMetricLog(idx){
  const val=parseFloat(document.getElementById('logVal').value);
  if(isNaN(val)){showToast('값을 입력해줘');return;}
  metricsData[idx].current=val;
  if(!metricsData[idx].history)metricsData[idx].history=[];
  metricsData[idx].history.push({val,date:new Date().toLocaleDateString('ko-KR')});
  if(metricsData[idx].history.length>30)metricsData[idx].history=metricsData[idx].history.slice(-30);
  localStorage.setItem('metrics_v1',JSON.stringify(metricsData));
  document.querySelector('.nds-modal')?.remove();
  renderMetricsPanel();renderMeMetrics();showToast('기록됐어!');
  if(fbUser)fbSaveAll();
}

function deleteMetricItem(idx){
  metricsData.splice(idx,1);
  localStorage.setItem('metrics_v1',JSON.stringify(metricsData));
  document.querySelector('.nds-modal')?.remove();
  renderMetricsPanel();
}

// ── 보상 탭 — 충전/방전 LIST ──────────────────────────────
let rewardData={charge:[],drain:[]};

function initRewardData(){
  rewardData=JSON.parse(localStorage.getItem('reward_data')||'{"charge":[],"drain":[]}');
}

function saveRewardData(){
  localStorage.setItem('reward_data',JSON.stringify(rewardData));
  if(fbUser)fbSaveAll();
}

function toggleRewardSec(type){
  const list=document.getElementById(type+'-list');
  const arr=document.getElementById('arr-'+type);
  const isOpen=arr.classList.contains('open');
  list.style.display=isOpen?'none':'block';
  arr.classList.toggle('open');
}

function renderRewards(){
  initRewardData();
  renderRewardList('charge');
  renderRewardList('drain');
  renderRealNeed();
}

function renderRewardList(type){
  const items=rewardData[type]||[];
  const el=document.getElementById(type+'-items');if(!el)return;
  if(items.length===0){
    el.innerHTML=`<div class="rw-empty">${type==='charge'
      ?'직접 해보고 좋았던 것들을 추가해봐.<br>산책, 반신욕, 운동, 좋아하는 음악 등.'
      :'끝이 안 좋았던 것들을 기록해봐.<br>유튜브 과다, 늦게까지 전자기기 등.'}</div>`;
    return;
  }
  el.innerHTML=items.map((item,i)=>{
    const logs=item.logs||[];
    const logPanelId=`${type}-log-${i}`;
    const logHtml=logs.length>0
      ?logs.slice(-5).reverse().map((l,li)=>`
        <div class="rw-log-entry">
          <span class="rw-log-date">${l.date||''}</span>
          ${l.photo?`<img class="rw-log-photo" src="${l.photo}" data-idx="${logs.length-1-li}" data-type="${type}" data-item="${i}" onclick="viewLogPhoto(this)" alt="">`:''}
          <span class="rw-log-note">${esc(l.note||'')}</span>
          <button class="rw-log-del" onclick="event.stopPropagation();deleteRewardLog('${type}',${i},${logs.length-1-li})">×</button>
        </div>`).join('')
      :`<div class="rw-log-empty">아직 기록이 없어. 오늘 해봤으면 기록해봐.</div>`;
    return `<div class="rw-card ${type}">
      <div class="rw-card-main" onclick="toggleLogPanel('${logPanelId}')">
        <span class="rw-card-emoji">${item.emoji||'·'}</span>
        <div class="rw-card-info">
          <div class="rw-card-name">${esc(item.name)}</div>
          ${item.feeling?`<div class="rw-card-feeling">${esc(item.feeling)}</div>`:''}
          ${logs.length>0?`<div class="rw-card-meta">${logs.length}회 기록됨 · 마지막 ${logs[logs.length-1].date||''}</div>`:''}
        </div>
        <div class="rw-card-actions" onclick="event.stopPropagation()">
          <button class="rw-log-btn ${type}" onclick="openRewardLogForm('${type}',${i})">+ 기록</button>
          <button class="rw-edit-btn" onclick="openRewardEditModal('${type}',${i})">✎</button>
          <button class="rw-del-btn" onclick="deleteRewardItem('${type}',${i})">삭제</button>
        </div>
      </div>
      <div class="rw-log-panel" id="${logPanelId}" style="display:none">
        ${logHtml}
      </div>
    </div>`;
  }).join('');
}

function toggleLogPanel(id){
  const el=document.getElementById(id);if(!el)return;
  el.style.display=el.style.display==='none'?'block':'none';
}

// ── 바텀시트 모달 생성 헬퍼 ──────────────────────────────
function makeModal(innerHtml){
  const modal=document.createElement('div');
  modal.className='nds-modal';
  const box=document.createElement('div');
  box.className='nds-modal-box';
  box.innerHTML='<div class="nds-modal-handle"></div>';
  const inner=document.createElement('div');
  inner.className='nds-modal-inner';
  if(innerHtml&&typeof innerHtml==='object'&&innerHtml.nodeType){
    inner.appendChild(innerHtml);
  } else {
    inner.innerHTML=innerHtml;
  }
  box.appendChild(inner);
  modal.appendChild(box);
  document.body.appendChild(modal);
  modal.addEventListener('click',e=>{if(e.target===modal)modal.remove();});
  setTimeout(()=>modal.querySelector('input,textarea')?.focus(),100);
  return modal;
}

function openRewardModal(type){
  const isCharge=type==='charge';
  makeModal(`
    <div class="nds-modal-title">${isCharge?'💙 충전 활동 추가':'🔴 방전 활동 추가'}</div>
    <div class="nds-field">
      <div class="nds-field-label">활동 이름</div>
      <input id="rwName" class="nds-inp" placeholder="${isCharge?'예: 산책, 반신욕, 운동':'예: 유튜브 과다, 늦게까지 핸드폰'}">
    </div>
    <div class="nds-field" style="display:flex;gap:10px">
      <div style="flex:0 0 72px">
        <div class="nds-field-label">이모지</div>
        <input id="rwEmoji" class="nds-inp" value="${isCharge?'🌿':'📱'}" style="text-align:center;font-size:20px;padding:10px">
      </div>
      <div style="flex:1">
        <div class="nds-field-label">${isCharge?'실제로 어떤 느낌?':'끝나고 어떤 기분?'}</div>
        <input id="rwFeeling" class="nds-inp" placeholder="${isCharge?'예: 머리 맑아짐, 개운함':'예: 눈 아프고 피곤함, 후회됨'}">
      </div>
    </div>
    <div class="nds-btn-row">
      <button class="nds-btn-primary ${type}" onclick="saveRewardItem('${type}')">추가하기</button>
      <button class="nds-btn-ghost" onclick="this.closest('.nds-modal').remove()">취소</button>
    </div>
  `);
}

function saveRewardItem(type){
  const name=document.getElementById('rwName').value.trim();
  if(!name){showToast('이름을 입력해줘');return;}
  rewardData[type].push({
    name,
    emoji:document.getElementById('rwEmoji').value.trim()||(type==='charge'?'🌿':'📱'),
    feeling:document.getElementById('rwFeeling').value.trim(),
    logs:[]
  });
  saveRewardData();
  document.querySelector('.nds-modal')?.remove();
  renderRewardList(type);showToast('추가됐어!');
}


// ═══════════════════════════════════════════════════════════
// ── 충전탭 — 항목 편집 ─────────────────────────────────────
// ═══════════════════════════════════════════════════════════

function openRewardEditModal(type, idx){
  const item=rewardData[type][idx];if(!item)return;
  const isCharge=type==='charge';
  makeModal(`
    <div class="nds-modal-title">${isCharge?'💙 충전 활동 편집':'🔴 방전 활동 편집'}</div>
    <div class="nds-field">
      <div class="nds-field-label">활동 이름</div>
      <input id="rwEditName" class="nds-inp" value="${esc(item.name)}">
    </div>
    <div class="nds-field" style="display:flex;gap:10px">
      <div style="flex:0 0 72px">
        <div class="nds-field-label">이모지</div>
        <input id="rwEditEmoji" class="nds-inp" value="${esc(item.emoji||'')}" style="text-align:center;font-size:20px;padding:10px">
      </div>
      <div style="flex:1">
        <div class="nds-field-label">${isCharge?'실제로 어떤 느낌?':'끝나고 어떤 기분?'}</div>
        <input id="rwEditFeeling" class="nds-inp" value="${esc(item.feeling||'')}" placeholder="${isCharge?'예: 머리 맑아짐, 개운함':'예: 눈 아프고 피곤함'}">
      </div>
    </div>
    <div class="nds-btn-row">
      <button class="nds-btn-primary" onclick="saveRewardEdit('${type}',${idx})">저장</button>
      <button class="nds-btn-ghost" onclick="this.closest('.nds-modal').remove()">취소</button>
    </div>
  `);
}

function saveRewardEdit(type, idx){
  const name=document.getElementById('rwEditName')?.value.trim();
  if(!name){showToast('이름을 입력해줘');return;}
  rewardData[type][idx].name=name;
  rewardData[type][idx].emoji=document.getElementById('rwEditEmoji')?.value.trim()||(type==='charge'?'🌿':'📱');
  rewardData[type][idx].feeling=document.getElementById('rwEditFeeling')?.value.trim()||'';
  saveRewardData();
  document.querySelector('.nds-modal')?.remove();
  renderRewardList(type);showToast('수정됐어!');
}

// ── 진짜 원하는 것 ────────────────────────────────────────
let realNeedData=JSON.parse(localStorage.getItem('real_need_v1')||'[]');

function saveRealNeedData(){
  localStorage.setItem('real_need_v1',JSON.stringify(realNeedData));
}

function renderRealNeed(){
  const el=document.getElementById('real-need-area');if(!el)return;
  if(realNeedData.length===0){
    el.innerHTML=`<div class="real-need-hint">끌린다고 원하는 게 아닐 수 있어.<br>지금 내가/내 몸이 <em>진짜로</em> 필요한 게 뭔지 물어봐.</div>`;
    return;
  }
  el.innerHTML=realNeedData.slice().reverse().map((r,i)=>{
    const realIdx=realNeedData.length-1-i;
    return `<div class="real-need-entry">
      <div class="real-need-entry-text">${esc(r.text)}</div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:3px;flex-shrink:0">
        <div class="real-need-entry-date">${r.date||''}</div>
        <button class="real-need-del" onclick="deleteRealNeed(${realIdx})">×</button>
      </div>
    </div>`;
  }).join('');
}

function openRealNeedPrompt(){
  makeModal(`
    <div class="nds-modal-title">✦ 지금 진짜 필요한 게 뭐야?</div>
    <div style="font-size:12px;color:var(--textF);line-height:1.9;margin-bottom:14px">
      지금 끌리는 것 말고 —<br>
      지금 내 몸/마음이 <strong>실제로 필요로 하는 것</strong>을 생각해봐.<br>
      <span style="color:var(--accent)">피곤함? 외로움? 인정? 고요함? 움직임?</span>
    </div>
    <div class="nds-field">
      <div class="nds-field-label">지금 진짜 필요한 것</div>
      <textarea id="realNeedTa" class="nds-ta" rows="3" placeholder="예: 눈을 쉬게 하는 것 / 조용히 누워있기 / 따뜻한 것 먹기 / 산책 5분..."></textarea>
    </div>
    <div class="nds-btn-row">
      <button class="nds-btn-primary" onclick="saveRealNeed()">기록하기</button>
      <button class="nds-btn-ghost" onclick="this.closest('.nds-modal').remove()">닫기</button>
    </div>
  `);
}

function saveRealNeed(){
  const val=document.getElementById('realNeedTa')?.value.trim();
  if(!val){showToast('내용을 입력해줘');return;}
  realNeedData.push({text:val,date:new Date().toLocaleDateString('ko-KR')});
  saveRealNeedData();
  document.querySelector('.nds-modal')?.remove();
  renderRealNeed();showToast('기록됐어!');
}

function deleteRealNeed(idx){
  realNeedData.splice(idx,1);
  saveRealNeedData();renderRealNeed();
}

// renderRealNeed는 renderRewards에 직접 통합됨

// ═══════════════════════════════════════════════════════════
// ── 인박스 시스템 ──────────────────────────────────────────
// ═══════════════════════════════════════════════════════════

const INBOX_DEFAULT_CATS=[
  {id:'todo',   label:'할 일',  color:'#4a7a50'},
  {id:'idea',   label:'아이디어', color:'#8a50a0'},
  {id:'feel',   label:'감정·생각', color:'#5080a0'},
  {id:'later',  label:'나중에',  color:'#a07040'},
  {id:'misc',   label:'기타',   color:'#808080'},
];

let inboxItems=JSON.parse(localStorage.getItem('inbox_v1')||'[]');
let inboxCats=JSON.parse(localStorage.getItem('inbox_cats_v1')||JSON.stringify(INBOX_DEFAULT_CATS));
let inboxActiveCat='all';

function saveInboxData(){
  localStorage.setItem('inbox_v1',JSON.stringify(inboxItems));
  if(fbUser)fbSaveAll();
}

function renderInbox(){
  renderInboxCatTabs();
  renderInboxMessages();
  renderInboxCatSelect();
}

function renderInboxCatTabs(){
  const el=document.getElementById('inboxCatTabs');if(!el)return;
  const allCount=inboxItems.filter(m=>!m.done).length;
  let html=`<button class="inbox-cat-tab${inboxActiveCat==='all'?' active':''}" onclick="setInboxCat('all')">전체 ${allCount>0?allCount:''}</button>`;
  inboxCats.forEach(cat=>{
    const n=inboxItems.filter(m=>m.catId===cat.id&&!m.done).length;
    html+=`<button class="inbox-cat-tab${inboxActiveCat===cat.id?' active':''}" onclick="setInboxCat('${cat.id}')" style="${inboxActiveCat===cat.id?'background:'+cat.color+';border-color:'+cat.color:''}">${cat.label}${n>0?' '+n:''}</button>`;
  });
  html+=`<button class="inbox-cat-tab" onclick="openInboxCatManager()" style="opacity:.6">+ 카테고리</button>`;
  el.innerHTML=html;
}

function renderInboxCatSelect(){
  const el=document.getElementById('inboxCatSelect');if(!el)return;
  el.innerHTML=inboxCats.map(cat=>`<option value="${cat.id}">${cat.label}</option>`).join('');
}

function renderInboxMessages(){
  const el=document.getElementById('inboxMessages');if(!el)return;
  let items=inboxActiveCat==='all'?[...inboxItems]:inboxItems.filter(m=>m.catId===inboxActiveCat);
  // 미완료 최신순 → 완료 순
  const active=items.filter(m=>!m.done).sort((a,b)=>b.id-a.id);
  const done=items.filter(m=>m.done).sort((a,b)=>b.id-a.id);
  items=[...active,...done];

  if(items.length===0){
    el.innerHTML=`<div class="inbox-empty">아직 비어있어.<br>머릿속에 있는 것을 아래에 던져봐.</div>`;
    return;
  }
  const prioLabel={high:'🔴 핵심',mid:'🟡 일반',low:'🟢 여유'};
  const cat=id=>inboxCats.find(c=>c.id===id)||{label:'기타',color:'#808080'};
  el.innerHTML=items.map(m=>{
    const c=cat(m.catId);
    const realIdx=inboxItems.findIndex(x=>x.id===m.id);
    return `<div class="inbox-msg">
      <div class="inbox-bubble${m.done?' processed':''}${m.priority==='high'?' high-prio':''}">${esc(m.text)}</div>
      <div class="inbox-msg-meta">
        <span class="inbox-msg-time">${m.time||''}</span>
        <span class="inbox-msg-cat" style="background:${c.color}22;color:${c.color}">${c.label}</span>
        ${m.priority?`<span class="inbox-priority-badge ${m.priority}">${prioLabel[m.priority]||''}</span>`:''}
      </div>
      <div class="inbox-msg-actions">
        <button class="inbox-action-btn${m.done?' done':''}" onclick="toggleInboxDone(${realIdx})">${m.done?'✓ 완료':'완료'}</button>
        <button class="inbox-action-btn" onclick="openInboxItemEdit(${realIdx})">우선순위·분류</button>
        <button class="inbox-action-btn" onclick="sendToTodo(${realIdx})" title="나 탭 할일로">→ 할일</button>
        <button class="inbox-action-btn sub" onclick="sendToSubItem(${realIdx})" title="기존 할일의 하위 항목으로">+ 하위항목</button>
        <button class="inbox-action-btn" onclick="deleteInboxItem(${realIdx})">삭제</button>
      </div>
    </div>`;
  }).join('');
  // 스크롤 최하단 (새 메시지 쪽)
  el.scrollTop=0;
}

function setInboxCat(catId){
  inboxActiveCat=catId;
  renderInboxCatTabs();
  renderInboxMessages();
}

function sendInboxItem(){
  const ta=document.getElementById('inboxInputTa');
  const text=ta?.value.trim();
  if(!text)return;
  const catId=document.getElementById('inboxCatSelect')?.value||'misc';
  const now=new Date();
  const time=`${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  inboxItems.unshift({id:Date.now(),text,catId,time,priority:'',done:false});
  saveInboxData();
  if(ta)ta.value='';
  if(ta)ta.style.height='auto';
  renderInboxMessages();
  renderInboxCatTabs();
}

function toggleInboxDone(idx){
  if(!inboxItems[idx])return;
  inboxItems[idx].done=!inboxItems[idx].done;
  saveInboxData();renderInboxMessages();renderInboxCatTabs();
}

function deleteInboxItem(idx){
  inboxItems.splice(idx,1);
  saveInboxData();renderInboxMessages();renderInboxCatTabs();
}

function sendToTodo(idx){
  const m=inboxItems[idx];if(!m)return;
  todoItems=JSON.parse(localStorage.getItem('todo_items')||'[]');
  if(todoItems.find(t=>t.text===m.text)){showToast('이미 할일에 있어');return;}
  todoItems.unshift({
    id:Date.now(),text:m.text,
    priority:m.priority||'mid',
    done:false,date:new Date().toLocaleDateString('ko-KR')
  });
  localStorage.setItem('todo_items',JSON.stringify(todoItems));
  inboxItems[idx].done=true;
  saveInboxData();renderInboxMessages();renderInboxCatTabs();
  showToast('할일 탭으로 이동됐어!');
}

function openInboxItemEdit(idx){
  const m=inboxItems[idx];if(!m)return;
  const catOpts=inboxCats.map(c=>`<option value="${c.id}"${m.catId===c.id?' selected':''}>${c.label}</option>`).join('');
  makeModal(`
    <div class="nds-modal-title">항목 설정</div>
    <div class="nds-field">
      <div class="nds-field-label">내용 (수정 불가)</div>
      <div style="font-size:13px;color:var(--text);padding:8px 0;line-height:1.7">${esc(m.text)}</div>
    </div>
    <div class="nds-field">
      <div class="nds-field-label">카테고리</div>
      <select id="ibEditCat" class="nds-inp">${catOpts}</select>
    </div>
    <div class="nds-field">
      <div class="nds-field-label">우선순위</div>
      <div style="display:flex;gap:8px">
        <button class="ws-opt${m.priority==='high'?' sel':''}" onclick="setInboxPrio('high',this)">🔴 핵심</button>
        <button class="ws-opt${m.priority==='mid'?' sel':''}" onclick="setInboxPrio('mid',this)">🟡 일반</button>
        <button class="ws-opt${m.priority==='low'?' sel':''}" onclick="setInboxPrio('low',this)">🟢 여유</button>
        <button class="ws-opt${!m.priority?' sel':''}" onclick="setInboxPrio('',this)">없음</button>
      </div>
      <input type="hidden" id="ibEditPrio" value="${m.priority||''}">
    </div>
    <div class="nds-btn-row">
      <button class="nds-btn-primary" onclick="saveInboxItemEdit(${idx})">저장</button>
      <button class="nds-btn-ghost" onclick="this.closest('.nds-modal').remove()">취소</button>
    </div>
  `);
}

function setInboxPrio(val, btn){
  document.getElementById('ibEditPrio').value=val;
  btn.closest('div').querySelectorAll('.ws-opt').forEach(b=>b.classList.remove('sel'));
  btn.classList.add('sel');
}

function saveInboxItemEdit(idx){
  inboxItems[idx].catId=document.getElementById('ibEditCat')?.value||inboxItems[idx].catId;
  inboxItems[idx].priority=document.getElementById('ibEditPrio')?.value||'';
  saveInboxData();
  document.querySelector('.nds-modal')?.remove();
  renderInboxMessages();renderInboxCatTabs();showToast('저장됐어!');
}

function openInboxCatManager(){
  const catList=inboxCats.map((c,i)=>`
    <div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border)">
      <span style="font-size:16px;width:20px;text-align:center;background:${c.color}22;border-radius:4px;padding:2px">${c.label[0]}</span>
      <span style="flex:1;font-size:13px">${esc(c.label)}</span>
      <button class="inbox-action-btn" onclick="deleteInboxCat(${i})">삭제</button>
    </div>`).join('');
  makeModal(`
    <div class="nds-modal-title">카테고리 관리</div>
    <div style="margin-bottom:14px">${catList}</div>
    <div class="nds-field">
      <div class="nds-field-label">새 카테고리</div>
      <input id="newCatName" class="nds-inp" placeholder="이름">
    </div>
    <div class="nds-btn-row">
      <button class="nds-btn-primary" onclick="addInboxCat()">추가</button>
      <button class="nds-btn-ghost" onclick="this.closest('.nds-modal').remove()">닫기</button>
    </div>
  `);
}

function addInboxCat(){
  const name=document.getElementById('newCatName')?.value.trim();
  if(!name){showToast('이름을 입력해줘');return;}
  const colors=['#4a7a50','#8a50a0','#5080a0','#a07040','#c05050','#4070c0'];
  const color=colors[inboxCats.length%colors.length];
  inboxCats.push({id:'cat_'+Date.now(),label:name,color});
  localStorage.setItem('inbox_cats_v1',JSON.stringify(inboxCats));
  document.querySelector('.nds-modal')?.remove();
  renderInbox();showToast('카테고리 추가됐어!');
}

function deleteInboxCat(i){
  const cat=inboxCats[i];
  if(['todo','idea','feel','later','misc'].includes(cat?.id)){showToast('기본 카테고리는 삭제 불가');return;}
  inboxCats.splice(i,1);
  localStorage.setItem('inbox_cats_v1',JSON.stringify(inboxCats));
  document.querySelector('.nds-modal')?.remove();
  renderInbox();
}

// ── AI 자동 분류/정리 ─────────────────────────────────────
async function runInboxAI(){
  const unprocessed=inboxItems.filter(m=>!m.done&&!m.priority);
  if(unprocessed.length===0){showToast('분류할 항목이 없어 (미완료 + 우선순위 없는 것 대상)');return;}
  if(!API_KEY){showToast('API 키가 없어. 설정 탭에서 추가해줘');return;}

  const el=document.getElementById('inboxMessages');
  const aiDiv=document.createElement('div');
  aiDiv.className='inbox-ai-result';
  aiDiv.textContent='분류 중...';
  el.prepend(aiDiv);

  const catNames=inboxCats.map(c=>`${c.id}(${c.label})`).join(', ');
  const items=unprocessed.map((m,i)=>`${i+1}. [id:${m.id}] "${m.text}"`).join('\n');

  const prompt=`다음 인박스 항목들을 분류해줘.

카테고리 목록: ${catNames}
우선순위: high(핵심), mid(일반), low(여유)

항목들:
${items}

규칙:
- 내용은 절대 변경하지 마
- 항목 관리(카테고리 지정, 우선순위 지정)만 해
- catId는 위 카테고리 목록의 id 중 하나를 사용

JSON 배열만 출력 (다른 텍스트 없이):
[{"id":항목id,"catId":"카테고리id","priority":"high|mid|low"}]`;

  try{
    const raw=await callAI(prompt,600);
    const clean=raw.replace(/```json|```/g,'').trim();
    const arr=JSON.parse(clean.slice(clean.indexOf('['),clean.lastIndexOf(']')+1));
    let changed=0;
    arr.forEach(r=>{
      const idx=inboxItems.findIndex(m=>m.id===r.id);
      if(idx>=0){
        if(r.catId)inboxItems[idx].catId=r.catId;
        if(r.priority)inboxItems[idx].priority=r.priority;
        changed++;
      }
    });
    saveInboxData();
    aiDiv.textContent=`✦ AI가 ${changed}개 항목을 분류했어. 확인해봐.`;
    setTimeout(()=>aiDiv.remove(),3000);
    renderInboxMessages();renderInboxCatTabs();
  }catch(e){
    aiDiv.textContent='AI 오류: '+e.message;
    setTimeout(()=>aiDiv.remove(),3000);
  }
}

function deleteRewardItem(type,idx){
  if(!confirm('삭제할까? 기록도 함께 사라져.'))return;
  rewardData[type].splice(idx,1);
  saveRewardData();renderRewardList(type);
}

function openRewardLogForm(type,idx){
  const item=rewardData[type][idx];if(!item)return;
  const isCharge=type==='charge';
  makeModal(`
    <div class="nds-modal-title">${item.emoji} ${esc(item.name)}</div>
    <div class="nds-field">
      <div class="nds-field-label">${isCharge?'오늘 어땠어?':'솔직하게 — 끝나고 어땠어?'}</div>
      <textarea id="rwLogNote" class="nds-ta" rows="3" placeholder="${isCharge?'예: 30분 산책했더니 머리가 맑아지고 기분이 좋아짐':'예: 2시간 봤는데 눈 아프고 시간 아깝다는 생각'}"></textarea>
    </div>
    ${isCharge?`<div class="nds-field">
      <div class="nds-field-label">사진 (선택)</div>
      <label class="nds-file-btn">
        📷 사진 선택
        <input type="file" id="rwLogPhoto" accept="image/*" style="display:none" onchange="previewLogPhoto(this)">
      </label>
      <img id="rwLogPhotoPreview" class="nds-photo-preview" alt="">
    </div>`:''}
    <div class="nds-btn-row">
      <button class="nds-btn-primary ${type}" onclick="saveRewardLog('${type}',${idx})">기록하기</button>
      <button class="nds-btn-ghost" onclick="this.closest('.nds-modal').remove()">취소</button>
    </div>
  `);
}

function previewLogPhoto(inp){
  if(!inp.files[0])return;
  const prev=document.getElementById('rwLogPhotoPreview');
  const reader=new FileReader();
  reader.onload=e=>{prev.src=e.target.result;prev.style.display='block';};
  reader.readAsDataURL(inp.files[0]);
}

async function saveRewardLog(type,idx){
  const note=document.getElementById('rwLogNote')?.value.trim()||'';
  let photo='';
  const fileEl=document.getElementById('rwLogPhoto');
  if(fileEl&&fileEl.files[0]){
    const file=fileEl.files[0];
    photo=await new Promise(res=>{const r=new FileReader();r.onload=e=>res(e.target.result);r.readAsDataURL(file);});
  }
  if(!rewardData[type][idx].logs)rewardData[type][idx].logs=[];
  rewardData[type][idx].logs.push({note,photo,date:new Date().toLocaleDateString('ko-KR')});
  saveRewardData();
  document.querySelector('.nds-modal')?.remove();
  renderRewardList(type);showToast('기록됐어!');
}

function deleteRewardLog(type,itemIdx,logIdx){
  rewardData[type][itemIdx].logs.splice(logIdx,1);
  saveRewardData();renderRewardList(type);
}

function viewLogPhoto(imgEl){
  const src=imgEl.src;
  const overlay=document.createElement('div');
  overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:600;display:flex;align-items:center;justify-content:center;cursor:pointer';
  const img=document.createElement('img');
  img.src=src;
  img.style.cssText='max-width:90vw;max-height:90vh;border-radius:8px';
  overlay.appendChild(img);
  overlay.onclick=()=>overlay.remove();
  document.body.appendChild(overlay);
}
function viewPhoto(src){
  const overlay=document.createElement('div');
  overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:600;display:flex;align-items:center;justify-content:center;cursor:pointer';
  const img=document.createElement('img');
  img.src=src;
  img.style.cssText='max-width:90vw;max-height:90vh;border-radius:8px';
  overlay.appendChild(img);
  overlay.onclick=()=>overlay.remove();
  document.body.appendChild(overlay);
}

function exportData(){
  const data={
    version:2,exportedAt:new Date().toISOString(),
    memos,philCards,questionSet,aiSettings,
    rewardData:JSON.parse(localStorage.getItem('reward_data')||'{"charge":[],"drain":[]}'),
    metricsV1:JSON.parse(localStorage.getItem('metrics_v1')||'[]')
  };
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;
  a.download=`나의돌아오는시스템_백업_${new Date().toLocaleDateString('ko-KR').replace(/\. /g,'-').replace('.','')}.json`;
  a.click();URL.revokeObjectURL(url);showToast('내보내기 완료!');
}

function importData(e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    try{
      const data=JSON.parse(ev.target.result);
      if(!data.version)throw new Error('올바른 백업 파일이 아니야.');
      if(!confirm(`${data.exportedAt?.slice(0,10)||'알 수 없는 날짜'} 백업을 불러올까? 현재 데이터는 덮어씌워져.`))return;
      if(data.memos){memos=data.memos;localStorage.setItem('memos_v5',JSON.stringify(memos));renderMemos();renderResultList();}
      if(data.philCards){philCards=data.philCards;localStorage.setItem('phil_cards',JSON.stringify(philCards));renderPhil();renderPhilEdit();}
      if(data.questionSet){questionSet=data.questionSet;localStorage.setItem('question_set',JSON.stringify(questionSet));renderQEdit();}
      if(data.aiSettings){aiSettings=data.aiSettings;localStorage.setItem('ai_settings',JSON.stringify(aiSettings));loadAiSettings();}
      if(data.rewardData){localStorage.setItem('reward_data',JSON.stringify(data.rewardData));initRewardData();}
      if(data.metricsV1){localStorage.setItem('metrics_v1',JSON.stringify(data.metricsV1));}
      if(fbUser)fbSaveAll();
      showToast('가져오기 완료!');
    }catch(err){showToast('오류: '+err.message);}
  };
  reader.readAsText(file);e.target.value='';
}

// ── Firebase ──────────────────────────────────────────────
let fbApp=null,fbAuth=null,fbDb=null,fbUser=null;
let fbConfigSaved=JSON.parse(localStorage.getItem('fb_config')||'null');

function saveFbConfig(){
  const apiKey=document.getElementById('fbApiKey').value.trim();
  const authDomain=document.getElementById('fbAuthDomain').value.trim();
  const projectId=document.getElementById('fbProjectId').value.trim();
  if(!apiKey||!authDomain||!projectId){showToast('세 칸 모두 입력해줘');return;}
  fbConfigSaved={apiKey,authDomain,projectId};
  localStorage.setItem('fb_config',JSON.stringify(fbConfigSaved));
  showToast('저장됐어. Firebase 연결 중...');
  initFirebase();
}

function clearFbConfig(){
  if(!confirm('Firebase 연결을 해제할까? 데이터는 이 기기에 그대로 남아.'))return;
  localStorage.removeItem('fb_config');
  fbConfigSaved=null;fbUser=null;fbAuth=null;fbDb=null;fbApp=null;
  setSyncStatus('disconnected');
  document.getElementById('fbStatusArea').style.display='none';
  document.getElementById('fbLoginSection').style.display='none';
  document.getElementById('fbApiKey').value='';
  document.getElementById('fbAuthDomain').value='';
  document.getElementById('fbProjectId').value='';
  showToast('연결 해제됐어');
}

async function initFirebase(){
  if(!fbConfigSaved)return;
  try{
    // 동적으로 Firebase SDK 로드
    if(!window.firebase){
      await loadScript('https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js');
      await loadScript('https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js');
      await loadScript('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js');
    }
    const cfg={...fbConfigSaved,storageBucket:'',messagingSenderId:'',appId:''};
    // 이미 앱이 있으면 재사용
    try{fbApp=firebase.app();}catch{fbApp=firebase.initializeApp(cfg);}
    fbAuth=firebase.auth();
    fbDb=firebase.firestore();
    setSyncStatus('disconnected');
    document.getElementById('fbLoginSection').style.display='block';
    // 저장된 설정값 표시
    document.getElementById('fbApiKey').value=fbConfigSaved.apiKey;
    document.getElementById('fbAuthDomain').value=fbConfigSaved.authDomain;
    document.getElementById('fbProjectId').value=fbConfigSaved.projectId;
    fbAuth.onAuthStateChanged(user=>{
      if(user){
        fbUser=user;
        setSyncStatus('connected');
        document.getElementById('fbLoggedUser').textContent=user.email||user.displayName||'로그인됨';
        document.getElementById('fbStatusArea').style.display='block';
        document.getElementById('fbLoginSection').style.display='none';
        document.getElementById('fbUserLabel').textContent=user.email||user.displayName||'';
        fbLoadAll();
      } else {
        fbUser=null;
        setSyncStatus('disconnected');
        document.getElementById('fbStatusArea').style.display='none';
        document.getElementById('fbLoginSection').style.display='block';
        document.getElementById('fbUserLabel').textContent='';
      }
    });
  }catch(err){
    setSyncStatus('error');
    showToast('Firebase 오류: '+err.message);
    console.error(err);
  }
}

function loadScript(src){
  return new Promise((res,rej)=>{
    const s=document.createElement('script');
    s.src=src;s.onload=res;s.onerror=rej;
    document.head.appendChild(s);
  });
}

function setSyncStatus(status){
  const dot=document.getElementById('syncDot');
  const label=document.getElementById('syncStatus');
  if(status==='connected'){
    dot.className='sync-dot connected';
    label.textContent='Firebase 연결됨 — 자동 동기화 중';
  } else if(status==='syncing'){
    dot.className='sync-dot syncing';
    label.textContent='동기화 중...';
  } else if(status==='error'){
    dot.className='sync-dot error';
    label.textContent='동기화 오류 — 로컬에만 저장됨';
  } else {
    dot.className='sync-dot';
    label.textContent='Firebase 미연결 — 기기 간 동기화 안 됨';
  }
}

async function fbGoogleLogin(){
  if(!fbAuth){showToast('먼저 Firebase 설정을 저장해줘');return;}
  try{
    const provider=new firebase.auth.GoogleAuthProvider();
    await fbAuth.signInWithPopup(provider);
  }catch(err){showToast('로그인 실패: '+err.message);}
}

async function fbLogout(){
  if(!fbAuth)return;
  await fbAuth.signOut();
  showToast('로그아웃됐어');
}

async function fbSaveAll(){
  if(!fbUser||!fbDb)return;
  setSyncStatus('syncing');
  try{
    const uid=fbUser.uid;
    await fbDb.collection('users').doc(uid).set({
      memos:JSON.stringify(memos),
      philCards:JSON.stringify(philCards),
      questionSet:JSON.stringify(questionSet),
      aiSettings:JSON.stringify(aiSettings),
      rewardData:localStorage.getItem('reward_data')||'{"charge":[],"drain":[]}',
      metricsV1:localStorage.getItem('metrics_v1')||'[]',
      inboxV1:localStorage.getItem('inbox_v1')||'[]',
      realNeedV1:localStorage.getItem('real_need_v1')||'[]',
      rpgObsV1:localStorage.getItem('rpg_obs_v1')||'{}',
      rpgStatsV1:localStorage.getItem('rpg_stats_v1')||'null',
      updatedAt:firebase.firestore.FieldValue.serverTimestamp()
    });
    setSyncStatus('connected');
  }catch(err){
    setSyncStatus('error');
    console.error('Firebase 저장 오류:',err);
  }
}

async function fbLoadAll(){
  if(!fbUser||!fbDb)return;
  setSyncStatus('syncing');
  try{
    const uid=fbUser.uid;
    const doc=await fbDb.collection('users').doc(uid).get();
    if(doc.exists){
      const d=doc.data();
      if(d.memos){memos=JSON.parse(d.memos);localStorage.setItem('memos_v5',d.memos);renderMemos();renderResultList();}
      if(d.philCards){philCards=JSON.parse(d.philCards);localStorage.setItem('phil_cards',d.philCards);renderPhil();renderPhilEdit();}
      if(d.questionSet){questionSet=JSON.parse(d.questionSet);localStorage.setItem('question_set',d.questionSet);renderQEdit();}
      if(d.aiSettings){aiSettings=JSON.parse(d.aiSettings);localStorage.setItem('ai_settings',d.aiSettings);loadAiSettings();}
      if(d.rewardData){localStorage.setItem('reward_data',d.rewardData);initRewardData();}
      if(d.metricsV1){localStorage.setItem('metrics_v1',d.metricsV1);}
      if(d.inboxV1){inboxItems=JSON.parse(d.inboxV1);localStorage.setItem('inbox_v1',d.inboxV1);}
      if(d.realNeedV1){realNeedData=JSON.parse(d.realNeedV1);localStorage.setItem('real_need_v1',d.realNeedV1);}
      if(d.rpgObsV1){localStorage.setItem('rpg_obs_v1',d.rpgObsV1);}
      if(d.rpgStatsV1&&d.rpgStatsV1!=='null'){localStorage.setItem('rpg_stats_v1',d.rpgStatsV1);}
    }
    setSyncStatus('connected');
  }catch(err){
    setSyncStatus('error');
    console.error('Firebase 불러오기 오류:',err);
  }
}

async function fbForceSync(){
  if(!fbUser){showToast('로그인이 필요해');return;}
  await fbSaveAll();
  showToast('동기화 완료!');
}

// Firebase 저장 후크: 기존 localStorage 저장 함수들에 Firebase 저장 추가
const _origSaveResult=saveResult;
// memos 변경 시 Firebase도 저장 (addMemoFromId, deleteMemo, saveResult에 훅)
const _fbHook=()=>{if(fbUser)fbSaveAll();};

// ── window.onload 확장 ────────────────────────────────────
const _origOnload=window.onload;
window.onload=()=>{
  initLock();
  _origOnload&&_origOnload();
  if(fbConfigSaved)initFirebase();
};
function esc(s){return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function showToast(msg){
  const el=document.getElementById('toast');
  el.textContent=msg;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),2200);
}
</script>
</body>
</html>

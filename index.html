<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë‚˜ì˜ ëŒì•„ì˜¤ëŠ” ì‹œìŠ¤í…œ</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f5f2ed;--surface:#fff;--border:#e0dbd2;
  --accent:#7c5c38;--accentL:#b8956a;--accentDim:#ede7dc;--accentDim2:#f7f3ee;
  --text:#1e1a16;--textDim:#5a5048;--textF:#9e9288;
  --green:#4a7a50;--greenBg:#eaf2eb;--yellow:#7a6030;--red:#8a3a3a;--redBg:#f5eaea;
  --radius:12px;--shadow:0 2px 12px rgba(0,0,0,.07);
}
/* ì ê¸ˆ í™”ë©´ */
#lockScreen{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;align-items:center;justify-content:center;}
.lock-box{width:100%;max-width:340px;padding:0 24px;text-align:center;}
.lock-icon{font-size:36px;margin-bottom:20px;}
.lock-title{font-family:Georgia,serif;font-size:22px;font-weight:400;color:var(--text);margin-bottom:8px;}
.lock-sub{font-size:13px;color:var(--textF);margin-bottom:28px;line-height:1.7;}
.lock-inp{width:100%;padding:14px 16px;border:1px solid var(--border);border-radius:var(--radius);font-family:inherit;font-size:16px;background:var(--surface);color:var(--text);text-align:center;letter-spacing:4px;margin-bottom:10px;transition:border-color .2s;}
.lock-inp:focus{outline:none;border-color:var(--accentL);}
.lock-btn{width:100%;padding:15px;background:var(--accent);border:none;color:#fff;font-family:inherit;font-size:15px;border-radius:var(--radius);cursor:pointer;transition:opacity .2s;}
.lock-btn:hover{opacity:.88;}
.lock-err{font-size:13px;color:var(--red);margin-top:10px;min-height:20px;}
body{font-family:-apple-system,'Apple SD Gothic Neo','Noto Sans KR',system-ui,sans-serif;font-weight:300;background:var(--bg);color:var(--text);font-size:15px;min-height:100vh}
.tab-bar{display:flex;border-bottom:1px solid var(--border);background:var(--surface);position:sticky;top:0;z-index:100;box-shadow:0 1px 8px rgba(0,0,0,.06)}
.tab-btn{flex:1;padding:13px 2px;background:none;border:none;border-bottom:2px solid transparent;font-family:inherit;font-size:12px;font-weight:300;color:var(--textF);cursor:pointer;transition:all .2s}
.tab-btn.active{border-bottom-color:var(--accent);color:var(--accent);font-weight:500}
.inner{max-width:540px;margin:0 auto;padding-bottom:80px}
.inner-wide{max-width:1200px;margin:0 auto;padding:0 20px 80px}
.page{display:none}.page.active{display:block}

/* í™ˆ */
.hero{padding:44px 24px 28px;border-bottom:1px solid var(--border)}
.eyebrow{font-size:10px;letter-spacing:4px;color:var(--accentL);text-transform:uppercase;margin-bottom:14px}
.hero h1{font-family:Georgia,serif;font-size:26px;font-weight:400;line-height:1.5;margin-bottom:22px}
.motto{background:var(--accentDim);border-radius:var(--radius);padding:18px 20px;font-size:14px;color:var(--textDim);line-height:2.2}
.motto strong{color:var(--accent);font-weight:500}
.sec-lbl{font-size:10px;letter-spacing:4px;color:var(--textF);text-transform:uppercase;padding:28px 24px 12px}
.phil-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;padding:0 24px;margin-bottom:24px}
.phil-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px 18px;box-shadow:var(--shadow)}
.phil-tag{font-size:10px;color:var(--accentL);font-weight:600;margin-bottom:5px;letter-spacing:1px;text-transform:uppercase}
.phil-title{font-size:14px;font-weight:500;color:var(--text);margin-bottom:6px;line-height:1.4}
.phil-body{font-size:13px;color:var(--textDim);line-height:1.9}
.start-btn{display:block;margin:0 24px;padding:17px;background:var(--accent);border:none;color:#fff;font-family:inherit;font-size:15px;border-radius:var(--radius);cursor:pointer;text-align:center;width:calc(100% - 48px);transition:opacity .2s}
.start-btn:hover{opacity:.88}

/* ì²´í¬ ì‹œì‘ ì „ â€” ì¼ì •/í• ì¼ ì…ë ¥ */
.precheck-wrap{max-width:540px;margin:0 auto;padding:32px 24px 80px}
.precheck-title{font-family:Georgia,serif;font-size:22px;font-weight:400;margin-bottom:6px}
.precheck-sub{font-size:13px;color:var(--textF);line-height:1.75;margin-bottom:28px}
.precheck-section{margin-bottom:20px}
.precheck-lbl{font-size:10px;letter-spacing:3px;color:var(--accentL);text-transform:uppercase;font-weight:600;margin-bottom:10px}
.precheck-lbl-sub{font-size:12px;color:var(--textF);margin-bottom:8px;line-height:1.6;font-weight:300;letter-spacing:0;text-transform:none}
.task-list{display:flex;flex-direction:column;gap:7px;margin-bottom:8px}
.task-item{display:flex;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
.task-item input[type=text]{flex:1;border:none;background:transparent;font-family:inherit;font-size:13px;color:var(--text);outline:none}
.task-item input[type=text]::placeholder{color:var(--textF)}
.task-urgency{padding:4px 8px;border:1px solid var(--border);border-radius:6px;font-family:inherit;font-size:11px;background:var(--bg);color:var(--textDim);cursor:pointer}
.task-del{background:none;border:none;color:var(--textF);font-size:16px;cursor:pointer;padding:0 2px;flex-shrink:0}
.task-add-btn{padding:8px 14px;background:var(--accentDim);border:1px solid var(--accentL);color:var(--accent);font-family:inherit;font-size:12px;border-radius:8px;cursor:pointer}
.precheck-skip{font-size:12px;color:var(--textF);text-align:center;margin-top:16px;cursor:pointer;text-decoration:underline}

/* ê²°ê³¼ col1ì— ì¼ì • í‘œì‹œ */
.schedule-block{margin-top:10px;padding-top:10px;border-top:1px solid var(--border)}
.schedule-lbl{font-size:10px;color:var(--textF);margin-bottom:6px;letter-spacing:1px;text-transform:uppercase}
.schedule-item{display:flex;align-items:flex-start;gap:7px;margin-bottom:5px;font-size:13px;color:var(--textDim);line-height:1.6}
.urgency-badge{font-size:10px;padding:1px 6px;border-radius:10px;flex-shrink:0;margin-top:2px}
.urgency-badge.high{background:#fce8e8;color:var(--red)}
.urgency-badge.mid{background:#fef3e2;color:#8a5a00}
.urgency-badge.low{background:var(--greenBg);color:var(--green)}
.q-header{padding:28px 24px 0}
.prog-row{display:flex;align-items:center;gap:12px;margin-bottom:24px}
.prog-bar{flex:1;height:3px;background:var(--border);border-radius:2px;overflow:hidden}
.prog-fill{height:100%;background:var(--accent);transition:width .5s cubic-bezier(.4,0,.2,1)}
.prog-lbl{font-size:11px;color:var(--textF);white-space:nowrap}
.q-cat{font-size:10px;color:var(--accentL);letter-spacing:3px;text-transform:uppercase;margin-bottom:8px;font-weight:600}
.q-text{font-family:Georgia,serif;font-size:21px;font-weight:400;line-height:1.5;margin-bottom:8px}
.q-sub{font-size:12px;color:var(--textF);line-height:1.9;margin-bottom:20px}
.opts{padding:0 24px;display:flex;flex-direction:column;gap:9px;margin-bottom:12px}
.opt-btn{padding:14px 17px;background:var(--surface);border:1px solid var(--border);color:var(--textDim);font-family:inherit;font-size:14px;font-weight:300;cursor:pointer;border-radius:var(--radius);text-align:left;transition:all .2s}
.opt-btn:hover{border-color:var(--accentL)}
.opt-btn.selected{background:var(--accentDim);border-color:var(--accent);color:var(--accent);font-weight:500}
.ta-wrap{padding:0 24px;margin-bottom:12px}
textarea{width:100%;background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:14px;font-weight:300;padding:14px 16px;resize:none;min-height:110px;border-radius:var(--radius);line-height:1.9;transition:border-color .2s}
textarea:focus{outline:none;border-color:var(--accentL)}
.insight-box{margin:0 24px 14px;border-radius:var(--radius);border:1px solid var(--border);overflow:hidden}
.insight-row{display:flex}
.insight-tag{background:var(--accentDim);padding:12px 14px;font-size:10px;color:var(--accent);font-weight:600;letter-spacing:1px;text-transform:uppercase;white-space:nowrap;border-right:1px solid var(--border);display:flex;align-items:center;writing-mode:vertical-rl}
.insight-txt{padding:12px 15px;font-size:13px;color:var(--textDim);line-height:1.9;flex:1}
.nav-row{display:flex;gap:10px;padding:14px 24px 0}
.btn-next{flex:1;padding:16px;background:var(--accent);border:none;color:#fff;font-family:inherit;font-size:14px;border-radius:var(--radius);cursor:pointer;transition:opacity .2s}
.btn-next:disabled{opacity:.35;cursor:not-allowed}
.btn-back{padding:16px 18px;background:var(--surface);border:1px solid var(--border);color:var(--textF);font-family:inherit;font-size:14px;cursor:pointer;border-radius:var(--radius)}
.loading-wrap{padding:70px 24px;text-align:center}
.spinner{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 14px}
.loading-txt{font-size:13px;color:var(--textF);line-height:1.9}
@keyframes spin{to{transform:rotate(360deg)}}

/* ê²°ê³¼ â€” 4ë‹¨ */
.res-header{padding:32px 0 20px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px}
.res-header h2{font-family:Georgia,serif;font-size:24px;font-weight:400}
.res-time{font-size:12px;color:var(--textF);margin-top:3px}
.save-result-btn{padding:10px 18px;background:var(--accent);border:none;color:#fff;font-family:inherit;font-size:13px;border-radius:10px;cursor:pointer;transition:opacity .2s;white-space:nowrap}
.save-result-btn:hover{opacity:.85}
.res-grid{display:grid;grid-template-columns:0.75fr 1fr 1fr 1fr;gap:14px;align-items:start}
@media(max-width:900px){.res-grid{grid-template-columns:1fr 1fr}}
@media(max-width:560px){.res-grid{grid-template-columns:1fr}}
.res-col{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow)}
.res-col-head{padding:12px 16px;border-bottom:1px solid var(--border);background:var(--accentDim2)}
.res-col-title{font-size:10px;letter-spacing:2.5px;color:var(--accent);text-transform:uppercase;font-weight:600}
.res-col-body{padding:16px}
.ans-item{margin-bottom:13px;padding-bottom:13px;border-bottom:1px solid var(--border)}
.ans-item:last-child{margin:0;padding:0;border:none}
.ans-q{font-size:11px;color:var(--textF);margin-bottom:4px}
.ans-dot-row{display:flex;align-items:flex-start;gap:8px}
.dot{width:7px;height:7px;border-radius:50%;margin-top:5px;flex-shrink:0}
.dot.ok{background:var(--green)}.dot.warn{background:var(--yellow)}.dot.bad{background:var(--red)}
.ans-v{font-size:13px;color:var(--text);line-height:1.8;white-space:pre-wrap}
.analysis-txt{font-size:13px;color:var(--textDim);line-height:2.1}

/* í–‰ë™ê°•ë ¹ â€” 3ë‹¨ê³„ ì—°ê²° êµ¬ì¡° */
.act-card{margin-bottom:13px;padding-bottom:13px;border-bottom:1px solid var(--border)}
.act-card:last-child{margin:0;padding:0;border:none}
.act-step{font-size:9px;letter-spacing:2px;text-transform:uppercase;font-weight:700;margin-bottom:5px;padding:3px 8px;border-radius:20px;display:inline-block}
.act-step.s1{background:#e8f0fe;color:#3c5a9a}
.act-step.s2{background:#e8f4ea;color:#2d6a35}
.act-step.s3{background:#fef3e2;color:#8a5a00}
.act-title{font-size:14px;font-weight:500;color:var(--text);line-height:1.4;margin-bottom:5px}
.act-logic{font-size:12px;color:var(--accentL);line-height:1.7;margin-bottom:5px;font-style:italic}
.act-how{font-size:13px;color:var(--textDim);line-height:1.8;background:var(--accentDim2);padding:8px 12px;border-radius:8px}

/* ìƒê°ê°•ë ¹ */
.thought-item{margin-bottom:13px;padding-bottom:13px;border-bottom:1px solid var(--border)}
.thought-item:last-child{margin:0;padding:0;border:none}
.thought-tag{font-size:10px;color:var(--accentL);font-weight:600;letter-spacing:1px;text-transform:uppercase;margin-bottom:5px}
.thought-txt{font-size:13px;color:var(--textDim);line-height:1.9;margin-bottom:4px}
.thought-origin{font-size:11px;color:var(--textF);font-style:italic;line-height:1.6}

/* ê²°ê³¼ í•˜ë‹¨ */
.res-bottom{margin-top:16px}
.memo-save-area{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:14px}
.memo-save-lbl{font-size:10px;letter-spacing:2px;color:var(--accent);text-transform:uppercase;font-weight:600;margin-bottom:8px}
.memo-save-sub{font-size:13px;color:var(--textDim);margin-bottom:10px;line-height:1.75}
.save-m-btn{padding:11px 18px;background:var(--accentDim);border:1px solid var(--accentL);color:var(--accent);font-family:inherit;font-size:13px;font-weight:500;border-radius:10px;cursor:pointer;margin-top:10px}
.final-box{background:var(--accentDim);border-radius:var(--radius);padding:22px;text-align:center;margin-bottom:14px}
.final-box p{font-family:Georgia,serif;font-size:15px;color:var(--textDim);line-height:2.3}
.final-box strong{color:var(--accent)}
.restart-btn{display:block;padding:15px;background:transparent;border:1px solid var(--border);color:var(--textF);font-family:inherit;font-size:13px;cursor:pointer;border-radius:var(--radius);text-align:center;width:100%}
.restart-btn:hover{border-color:var(--accentL)}

/* ê¸°ë¡ */
.memo-h{padding:28px 24px 18px;border-bottom:1px solid var(--border)}
.memo-h h2{font-family:Georgia,serif;font-size:21px;font-weight:400;margin-bottom:5px}
.memo-sub{font-size:12px;color:var(--textF);line-height:1.75}
.memo-add{padding:18px 24px;border-bottom:1px solid var(--border)}
.memo-add-btn{padding:11px 18px;background:var(--accent);border:none;color:#fff;font-family:inherit;font-size:13px;border-radius:10px;cursor:pointer;margin-top:10px}
.memo-list{padding:16px 24px}
.memo-empty{font-size:13px;color:var(--textF);text-align:center;padding:48px 0;line-height:2.2}
.memo-item{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;margin-bottom:9px;position:relative}
.memo-item.result-item{border-left:3px solid var(--accent)}
.memo-date{font-size:11px;color:var(--textF);margin-bottom:5px}
.memo-type{font-size:10px;color:var(--accentL);font-weight:600;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px}
.memo-text{font-size:13px;color:var(--textDim);line-height:1.85;padding-right:28px;white-space:pre-wrap}
.memo-del{position:absolute;top:12px;right:14px;background:none;border:none;color:var(--textF);font-size:17px;cursor:pointer}
.memo-expand-btn{font-size:12px;color:var(--accentL);background:none;border:none;cursor:pointer;margin-top:6px;padding:0;font-family:inherit}

/* ì„¤ì • */
.settings-wrap{padding:24px}
.settings-title{font-family:Georgia,serif;font-size:20px;font-weight:400;margin-bottom:6px}
.settings-sub{font-size:13px;color:var(--textF);line-height:1.7;margin-bottom:24px}
.set-section{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:14px;overflow:hidden}
.set-section-head{padding:14px 18px;border-bottom:1px solid var(--border);background:var(--accentDim2);display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none}
.set-section-title{font-size:11px;letter-spacing:2px;color:var(--accent);text-transform:uppercase;font-weight:600}
.set-section-arrow{font-size:12px;color:var(--textF);transition:transform .2s}
.set-section-arrow.open{transform:rotate(180deg)}
.set-section-body{padding:18px;display:none}
.set-section-body.open{display:block}
.setting-lbl{font-size:11px;color:var(--textDim);font-weight:500;margin-bottom:8px;margin-top:16px;letter-spacing:.5px}
.setting-lbl:first-child{margin-top:0}
.setting-inp{width:100%;padding:11px 13px;border:1px solid var(--border);border-radius:10px;font-family:inherit;font-size:13px;background:var(--bg);color:var(--text);transition:border-color .2s}
.setting-inp:focus{outline:none;border-color:var(--accentL)}
.setting-ta{width:100%;padding:11px 13px;border:1px solid var(--border);border-radius:10px;font-family:inherit;font-size:13px;background:var(--bg);color:var(--text);resize:none;line-height:1.8;min-height:80px}
.setting-ta:focus{outline:none;border-color:var(--accentL)}
.setting-hint{font-size:12px;color:var(--textF);margin-top:5px;line-height:1.6}
.setting-hint a{color:var(--accentL);text-decoration:none}
.api-status{display:flex;align-items:center;gap:8px;margin-top:8px;font-size:12px}
.status-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.status-dot.ok{background:var(--green)}.status-dot.none{background:var(--textF)}
.btn-row{display:flex;gap:10px;margin-top:12px}
.btn-primary{flex:1;padding:11px;background:var(--accent);border:none;color:#fff;font-family:inherit;font-size:13px;border-radius:10px;cursor:pointer}
.btn-secondary{padding:11px 16px;background:var(--surface);border:1px solid var(--border);color:var(--textDim);font-family:inherit;font-size:13px;border-radius:10px;cursor:pointer}
.btn-ghost{padding:11px 16px;background:transparent;border:1px solid var(--border);color:var(--textF);font-family:inherit;font-size:13px;border-radius:10px;cursor:pointer}
.test-result{margin-top:10px;padding:11px 14px;border-radius:8px;font-size:13px;line-height:1.7;display:none}
.test-result.ok{background:var(--greenBg);color:#2d5a33}.test-result.err{background:var(--redBg);color:#6b2020}
.divider{height:1px;background:var(--border);margin:16px 0}
.danger-btn{padding:11px 16px;background:transparent;border:1px solid #d0a0a0;color:var(--red);font-family:inherit;font-size:13px;border-radius:10px;cursor:pointer}
.phil-edit-item{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:10px}
.phil-edit-row{display:flex;gap:8px;margin-bottom:8px}
.phil-edit-tag{width:110px;flex-shrink:0;padding:9px 10px;border:1px solid var(--border);border-radius:8px;font-family:inherit;font-size:12px;background:var(--surface);color:var(--accent)}
.phil-edit-title{flex:1;padding:9px 10px;border:1px solid var(--border);border-radius:8px;font-family:inherit;font-size:13px;background:var(--surface);color:var(--text)}
.phil-edit-body{width:100%;padding:9px 10px;border:1px solid var(--border);border-radius:8px;font-family:inherit;font-size:12px;background:var(--surface);color:var(--textDim);resize:none;min-height:70px;line-height:1.8}
.phil-edit-del{padding:6px 10px;background:transparent;border:1px solid #d0a0a0;color:var(--red);font-family:inherit;font-size:12px;border-radius:8px;cursor:pointer;margin-top:6px}
.q-edit-item{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:10px}
.q-edit-row{display:flex;gap:8px;margin-bottom:8px;align-items:center}
.q-edit-cat{width:90px;flex-shrink:0;padding:9px 10px;border:1px solid var(--border);border-radius:8px;font-family:inherit;font-size:12px;background:var(--surface);color:var(--accent)}
.q-edit-text{flex:1;padding:9px 10px;border:1px solid var(--border);border-radius:8px;font-family:inherit;font-size:13px;background:var(--surface);color:var(--text)}
.q-edit-sub{width:100%;padding:9px 10px;border:1px solid var(--border);border-radius:8px;font-family:inherit;font-size:12px;background:var(--surface);color:var(--textDim);resize:none;min-height:50px;line-height:1.7}
.sel{padding:9px 10px;border:1px solid var(--border);border-radius:8px;font-family:inherit;font-size:12px;background:var(--surface);color:var(--textDim)}
.q-edit-del{padding:6px 10px;background:transparent;border:1px solid #d0a0a0;color:var(--red);font-family:inherit;font-size:12px;border-radius:8px;cursor:pointer;margin-top:6px}
.add-item-btn{padding:10px 16px;background:var(--accentDim);border:1px solid var(--accentL);color:var(--accent);font-family:inherit;font-size:13px;border-radius:10px;cursor:pointer;margin-top:4px}

.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%);background:var(--text);color:#fff;font-size:13px;padding:11px 22px;border-radius:22px;z-index:999;opacity:0;transition:opacity .25s;pointer-events:none;white-space:nowrap}
.toast.show{opacity:1}
.sync-bar{display:flex;align-items:center;gap:8px;padding:8px 16px;background:var(--accentDim);border-bottom:1px solid var(--border);font-size:12px;color:var(--textDim)}
.sync-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;background:var(--textF)}
.sync-dot.connected{background:var(--green)}
.sync-dot.syncing{background:var(--yellow);animation:pulse 1s infinite}
.sync-dot.error{background:var(--red)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.firebase-user{margin-left:auto;font-size:11px;color:var(--textF)}
.fb-login-btn{padding:9px 16px;background:var(--surface);border:1px solid var(--border);color:var(--textDim);font-family:inherit;font-size:13px;border-radius:10px;cursor:pointer;width:100%;margin-bottom:8px;text-align:left;display:flex;align-items:center;gap:10px}
.fb-login-btn:hover{border-color:var(--accentL)}
.fb-login-btn svg{flex-shrink:0}
.btn-danger-outline{padding:11px 16px;background:transparent;border:1px solid #d0a0a0;color:var(--red);font-family:inherit;font-size:13px;border-radius:10px;cursor:pointer}
.export-import-row{display:flex;gap:10px;margin-top:8px}

/* â”€â”€ ì„¸ê·¸ë¨¼íŠ¸ ì»¨íŠ¸ë¡¤ (ê¸°ë¡ íƒ­ ìƒë‹¨) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.seg-ctrl{display:flex;background:var(--accentDim);border-radius:10px;padding:3px;gap:2px;margin:16px 24px}
.seg-btn{flex:1;padding:8px;background:transparent;border:none;font-family:inherit;font-size:13px;color:var(--textF);cursor:pointer;border-radius:8px;transition:all .2s;font-weight:400}
.seg-btn.active{background:var(--surface);color:var(--accent);font-weight:500;box-shadow:0 1px 4px rgba(0,0,0,.1)}
.seg-panel{display:none}.seg-panel.active{display:block}

/* â”€â”€ ë³´ìƒ íƒ­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.reward-wrap{max-width:640px;margin:0 auto;padding-bottom:80px}
.reward-header{padding:24px 20px 0}
.reward-header h2{font-family:Georgia,serif;font-size:20px;font-weight:400;margin-bottom:4px}
.reward-sub{font-size:12px;color:var(--textF);line-height:1.7;margin-bottom:0}

/* ì¶©ì „/ë°©ì „ ì„¹ì…˜ í—¤ë” */
.reward-section{margin:16px 0}
.reward-sec-head{
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 20px;cursor:pointer;user-select:none;
  border-radius:12px 12px 0 0;
}
.reward-sec-head.charge{background:linear-gradient(135deg,#e8f4ec,#d4edda);border:1px solid #b8ddc2;border-bottom:none}
.reward-sec-head.drain{background:linear-gradient(135deg,#fdecea,#fad5d2);border:1px solid #f0b8b4;border-bottom:none}
.reward-sec-icon{font-size:18px;margin-right:8px}
.reward-sec-title{font-size:14px;font-weight:600;color:var(--text);flex:1}
.reward-sec-count{font-size:11px;color:var(--textF);margin-right:10px}
.reward-add-btn{
  padding:5px 12px;border:none;font-family:inherit;font-size:12px;
  border-radius:8px;cursor:pointer;font-weight:500;transition:all .15s;
}
.reward-add-btn.charge{background:#4a7a50;color:#fff}
.reward-add-btn.drain{background:#8a3a3a;color:#fff}
.reward-add-btn:hover{opacity:.85}
.reward-sec-arrow{font-size:11px;color:var(--textF);margin-left:8px;transition:transform .2s}
.reward-sec-arrow.open{transform:rotate(180deg)}

/* ë¦¬ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ */
.reward-list{
  border:1px solid;border-top:none;border-radius:0 0 12px 12px;
  overflow:hidden;
}
.reward-list.charge{border-color:#b8ddc2;background:#f8fdf9}
.reward-list.drain{border-color:#f0b8b4;background:#fdf8f8}

/* ë¦¬ìŠ¤íŠ¸ í—¤ë” */
.reward-list-header{
  display:grid;padding:8px 14px;
  border-bottom:1px solid;font-size:10px;letter-spacing:1.5px;
  text-transform:uppercase;font-weight:600;
}
.reward-list-header.charge{color:#3a6040;border-color:#b8ddc2;grid-template-columns:1fr 2fr 80px}
.reward-list-header.drain{color:#7a2828;border-color:#f0b8b4;grid-template-columns:1fr 2fr 80px}

/* ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ */
.reward-item{
  display:grid;align-items:start;padding:12px 14px;
  border-bottom:1px solid;cursor:pointer;transition:background .15s;
}
.reward-item.charge{border-color:#d4edda;grid-template-columns:1fr 2fr 80px}
.reward-item.charge:hover{background:rgba(74,122,80,.05)}
.reward-item.drain{border-color:#fad5d2;grid-template-columns:1fr 2fr 80px}
.reward-item.drain:hover{background:rgba(138,58,58,.05)}
.reward-item:last-child{border-bottom:none}
.reward-item-name{display:flex;align-items:center;gap:6px}
.reward-item-emoji{font-size:16px;flex-shrink:0}
.reward-item-label{font-size:13px;font-weight:500;color:var(--text);line-height:1.4}
.reward-item-count{font-size:10px;color:var(--textF);margin-top:2px}
.reward-item-feeling{font-size:12px;color:var(--textDim);line-height:1.6;padding-right:8px}
.reward-item-feeling strong{font-weight:500}
.reward-item-actions{display:flex;flex-direction:column;align-items:flex-end;gap:5px}
.reward-log-btn{
  padding:4px 10px;border:none;font-family:inherit;font-size:11px;
  border-radius:6px;cursor:pointer;white-space:nowrap;font-weight:500;
}
.reward-log-btn.charge{background:#4a7a50;color:#fff}
.reward-log-btn.drain{background:rgba(138,58,58,.12);color:#8a3a3a;border:1px solid #f0b8b4}
.reward-del-btn{background:none;border:none;color:var(--textF);font-size:13px;cursor:pointer;padding:0}

/* ê¸°ë¡ ëª¨ë‹¬ íŒ¨ë„ (ì•„ì´í…œ í´ë¦­ ì‹œ ì•„ë˜ë¡œ í¼ì³ì§) */
.reward-log-panel{
  border-top:1px dashed;padding:12px 14px;
  background:rgba(255,255,255,.8);
}
.reward-log-panel.charge{border-color:#b8ddc2}
.reward-log-panel.drain{border-color:#f0b8b4}
.reward-log-list{margin-bottom:8px}
.reward-log-entry{
  display:flex;align-items:flex-start;gap:8px;padding:6px 0;
  border-bottom:1px solid var(--border);font-size:12px;
}
.reward-log-entry:last-child{border-bottom:none}
.reward-log-date{color:var(--textF);white-space:nowrap;flex-shrink:0;padding-top:1px}
.reward-log-note{color:var(--textDim);line-height:1.6;flex:1}
.reward-log-photo{width:40px;height:40px;border-radius:6px;object-fit:cover;flex-shrink:0;cursor:pointer}
.reward-log-del{background:none;border:none;color:var(--textF);font-size:12px;cursor:pointer;flex-shrink:0}
.reward-log-add{display:flex;gap:6px;margin-top:6px}
.reward-log-inp{
  flex:1;padding:7px 10px;border:1px solid var(--border);
  border-radius:8px;font-family:inherit;font-size:12px;
  background:var(--surface);color:var(--text);
}
.reward-log-inp:focus{outline:none;border-color:var(--accentL)}
.reward-log-save{
  padding:7px 12px;border:none;font-family:inherit;font-size:12px;
  border-radius:8px;cursor:pointer;font-weight:500;white-space:nowrap;
}
.reward-log-save.charge{background:#4a7a50;color:#fff}
.reward-log-save.drain{background:#8a3a3a;color:#fff}
.reward-empty{padding:20px;text-align:center;font-size:13px;color:var(--textF)}

/* â”€â”€ ì„±ì¥ ì§€í‘œ ê·¸ë˜í”„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.metric-graph-wrap{padding:4px 0}
.metric-graph-item{margin-bottom:18px}
.metric-graph-item:last-child{margin-bottom:0}
.metric-graph-header{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:6px}
.metric-graph-name{font-size:13px;font-weight:500;color:var(--text)}
.metric-graph-val{font-size:18px;font-weight:700;color:var(--accent);line-height:1}
.metric-graph-unit{font-size:11px;color:var(--textF);margin-left:2px}
.metric-graph-goal{font-size:11px;color:var(--textF)}
/* ìº”ë²„ìŠ¤ ê¸°ë°˜ ìŠ¤íŒŒí¬ë¼ì¸ */
.metric-sparkline{width:100%;height:36px;display:block;margin-bottom:4px}
/* ë§‰ëŒ€ ê¸°ë°˜ íˆìŠ¤í† ë¦¬ */
.metric-bar-chart{display:flex;align-items:flex-end;gap:3px;height:40px;margin-bottom:4px}
.metric-bar-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px}
.metric-bar-fill-wrap{width:100%;flex:1;display:flex;align-items:flex-end}
.metric-bar-seg{width:100%;border-radius:2px 2px 0 0;transition:height .5s cubic-bezier(.4,0,.2,1);min-height:2px}
.metric-bar-seg.charge-bar{background:linear-gradient(180deg,#6aaa72,#4a7a50)}
.metric-bar-seg.neutral-bar{background:linear-gradient(180deg,var(--accentL),var(--accent))}
.metric-bar-lbl{font-size:9px;color:var(--textF);white-space:nowrap}
.metric-progress-wrap{position:relative}
.metric-progress-bg{height:6px;background:var(--border);border-radius:3px;overflow:hidden}
.metric-progress-fill{height:100%;background:linear-gradient(90deg,var(--accentL),var(--accent));border-radius:3px;transition:width .8s cubic-bezier(.4,0,.2,1)}
.metric-progress-pct{font-size:11px;color:var(--textF);margin-top:3px;text-align:right}
.metric-note-row{display:flex;justify-content:space-between;align-items:center;margin-top:2px}
.metric-note{font-size:11px;color:var(--textF)}
.metric-edit-btn{background:none;border:none;font-size:11px;color:var(--accentL);cursor:pointer;font-family:inherit;padding:0}

/* â”€â”€ ê²°ê³¼ì§€ 4ì»¬ëŸ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.result-sheet{border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:14px;box-shadow:var(--shadow)}
.result-sheet-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--accentDim2);border-bottom:1px solid var(--border);gap:10px}
.result-sheet-date{font-size:11px;color:var(--textF)}
.result-sheet-title{font-family:Georgia,serif;font-size:13px;color:var(--text)}
.result-sheet-toggle{background:none;border:1px solid var(--border);color:var(--textDim);font-family:inherit;font-size:11px;padding:4px 10px;border-radius:6px;cursor:pointer}
.result-sheet-grid{display:grid;grid-template-columns:0.8fr 1fr 1fr 1fr;gap:0;border-top:1px solid var(--border)}
@media(max-width:700px){.result-sheet-grid{grid-template-columns:1fr 1fr}}
@media(max-width:420px){.result-sheet-grid{grid-template-columns:1fr}}
.result-sheet-col{padding:14px;border-right:1px solid var(--border)}
.result-sheet-col:last-child{border-right:none}
.result-sheet-col-head{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--accent);font-weight:600;margin-bottom:10px}
.result-sheet-ans{margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.result-sheet-ans:last-child{margin:0;padding:0;border:none}
.result-sheet-q{font-size:10px;color:var(--textF);margin-bottom:3px}
.result-sheet-v{font-size:12px;color:var(--text);line-height:1.7;white-space:pre-wrap}
.result-sheet-txt{font-size:12px;color:var(--textDim);line-height:1.9}
.result-sheet-card{margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.result-sheet-card:last-child{margin:0;padding:0;border:none}
.result-sheet-card-tag{font-size:10px;color:var(--accentL);font-weight:600;margin-bottom:3px}
.result-sheet-card-title{font-size:12px;font-weight:500;color:var(--text);margin-bottom:3px}
.result-sheet-card-sub{font-size:11px;color:var(--textF);line-height:1.6}
.result-sheet-choice{margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.result-sheet-choice:last-child{margin:0;padding:0;border:none}
.result-sheet-choice-title{font-size:12px;font-weight:500;color:var(--text);margin-bottom:3px}
.result-sheet-choice-how{font-size:11px;color:var(--textDim);line-height:1.7;background:var(--accentDim2);padding:6px 8px;border-radius:6px}

/* â”€â”€ ê¸°ë¡ íƒ­ ë©”ëª¨ del ë²„íŠ¼ ìœ„ì¹˜ ê³ ì • â”€â”€â”€ */
#memoList .memo-item{position:relative}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë‚˜ íƒ­ â€” ì™€ì´ë“œ í’€í™”ë©´ ë ˆì´ì•„ì›ƒ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* í”„ë¡œí•„ í—¤ë” */
.me-header{
  background:linear-gradient(160deg,#1e1a16 0%,#2a1f12 60%,#1a1208 100%);
  padding:20px 28px 18px;
}
.me-header-inner{
  max-width:1400px;margin:0 auto;
  display:flex;align-items:center;gap:20px;
}
.me-avatar-zone{position:relative;flex-shrink:0}
.me-avatar-ring{
  width:84px;height:84px;border-radius:50%;
  background:linear-gradient(135deg,#c9a84c,#8a6520);
  padding:3px;cursor:pointer;box-shadow:0 0 20px rgba(201,168,76,.35);
}
.me-avatar-ring canvas,.me-avatar-ring img{border-radius:50%;display:block}
.me-level{
  position:absolute;bottom:-6px;left:50%;transform:translateX(-50%);
  background:#c9a84c;color:#1e1a16;
  font-size:9px;font-weight:700;letter-spacing:1.5px;padding:2px 8px;
  border-radius:20px;white-space:nowrap;
}
.me-identity{flex:1;min-width:0}
.me-class{
  display:inline-block;font-size:10px;letter-spacing:3px;text-transform:uppercase;
  color:#c9a84c;border:1px solid rgba(201,168,76,.3);padding:2px 10px;
  border-radius:20px;margin-bottom:5px;
}
.me-name-inp{
  display:block;width:100%;background:transparent;border:none;outline:none;
  font-family:Georgia,serif;font-size:22px;color:#f5f0e8;margin-bottom:1px;
}
.me-name-inp::placeholder{color:rgba(245,240,232,.25)}
.me-name-inp:focus{border-bottom:1px solid rgba(201,168,76,.4)}
.me-tagline-inp{
  display:block;width:100%;background:transparent;border:none;outline:none;
  font-family:inherit;font-size:12px;color:rgba(245,240,232,.5);resize:none;line-height:1.5;
}
.me-tagline-inp:focus{border-bottom:1px solid rgba(201,168,76,.25)}
.me-stat-row{display:flex;gap:20px;margin-top:10px}
.me-stat{display:flex;flex-direction:column;align-items:center}
.me-stat-v{font-size:16px;font-weight:700;color:#c9a84c;line-height:1}
.me-stat-l{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:rgba(245,240,232,.35);margin-top:2px}
.me-check-btn{
  padding:12px 22px;background:#c9a84c;border:none;
  color:#1e1a16;font-family:inherit;font-size:13px;font-weight:700;
  border-radius:12px;cursor:pointer;flex-shrink:0;transition:opacity .15s;
  letter-spacing:1px;
}
.me-check-btn:hover{opacity:.85}

/* ë©”ì¸ ê·¸ë¦¬ë“œ */
.me-grid{
  display:grid;
  grid-template-columns:1fr 1.4fr 1fr;
  /* ìƒë‹¨ 3ì¹¸ì€ ê³ ì • ë†’ì´, í•˜ë‹¨ ê°€ì¹˜ê´€ì€ ë‚´ìš© ë†’ì´ */
  grid-template-rows:calc(100vh - 260px) auto;
  gap:0;
}
@media(max-width:900px){
  .me-grid{grid-template-columns:1fr 1fr;grid-template-rows:auto;}
  .me-phil-card{grid-column:1/-1;}
}
@media(max-width:560px){
  .me-grid{grid-template-columns:1fr;}
}

/* ì¹´ë“œ ê³µí†µ */
.me-card{
  border-right:1px solid var(--border);
  border-bottom:1px solid var(--border);
  overflow:hidden;
  display:flex;flex-direction:column;
  min-height:0;
}
.me-card:last-child,.me-phil-card{border-right:none}
.me-card-head{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 16px;
  background:var(--accentDim2);border-bottom:1px solid var(--border);
  font-size:11px;font-weight:600;color:var(--accent);letter-spacing:1.5px;
  text-transform:uppercase;flex-shrink:0;
}
.me-card-action{
  background:none;border:1px solid var(--border);color:var(--accent);
  font-family:inherit;font-size:11px;padding:3px 10px;border-radius:6px;cursor:pointer;
}
.me-card-action:hover{background:var(--accentDim)}

/* ê°€ì¹˜ê´€ ì¹´ë“œ â€” í•˜ë‹¨ ì „ì²´ ë„ˆë¹„ */
.me-phil-card{grid-column:1/-1;border-bottom:none;overflow:visible}
.me-phil-mini-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:10px;padding:14px 16px;
}
.me-phil-mini{
  padding:12px 14px;
  border:1px solid var(--border);border-radius:10px;
  background:var(--surface);
}
.me-phil-mini-tag{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--accentL);font-weight:600;margin-bottom:3px}
.me-phil-mini-title{font-size:12px;font-weight:600;color:var(--text);margin-bottom:4px;line-height:1.4}
.me-phil-mini-body{font-size:11px;color:var(--textF);line-height:1.7}

/* Todo ë¦¬ìŠ¤íŠ¸ */
.me-todo-list{flex:1;overflow-y:auto;padding:8px 12px}
.me-todo-item{
  display:flex;align-items:flex-start;gap:10px;padding:9px 10px;
  border-radius:8px;margin-bottom:4px;cursor:pointer;transition:background .1s;
  background:var(--surface);border:1px solid var(--border);
}
.me-todo-item:hover{border-color:var(--accentL)}
.me-todo-item.done{opacity:.45}
.me-todo-check{
  width:18px;height:18px;border-radius:4px;border:2px solid var(--border);
  flex-shrink:0;display:flex;align-items:center;justify-content:center;
  font-size:11px;transition:all .15s;margin-top:1px;
}
.me-todo-item.done .me-todo-check{background:var(--accent);border-color:var(--accent);color:#fff}
.me-todo-text{font-size:13px;color:var(--text);flex:1;line-height:1.5}
.me-todo-item.done .me-todo-text{text-decoration:line-through;color:var(--textF)}
.me-todo-del{background:none;border:none;color:var(--textF);font-size:14px;cursor:pointer;flex-shrink:0;padding:0 2px}
.me-todo-empty{padding:20px;text-align:center;font-size:13px;color:var(--textF);line-height:1.9}
.me-todo-tag{
  font-size:9px;padding:1px 6px;border-radius:10px;flex-shrink:0;margin-top:2px;font-weight:600;
}
.me-todo-tag.high{background:#fce8e8;color:var(--red)}
.me-todo-tag.mid{background:#fef3e2;color:#8a5a00}
.me-todo-tag.low{background:var(--greenBg);color:var(--green)}

/* ì„±ì¥ ì§€í‘œ ë¯¸ë‹ˆ */
.me-metrics-list{flex:1;overflow-y:auto;padding:8px 12px;display:flex;flex-direction:column;gap:8px}
.me-metric-mini{
  background:var(--surface);border:1px solid var(--border);
  border-radius:10px;padding:10px 12px;
}
.me-metric-mini-header{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:6px}
.me-metric-mini-name{font-size:12px;font-weight:500;color:var(--text)}
.me-metric-mini-val{font-size:20px;font-weight:800;color:var(--accent);line-height:1}
.me-metric-mini-unit{font-size:10px;color:var(--textF);margin-left:2px}
.me-metric-mini-goal{font-size:10px;color:var(--textF)}
/* ë°” ì°¨íŠ¸ */
.me-bar-chart{
  display:flex;align-items:flex-end;gap:3px;
  height:52px;margin-bottom:6px;padding:0 2px;
}
.me-bar-col{
  flex:1;display:flex;flex-direction:column;
  align-items:center;justify-content:flex-end;gap:3px;min-width:0;height:100%;
}
.me-bar-seg{
  width:100%;border-radius:3px 3px 0 0;flex-shrink:0;
  background:linear-gradient(180deg,var(--accentL),var(--accent));
  min-height:3px;
  transition:height .45s cubic-bezier(.4,0,.2,1);
}
.me-bar-lbl{
  font-size:8px;color:var(--textF);flex-shrink:0;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  width:100%;text-align:center;line-height:1;
}
/* í”„ë¡œê·¸ë ˆìŠ¤ ë°” */
.me-prog-bg{height:5px;background:var(--border);border-radius:3px;overflow:hidden}
.me-prog-fill{height:100%;background:linear-gradient(90deg,var(--accentL),var(--accent));border-radius:3px;transition:width .8s cubic-bezier(.4,0,.2,1)}
.me-prog-info{display:flex;justify-content:space-between;font-size:10px;color:var(--textF);margin-top:2px}
.me-metric-mini-actions{display:flex;gap:6px;margin-top:6px}
.me-metric-log-btn{
  padding:4px 10px;background:var(--accent);border:none;color:#fff;
  font-family:inherit;font-size:10px;border-radius:6px;cursor:pointer;
}
.me-metric-edit-btn{
  padding:4px 8px;background:none;border:1px solid var(--border);color:var(--textF);
  font-family:inherit;font-size:10px;border-radius:6px;cursor:pointer;
}
.me-metrics-empty{padding:20px;text-align:center;font-size:13px;color:var(--textF);line-height:1.9}

/* ê²°ê³¼ì§€ ë¯¸ë‹ˆ */
.me-result-list{flex:1;overflow-y:auto;padding:8px 12px;display:flex;flex-direction:column;gap:6px}
.me-result-mini{
  background:var(--surface);border:1px solid var(--border);border-radius:10px;
  padding:10px 12px;cursor:pointer;transition:border-color .15s;
}
.me-result-mini:hover{border-color:var(--accentL)}
.me-result-mini-date{font-size:10px;color:var(--textF);margin-bottom:3px}
.me-result-mini-title{font-size:12px;font-weight:500;color:var(--text);margin-bottom:3px}
.me-result-mini-preview{font-size:11px;color:var(--textDim);line-height:1.6;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
.me-result-empty{padding:20px;text-align:center;font-size:13px;color:var(--textF);line-height:1.9}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë³´ìƒ íƒ­ â€” ì¹´ë“œí˜•
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.reward-wrap{max-width:560px;margin:0 auto;padding-bottom:80px}
.reward-page-header{padding:24px 20px 16px}
.reward-page-header h2{font-family:Georgia,serif;font-size:20px;font-weight:400;margin-bottom:4px}
.reward-page-header p{font-size:12px;color:var(--textF);line-height:1.7}

.rw-section{margin-bottom:8px}
.rw-sec-title{
  display:flex;align-items:center;gap:8px;
  padding:12px 20px;
  font-size:13px;font-weight:600;color:var(--text);
}
.rw-sec-title.charge{border-left:3px solid #4a7a50;background:linear-gradient(90deg,#eaf4ed,transparent)}
.rw-sec-title.drain{border-left:3px solid #8a3a3a;background:linear-gradient(90deg,#f5eaea,transparent)}
.rw-sec-sub{font-size:11px;color:var(--textF);font-weight:400;flex:1}
.rw-new-btn{
  padding:5px 12px;border:none;font-family:inherit;font-size:12px;
  border-radius:8px;cursor:pointer;font-weight:500;flex-shrink:0;
}
.rw-new-btn.charge{background:#4a7a50;color:#fff}
.rw-new-btn.drain{background:#8a3a3a;color:#fff}

/* ì¹´ë“œ ê·¸ë¦¬ë“œ */
.rw-cards{padding:0 16px 12px;display:flex;flex-direction:column;gap:8px}

/* ê°œë³„ ì¹´ë“œ */
.rw-card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:12px;overflow:hidden;box-shadow:0 1px 6px rgba(0,0,0,.05);
}
.rw-card.charge{border-left:3px solid #4a7a50}
.rw-card.drain{border-left:3px solid #c87070}

.rw-card-main{
  display:flex;align-items:center;gap:12px;padding:12px 14px;cursor:pointer;
  transition:background .15s;
}
.rw-card-main:hover{background:var(--accentDim2)}
.rw-card-emoji{font-size:22px;flex-shrink:0;line-height:1}
.rw-card-info{flex:1;min-width:0}
.rw-card-name{font-size:14px;font-weight:500;color:var(--text);margin-bottom:3px}
.rw-card-feeling{font-size:12px;color:var(--textDim);line-height:1.5}
.rw-card-meta{font-size:10px;color:var(--textF);margin-top:3px}
.rw-card-actions{display:flex;gap:6px;flex-shrink:0}
.rw-log-btn{
  padding:6px 12px;border:none;font-family:inherit;font-size:11px;
  border-radius:8px;cursor:pointer;font-weight:500;
}
.rw-log-btn.charge{background:#4a7a50;color:#fff}
.rw-log-btn.drain{background:rgba(138,58,58,.1);color:#8a3a3a;border:1px solid #e8c0c0}
.rw-del-btn{
  background:none;border:1px solid var(--border);color:var(--textF);
  font-size:12px;cursor:pointer;padding:6px 8px;border-radius:8px;
}

/* ë¡œê·¸ íŒ¨ë„ */
.rw-log-panel{
  border-top:1px solid var(--border);padding:12px 14px;
  background:var(--accentDim2);
}
.rw-log-empty{font-size:12px;color:var(--textF);margin-bottom:8px}
.rw-log-entry{
  display:flex;align-items:flex-start;gap:8px;padding:6px 0;
  border-bottom:1px solid var(--border);
}
.rw-log-entry:last-child{border-bottom:none}
.rw-log-date{font-size:11px;color:var(--textF);white-space:nowrap;flex-shrink:0;padding-top:1px}
.rw-log-note{font-size:12px;color:var(--textDim);line-height:1.6;flex:1}
.rw-log-photo{width:40px;height:40px;border-radius:6px;object-fit:cover;cursor:pointer;flex-shrink:0}
.rw-log-del{background:none;border:none;color:var(--textF);font-size:13px;cursor:pointer;flex-shrink:0}

.rw-empty{
  padding:24px;text-align:center;font-size:13px;color:var(--textF);
  background:var(--surface);border:1px dashed var(--border);border-radius:12px;line-height:1.8;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ê³µí†µ ëª¨ë‹¬ (ë°”í…€ì‹œíŠ¸)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.nds-modal{
  position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:500;
  display:flex;align-items:flex-end;justify-content:center;
}
.nds-modal-box{
  background:var(--surface);border-radius:20px 20px 0 0;
  padding:0;width:100%;max-width:560px;max-height:88vh;
  overflow-y:auto;box-shadow:0 -4px 24px rgba(0,0,0,.15);
}
.nds-modal-handle{
  width:36px;height:4px;background:var(--border);border-radius:2px;
  margin:12px auto 0;
}
.nds-modal-inner{padding:20px 24px 40px}
.nds-modal-title{
  font-size:16px;font-weight:600;color:var(--text);
  margin-bottom:20px;padding-top:4px;
}
.nds-field{margin-bottom:14px}
.nds-field-label{
  font-size:11px;font-weight:600;color:var(--textDim);
  letter-spacing:.5px;margin-bottom:6px;
}
.nds-inp{
  width:100%;padding:12px 14px;border:1.5px solid var(--border);
  border-radius:10px;font-family:inherit;font-size:14px;
  background:var(--bg);color:var(--text);transition:border-color .2s;
}
.nds-inp:focus{outline:none;border-color:var(--accentL);background:var(--surface)}
.nds-inp::placeholder{color:var(--textF)}
.nds-ta{
  width:100%;padding:12px 14px;border:1.5px solid var(--border);
  border-radius:10px;font-family:inherit;font-size:14px;
  background:var(--bg);color:var(--text);resize:none;min-height:80px;
  line-height:1.7;transition:border-color .2s;
}
.nds-ta:focus{outline:none;border-color:var(--accentL);background:var(--surface)}
.nds-file-btn{
  display:block;width:100%;padding:11px;border:1.5px dashed var(--border);
  border-radius:10px;font-family:inherit;font-size:13px;color:var(--textDim);
  background:var(--bg);cursor:pointer;text-align:center;transition:border-color .2s;
}
.nds-file-btn:hover{border-color:var(--accentL);color:var(--accent)}
.nds-btn-row{display:flex;gap:10px;margin-top:20px}
.nds-btn-primary{
  flex:1;padding:14px;background:var(--accent);border:none;
  color:#fff;font-family:inherit;font-size:14px;font-weight:500;
  border-radius:12px;cursor:pointer;transition:opacity .15s;
}
.nds-btn-primary.charge{background:#4a7a50}
.nds-btn-primary.drain{background:#8a3a3a}
.nds-btn-primary:hover{opacity:.88}
.nds-btn-ghost{
  padding:14px 18px;background:transparent;border:1.5px solid var(--border);
  color:var(--textF);font-family:inherit;font-size:14px;
  border-radius:12px;cursor:pointer;transition:border-color .2s;
}
.nds-btn-ghost:hover{border-color:var(--accentL);color:var(--textDim)}
.nds-btn-danger{
  padding:14px 18px;background:transparent;border:1.5px solid #d0a0a0;
  color:var(--red);font-family:inherit;font-size:14px;border-radius:12px;cursor:pointer;
}
.nds-photo-preview{
  width:60px;height:60px;border-radius:8px;object-fit:cover;
  margin-top:8px;display:none;
}
</style>
</head>
<body>
<!-- ì ê¸ˆ í™”ë©´ -->
<div id="lockScreen">
  <div class="lock-box">
    <div class="lock-icon">ğŸ”’</div>
    <div class="lock-title">ë‚˜ì˜ ëŒì•„ì˜¤ëŠ” ì‹œìŠ¤í…œ</div>
    <div class="lock-sub">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì•¼ ë“¤ì–´ì˜¬ ìˆ˜ ìˆì–´.</div>
    <input id="lockInp" class="lock-inp" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" maxlength="20"
      onkeydown="if(event.key==='Enter')tryUnlock()">
    <button class="lock-btn" onclick="tryUnlock()">ë“¤ì–´ê°€ê¸°</button>
    <div class="lock-err" id="lockErr"></div>
  </div>
</div>

<div class="tab-bar">
  <button class="tab-btn active" onclick="goTab('me')">ë‚˜</button>
  <button class="tab-btn" onclick="goTab('memo')">ê¸°ë¡</button>
  <button class="tab-btn" onclick="goTab('reward')">ë³´ìƒ</button>
  <button class="tab-btn" onclick="startCheck()">ì²´í¬</button>
  <button class="tab-btn" onclick="goTab('settings')">ì„¤ì •</button>
</div>
<div class="sync-bar" id="syncBar">
  <div class="sync-dot" id="syncDot"></div>
  <span id="syncStatus">Firebase ë¯¸ì—°ê²° â€” ê¸°ê¸° ê°„ ë™ê¸°í™” ì•ˆ ë¨</span>
  <span class="firebase-user" id="fbUserLabel"></span>
</div>

<!-- ë‚˜ íƒ­ (í™ˆ ê²¸ìš©, active) -->
<div id="page-me" class="page active">
  <!-- í”„ë¡œí•„ í—¤ë” â€” í’€ í™”ë©´ ë„ˆë¹„ -->
  <div class="me-header">
    <div class="me-header-inner">
      <div class="me-avatar-zone">
        <div class="me-avatar-ring" onclick="document.getElementById('avatarInp').click()">
          <canvas id="meAvatarCanvas" width="80" height="80"></canvas>
          <img id="meAvatarImg" style="display:none;width:80px;height:80px;border-radius:50%;object-fit:cover" alt="">
        </div>
        <input type="file" id="avatarInp" accept="image/*" style="display:none" onchange="onAvatarUpload(event)">
        <div class="me-level" id="meLevelBadge">Lv.1</div>
      </div>
      <div class="me-identity">
        <div class="me-class" id="meClassTag">ê´€ì°°ì</div>
        <input id="meNameInp" class="me-name-inp" placeholder="ì´ë¦„" onchange="saveProfileData()">
        <textarea id="meTaglineInp" class="me-tagline-inp" rows="1" placeholder="ë‚˜ë¥¼ í•œ ì¤„ë¡œ..." onchange="saveProfileData()"></textarea>
        <div class="me-stat-row" id="meStatRow"></div>
      </div>
      <button class="me-check-btn" onclick="startCheck()">ì²´í¬ â†’</button>
    </div>
  </div>

  <!-- ë©”ì¸ ê·¸ë¦¬ë“œ -->
  <div class="me-grid">

    <!-- ì™¼ìª½: ì§‘ì¤‘í• ì¼ Todo -->
    <div class="me-card me-todo-card">
      <div class="me-card-head">
        <span>â— ì§€ê¸ˆ ì§‘ì¤‘í•  ê²ƒ</span>
        <button class="me-card-action" onclick="openTodoModal()">+ ì¶”ê°€</button>
      </div>
      <div id="meTodoList" class="me-todo-list"></div>
    </div>

    <!-- ì¤‘ê°„: ì„±ì¥ ì§€í‘œ ê·¸ë˜í”„ -->
    <div class="me-card me-metrics-card">
      <div class="me-card-head">
        <span>â—† ì„±ì¥ ì§€í‘œ</span>
        <button class="me-card-action" onclick="openMetricModal(-1)">+ ì¶”ê°€</button>
      </div>
      <div id="meMiniMetrics" class="me-metrics-list"></div>
    </div>

    <!-- ì˜¤ë¥¸ìª½: ìµœê·¼ ê²°ê³¼ì§€ + ê°€ì¹˜ê´€ -->
    <div class="me-card me-results-card">
      <div class="me-card-head">
        <span>â–£ ìµœê·¼ ì²´í¬ ê²°ê³¼</span>
        <button class="me-card-action" onclick="goTab('memo');switchSeg('seg-results',document.querySelectorAll('.seg-btn')[1])">ì „ì²´ â†’</button>
      </div>
      <div id="meResultPreview" class="me-result-list"></div>
    </div>

    <!-- ê°€ì¹˜ê´€ ì¹´ë“œë“¤ -->
    <div class="me-card me-phil-card">
      <div class="me-card-head"><span>â—ˆ ë‚´ ê°€ì¹˜ê´€</span></div>
      <div id="mePhilGrid" class="me-phil-mini-grid"></div>
    </div>

  </div>
</div>

<!-- ê¸°ë¡ â€” ì„¸ê·¸ë¨¼íŠ¸ ì»¨íŠ¸ë¡¤ -->
<div id="page-memo" class="page">
  <div class="inner">
    <div class="memo-h">
      <h2>ë‚˜ì˜ ê¸°ë¡</h2>
      <p class="memo-sub">ê°€ì¹˜ê´€, ê¹¨ë‹¬ìŒ, ì˜¤ëŠ˜ ëŠë‚€ ê²ƒì„ ë©”ëª¨í•˜ëŠ” ê³³.<br>ê¸°ë¡ì´ ë§¤ë²ˆ AI ë¶„ì„ì— ë°˜ì˜ëœë‹¤.</p>
    </div>
    <!-- ì„¸ê·¸ë¨¼íŠ¸ -->
    <div class="seg-ctrl">
      <button class="seg-btn active" onclick="switchSeg('seg-notes',this)">ë©”ëª¨</button>
      <button class="seg-btn" onclick="switchSeg('seg-results',this)">ê²°ê³¼ì§€</button>
      <button class="seg-btn" onclick="switchSeg('seg-metrics',this)">ì„±ì¥ ì§€í‘œ</button>
    </div>

    <!-- ë©”ëª¨ íŒ¨ë„ -->
    <div class="seg-panel active" id="seg-notes">
      <div class="memo-add">
        <textarea id="newMemoTa" style="min-height:80px" placeholder="ì˜¤ëŠ˜ ìƒˆë¡­ê²Œ ì•Œê²Œ ëœ ê²ƒ, ê°€ì¹˜ê´€, ê¹¨ë‹¬ìŒ..."></textarea>
        <button class="memo-add-btn" onclick="addMemoFromId('newMemoTa')">ì €ì¥</button>
      </div>
      <div class="memo-list" id="memoList"></div>
    </div>

    <!-- ê²°ê³¼ì§€ íŒ¨ë„ -->
    <div class="seg-panel" id="seg-results">
      <div class="memo-list" id="resultList" style="padding-top:8px"></div>
    </div>

    <!-- ì„±ì¥ ì§€í‘œ íŒ¨ë„ -->
    <div class="seg-panel" id="seg-metrics">
      <div style="padding:16px 0 8px;display:flex;justify-content:flex-end">
        <button class="memo-add-btn" style="margin-top:0" onclick="openMetricModal(-1)">+ ì§€í‘œ ì¶”ê°€</button>
      </div>
      <div id="metricsPanel"></div>
    </div>
  </div>
</div>

<!-- ë³´ìƒ íƒ­ -->
<div id="page-reward" class="page">
  <div class="reward-wrap">
    <div class="reward-page-header">
      <h2>ì§„ì§œ ë³´ìƒ Â· ê°€ì§œ ë³´ìƒ</h2>
      <p>ì§ì ‘ í•´ë³´ê³  ì•Œê²Œ ëœ ê²ƒë“¤. ëì´ ì–´ë• ëŠ”ì§€ê°€ ê¸°ì¤€ì´ì•¼.</p>
    </div>

    <!-- ì¶©ì „ ì„¹ì…˜ -->
    <div class="rw-section">
      <div class="rw-sec-title charge">
        <span>ğŸ’™ ì¶©ì „ LIST</span>
        <span class="rw-sec-sub">ì§„ì§œ ë³´ìƒ â€” í•´ë³´ë‹ˆê¹Œ ì‹¤ì œë¡œ ì¢‹ì•˜ë˜ ê²ƒ</span>
        <button class="rw-new-btn charge" onclick="openRewardModal('charge')">+ ì¶”ê°€</button>
      </div>
      <div class="rw-cards" id="charge-items"></div>
    </div>

    <!-- ë°©ì „ ì„¹ì…˜ -->
    <div class="rw-section">
      <div class="rw-sec-title drain">
        <span>ğŸ”´ ë°©ì „ LIST</span>
        <span class="rw-sec-sub">ê°€ì§œ ë³´ìƒ â€” ëì´ ì•ˆ ì¢‹ì•˜ë˜ ê²ƒ</span>
        <button class="rw-new-btn drain" onclick="openRewardModal('drain')">+ ì¶”ê°€</button>
      </div>
      <div class="rw-cards" id="drain-items"></div>
    </div>
  </div>
</div>

<!-- ì²´í¬ -->
<div id="page-check" class="page">
  <div class="q-outer" id="checkContent"></div>
</div>

<!-- ê²°ê³¼ -->
<div id="page-result" class="page">
  <div class="inner-wide" id="resultContent"></div>
</div>

<!-- ì„¤ì • -->
<div id="page-settings" class="page">
  <div class="inner" style="padding-top:8px">
    <div class="settings-wrap">
      <h2 class="settings-title">ì„¤ì •</h2>
      <p class="settings-sub">ì‹œìŠ¤í…œì˜ ëª¨ë“  ë¶€ë¶„ì„ ì§ì ‘ ìˆ˜ì •í•  ìˆ˜ ìˆì–´.</p>

      <!-- API -->
      <div class="set-section">
        <div class="set-section-head" onclick="toggleSection('sec-api')">
          <div class="set-section-title">API í‚¤</div>
          <div class="set-section-arrow open" id="arr-sec-api">â–¼</div>
        </div>
        <div class="set-section-body open" id="sec-api">
          <div class="setting-lbl">Groq API í‚¤</div>
          <input id="apiKeyInp" class="setting-inp" type="password" placeholder="gsk_...ë¡œ ì‹œì‘í•˜ëŠ” í‚¤">
          <div class="setting-hint">
            <a href="https://console.groq.com" target="_blank">console.groq.com</a>ì—ì„œ ë¬´ë£Œë¡œ ë°œê¸‰ë°›ì„ ìˆ˜ ìˆì–´. í‚¤ëŠ” ì´ ê¸°ê¸°ì—ë§Œ ì €ì¥ë¼.
          </div>
          <div class="api-status" id="apiStatus"></div>
          <div class="btn-row">
            <button class="btn-primary" onclick="saveApiKey()">ì €ì¥</button>
            <button class="btn-secondary" onclick="testApiKey()">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
          </div>
          <div class="test-result" id="testResult"></div>
        </div>
      </div>

      <!-- AI ìŠ¤íƒ€ì¼ -->
      <div class="set-section">
        <div class="set-section-head" onclick="toggleSection('sec-ai')">
          <div class="set-section-title">AI ì‘ë‹µ ìŠ¤íƒ€ì¼</div>
          <div class="set-section-arrow" id="arr-sec-ai">â–¼</div>
        </div>
        <div class="set-section-body" id="sec-ai">
          <div class="setting-lbl">ë¶„ì„ ìŠ¤íƒ€ì¼</div>
          <select id="setAnalysisStyle" class="sel setting-inp" onchange="saveSettings()">
            <option value="pattern">íŒ¨í„´ ë¶„ì„ (ë‹µë³€ë“¤ ì‚¬ì´ì˜ ì—°ê²°ê³ ë¦¬ ì§šê¸°)</option>
            <option value="direct">ì§ì ‘ì  (ë³´ì´ëŠ” ê²ƒ ê·¸ëŒ€ë¡œ)</option>
            <option value="gentle">ë¶€ë“œëŸ½ê²Œ (ë”°ëœ»í•œ í†¤ìœ¼ë¡œ)</option>
          </select>
          <div class="setting-lbl">í–‰ë™ê°•ë ¹ ìŠ¤íƒ€ì¼</div>
          <select id="setActionStyle" class="sel setting-inp" onchange="saveSettings()">
            <option value="step">3ë‹¨ê³„ ì—°ê²° (ì¸ì§€â†’í–‰ë™â†’ìŠµê´€)</option>
            <option value="simple">ë‹¨ìˆœ ëª…í™• (ë°”ë¡œ í•  ê²ƒë§Œ)</option>
            <option value="why">ì´ìœ  ì¤‘ì‹¬ (ì™œ í•´ì•¼ í•˜ëŠ”ì§€ ë¨¼ì €)</option>
          </select>
          <div class="setting-lbl">ì¶”ê°€ í”„ë¡¬í”„íŠ¸ (ì„ íƒ)</div>
          <textarea id="setExtraPrompt" class="setting-ta" placeholder="AIì—ê²Œ ì¶”ê°€ë¡œ ì§€ì‹œí•˜ê³  ì‹¶ì€ ë‚´ìš©. ì˜ˆ: 'í•­ìƒ êµ¬ì²´ì ì¸ ì‹œê°„ì„ í¬í•¨í•´ì¤˜'" oninput="saveSettings()"></textarea>
        </div>
      </div>

      <!-- ê°€ì¹˜ê´€ ì¹´ë“œ í¸ì§‘ -->
      <div class="set-section">
        <div class="set-section-head" onclick="toggleSection('sec-phil')">
          <div class="set-section-title">ê°€ì¹˜ê´€ ì¹´ë“œ í¸ì§‘</div>
          <div class="set-section-arrow" id="arr-sec-phil">â–¼</div>
        </div>
        <div class="set-section-body" id="sec-phil">
          <div id="philEditList"></div>
          <button class="add-item-btn" onclick="addPhilCard()">+ ê°€ì¹˜ê´€ ì¶”ê°€</button>
          <div class="btn-row" style="margin-top:14px">
            <button class="btn-primary" onclick="savePhilCards()">ì €ì¥</button>
            <button class="btn-ghost" onclick="resetPhilCards()">ê¸°ë³¸ê°’ìœ¼ë¡œ</button>
          </div>
        </div>
      </div>

      <!-- ì§ˆë¬¸ í¸ì§‘ -->
      <div class="set-section">
        <div class="set-section-head" onclick="toggleSection('sec-q')">
          <div class="set-section-title">ì§ˆë¬¸ í¸ì§‘</div>
          <div class="set-section-arrow" id="arr-sec-q">â–¼</div>
        </div>
        <div class="set-section-body" id="sec-q">
          <div id="qEditList"></div>
          <button class="add-item-btn" onclick="addQuestion()">+ ì§ˆë¬¸ ì¶”ê°€</button>
          <div class="btn-row" style="margin-top:14px">
            <button class="btn-primary" onclick="saveQuestionSet()">ì €ì¥</button>
            <button class="btn-ghost" onclick="resetQuestions()">ê¸°ë³¸ê°’ìœ¼ë¡œ</button>
          </div>
        </div>
      </div>

      <!-- ë¹„ë°€ë²ˆí˜¸ -->
      <div class="set-section">
        <div class="set-section-head" onclick="toggleSection('sec-pw')">
          <div class="set-section-title">ğŸ”’ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</div>
          <div class="set-section-arrow" id="arr-sec-pw">â–¼</div>
        </div>
        <div class="set-section-body" id="sec-pw">
          <div class="setting-lbl">ìƒˆ ë¹„ë°€ë²ˆí˜¸</div>
          <input id="newPwInp" class="setting-inp" type="password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
          <div class="setting-lbl" style="margin-top:12px">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</div>
          <input id="newPwInp2" class="setting-inp" type="password" placeholder="í•œ ë²ˆ ë” ì…ë ¥">
          <div class="btn-row" style="margin-top:12px">
            <button class="btn-primary" onclick="changePassword()">ë³€ê²½</button>
          </div>
          <div class="setting-hint" style="margin-top:10px">ë¹„ë°€ë²ˆí˜¸ëŠ” ì´ ê¸°ê¸° ë¸Œë¼ìš°ì €ì— ì €ì¥ë¼. ìŠì–´ë²„ë¦¬ë©´ ì•„ë˜ ë°©ë²•ìœ¼ë¡œ ì´ˆê¸°í™”í•  ìˆ˜ ìˆì–´.<br><br>
          ì´ˆê¸°í™”: ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì—ì„œ <code style="background:var(--bg);padding:2px 6px;border-radius:4px;font-size:11px">localStorage.removeItem('app_pw')</code> ì‹¤í–‰</div>
        </div>
      </div>

      <!-- Firebase ë™ê¸°í™” -->
      <div class="set-section">
        <div class="set-section-head" onclick="toggleSection('sec-firebase')">
          <div class="set-section-title">â˜ï¸ Firebase ë™ê¸°í™” (ê¸°ê¸° ì—°ë™)</div>
          <div class="set-section-arrow" id="arr-sec-firebase">â–¼</div>
        </div>
        <div class="set-section-body" id="sec-firebase">
          <p class="setting-hint" style="margin-bottom:14px;line-height:1.75">Firebaseë¥¼ ì—°ê²°í•˜ë©´ í°Â·íŒ¨ë“œÂ·ì»´í“¨í„° ì–´ë””ì„œë“  ê°™ì€ ë°ì´í„°ë¥¼ ë³¼ ìˆ˜ ìˆì–´. êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ë©´ ìë™ìœ¼ë¡œ ë™ê¸°í™”ë¼. <a href="https://console.firebase.google.com" target="_blank" style="color:var(--accentL)">Firebase ì½˜ì†”</a>ì—ì„œ í”„ë¡œì íŠ¸ë¥¼ ë§Œë“¤ê³  ì•„ë˜ì— ì„¤ì •ê°’ì„ ë„£ì–´ì¤˜.</p>

          <div id="fbConfigForm">
            <div class="setting-lbl">Firebase ì„¤ì •ê°’</div>
            <div class="setting-hint" style="margin-bottom:10px">Firebase ì½˜ì†” â†’ í”„ë¡œì íŠ¸ ì„¤ì • â†’ ë‚´ ì•± â†’ ì›¹ ì•± ì¶”ê°€ â†’ firebaseConfig ì•ˆì˜ ê°’ë“¤</div>
            <input id="fbApiKey" class="setting-inp" type="password" placeholder="apiKey" style="margin-bottom:6px">
            <input id="fbAuthDomain" class="setting-inp" type="text" placeholder="authDomain (ì˜ˆ: myapp.firebaseapp.com)" style="margin-bottom:6px">
            <input id="fbProjectId" class="setting-inp" type="text" placeholder="projectId" style="margin-bottom:6px">
            <div class="btn-row" style="margin-top:10px">
              <button class="btn-primary" onclick="saveFbConfig()">ì €ì¥ ë° ì—°ê²°</button>
              <button class="btn-ghost" onclick="clearFbConfig()">ì—°ê²° í•´ì œ</button>
            </div>
          </div>

          <div style="margin-top:16px" id="fbLoginSection" style="display:none">
            <div class="setting-lbl">ë¡œê·¸ì¸</div>
            <div id="fbLoginArea">
              <button class="fb-login-btn" onclick="fbGoogleLogin()">
                <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.5 0 6.6 1.2 9.1 3.2l6.8-6.8C35.8 2.5 30.2 0 24 0 14.7 0 6.8 5.4 3.1 13.4l7.9 6.2C12.9 13.2 18 9.5 24 9.5z"/><path fill="#4285F4" d="M46.5 24.5c0-1.6-.1-3.1-.4-4.5H24v8.5h12.7c-.6 3-2.3 5.5-4.8 7.2l7.5 5.8C43.6 37.4 46.5 31.4 46.5 24.5z"/><path fill="#FBBC05" d="M11 28.6C10.3 26.8 10 24.9 10 23s.4-3.8 1-5.6L3.1 11.2C1.1 15 0 19.4 0 24s1.1 9 3.1 12.8l7.9-6.2z"/><path fill="#34A853" d="M24 48c6.2 0 11.4-2 15.2-5.5l-7.5-5.8c-2 1.4-4.6 2.2-7.7 2.2-6 0-11.1-3.7-13-9.1L3.1 36.1C6.8 43.6 14.7 48 24 48z"/></svg>
                Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
              </button>
            </div>
          </div>

          <div id="fbStatusArea" style="display:none;margin-top:12px">
            <div class="api-status">
              <div class="status-dot ok"></div>
              <span id="fbLoggedUser" style="color:var(--green)"></span>
            </div>
            <div class="btn-row" style="margin-top:10px">
              <button class="btn-secondary" onclick="fbForceSync()">ì§€ê¸ˆ ë™ê¸°í™”</button>
              <button class="btn-ghost" onclick="fbLogout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
          </div>

          <div style="margin-top:14px;padding:12px 14px;background:var(--accentDim2);border-radius:10px">
            <div style="font-size:11px;color:var(--accentL);font-weight:600;margin-bottom:6px;letter-spacing:1px">ì„¤ì • ë°©ë²• ìš”ì•½</div>
            <div style="font-size:12px;color:var(--textDim);line-height:2">
              1. <a href="https://console.firebase.google.com" target="_blank" style="color:var(--accentL)">Firebase ì½˜ì†”</a>ì—ì„œ í”„ë¡œì íŠ¸ ìƒˆë¡œ ë§Œë“¤ê¸°<br>
              2. Authentication â†’ Google ë¡œê·¸ì¸ í™œì„±í™”<br>
              3. Firestore Database ë§Œë“¤ê¸° (í…ŒìŠ¤íŠ¸ ëª¨ë“œ)<br>
              4. í”„ë¡œì íŠ¸ ì„¤ì • â†’ ì›¹ ì•± ì¶”ê°€ â†’ apiKey, authDomain, projectId ë³µì‚¬<br>
              5. ìœ„ ì¹¸ì— ë¶™ì—¬ë„£ê¸° í›„ ì €ì¥ â†’ Google ë¡œê·¸ì¸
            </div>
          </div>
        </div>
      </div>

      <!-- ë°ì´í„° -->
      <div class="set-section">
        <div class="set-section-head" onclick="toggleSection('sec-data')">
          <div class="set-section-title">ë°ì´í„° ê´€ë¦¬ Â· ë°±ì—…</div>
          <div class="set-section-arrow" id="arr-sec-data">â–¼</div>
        </div>
        <div class="set-section-body" id="sec-data">
          <p class="setting-hint" style="margin-bottom:14px">ê¸°ë¡ì„ íŒŒì¼ë¡œ ë‚´ë³´ë‚´ê±°ë‚˜, ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆì–´. Firebase ì—†ì´ ìˆ˜ë™ ë°±ì—…í•  ë•Œ ìœ ìš©í•´.</p>
          <div class="export-import-row">
            <button class="btn-primary" onclick="exportData()">ğŸ“¥ ë‚´ë³´ë‚´ê¸° (JSON)</button>
            <label class="btn-secondary" style="cursor:pointer;padding:11px 16px;display:inline-block">
              ğŸ“¤ ê°€ì ¸ì˜¤ê¸°
              <input type="file" accept=".json" onchange="importData(event)" style="display:none">
            </label>
          </div>
          <div class="divider"></div>
          <button class="btn-danger-outline" onclick="clearAllData()">ëª¨ë“  ê¸°ë¡ ì‚­ì œ</button>
        </div>
      </div>

    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€ ë¹„ë°€ë²ˆí˜¸ ì ê¸ˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEFAULT_PW = 'myreturn2024'; // â† ì—¬ê¸°ì„œ ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ê°€ëŠ¥
const SALT = 'nds_v1_';

async function hashPw(pw){
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(SALT+pw));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

async function initLock(){
  // ì €ì¥ëœ í•´ì‹œê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸ë¡œ ì´ˆê¸°í™”
  if(!localStorage.getItem('app_pw')){
    localStorage.setItem('app_pw', await hashPw(DEFAULT_PW));
  }
  // ì„¸ì…˜ ì¤‘ ì´ë¯¸ ì¸ì¦ëìœ¼ë©´ ë°”ë¡œ í†µê³¼
  if(sessionStorage.getItem('unlocked')==='1'){
    document.getElementById('lockScreen').style.display='none';
    return;
  }
  document.getElementById('lockInp').focus();
}

async function tryUnlock(){
  const val = document.getElementById('lockInp').value;
  const err = document.getElementById('lockErr');
  if(!val){err.textContent='ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì¤˜';return;}
  const hash = await hashPw(val);
  const saved = localStorage.getItem('app_pw');
  if(hash === saved){
    sessionStorage.setItem('unlocked','1');
    document.getElementById('lockScreen').style.display='none';
    err.textContent='';
  } else {
    err.textContent='ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ì–´';
    document.getElementById('lockInp').value='';
    document.getElementById('lockInp').focus();
  }
}

async function changePassword(){
  const p1 = document.getElementById('newPwInp').value;
  const p2 = document.getElementById('newPwInp2').value;
  if(!p1){showToast('ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì¤˜');return;}
  if(p1 !== p2){showToast('ë‘ ë¹„ë°€ë²ˆí˜¸ê°€ ë‹¬ë¼');return;}
  if(p1.length < 4){showToast('4ì ì´ìƒìœ¼ë¡œ í•´ì¤˜');return;}
  localStorage.setItem('app_pw', await hashPw(p1));
  document.getElementById('newPwInp').value='';
  document.getElementById('newPwInp2').value='';
  showToast('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ëì–´!');
}

// â”€â”€ ê¸°ë³¸ ë°ì´í„° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BASE_PHIL=[
  {tag:"ì¤‘ì‹¬ ê°€ì¹˜",title:"í–‰ë³µí•˜ê²Œ ì‚´ì",body:"ì›í•˜ëŠ” ëŒ€ë¡œë§Œ ì‚´ì•„ë´¤ë”ë‹ˆ í–‰ë³µí•˜ì§€ ì•Šì•˜ë‹¤. í•œë‘ ë‹¬ í•´ë³´ë‹ˆ ë‚˜ê°€ëŠ” ì¼ì´ ì—†ì„ìˆ˜ë¡ ëª¸ì´ ë§ê°€ì§€ê³  í”¼ê³¤í•´ì¡Œë‹¤. ì–´ì°¨í”¼ ì‚´ ê±°ë¼ë©´ í–‰ë³µí•˜ê²Œ ì‚´ê² ë‹¤."},
  {tag:"ê°€ì§œ ë³´ìƒ",title:"ëŒë¦°ë‹¤ê³  ì§„ì§œ ì›í•˜ëŠ” ê²Œ ì•„ë‹ ìˆ˜ ìˆë‹¤",body:"ì „ìê¸°ê¸°ë¥¼ ì˜¤ë˜ í•´ë´¤ë‹¤. ëì€ í•­ìƒ ëª¸ì´ ì•„í”„ê±°ë‚˜ ë” ìš°ìš¸í–ˆë‹¤. í•˜ì§€ ë§ë¼ê³  í•˜ë‹ˆê¹Œ ìŠ¤íŠ¸ë ˆìŠ¤Â·íšŒí”¼Â·ë³´ìƒ ì‹¬ë¦¬ë¡œ í•˜ê³  ìˆì—ˆë˜ ê²ƒì´ë‹¤. ì§ì ‘ í•´ë´¤ì„ ë•Œ ëì´ ì–´ë• ëŠ”ì§€ê°€ ê¸°ì¤€ì´ë‹¤."},
  {tag:"ìƒê°ì˜ ì‹¤ì²´",title:"êº¼ë‚´ì•¼ ì‹¤ì²´ê°€ ìƒê¸´ë‹¤",body:"ë¨¸ë¦¿ì†ì—ì„œ ë…¼ë¬¸ì²˜ëŸ¼ ëŠê»´ì§€ëŠ” ìƒê°ë„ êº¼ë‚´ë³´ë©´ ë‘ ì¤„ì´ ëœë‹¤. ì‹¤ë§ì´ ì•„ë‹ˆë‹¤. ì‹¤ì²´ê°€ ìƒê¸´ ê²ƒì´ë‹¤. ì‹¤ì²´ê°€ ìˆì–´ì•¼ ë‹¤ë£° ìˆ˜ ìˆë‹¤."},
  {tag:"ë¶ˆì•ˆ",title:"ë¶ˆì•ˆì€ ë¯¸ë˜ì— ìˆê³ , ë‚˜ëŠ” ì§€ê¸ˆ ì—¬ê¸° ìˆë‹¤",body:"ê±±ì •ì˜ 99%ëŠ” ì¼ì–´ë‚˜ì§€ ì•ŠëŠ”ë‹¤. ë¯¸ë˜ ê±±ì •ì— ì“°ëŠ” ì—ë„ˆì§€ë¥¼ ì°¨ë¼ë¦¬ ì§€ê¸ˆ í•  ìˆ˜ ìˆëŠ” ê²ƒì— ì“°ëŠ” ê²Œ ë‚«ë‹¤."},
  {tag:"ë‚˜ë¥¼ ëŒ€í•˜ëŠ” ë°©ì‹",title:"ë‚˜ëŠ” í‰ìƒ ë‚˜ì™€ í•¨ê»˜ ì‚°ë‹¤",body:"ì•„ì´ëŒ ë§¤ë‹ˆì €ì²˜ëŸ¼ ëƒ‰ì² í•˜ê²Œ íŒŒì•…í•˜ë˜, ê·¸ ì •ë³´ëŠ” ë‚˜ë¥¼ ë°œì „ì‹œí‚¤ëŠ” ë° ì“´ë‹¤. ë¶€ì¡±í•œ ì ì€ ë‚˜ë¥¼ ê³µê²©í•˜ê¸° ìœ„í•œ ê²Œ ì•„ë‹ˆë¼ ì„±ì¥ì‹œí‚¤ê¸° ìœ„í•´ ìˆëŠ” ê²ƒì´ë‹¤."},
  {tag:"ë…¸ë ¥",title:"ë…¸ë ¥ì€ ë°°ì‹ í•˜ì§€ ì•ŠëŠ”ë‹¤",body:"ì•ˆ ì¢‹ì€ ì¼ì´ ìƒê¸°ê±°ë‚˜ ë‹¹ì¥ ë³€í™”ê°€ ì—†ì–´ë„ ìŒ“ì´ê³  ìˆë‹¤. ì¹˜ì—´í•˜ê²Œ 1ë¶„ 1ì´ˆ ê³ ë¯¼í•˜ëŠ” ê²ƒë„ ë‚˜ë¥¼ ì„±ì¥ì‹œí‚¤ê³  ìˆë‹¤."},
];
const BASE_QUESTIONS=[
  {id:'mood',cat:'ì§€ê¸ˆ ìƒíƒœ',text:'ì§€ê¸ˆ ê¸°ë¶„ì´ë‚˜ ìƒíƒœë¥¼ ì†”ì§í•˜ê²Œ í‘œí˜„í•˜ë©´?',sub:'ì¢‹ë‹¤, ë¬´ê¸°ë ¥í•˜ë‹¤, ë¶ˆì•ˆí•˜ë‹¤, ëª¨ë¥´ê² ë‹¤ â€” ë­ë“  ê´œì°®ì•„.',type:'ta'},
  {id:'body',cat:'ëª¸ ìƒíƒœ',text:'ì§€ê¸ˆ ëª¸ì€ ì–´ë•Œ?',sub:'ì , í”¼ë¡œë„, ì•„í”ˆ ê³³, ë°¥ì€ ë¨¹ì—ˆëŠ”ì§€.',type:'opts',opts:['ê´œì°®ì•„','ì¢€ í”¼ê³¤í•˜ê±°ë‚˜ ì°Œë¿Œë‘¥í•´','í™•ì‹¤íˆ ì•ˆ ì¢‹ì•„']},
  {id:'reality',cat:'í˜„ì‹¤ ìƒí™©',text:'ì§€ê¸ˆ í˜„ì‹¤ì—ì„œ ë‚´ ìƒí™©ì€ ì–´ë•Œ?',sub:'ìš”ì¦˜ ì–´ë–»ê²Œ ì§€ë‚´ê³  ìˆëŠ”ì§€. ìƒí™œ ë£¨í‹´, ì‚¬ëŒë“¤ê³¼ì˜ ê´€ê³„, í•™êµë‚˜ ì¼, ëˆ, ë­ë“ . ì§€ê¸ˆ ë‚´ í¬ì§€ì…˜ì´ ì–´ë””ì¯¤ì¸ì§€ êº¼ë‚´ë´.',type:'ta'},
  {id:'tasks',cat:'í•´ì•¼ í•  ê²ƒë“¤',text:'ì§€ê¸ˆ í•´ì•¼ í•˜ëŠ”ë° ëª» í•˜ê³  ìˆê±°ë‚˜ ë‹¤ê°€ì˜¤ëŠ” ì¼ì´ ìˆì–´?',sub:'ê¸‰í•œ ê²ƒ, ë¯¸ë£¨ê³  ìˆëŠ” ê²ƒ, ê³§ ë‹¥ì¹  ì¼ì •. ì‘ì€ ê±°ë¼ë„ ë¨¸ë¦¿ì†ì— ê±¸ë ¤ ìˆìœ¼ë©´ êº¼ë‚´ë´.',type:'ta'},
  {id:'avoidance',cat:'í–‰ë™ íŒ¨í„´',text:'ì§€ê¸ˆ í”¼í•˜ê±°ë‚˜ ì˜¤ë˜ ë¶™ì¡ê³  ìˆëŠ” ê²Œ ìˆì–´?',sub:'ì „ìê¸°ê¸°, ìœ íŠœë¸Œ, ê²Œì„, í•´ì•¼ í•  ì¼ ë¯¸ë£¨ê¸° ë“±. ìˆìœ¼ë©´ ë­”ì§€, ì–¼ë§ˆë‚˜ í–ˆëŠ”ì§€ë„.',type:'ta'},
  {id:'anxiety',cat:'ë¶ˆì•ˆÂ·ê±±ì •',text:'ì§€ê¸ˆ ë¨¸ë¦¿ì†ì„ ë§´ë„ëŠ” ê±±ì •ì´ë‚˜ ìƒê°ì´ ìˆì–´?',sub:'ìˆë‹¤ë©´ êº¼ë‚´ë´. ë¨¸ë¦¿ì†ì— ë‘ë©´ ê³„ì† ì»¤ì§„ë‹¤.',type:'ta'},
  {id:'compare',cat:'ë¹„êµÂ·ìì±…',text:'ìš”ì¦˜ íƒ€ì¸ê³¼ ë¹„êµí•˜ê±°ë‚˜ ìŠ¤ìŠ¤ë¡œë¥¼ ìì±…í•˜ëŠ” ì¼ì´ ìˆì–´?',sub:'ì–´ë–¤ ìƒí™©ì—ì„œ ê·¸ëŸ° ìƒê°ì´ ë“œëŠ”ì§€.',type:'ta'},
];
const Q_INSIGHTS={
  mood:{tag:"ìƒê°ì˜ ì‹¤ì²´",text:"ë¨¸ë¦¿ì†ì—ì„œ ë…¼ë¬¸ì²˜ëŸ¼ ëŠê»´ì§€ëŠ” ê²ƒë„ êº¼ë‚´ë³´ë©´ ë‘ ì¤„ì´ ëœë‹¤. ì§€ê¸ˆ ìƒíƒœë¥¼ ë§ë¡œ êº¼ë‚¸ ê²ƒ ìì²´ê°€ ì´ë¯¸ ì ˆë°˜ì´ë‹¤."},
  body:{
    ok:{tag:"ì¤‘ì‹¬ ê°€ì¹˜",text:"ëª¸ì´ ë°›ì³ì¤„ ë•Œ í•  ìˆ˜ ìˆëŠ” ê²ƒë“¤ì´ ë‹¤ë¥´ë‹¤. ì§€ê¸ˆì´ ê·¸ ë•Œë‹¤."},
    warn:{tag:"ì¤‘ì‹¬ ê°€ì¹˜",text:"ì§€ê¸ˆ ëŠë¼ëŠ” ê²ƒì˜ ì¼ë¶€ê°€ ëª¸ì—ì„œ ì˜¤ëŠ” ê²ƒì¼ ìˆ˜ ìˆë‹¤. ëª¸ê³¼ ë§ˆìŒì€ ì´ì–´ì ¸ ìˆë‹¤."},
    bad:{tag:"ì¤‘ì‹¬ ê°€ì¹˜",text:"ëª¸ì´ ë¨¼ì €ë‹¤. ëª¸ì´ ë§ê°€ì§„ ì±„ë¡œ ì–µì§€ë¡œ í•˜ëŠ” ê±´ íš¨ìœ¨ì´ ì—†ë‹¤ëŠ” ê±¸ ê²½í—˜ìœ¼ë¡œ ì•Œì–ì•„."}
  },
  reality:{tag:"ìƒê°ì˜ ì‹¤ì²´",text:"ì§€ê¸ˆ ë‚´ ìƒí™©ì„ êº¼ë‚´ë³´ëŠ” ê²ƒ ìì²´ê°€ ì´ë¯¸ í˜„ì‹¤ì„ ì§ì‹œí•˜ëŠ” ê±°ì•¼. ë¨¸ë¦¿ì†ì—ì„œ íë¦¿í•˜ê²Œ ë‘ë©´ ì‹¤ì²´ê°€ ì—†ë‹¤."},
  tasks:{tag:"ë¶ˆì•ˆ",text:"ë¨¸ë¦¿ì†ì— ê±¸ë ¤ ìˆëŠ” ê²ƒë“¤ì€ êº¼ë‚´ì•¼ í¬ê¸°ê°€ ë³´ì¸ë‹¤. í•´ì•¼ í•  ì¼ì€ ìƒê° ì†ì—ì„  í•­ìƒ ì‹¤ì œë³´ë‹¤ í¬ê²Œ ëŠê»´ì ¸."},
  avoidance:{tag:"ê°€ì§œ ë³´ìƒ",text:"ëŒë¦°ë‹¤ê³  ì›í•˜ëŠ” ê²Œ ì•„ë‹ ìˆ˜ ìˆë‹¤. ì§ì ‘ í•´ë´¤ì„ ë•Œ ëì´ ì–´ë• ëŠ”ì§€ ê¸°ì–µí•˜ë©´ ë‹µì´ ë‚˜ì˜¨ë‹¤."},
  anxiety:{tag:"ë¶ˆì•ˆ",text:"ê±±ì •ì˜ 99%ëŠ” ì¼ì–´ë‚˜ì§€ ì•ŠëŠ”ë‹¤. êº¼ë‚´ë³´ë©´ ìƒê°ë³´ë‹¤ ë‹¨ìˆœí•œ ê²½ìš°ê°€ ë§ì•„."},
  compare:{tag:"ë‚˜ë¥¼ ëŒ€í•˜ëŠ” ë°©ì‹",text:"ë¹„êµí•  ë•Œ ë‚´ê°€ ì™œ ì§€ê¸ˆ ì´ ë…¸ë ¥ì„ í•˜ê³  ìˆëŠ”ì§€ ê·¼ë³¸ì ì¸ ì´ìœ ë¥¼ ë‹¤ì‹œ ë– ì˜¬ë ¤ë´."},
};

// â”€â”€ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let API_KEY=localStorage.getItem('groq_key')||'';
let memos=JSON.parse(localStorage.getItem('memos_v5')||'[]');
let philCards=JSON.parse(localStorage.getItem('phil_cards')||'null')||JSON.parse(JSON.stringify(BASE_PHIL));
let questionSet=JSON.parse(localStorage.getItem('question_set')||'null')||JSON.parse(JSON.stringify(BASE_QUESTIONS));
let aiSettings=JSON.parse(localStorage.getItem('ai_settings')||'{}');
let questions=[],curQ=0,answers={};
let lastResult=null; // ê²°ê³¼ ì €ì¥ìš©

window.onload=()=>{renderMemos();renderResultList();renderApiStatus();loadSavedKey();loadAiSettings();renderPhilEdit();renderQEdit();initRewardData();renderRewards();renderMetricsPanel();initMeTab();renderMeTab();};

// â”€â”€ íƒ­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function goTab(t){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+t).classList.add('active');
  ['me','memo','reward','check','settings'].forEach((n,i)=>{
    if(n===t)document.querySelectorAll('.tab-btn')[i].classList.add('active');
  });
  if(t==='me')renderMeTab();
  if(t==='memo'){renderMemos();renderResultList();renderMetricsPanel();}
  if(t==='reward')renderRewards();
}

// â”€â”€ ë‚˜ íƒ­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let profileData=JSON.parse(localStorage.getItem('profile_data')||'{}');

function initMeTab(){
  profileData=JSON.parse(localStorage.getItem('profile_data')||'{}');
  const nameInp=document.getElementById('meNameInp');
  const tagInp=document.getElementById('meTaglineInp');
  if(nameInp)nameInp.value=profileData.name||'';
  if(tagInp)tagInp.value=profileData.tagline||'';
  if(profileData.avatar){
    const img=document.getElementById('meAvatarImg');
    const canvas=document.getElementById('meAvatarCanvas');
    if(img){img.src=profileData.avatar;img.style.display='block';}
    if(canvas)canvas.style.display='none';
  } else {
    drawMeAvatar(profileData.name||'ë‚˜');
  }
}

function drawMeAvatar(name){
  const canvas=document.getElementById('meAvatarCanvas');
  if(!canvas)return;
  const ctx=canvas.getContext('2d');
  const colors=['#c9a84c','#b8956a','#a07850','#8a6040'];
  const bg=colors[(name.charCodeAt(0)||65)%colors.length];
  ctx.clearRect(0,0,72,72);
  ctx.fillStyle=bg;ctx.beginPath();ctx.arc(36,36,36,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='rgba(255,255,255,.15)';ctx.beginPath();ctx.arc(36,36,36,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#fff';ctx.font='bold 28px Georgia,serif';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText((name||'ë‚˜')[0],36,37);
}

function saveProfileData(){
  profileData.name=document.getElementById('meNameInp').value||'ë‚˜';
  profileData.tagline=document.getElementById('meTaglineInp').value||'';
  localStorage.setItem('profile_data',JSON.stringify(profileData));
  drawMeAvatar(profileData.name);
}

function onAvatarUpload(e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    profileData.avatar=ev.target.result;
    localStorage.setItem('profile_data',JSON.stringify(profileData));
    const img=document.getElementById('meAvatarImg');
    const canvas=document.getElementById('meAvatarCanvas');
    if(img){img.src=ev.target.result;img.style.display='block';}
    if(canvas)canvas.style.display='none';
  };
  reader.readAsDataURL(file);
}

function renderMeTab(){
  profileData=JSON.parse(localStorage.getItem('profile_data')||'{}');
  const results=memos.filter(m=>m.type==='result');
  const checkCount=results.length;

  // ë ˆë²¨ & ì§ì±…
  const lv=Math.max(1,Math.floor(checkCount/5)+1);
  const lvEl=document.getElementById('meLevelBadge');
  if(lvEl)lvEl.textContent=`Lv.${lv}`;
  const titles=['ê´€ì°°ì','ê¸°ë¡ì','íƒìƒ‰ì','ê°ì„±ì','ê·€í™˜ì'];
  const classEl=document.getElementById('meClassTag');
  if(classEl)classEl.textContent=titles[Math.min(Math.floor(checkCount/5),titles.length-1)];

  // ì´ë¦„/íƒœê·¸ë¼ì¸
  const nameInp=document.getElementById('meNameInp');
  const tagInp=document.getElementById('meTaglineInp');
  if(nameInp&&!nameInp.value)nameInp.value=profileData.name||'';
  if(tagInp&&!tagInp.value)tagInp.value=profileData.tagline||'';

  // ì•„ë°”íƒ€
  if(profileData.avatar){
    const img=document.getElementById('meAvatarImg');
    const canvas=document.getElementById('meAvatarCanvas');
    if(img){img.src=profileData.avatar;img.style.display='block';}
    if(canvas)canvas.style.display='none';
  } else {
    drawMeAvatar(profileData.name||'ë‚˜');
  }

  // ìŠ¤íƒ¯
  const statEl=document.getElementById('meStatRow');
  if(statEl){
    const md=JSON.parse(localStorage.getItem('metrics_v1')||'[]');
    const rd=JSON.parse(localStorage.getItem('reward_data')||'{"charge":[],"drain":[]}');
    const td=JSON.parse(localStorage.getItem('todo_items')||'[]');
    statEl.innerHTML=[
      {v:checkCount,l:'ì²´í¬ì¸'},
      {v:td.filter(t=>!t.done).length,l:'í•  ì¼'},
      {v:(rd.charge||[]).length,l:'ì¶©ì „'},
      {v:md.length,l:'ì§€í‘œ'},
    ].map(s=>`<div class="me-stat"><div class="me-stat-v">${s.v}</div><div class="me-stat-l">${s.l}</div></div>`).join('');
  }

  renderMeTodo();
  renderMeMetrics();
  renderMeResults();
  renderMePhil();
}

// â”€â”€ Todo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let todoItems=JSON.parse(localStorage.getItem('todo_items')||'[]');

function saveTodos(){
  localStorage.setItem('todo_items',JSON.stringify(todoItems));
}

function renderMeTodo(){
  const el=document.getElementById('meTodoList');if(!el)return;
  const active=todoItems.filter(t=>!t.done);
  const done=todoItems.filter(t=>t.done);
  const all=[...active,...done];
  if(all.length===0){
    el.innerHTML=`<div class="me-todo-empty">ì§‘ì¤‘í•  ì¼ì´ ì—†ì–´.<br>ì²´í¬ íƒ­ì—ì„œ Taskë¥¼ ì…ë ¥í•˜ë©´<br>ì—¬ê¸° ìë™ìœ¼ë¡œ ì˜¬ë¼ì™€.</div>`;
    return;
  }
  el.innerHTML=all.map((t,i)=>{
    const realIdx=todoItems.indexOf(t);
    const tagClass=t.priority==='high'?'high':t.priority==='mid'?'mid':'low';
    const tagLabel=t.priority==='high'?'í•µì‹¬':t.priority==='mid'?'ì¼ë°˜':'ì—¬ìœ ';
    return `<div class="me-todo-item${t.done?' done':''}" onclick="toggleTodo(${realIdx})">
      <div class="me-todo-check">${t.done?'âœ“':''}</div>
      <div class="me-todo-text">${esc(t.text)}</div>
      ${t.priority?`<span class="me-todo-tag ${tagClass}">${tagLabel}</span>`:''}
      <button class="me-todo-del" onclick="event.stopPropagation();deleteTodo(${realIdx})">Ã—</button>
    </div>`;
  }).join('');
}

function toggleTodo(idx){
  todoItems[idx].done=!todoItems[idx].done;
  saveTodos();
  renderMeTodo();
  // ìŠ¤íƒ¯ ê°±ì‹ 
  const statEl=document.getElementById('meStatRow');
  if(statEl){
    const td=todoItems;
    const activeCount=td.filter(t=>!t.done).length;
    const vEls=statEl.querySelectorAll('.me-stat-v');
    if(vEls[1])vEls[1].textContent=activeCount;
  }
}

function deleteTodo(idx){
  todoItems.splice(idx,1);
  saveTodos();
  renderMeTodo();
}

function openTodoModal(){
  makeModal(`
    <div class="nds-modal-title">í•  ì¼ ì¶”ê°€</div>
    <div class="nds-field">
      <div class="nds-field-label">í•  ì¼</div>
      <input id="todoText" class="nds-inp" placeholder="ì˜¤ëŠ˜ í•´ì•¼ í•  ê²ƒ">
    </div>
    <div class="nds-field">
      <div class="nds-field-label">ìš°ì„ ìˆœìœ„</div>
      <div style="display:flex;gap:8px">
        <button class="ws-opt sel" id="prio-high" onclick="selectPrio('high')">ğŸ”´ í•µì‹¬</button>
        <button class="ws-opt" id="prio-mid" onclick="selectPrio('mid')">ğŸŸ¡ ì¼ë°˜</button>
        <button class="ws-opt" id="prio-low" onclick="selectPrio('low')">ğŸŸ¢ ì—¬ìœ </button>
      </div>
    </div>
    <div class="nds-btn-row">
      <button class="nds-btn-primary" onclick="saveTodoFromModal()">ì¶”ê°€</button>
      <button class="nds-btn-ghost" onclick="this.closest('.nds-modal').remove()">ì·¨ì†Œ</button>
    </div>
  `);
  window._selectedPrio='high';
}

function selectPrio(p){
  window._selectedPrio=p;
  ['high','mid','low'].forEach(k=>{
    const btn=document.getElementById('prio-'+k);
    if(btn)btn.classList.toggle('sel',k===p);
  });
}

function saveTodoFromModal(){
  const text=document.getElementById('todoText')?.value.trim();
  if(!text){showToast('ë‚´ìš©ì„ ì…ë ¥í•´ì¤˜');return;}
  todoItems.unshift({id:Date.now(),text,priority:window._selectedPrio||'mid',done:false,date:new Date().toLocaleDateString('ko-KR')});
  saveTodos();
  document.querySelector('.nds-modal')?.remove();
  renderMeTodo();showToast('ì¶”ê°€ëì–´!');
}

// ì²´í¬ ì›Œí¬ì‹œíŠ¸ì—ì„œ task ê°€ì ¸ì˜¤ê¸°
function importTasksFromWs(wsAns){
  const taskMap=[
    {key:'task1',priority:'high'},
    {key:'task2',priority:'high'},
    {key:'task3',priority:'mid'},
  ];
  let added=0;
  taskMap.forEach(({key,priority})=>{
    const text=(wsAns[key]||'').trim();
    if(!text)return;
    // ì´ë¯¸ ìˆìœ¼ë©´ ì¤‘ë³µ ì¶”ê°€ ì•ˆ í•¨
    if(todoItems.find(t=>t.text===text))return;
    todoItems.unshift({id:Date.now()+Math.random(),text,priority,done:false,date:new Date().toLocaleDateString('ko-KR')});
    added++;
  });
  if(added>0){saveTodos();showToast(`${added}ê°œ í•  ì¼ì´ ë‚˜ íƒ­ì— ì¶”ê°€ëì–´!`);}
}

// â”€â”€ ë‚˜ íƒ­ â€” ë¯¸ë‹ˆ ì§€í‘œ ê·¸ë˜í”„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMeMetrics(){
  const el=document.getElementById('meMiniMetrics');if(!el)return;
  metricsData=JSON.parse(localStorage.getItem('metrics_v1')||'[]');
  if(metricsData.length===0){
    el.innerHTML=`<div class="me-metrics-empty">ì„±ì¥ ì§€í‘œê°€ ì—†ì–´.<br>ê¸°ë¡ íƒ­ â†’ ì„±ì¥ ì§€í‘œì—ì„œ ì¶”ê°€í•´ë´.</div>`;
    return;
  }
  el.innerHTML=metricsData.map((m,i)=>{
    const h=m.history||[];
    const curr=m.current||0;
    const goal=m.goal||0;
    const pct=goal>0?Math.min(100,Math.round((curr/goal)*100)):0;
    const barHtml=h.length>0?renderMeBarChart(h):'';
    return `<div class="me-metric-mini">
      <div class="me-metric-mini-header">
        <span class="me-metric-mini-name">${esc(m.name)}</span>
        <span>
          <span class="me-metric-mini-val">${curr}</span>
          <span class="me-metric-mini-unit">${esc(m.unit)}</span>
          ${goal>0?`<span class="me-metric-mini-goal"> / ${goal}</span>`:''}
        </span>
      </div>
      ${barHtml}
      ${goal>0?`<div class="me-prog-bg"><div class="me-prog-fill" style="width:${pct}%"></div></div>
      <div class="me-prog-info"><span>${esc(m.note||'')}</span><span>${pct}%</span></div>`
      :`<div style="font-size:10px;color:var(--textF)">${esc(m.note||'')}</div>`}
      <div class="me-metric-mini-actions">
        <button class="me-metric-log-btn" onclick="openMetricLogModal(${i})">+ ê¸°ë¡</button>
        <button class="me-metric-edit-btn" onclick="openMetricModal(${i})">í¸ì§‘</button>
      </div>
    </div>`;
  }).join('');
}

function renderMeBarChart(history){
  const vals=history.slice(-10);
  const maxV=Math.max(...vals.map(h=>h.val),0.1);
  const chartH=40; // px
  return `<div class="me-bar-chart">${vals.map(h=>{
    const barH=Math.max(3,Math.round((h.val/maxV)*chartH));
    const d=(h.date||'').replace(/^\d{4}\./,'').replace(/\.$/,'');
    return `<div class="me-bar-col">
      <div class="me-bar-seg" style="height:${barH}px"></div>
      <div class="me-bar-lbl">${d}</div>
    </div>`;
  }).join('')}</div>`;
}

// â”€â”€ ë‚˜ íƒ­ â€” ê²°ê³¼ì§€ ë¯¸ë‹ˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMeResults(){
  const el=document.getElementById('meResultPreview');if(!el)return;
  const results=memos.filter(m=>m.type==='result');
  if(results.length===0){
    el.innerHTML=`<div class="me-metrics-empty">ì €ì¥ëœ ê²°ê³¼ì§€ê°€ ì—†ì–´.<br>ì²´í¬ í›„ ì €ì¥í•´ë´.</div>`;
    return;
  }
  el.innerHTML=results.slice(0,5).map(m=>`
    <div class="me-result-mini" onclick="goTab('memo');setTimeout(()=>switchSeg('seg-results',document.querySelectorAll('.seg-btn')[1]),100)">
      <div class="me-result-mini-date">${m.ts||m.date}</div>
      <div class="me-result-mini-title">${esc((m.short||'').slice(0,50))}${(m.short||'').length>50?'â€¦':''}</div>
    </div>`).join('');
}

// â”€â”€ ë‚˜ íƒ­ â€” ê°€ì¹˜ê´€ ë¯¸ë‹ˆ ê·¸ë¦¬ë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMePhil(){
  const el=document.getElementById('mePhilGrid');if(!el)return;
  el.innerHTML=philCards.map(p=>`
    <div class="me-phil-mini">
      <div class="me-phil-mini-tag">${esc(p.tag)}</div>
      <div class="me-phil-mini-title">${esc(p.title)}</div>
      <div class="me-phil-mini-body">${esc(p.body)}</div>
    </div>`).join('');
}


function switchSeg(id,btn){
  document.querySelectorAll('.seg-panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.seg-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  btn.classList.add('active');
  if(id==='seg-metrics')renderMetricsPanel();
}

// â”€â”€ ì„¤ì • ì„¹ì…˜ í† ê¸€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSection(id){
  const body=document.getElementById(id);
  const arr=document.getElementById('arr-'+id);
  body.classList.toggle('open');
  arr.classList.toggle('open');
}

// â”€â”€ í™ˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPhil(){
  document.getElementById('philList').innerHTML=philCards.map(p=>`
    <div class="phil-card">
      <div class="phil-tag">${p.tag}</div>
      <div class="phil-title">${p.title}</div>
      <div class="phil-body">${p.body}</div>
    </div>`).join('');
}

// â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadSavedKey(){const i=document.getElementById('apiKeyInp');if(i&&API_KEY)i.value=API_KEY;}
function renderApiStatus(){
  const el=document.getElementById('apiStatus');if(!el)return;
  el.innerHTML=API_KEY
    ?`<div class="status-dot ok"></div><span style="color:var(--green)">í‚¤ ì €ì¥ë¨</span>`
    :`<div class="status-dot none"></div><span style="color:var(--textF)">í‚¤ ì—†ìŒ</span>`;
}
function saveApiKey(){
  const v=document.getElementById('apiKeyInp').value.trim();
  if(!v){showToast('í‚¤ë¥¼ ì…ë ¥í•´ì¤˜');return;}
  if(!v.startsWith('gsk_')){showToast('gsk_...ë¡œ ì‹œì‘í•˜ëŠ” í‚¤ë¥¼ ì…ë ¥í•´ì¤˜');return;}
  API_KEY=v;localStorage.setItem('groq_key',v);renderApiStatus();showToast('ì €ì¥ëì–´');
}
async function testApiKey(){
  const inp=document.getElementById('apiKeyInp').value.trim()||API_KEY;
  const resEl=document.getElementById('testResult');resEl.style.display='none';
  if(!inp){showToast('ë¨¼ì € í‚¤ë¥¼ ì…ë ¥í•´ì¤˜');return;}
  showToast('í…ŒìŠ¤íŠ¸ ì¤‘...');
  try{
    const txt=await callAI('ì•ˆë…•. í•œ ë¬¸ì¥ìœ¼ë¡œë§Œ ë‹µí•´ì¤˜.',200,inp);
    resEl.className='test-result ok';resEl.textContent='âœ“ ì—°ê²° ì„±ê³µ: '+txt.trim().slice(0,80);resEl.style.display='block';
  }catch(e){resEl.className='test-result err';resEl.textContent='âœ— ì˜¤ë¥˜: '+e.message;resEl.style.display='block';}
}

// â”€â”€ AI ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadAiSettings(){
  const s=aiSettings;
  const aStyle=document.getElementById('setAnalysisStyle');
  const acStyle=document.getElementById('setActionStyle');
  const extra=document.getElementById('setExtraPrompt');
  if(aStyle&&s.analysisStyle)aStyle.value=s.analysisStyle;
  if(acStyle&&s.actionStyle)acStyle.value=s.actionStyle;
  if(extra&&s.extraPrompt)extra.value=s.extraPrompt;
}
function saveSettings(){
  aiSettings={
    analysisStyle:document.getElementById('setAnalysisStyle')?.value||'pattern',
    actionStyle:document.getElementById('setActionStyle')?.value||'step',
    extraPrompt:document.getElementById('setExtraPrompt')?.value||''
  };
  localStorage.setItem('ai_settings',JSON.stringify(aiSettings));
  if(fbUser)fbSaveAll();
}

// â”€â”€ ê°€ì¹˜ê´€ í¸ì§‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPhilEdit(){
  document.getElementById('philEditList').innerHTML=philCards.map((p,i)=>`
    <div class="phil-edit-item">
      <div class="phil-edit-row">
        <input class="phil-edit-tag" value="${esc(p.tag)}" oninput="philCards[${i}].tag=this.value" placeholder="íƒœê·¸">
        <input class="phil-edit-title" value="${esc(p.title)}" oninput="philCards[${i}].title=this.value" placeholder="ì œëª©">
      </div>
      <textarea class="phil-edit-body" oninput="philCards[${i}].body=this.value" placeholder="ë‚´ìš©">${esc(p.body)}</textarea>
      <button class="phil-edit-del" onclick="delPhilCard(${i})">ì‚­ì œ</button>
    </div>`).join('');
}
function addPhilCard(){
  philCards.push({tag:'ìƒˆ ê°€ì¹˜ê´€',title:'',body:''});
  renderPhilEdit();
}
function delPhilCard(i){philCards.splice(i,1);renderPhilEdit();}
function savePhilCards(){
  localStorage.setItem('phil_cards',JSON.stringify(philCards));
  renderPhil();showToast('ê°€ì¹˜ê´€ ì €ì¥ëì–´');
  if(fbUser)fbSaveAll();
}
function resetPhilCards(){
  philCards=JSON.parse(JSON.stringify(BASE_PHIL));
  localStorage.setItem('phil_cards',JSON.stringify(philCards));
  renderPhil();renderPhilEdit();showToast('ê¸°ë³¸ê°’ìœ¼ë¡œ ë˜ëŒë ¸ì–´');
}

// â”€â”€ ì§ˆë¬¸ í¸ì§‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderQEdit(){
  document.getElementById('qEditList').innerHTML=questionSet.map((q,i)=>`
    <div class="q-edit-item">
      <div class="q-edit-row">
        <input class="q-edit-cat" value="${esc(q.cat)}" oninput="questionSet[${i}].cat=this.value" placeholder="ì¹´í…Œê³ ë¦¬">
        <input class="q-edit-text" value="${esc(q.text)}" oninput="questionSet[${i}].text=this.value" placeholder="ì§ˆë¬¸">
      </div>
      <textarea class="q-edit-sub" oninput="questionSet[${i}].sub=this.value" placeholder="ë³´ì¡° ì„¤ëª…">${esc(q.sub||'')}</textarea>
      <button class="q-edit-del" onclick="delQuestion(${i})">ì‚­ì œ</button>
    </div>`).join('');
}
function addQuestion(){
  questionSet.push({id:'q'+Date.now(),cat:'ìƒˆ ì¹´í…Œê³ ë¦¬',text:'',sub:'',type:'ta'});
  renderQEdit();
}
function delQuestion(i){questionSet.splice(i,1);renderQEdit();}
function saveQuestionSet(){
  localStorage.setItem('question_set',JSON.stringify(questionSet));
  showToast('ì§ˆë¬¸ ì €ì¥ëì–´');
  if(fbUser)fbSaveAll();
}
function resetQuestions(){
  questionSet=JSON.parse(JSON.stringify(BASE_QUESTIONS));
  localStorage.setItem('question_set',JSON.stringify(questionSet));
  renderQEdit();showToast('ê¸°ë³¸ê°’ìœ¼ë¡œ ë˜ëŒë ¸ì–´');
}

// â”€â”€ ë°ì´í„° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function clearAllData(){
  if(!confirm('ëª¨ë“  ê¸°ë¡ì„ ì‚­ì œí• ê¹Œ? ë˜ëŒë¦´ ìˆ˜ ì—†ì–´.'))return;
  localStorage.removeItem('memos_v5');
  memos=[];renderMemos();showToast('ì‚­ì œëì–´');
}

// â”€â”€ ì²´í¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ ì²´í¬ ì›Œí¬ì‹œíŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì›Œí¬ì‹œíŠ¸ í˜ì´ì§€ ì •ì˜
const WS_PAGES=[
  {id:'ws_situation', title:'í˜„ì‹¤ ìƒí™© íŒŒì•…', sub:'ì§€ê¸ˆ ë‚´ í™˜ê²½ê³¼ ë§¥ë½ì„ ì •ë¦¬í•´ë´.', icon:'ğŸ“',
   fields:[
     {key:'relations', label:'ì¸ê°„ê´€ê³„', hint:'ìµœê·¼ ì‹ ê²½ ì“°ì´ëŠ” ê´€ê³„ë‚˜ ìƒí™©', type:'text'},
     {key:'schedule',  label:'ë‹¤ê°€ì˜¤ëŠ” ì¼ì •', hint:'ì´ë²ˆ ì£¼, ì´ë²ˆ ë‹¬ ì£¼ìš” ì¼ì •', type:'text'},
     {key:'money',     label:'ëˆ/ìƒí™œ', hint:'ì¬ì • ìƒíƒœ, ìƒí™œ í™˜ê²½', type:'text'},
     {key:'work',      label:'ì¼/í•™ì—…', hint:'í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ê²ƒ, ë§‰íŒ ê²ƒ', type:'text'},
     {key:'body_env',  label:'ëª¸/í™˜ê²½', hint:'ìˆ˜ë©´, ì‹ì‚¬, ìš´ë™, ê³µê°„ ìƒíƒœ', type:'text'},
   ]
  },
  {id:'ws_state', title:'ì§€ê¸ˆ ë‚´ ìƒíƒœ', sub:'ì§€ê¸ˆ ì´ ìˆœê°„ ë‚˜ì˜ ìƒíƒœë¥¼ ì²´í¬í•´ë´.', icon:'ğŸŒ¡',
   fields:[
     {key:'mood',      label:'ì§€ê¸ˆ ê¸°ë¶„', hint:'', type:'opts', opts:['ì¢‹ì•„','ë³´í†µ','ë³„ë¡œ','ëª¨ë¥´ê² ì–´']},
     {key:'body',      label:'ëª¸ ìƒíƒœ', hint:'', type:'opts', opts:['ê´œì°®ì•„','ì¢€ í”¼ê³¤í•´','í™•ì‹¤íˆ ì•ˆ ì¢‹ì•„']},
     {key:'energy',    label:'ì—ë„ˆì§€ ë ˆë²¨', hint:'', type:'opts', opts:['ì¶©ì „ ì™„ë£Œ','ë°˜ì •ë„','ë°©ì „ ì§ì „']},
     {key:'mind',      label:'ì§€ê¸ˆ ë¨¸ë¦¿ì†', hint:'ì§€ê¸ˆ ë§´ë„ëŠ” ìƒê°, ê±±ì •, ê°ì •ì„ ì§§ê²Œ', type:'text'},
     {key:'avoidance', label:'í”¼í•˜ê³  ìˆëŠ” ê²ƒ', hint:'ì§€ê¸ˆ ì•ˆ í•˜ê³  ìˆëŠ”ë° í•´ì•¼ í•  ê²ƒ, ë¶™ì¡ê³  ìˆëŠ” ê²ƒ', type:'text'},
   ]
  },
  {id:'ws_tasks', title:'ì˜¤ëŠ˜ ì§‘ì¤‘í•  ê²ƒ', sub:'ê°€ì¥ ì¤‘ìš”í•œ ê²ƒë¶€í„° êº¼ë‚´ë´.', icon:'âœ”',
   fields:[
     {key:'task1', label:'í•µì‹¬ Task 1', hint:'ì˜¤ëŠ˜ ë°˜ë“œì‹œ í•´ì•¼ í•˜ëŠ” ê²ƒ', type:'text'},
     {key:'task2', label:'í•µì‹¬ Task 2', hint:'', type:'text'},
     {key:'task3', label:'Task 3', hint:'ì—¬ìœ  ìˆìœ¼ë©´ í•˜ëŠ” ê²ƒ', type:'text'},
     {key:'stuck', label:'ë§‰í˜€ ìˆëŠ” ê²ƒ', hint:'ì–´ë””ì„œ ë©ˆì·„ëŠ”ì§€, ë­ê°€ ë§‰í˜”ëŠ”ì§€', type:'text'},
     {key:'reward_pick', label:'ì§„ì§œ ë³´ìƒìœ¼ë¡œ ë­˜ í•  ê±°ì•¼?', hint:'', type:'reward_pick'},
   ]
  },
  {id:'ws_anxiety', title:'ë¶ˆì•ˆ Â· ë¹„êµ Â· ìì±…', sub:'ë¨¸ë¦¿ì†ì— ë‘ë©´ ê³„ì† ì»¤ì§„ë‹¤. êº¼ë‚´ë´.', icon:'ğŸ’­',
   fields:[
     {key:'anxiety',   label:'ì§€ê¸ˆ ê±±ì •ë˜ëŠ” ê²ƒ', hint:'ì¼ì–´ë‚  ê²ƒ ê°™ì€ ë‚˜ìœ ì¼, ë§‰ì—°í•œ ë¶ˆì•ˆ', type:'text'},
     {key:'compare',   label:'ë¹„êµí•˜ê³  ìˆëŠ” ê²ƒ', hint:'ëˆ„êµ¬ì™€, ë¬´ì—‡ì„ ë¹„êµí•˜ê³  ìˆëŠ”ì§€', type:'text'},
     {key:'self_crit', label:'ìì±…í•˜ê³  ìˆëŠ” ê²ƒ', hint:'ìŠ¤ìŠ¤ë¡œë¥¼ ì–´ë–»ê²Œ ê³µê²©í•˜ê³  ìˆëŠ”ì§€', type:'text'},
     {key:'reality_check', label:'ì‹¤ì œë¡œ ì§€ê¸ˆ ì¼ì–´ë‚˜ê³  ìˆëŠ”ê°€?', hint:'ì•„ë‹ˆë¼ë©´ â€” ì§€ê¸ˆ ë‹¹ì¥ í•  ìˆ˜ ìˆëŠ” ê²ƒ í•œ ê°€ì§€', type:'text'},
   ]
  },
];

let wsAnswers={};
let wsPage=0;

function startCheck(){
  if(!API_KEY){goTab('settings');showToast('ë¨¼ì € API í‚¤ë¥¼ ì„¤ì •í•´ì¤˜');return;}
  wsAnswers={};wsPage=0;
  goTab('check');renderWsPage();
}

function renderWsPage(){
  const page=WS_PAGES[wsPage];
  const isLast=wsPage===WS_PAGES.length-1;
  const pct=Math.round((wsPage/WS_PAGES.length)*100);

  const fieldsHtml=page.fields.map(f=>{
    const val=wsAnswers[f.key]||'';
    if(f.type==='opts'){
      return `<div class="ws-field">
        <div class="ws-field-label">${f.label}</div>
        <div class="ws-opts-row" id="opts_${f.key}">
          ${f.opts.map(o=>`<button class="ws-opt${val===o?' sel':''}"
            onclick="wsSelectOpt('${f.key}','${o.replace(/'/g,"&#39;")}')">${o}</button>`).join('')}
        </div>
      </div>`;
    }
    if(f.type==='reward_pick'){
      const rd=JSON.parse(localStorage.getItem('reward_data')||'{"charge":[],"drain":[]}');
      const charges=rd.charge||[];
      return `<div class="ws-field">
        <div class="ws-field-label">${f.label}</div>
        <div class="ws-field-hint">ì¶©ì „ LISTì—ì„œ ì„ íƒí•´ë´</div>
        ${charges.length===0
          ?`<div class="ws-reward-empty">ë³´ìƒ íƒ­ì—ì„œ ì¶©ì „ í™œë™ì„ ë¨¼ì € ì¶”ê°€í•´ì¤˜</div>`
          :`<div class="ws-opts-row" id="opts_${f.key}">
            ${charges.map(c=>`<button class="ws-opt ws-reward-opt${val===c.name?' sel':''}"
              onclick="wsSelectOpt('${f.key}','${c.name.replace(/'/g,"&#39;")}')">${c.emoji||'ğŸŒ¿'} ${c.name}</button>`).join('')}
          </div>`
        }
      </div>`;
    }
    // text
    return `<div class="ws-field">
      <div class="ws-field-label">${f.label}${f.hint?`<span class="ws-field-hint"> â€” ${f.hint}</span>`:''}</div>
      <input class="ws-inp" id="wsinp_${f.key}" value="${esc(val)}"
        placeholder=""
        oninput="wsAnswers['${f.key}']=this.value">
    </div>`;
  }).join('');

  document.getElementById('checkContent').innerHTML=`
    <div class="ws-wrap">
      <div class="ws-prog-row">
        <div class="ws-prog-bg"><div class="ws-prog-fill" style="width:${pct}%"></div></div>
        <span class="ws-prog-lbl">${wsPage+1} / ${WS_PAGES.length}</span>
      </div>
      <div class="ws-page-header">
        <span class="ws-page-icon">${page.icon}</span>
        <div>
          <div class="ws-page-title">${page.title}</div>
          <div class="ws-page-sub">${page.sub}</div>
        </div>
      </div>
      <div class="ws-fields">${fieldsHtml}</div>
      <div class="ws-nav">
        ${wsPage>0?`<button class="ws-btn-back" onclick="wsPrev()">â† ì´ì „</button>`:''}
        <button class="ws-btn-next" onclick="wsNext()">${isLast?'ê²°ê³¼ ë³´ê¸° â†’':'ë‹¤ìŒ â†’'}</button>
      </div>
    </div>`;
}

function wsSelectOpt(key,val){
  wsAnswers[key]=val;
  // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
  document.querySelectorAll(`#opts_${key} .ws-opt`).forEach(b=>{
    b.classList.toggle('sel', b.textContent.trim()===val||b.getAttribute('onclick')?.includes(val));
  });
}

function wsPrev(){if(wsPage>0){wsPage--;renderWsPage();}}
function wsNext(){
  wsPage++;
  if(wsPage>=WS_PAGES.length){
    todoItems=JSON.parse(localStorage.getItem('todo_items')||'[]');
    importTasksFromWs(wsAnswers);
    showResult();
  }
  else renderWsPage();
}

// êµ¬ë²„ì „ í˜¸í™˜ (renderQ ë“± ì™¸ë¶€ ì°¸ì¡° ë°©ì–´)
function renderQ(){}
function onTaInput(){}
function selectOpt(){}
function prevQ(){wsPrev();}
function nextQ(){wsNext();}



// â”€â”€ ê²°ê³¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showResult(){
  const now=new Date();
  const ts=`${now.getFullYear()}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-result').classList.add('active');
  document.getElementById('resultContent').innerHTML=`
    <div class="res-header">
      <div><h2>ì§€ê¸ˆ ë‚˜ì˜ ìƒíƒœ</h2><div class="res-time">${ts}</div></div>
      <button class="save-result-btn" onclick="saveResult()">ê²°ê³¼ì§€ ì €ì¥</button>
    </div>
    <div class="res-grid">
      <div class="res-col">
        <div class="res-col-head"><div class="res-col-title">ë‚´ê°€ í•œ ë§</div></div>
        <div class="res-col-body" id="col1"></div>
      </div>
      <div class="res-col">
        <div class="res-col-head"><div class="res-col-title">ì§€ê¸ˆ ë‚˜ë¥¼ ì½ì–´ë³´ë©´</div></div>
        <div class="res-col-body"><div id="col2"><div class="spinner" style="margin:8px 0"></div></div></div>
      </div>
      <div class="res-col">
        <div class="res-col-head"><div class="res-col-title">ì§€ê¸ˆ í•„ìš”í•œ ìƒê°ê°•ë ¹</div></div>
        <div class="res-col-body" id="col4"><div class="spinner" style="margin:8px 0"></div></div>
      </div>
      <div class="res-col">
        <div class="res-col-head"><div class="res-col-title">ì§€ê¸ˆ ë‹¹ì¥ í•  ê²ƒ</div></div>
        <div class="res-col-body" id="col3"><div class="spinner" style="margin:8px 0"></div></div>
      </div>
    </div>
    <div class="res-bottom">
      <div class="memo-save-area">
        <div class="memo-save-lbl">ì˜¤ëŠ˜ì˜ ë©”ëª¨</div>
        <div class="memo-save-sub">ì˜¤ëŠ˜ ìƒˆë¡­ê²Œ ì•Œê²Œ ëœ ê²ƒì´ë‚˜ ëŠë‚€ ì .<br>ì´ ê¸°ë¡ì´ ë‹¤ìŒ ë¶„ì„ì— ë°˜ì˜ëœë‹¤.</div>
        <textarea id="resMemoTa" style="min-height:70px;margin-top:4px" placeholder="ì˜¤ëŠ˜ì˜ ê¹¨ë‹¬ìŒ..."></textarea>
        <button class="save-m-btn" onclick="addMemoFromId('resMemoTa')">ê¸°ë¡ì— ì €ì¥</button>
      </div>
      <div class="final-box" style="margin-top:14px">
        <p>ì™„ë²½í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.<br><strong>ì´ê±¸ ì—´ì—ˆë‹¤ëŠ” ê²ƒ ìì²´ê°€ ì´ë¯¸ ëŒì•„ì˜¤ëŠ” ì¤‘ì´ë‹¤.</strong></p>
      </div>
      <button class="restart-btn" style="margin-top:12px" onclick="startCheck()">ì²˜ìŒë¶€í„° ë‹¤ì‹œ</button>
    </div>`;
  renderCol1();
  runAnalysis();
}

function renderCol1(){
  const dotCls=id=>id!=='body'?'warn':(answers[id]==='ê´œì°®ì•„'?'ok':answers[id]==='í™•ì‹¤íˆ ì•ˆ ì¢‹ì•„'?'bad':'warn');
  document.getElementById('col1').innerHTML=questions
    .filter(q=>answers[q.id]&&answers[q.id].trim())
    .map(q=>`<div class="ans-item"><div class="ans-dot-row">
      <div class="dot ${dotCls(q.id)}"></div>
      <div><div class="ans-q">${q.text}</div><div class="ans-v">${answers[q.id]}</div></div>
    </div></div>`).join('');
}

// â”€â”€ AI ë¶„ì„ â€” ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ë™ì  ìƒì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildSYS(){
  const philTxt=philCards.map(p=>`- ${p.tag}: ${p.title} â€” ${p.body}`).join('\n');
  return `ë„ˆëŠ” ì´ ì‚¬ëŒì˜ ìƒíƒœë¥¼ íŒŒì•…í•˜ê³ , ì§€ê¸ˆ í•„ìš”í•œ ê²ƒì„ ì§šì–´ì£¼ëŠ” ì—­í• ì´ë‹¤.
ì´ ì‚¬ëŒì´ ì§ì ‘ ê²½í—˜ìœ¼ë¡œ ì–»ì€ ê°€ì¹˜ê´€ì´ ì•„ë˜ì— ìˆë‹¤. ë°˜ë“œì‹œ ì´ê²ƒì„ ê·¼ê±°ë¡œ, ì´ê²ƒì˜ í‘œí˜„ì„ ì‚´ë ¤ì„œ ë‹µë³€í•˜ë¼.

[ê°€ì¹˜ê´€ ë° ê²½í—˜]
${philTxt}

[ì›ì¹™]
- í•œêµ­ì–´. êµ¬ì–´ì²´. íŠ¹ìˆ˜ë¬¸ì(**,#,*,_) ì ˆëŒ€ ê¸ˆì§€.
- ë°˜ë“œì‹œ ìœ„ ê°€ì¹˜ê´€ì˜ í‘œí˜„ì„ ê·¸ëŒ€ë¡œ ì‚´ë ¤ì„œ ì“¸ ê²ƒ.
- ì¼ë°˜ë¡ ì ì¸ ì‹¬ë¦¬ ì¡°ì–¸ ê¸ˆì§€. ì´ ì‚¬ëŒì´ ì§ì ‘ ê²½í—˜í•œ ê²ƒë§Œ ê·¼ê±°ë¡œ ì‚¼ì„ ê²ƒ.
- í–‰ë™ê°•ë ¹ì€ ì§€ê¸ˆ ë°”ë¡œ ì‹¤í–‰ ê°€ëŠ¥í•œ ê²ƒìœ¼ë¡œ. ì¶”ìƒì  í‘œí˜„ ê¸ˆì§€.
${aiSettings.extraPrompt?`\n[ì¶”ê°€ ì§€ì‹œ]\n${aiSettings.extraPrompt}`:''}`;
}

async function runAnalysis(){
  const ctx=questions.filter(q=>answers[q.id]&&answers[q.id].trim())
    .map(q=>`[${q.text}]\n${answers[q.id]}`).join('\n\n');
  const memCtx=memos.filter(m=>m.type==='memo').length>0
    ?`\n\n[ì´ ì‚¬ëŒì˜ ì´ì „ ê¸°ë¡/ê¹¨ë‹¬ìŒ]\n${memos.filter(m=>m.type==='memo').slice(0,5).map(m=>m.text).join('\n')}`:'';

  // reality/tasks ë‹µë³€ì´ ìˆìœ¼ë©´ íšŒí”¼ ì—°ê²° ë¶„ì„ ê°•í™”
  const hasReality=answers['reality']&&answers['reality'].trim();
  const hasTasks=answers['tasks']&&answers['tasks'].trim();
  const realityInstr=(hasReality||hasTasks)
    ?`\n\nì¤‘ìš” ë¶„ì„ í¬ì¸íŠ¸: ì´ ì‚¬ëŒì´ ë°íŒ í˜„ì‹¤ ìƒí™©ê³¼ í•´ì•¼ í•  ê²ƒë“¤ì„ ë°˜ë“œì‹œ ì°¸ê³ í•˜ë¼. (1) ì§€ê¸ˆ íšŒí”¼í•˜ê³  ìˆëŠ” í–‰ë™ì´ ì´ í• ì¼ë“¤ê³¼ ì—°ê²°ë¼ ìˆëŠ”ì§€ ì§šì–´ë¼. (2) í–‰ë™ê°•ë ¹ì—ëŠ” ì§€ê¸ˆ ì‹¤ì œ í˜„ì‹¤ì—ì„œ ë°”ë¡œ ì‹œì‘í•  ìˆ˜ ìˆëŠ” ê²ƒì„ í¬í•¨ì‹œì¼œë¼. ì¼ë°˜ë¡  ê¸ˆì§€, ì´ ì‚¬ëŒì˜ êµ¬ì²´ì  ìƒí™© ê¸°ë°˜ìœ¼ë¡œ.`
    :'';

  const aStyle=aiSettings.analysisStyle||'pattern';
  const analysisInstr=aStyle==='pattern'
    ?'ë‹µë³€ë“¤ ì‚¬ì´ì˜ íŒ¨í„´Â·ì—°ê²°ê³ ë¦¬Â·ìˆ¨ê²¨ì§„ ë§¥ë½ì„ ì§šì–´ë¼. ë‹¨ìˆœ ìš”ì•½ ê¸ˆì§€.'
    :aStyle==='direct'?'ë³´ì´ëŠ” ê²ƒ ê·¸ëŒ€ë¡œ ì§ì ‘ì ìœ¼ë¡œ ì¨ë¼.'
    :'ë”°ëœ»í•œ í†¤ìœ¼ë¡œ, ì´ ì‚¬ëŒ í¸ì—ì„œ ì¨ë¼.';

  const acStyle=aiSettings.actionStyle||'step';

  // í˜¸ì¶œ 1: ë¶„ì„
  const p1=`ì˜¤ëŠ˜ ìƒíƒœ:\n${ctx}${memCtx}\n\n3~4ë¬¸ì¥ìœ¼ë¡œ ì§€ê¸ˆ ìƒíƒœë¥¼ ì¨ë¼.\nê·œì¹™: ${analysisInstr}${realityInstr} íŠ¹ìˆ˜ë¬¸ì ê¸ˆì§€.`;
  try{
    const t1=await callAI(p1,400);
    document.getElementById('col2').innerHTML=`<div class="analysis-txt">${t1.trim().replace(/[*_#`]/g,'').replace(/\n/g,'<br>')}</div>`;
  }catch(e){
    document.getElementById('col2').innerHTML=`<div class="analysis-txt" style="color:var(--red)">${e.message}</div>`;
  }

  // í˜¸ì¶œ 2+3 ë³‘ë ¬
  const p2=`ì˜¤ëŠ˜ ìƒíƒœ:\n${ctx}${memCtx}\n\nì§€ê¸ˆ ì´ ìƒíƒœì— ë§ëŠ” ìƒê°ê°•ë ¹ 3ê°€ì§€. ì¼ë°˜ë¡  ê¸ˆì§€. ê²½í—˜ìœ¼ë¡œ ì–»ì€ í‘œí˜„ ê·¸ëŒ€ë¡œ.${realityInstr} íŠ¹ìˆ˜ë¬¸ì(**,#,*) ê¸ˆì§€.\nJSON ë°°ì—´ë§Œ ì¶œë ¥:\n[{"tag":"ê°€ì¹˜ê´€ì´ë¦„","content":"í•œë‘ ë¬¸ì¥","reason":"ì§€ê¸ˆ ì™œ í•„ìš”í•œì§€ í•œ ì¤„"},{"tag":"...","content":"...","reason":"..."},{"tag":"...","content":"...","reason":"..."}]`;

  const stepLabels={
    step:['STEP 1 â€” ìƒê° ì „í™˜','STEP 2 â€” ì¦‰ê° í–‰ë™','STEP 3 â€” ìŠµê´€ ì—°ê²°'],
    simple:['','',''],
    why:['WHY','HOW','HABIT']
  };
  const labels=stepLabels[acStyle]||stepLabels.step;
  const actionInstr=acStyle==='step'
    ?`3ê°€ì§€ë¥¼ ìˆœì„œëŒ€ë¡œ ì¨ë¼: (1) ì¸ì§€ ì¬êµ¬ì„± â€” ì§€ê¸ˆ ì™œê³¡ëœ ìƒê°ì„ ë°”ë¡œì¡ëŠ” ê²ƒ, (2) ì¦‰ê° í–‰ë™ â€” ì§€ê¸ˆ ë‹¹ì¥ ëª¸ì„ ì›€ì§ì´ëŠ” ê²ƒ (ì‹¤ì œ í•´ì•¼ í•  ê²ƒê³¼ ì—°ê²°ë˜ë©´ ë” ì¢‹ìŒ), (3) ìŠµê´€ ì—°ê²° â€” ì´ê²ƒì´ ì™œ ì¥ê¸°ì ìœ¼ë¡œ ì—°ê²°ë˜ëŠ”ì§€. 3ê°€ì§€ê°€ ì´ì–´ì§€ëŠ” í•˜ë‚˜ì˜ íë¦„ì´ì–´ì•¼ í•œë‹¤.`
    :acStyle==='simple'?`ì§€ê¸ˆ ë‹¹ì¥ ë°”ë¡œ í•  ìˆ˜ ìˆëŠ” í–‰ë™ 3ê°€ì§€. ì‹¤ì œ í•´ì•¼ í•  ê²ƒë“¤ì´ ìˆë‹¤ë©´ ê·¸ê²ƒê³¼ ì—°ê²°í•´ì„œ. êµ°ë”ë”ê¸° ì—†ì´ ì‹¬í”Œí•˜ê²Œ.`
    :`ê° í–‰ë™ë§ˆë‹¤ ì™œ í•´ì•¼ í•˜ëŠ”ì§€ ì´ìœ ë¥¼ ë¨¼ì € ì œì‹œí•˜ê³ , ê·¸ ë‹¤ìŒ ì–´ë–»ê²Œ í• ì§€ ì¨ë¼. ì‹¤ì œ í˜„ì‹¤ ìƒí™©ê³¼ ì—°ê²°ì§€ì–´ë¼.`;

  const p3=`ì˜¤ëŠ˜ ìƒíƒœ:\n${ctx}${memCtx}\n\n${actionInstr} ì´ ì‚¬ëŒì˜ ê²½í—˜ê³¼ ê°€ì¹˜ê´€ ê¸°ë°˜ìœ¼ë¡œ.${realityInstr} íŠ¹ìˆ˜ë¬¸ì(**,#,*) ê¸ˆì§€.\nJSON ë°°ì—´ë§Œ ì¶œë ¥:\n[{"title":"í–‰ë™ ì´ë¦„","logic":"ê°€ì¹˜ê´€ ê·¼ê±°ì™€ ë…¼ë¦¬ì  ì´ìœ  í•œ ì¤„","how":"ì§€ê¸ˆ ë‹¹ì¥ êµ¬ì²´ì ìœ¼ë¡œ. ë™ì‚¬ë¡œ ì‹œì‘"},{"title":"...","logic":"...","how":"..."},{"title":"...","logic":"...","how":"..."}]`;

  const [r2,r3]=await Promise.allSettled([callAI(p2,700),callAI(p3,700)]);

  // ìƒê°ê°•ë ¹
  try{
    const raw2=(r2.status==='fulfilled'?r2.value:'').replace(/[*_#`]/g,'').replace(/```json|```/g,'').trim();
    const arr2=JSON.parse(raw2.slice(raw2.indexOf('['),raw2.lastIndexOf(']')+1));
    document.getElementById('col4').innerHTML=arr2.map(it=>`<div class="thought-item">
        <div class="thought-tag">${it.tag||''}</div>
        <div class="thought-txt">${it.content||''}</div>
        ${it.reason?`<div class="thought-origin">â†³ ${it.reason}</div>`:''}
      </div>`).join('');
  }catch(e){
    document.getElementById('col4').innerHTML=`<div class="analysis-txt" style="color:var(--red)">ì˜¤ë¥˜: ${r2.reason?.message||e.message}</div>`;
  }

  // í–‰ë™ê°•ë ¹
  try{
    const raw3=(r3.status==='fulfilled'?r3.value:'').replace(/[*_#`]/g,'').replace(/```json|```/g,'').trim();
    const arr3=JSON.parse(raw3.slice(raw3.indexOf('['),raw3.lastIndexOf(']')+1));
    document.getElementById('col3').innerHTML=arr3.map((a,i)=>`<div class="act-card">
        ${labels[i]?`<div class="act-step s${i+1}">${labels[i]}</div>`:''}
        <div class="act-title">${a.title||''}</div>
        ${a.logic?`<div class="act-logic">${a.logic}</div>`:''}
        ${a.how?`<div class="act-how">${a.how}</div>`:''}
      </div>`).join('');
    // lastResult ì €ì¥
    lastResult={ts:new Date().toLocaleString('ko-KR'),answers:{...answers},thoughts:r2.status==='fulfilled'?r2.value:'',actions:r3.status==='fulfilled'?r3.value:''};
  }catch(e){
    document.getElementById('col3').innerHTML=`<div class="analysis-txt" style="color:var(--red)">ì˜¤ë¥˜: ${r3.reason?.message||e.message}</div>`;
  }
}

// saveResult â€” ì•„ë˜ 4ì»¬ëŸ¼ êµ¬ì¡° ë²„ì „ ì‚¬ìš©

// â”€â”€ AI í˜¸ì¶œ (Groq) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function callAI(prompt,maxTokens=800,keyOverride=null){
  const key=keyOverride||API_KEY;
  if(!key)throw new Error('API í‚¤ê°€ ì—†ì–´. ì„¤ì • íƒ­ì—ì„œ ì…ë ¥í•´ì¤˜.');
  const res=await fetch('https://api.groq.com/openai/v1/chat/completions',{
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':`Bearer ${key}`},
    body:JSON.stringify({
      model:'llama-3.3-70b-versatile',
      max_tokens:maxTokens,
      temperature:0.7,
      messages:[{role:'system',content:buildSYS()},{role:'user',content:prompt}]
    })
  });
  const d=await res.json();
  if(d.error)throw new Error(d.error.message||JSON.stringify(d.error));
  return d.choices?.[0]?.message?.content||'';
}

// â”€â”€ ë©”ëª¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addMemoFromId(taId){
  const el=document.getElementById(taId);if(!el||!el.value.trim())return;
  memos=[{id:Date.now(),type:'memo',text:el.value.trim(),date:new Date().toLocaleDateString('ko-KR')},...memos];
  localStorage.setItem('memos_v5',JSON.stringify(memos));
  el.value='';renderMemos();showToast('ì €ì¥ëì–´');
  if(fbUser)fbSaveAll();
}
function deleteMemo(id){
  memos=memos.filter(m=>m.id!==id);
  localStorage.setItem('memos_v5',JSON.stringify(memos));
  renderMemos();renderResultList();
  if(fbUser)fbSaveAll();
}
function renderMemos(){
  const el=document.getElementById('memoList');if(!el)return;
  const notes=memos.filter(m=>m.type==='memo');
  if(notes.length===0){el.innerHTML=`<div class="memo-empty">ì•„ì§ ë©”ëª¨ê°€ ì—†ì–´.<br>ì˜¤ëŠ˜ ê¹¨ë‹¬ì€ ê²ƒ í•œ ì¤„ì´ë¼ë„ ë‚¨ê²¨ë‘ì.</div>`;return;}
  el.innerHTML=notes.map(m=>`<div class="memo-item">
    <div class="memo-date">${m.date}</div>
    <div class="memo-text">${esc(m.text)}</div>
    <button class="memo-del" onclick="deleteMemo(${m.id})">Ã—</button>
  </div>`).join('');
}

function renderResultList(){
  const el=document.getElementById('resultList');if(!el)return;
  const results=memos.filter(m=>m.type==='result');
  if(results.length===0){el.innerHTML=`<div class="memo-empty">ì €ì¥ëœ ê²°ê³¼ì§€ê°€ ì—†ì–´.<br>ì²´í¬ íƒ­ì—ì„œ ê²°ê³¼ì§€ë¥¼ ì €ì¥í•´ë´.</div>`;return;}
  el.innerHTML=results.map(m=>{
    const id='rs_'+m.id;
    const ansHtml=(m.ansData||[]).map(a=>`
      <div class="result-sheet-ans">
        <div class="result-sheet-q">${esc(a.cat||a.text||'')}</div>
        <div class="result-sheet-v">${esc(a.val||'')}</div>
      </div>`).join('') || `<div class="result-sheet-txt">${esc(m.short||m.text||'')}</div>`;
    const col2Html=`<div class="result-sheet-txt">${esc(m.col2||m.analysis||'').replace(/\n/g,'<br>')}</div>`;
    const col4data=m.col4data||[];
    const col3data=m.col3data||[];
    // êµ¬ë²„ì „ í…ìŠ¤íŠ¸ fallback
    const col4Html=col4data.length>0
      ?col4data.map(it=>`<div class="result-sheet-card">
          <div class="result-sheet-card-tag">${esc(it.tag||'')}</div>
          <div class="result-sheet-card-title">${esc(it.title||it.content||'')}</div>
          ${it.reason?`<div class="result-sheet-card-sub">â†³ ${esc(it.reason)}</div>`:''}
        </div>`).join('')
      :`<div class="result-sheet-txt">${esc(m.col4||'')}</div>`;
    const col3Html=col3data.length>0
      ?col3data.map(a=>`<div class="result-sheet-choice">
          <div class="result-sheet-choice-title">${esc(a.title||'')}</div>
          ${a.how?`<div class="result-sheet-choice-how">${esc(a.how)}</div>`:''}
        </div>`).join('')
      :`<div class="result-sheet-txt">${esc(m.col3||m.actions||'')}</div>`;
    return `<div class="result-sheet" id="${id}">
      <div class="result-sheet-header">
        <div>
          <div class="result-sheet-date">${m.ts||m.date}</div>
          <div class="result-sheet-title">${esc((m.short||'').slice(0,45))}${(m.short||'').length>45?'â€¦':''}</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="result-sheet-toggle" onclick="toggleResultSheet('${id}')">ì ‘ê¸° â–²</button>
          <button class="memo-del" style="position:static" onclick="deleteMemo(${m.id})">Ã—</button>
        </div>
      </div>
      <div class="result-sheet-grid" id="${id}_grid">
        <div class="result-sheet-col"><div class="result-sheet-col-head">ë‚´ê°€ í•œ ë§</div>${ansHtml}</div>
        <div class="result-sheet-col"><div class="result-sheet-col-head">ìš”ì•½</div>${col2Html}</div>
        <div class="result-sheet-col"><div class="result-sheet-col-head">êº¼ë‚´ë³¸ ê°€ì¹˜ê´€</div>${col4Html}</div>
        <div class="result-sheet-col"><div class="result-sheet-col-head">í•  ìˆ˜ ìˆëŠ” ê²ƒ</div>${col3Html}</div>
      </div>
    </div>`;
  }).join('');
}

function toggleResultSheet(id){
  const grid=document.getElementById(id+'_grid');
  const btn=document.querySelector('#'+id+' .result-sheet-toggle');
  if(!grid)return;
  const isOpen=grid.style.display!=='none';
  grid.style.display=isOpen?'none':'grid';
  if(btn)btn.textContent=isOpen?'í¼ì¹˜ê¸° â–¼':'ì ‘ê¸° â–²';
}

// â”€â”€ ê²°ê³¼ì§€ ì €ì¥ (4ì»¬ëŸ¼ êµ¬ì¡° ì €ì¥) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveResult(){
  if(!lastResult){showToast('ì €ì¥í•  ê²°ê³¼ê°€ ì—†ì–´');return;}
  const ansData=questions.filter(q=>answers[q.id]&&answers[q.id].trim())
    .map(q=>({text:q.text,cat:q.cat||q.text,val:answers[q.id]}));
  const col2txt=document.getElementById('col2')?.innerText||'';
  const col4raw=lastResult.thoughts||'';
  const col3raw=lastResult.actions||'';
  let col4data=[],col3data=[];
  try{const r=col4raw.replace(/```json|```/g,'').trim();col4data=JSON.parse(r.slice(r.indexOf('['),r.lastIndexOf(']')+1));}catch(e){}
  try{const r=col3raw.replace(/```json|```/g,'').trim();col3data=JSON.parse(r.slice(r.indexOf('['),r.lastIndexOf(']')+1));}catch(e){}
  const short=ansData.map(a=>a.val).join(' / ').slice(0,80);
  memos=[{id:Date.now(),type:'result',date:new Date().toLocaleDateString('ko-KR'),ts:lastResult.ts,short,ansData,col2:col2txt,col4data,col3data},...memos];
  localStorage.setItem('memos_v5',JSON.stringify(memos));
  renderMemos();renderResultList();
  showToast('ê¸°ë¡ íƒ­ì— ì €ì¥ëì–´');
  if(fbUser)fbSaveAll();
}

// â”€â”€ ì„±ì¥ ì§€í‘œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let metricsData=JSON.parse(localStorage.getItem('metrics_v1')||'[]');

function renderMetricsPanel(){
  metricsData=JSON.parse(localStorage.getItem('metrics_v1')||'[]');
  const el=document.getElementById('metricsPanel');if(!el)return;
  if(metricsData.length===0){
    el.innerHTML=`<div class="memo-empty">ë‹¬ë¦¬ê¸° ê±°ë¦¬, ì²´ì¤‘, ìš´ë™ íšŸìˆ˜ ê°™ì€<br>ìˆ«ì ì§€í‘œë¥¼ ì¶”ê°€í•´ë´. ì„±ì¥ì´ ë³´ì—¬.</div>`;
    return;
  }
  el.innerHTML=`<div class="metric-graph-wrap">${metricsData.map((m,i)=>{
    const history=m.history||[];
    const curr=m.current||0;
    const goal=m.goal||0;
    const pct=goal>0?Math.min(100,Math.round((curr/goal)*100)):0;
    // íˆìŠ¤í† ë¦¬ ë°” ì°¨íŠ¸
    const barHtml=history.length>1?renderBarChart(history,m.type):'';
    const goalHtml=goal>0?`
      <div class="metric-progress-wrap" style="margin-top:6px">
        <div class="metric-progress-bg"><div class="metric-progress-fill" style="width:${pct}%"></div></div>
        <div class="metric-progress-pct">${pct}% ë‹¬ì„±</div>
      </div>`:'';
    return `<div class="metric-graph-item" style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px 16px">
      <div class="metric-graph-header">
        <span class="metric-graph-name">${esc(m.name)}</span>
        <span><span class="metric-graph-val">${curr}</span><span class="metric-graph-unit">${esc(m.unit)}</span>${goal>0?`<span class="metric-graph-goal"> / ëª©í‘œ ${goal}${esc(m.unit)}</span>`:''}</span>
      </div>
      ${barHtml}
      ${goalHtml}
      <div class="metric-note-row" style="margin-top:6px">
        <span class="metric-note">${esc(m.note||'')}</span>
        <div style="display:flex;gap:8px">
          <button class="metric-edit-btn" onclick="openMetricLogModal(${i})">+ ê¸°ë¡</button>
          <button class="metric-edit-btn" onclick="openMetricModal(${i})">í¸ì§‘ âœ</button>
        </div>
      </div>
    </div>`;
  }).join('')}</div>`;
}

function renderBarChart(history,type){
  if(!history||history.length<1)return'';
  const vals=history.slice(-8);
  const maxV=Math.max(...vals.map(h=>h.val),0.1);
  return `<div class="metric-bar-chart">${vals.map(h=>{
    const pct=Math.round((h.val/maxV)*100);
    return `<div class="metric-bar-col">
      <div class="metric-bar-fill-wrap">
        <div class="metric-bar-seg neutral-bar" style="height:${Math.max(4,pct)}%"></div>
      </div>
      <div class="metric-bar-lbl">${(h.date||'').slice(5)||''}</div>
    </div>`;
  }).join('')}</div>`;
}

function openMetricModal(editIdx){
  const isEdit=typeof editIdx==='number'&&editIdx>=0;
  const m=isEdit?metricsData[editIdx]:{name:'',unit:'',current:0,goal:0,note:''};
  makeModal(`
    <div class="nds-modal-title">${isEdit?'ì§€í‘œ í¸ì§‘':'ìƒˆ ì§€í‘œ ì¶”ê°€'}</div>
    <div class="nds-field">
      <div class="nds-field-label">ì´ë¦„</div>
      <input id="mName" class="nds-inp" placeholder="ì˜ˆ: ë‹¬ë¦¬ê¸° ê±°ë¦¬, ì²´ì¤‘, ìš´ë™ íšŸìˆ˜" value="${esc(m.name)}">
    </div>
    <div class="nds-field" style="display:flex;gap:10px">
      <div style="flex:1">
        <div class="nds-field-label">ë‹¨ìœ„</div>
        <input id="mUnit" class="nds-inp" placeholder="km, kg, íšŒ" value="${esc(m.unit)}">
      </div>
      <div style="flex:1">
        <div class="nds-field-label">í˜„ì¬ ê°’</div>
        <input id="mCurrent" class="nds-inp" type="number" value="${m.current||0}">
      </div>
      <div style="flex:1">
        <div class="nds-field-label">ëª©í‘œ (0=ì—†ìŒ)</div>
        <input id="mGoal" class="nds-inp" type="number" value="${m.goal||0}">
      </div>
    </div>
    <div class="nds-field">
      <div class="nds-field-label">ë©”ëª¨ (ì„ íƒ)</div>
      <input id="mNote" class="nds-inp" value="${esc(m.note||'')}" placeholder="ì§§ì€ ë©”ëª¨">
    </div>
    <div class="nds-btn-row">
      <button class="nds-btn-primary" onclick="saveMetricItem(${isEdit?editIdx:-1})">ì €ì¥</button>
      ${isEdit?`<button class="nds-btn-danger" onclick="deleteMetricItem(${editIdx})">ì‚­ì œ</button>`:''}
      <button class="nds-btn-ghost" onclick="this.closest('.nds-modal').remove()">ì·¨ì†Œ</button>
    </div>
  `);
}

function openMetricLogModal(idx){
  const m=metricsData[idx];if(!m)return;
  makeModal(`
    <div class="nds-modal-title">${esc(m.name)} ê¸°ë¡</div>
    <div class="nds-field">
      <div class="nds-field-label">ì˜¤ëŠ˜ ê°’ (${esc(m.unit)})</div>
      <input id="logVal" class="nds-inp" type="number" placeholder="ìˆ«ì ì…ë ¥" style="font-size:22px;font-weight:700;text-align:center;color:var(--accent)">
    </div>
    ${m.goal>0?`<div style="font-size:12px;color:var(--textF);text-align:center;margin-top:-4px;margin-bottom:8px">í˜„ì¬ ${m.current}${esc(m.unit)} / ëª©í‘œ ${m.goal}${esc(m.unit)}</div>`:''}
    <div class="nds-btn-row">
      <button class="nds-btn-primary" onclick="saveMetricLog(${idx})">ê¸°ë¡í•˜ê¸°</button>
      <button class="nds-btn-ghost" onclick="this.closest('.nds-modal').remove()">ì·¨ì†Œ</button>
    </div>
  `);
}

function saveMetricItem(editIdx){
  const item={
    name:document.getElementById('mName').value.trim(),
    unit:document.getElementById('mUnit').value.trim(),
    current:parseFloat(document.getElementById('mCurrent').value)||0,
    goal:parseFloat(document.getElementById('mGoal').value)||0,
    note:document.getElementById('mNote').value.trim(),
    history:editIdx>=0?(metricsData[editIdx].history||[]):[]
  };
  if(!item.name){showToast('ì´ë¦„ì„ ì…ë ¥í•´ì¤˜');return;}
  if(editIdx>=0)metricsData[editIdx]=item;
  else metricsData.push(item);
  localStorage.setItem('metrics_v1',JSON.stringify(metricsData));
  document.querySelector('.nds-modal')?.remove();
  renderMetricsPanel();
  if(fbUser)fbSaveAll();
}

function saveMetricLog(idx){
  const val=parseFloat(document.getElementById('logVal').value);
  if(isNaN(val)){showToast('ê°’ì„ ì…ë ¥í•´ì¤˜');return;}
  metricsData[idx].current=val;
  if(!metricsData[idx].history)metricsData[idx].history=[];
  metricsData[idx].history.push({val,date:new Date().toLocaleDateString('ko-KR')});
  if(metricsData[idx].history.length>30)metricsData[idx].history=metricsData[idx].history.slice(-30);
  localStorage.setItem('metrics_v1',JSON.stringify(metricsData));
  document.querySelector('.nds-modal')?.remove();
  renderMetricsPanel();showToast('ê¸°ë¡ëì–´!');
  if(fbUser)fbSaveAll();
}

function deleteMetricItem(idx){
  metricsData.splice(idx,1);
  localStorage.setItem('metrics_v1',JSON.stringify(metricsData));
  document.querySelector('.nds-modal')?.remove();
  renderMetricsPanel();
}

// â”€â”€ ë³´ìƒ íƒ­ â€” ì¶©ì „/ë°©ì „ LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let rewardData={charge:[],drain:[]};

function initRewardData(){
  rewardData=JSON.parse(localStorage.getItem('reward_data')||'{"charge":[],"drain":[]}');
}

function saveRewardData(){
  localStorage.setItem('reward_data',JSON.stringify(rewardData));
  if(fbUser)fbSaveAll();
}

function toggleRewardSec(type){
  const list=document.getElementById(type+'-list');
  const arr=document.getElementById('arr-'+type);
  const isOpen=arr.classList.contains('open');
  list.style.display=isOpen?'none':'block';
  arr.classList.toggle('open');
}

function renderRewards(){
  initRewardData();
  renderRewardList('charge');
  renderRewardList('drain');
}

function renderRewardList(type){
  const items=rewardData[type]||[];
  const el=document.getElementById(type+'-items');if(!el)return;
  if(items.length===0){
    el.innerHTML=`<div class="rw-empty">${type==='charge'
      ?'ì§ì ‘ í•´ë³´ê³  ì¢‹ì•˜ë˜ ê²ƒë“¤ì„ ì¶”ê°€í•´ë´.<br>ì‚°ì±…, ë°˜ì‹ ìš•, ìš´ë™, ì¢‹ì•„í•˜ëŠ” ìŒì•… ë“±.'
      :'ëì´ ì•ˆ ì¢‹ì•˜ë˜ ê²ƒë“¤ì„ ê¸°ë¡í•´ë´.<br>ìœ íŠœë¸Œ ê³¼ë‹¤, ëŠ¦ê²Œê¹Œì§€ ì „ìê¸°ê¸° ë“±.'}</div>`;
    return;
  }
  el.innerHTML=items.map((item,i)=>{
    const logs=item.logs||[];
    const logPanelId=`${type}-log-${i}`;
    const logHtml=logs.length>0
      ?logs.slice(-5).reverse().map((l,li)=>`
        <div class="rw-log-entry">
          <span class="rw-log-date">${l.date||''}</span>
          ${l.photo?`<img class="rw-log-photo" src="${l.photo}" onclick="viewPhoto('${l.photo}')" alt="">`:''}
          <span class="rw-log-note">${esc(l.note||'')}</span>
          <button class="rw-log-del" onclick="event.stopPropagation();deleteRewardLog('${type}',${i},${logs.length-1-li})">Ã—</button>
        </div>`).join('')
      :`<div class="rw-log-empty">ì•„ì§ ê¸°ë¡ì´ ì—†ì–´. ì˜¤ëŠ˜ í•´ë´¤ìœ¼ë©´ ê¸°ë¡í•´ë´.</div>`;
    return `<div class="rw-card ${type}">
      <div class="rw-card-main" onclick="toggleLogPanel('${logPanelId}')">
        <span class="rw-card-emoji">${item.emoji||'Â·'}</span>
        <div class="rw-card-info">
          <div class="rw-card-name">${esc(item.name)}</div>
          ${item.feeling?`<div class="rw-card-feeling">${esc(item.feeling)}</div>`:''}
          ${logs.length>0?`<div class="rw-card-meta">${logs.length}íšŒ ê¸°ë¡ë¨ Â· ë§ˆì§€ë§‰ ${logs[logs.length-1].date||''}</div>`:''}
        </div>
        <div class="rw-card-actions" onclick="event.stopPropagation()">
          <button class="rw-log-btn ${type}" onclick="openRewardLogForm('${type}',${i})">+ ê¸°ë¡</button>
          <button class="rw-del-btn" onclick="deleteRewardItem('${type}',${i})">ì‚­ì œ</button>
        </div>
      </div>
      <div class="rw-log-panel" id="${logPanelId}" style="display:none">
        ${logHtml}
      </div>
    </div>`;
  }).join('');
}

function toggleLogPanel(id){
  const el=document.getElementById(id);if(!el)return;
  el.style.display=el.style.display==='none'?'block':'none';
}

// â”€â”€ ë°”í…€ì‹œíŠ¸ ëª¨ë‹¬ ìƒì„± í—¬í¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function makeModal(innerHtml){
  const modal=document.createElement('div');
  modal.className='nds-modal';
  modal.innerHTML=`<div class="nds-modal-box">
    <div class="nds-modal-handle"></div>
    <div class="nds-modal-inner">${innerHtml}</div>
  </div>`;
  document.body.appendChild(modal);
  modal.addEventListener('click',e=>{if(e.target===modal)modal.remove();});
  setTimeout(()=>modal.querySelector('input,textarea')?.focus(),100);
  return modal;
}

function openRewardModal(type){
  const isCharge=type==='charge';
  makeModal(`
    <div class="nds-modal-title">${isCharge?'ğŸ’™ ì¶©ì „ í™œë™ ì¶”ê°€':'ğŸ”´ ë°©ì „ í™œë™ ì¶”ê°€'}</div>
    <div class="nds-field">
      <div class="nds-field-label">í™œë™ ì´ë¦„</div>
      <input id="rwName" class="nds-inp" placeholder="${isCharge?'ì˜ˆ: ì‚°ì±…, ë°˜ì‹ ìš•, ìš´ë™':'ì˜ˆ: ìœ íŠœë¸Œ ê³¼ë‹¤, ëŠ¦ê²Œê¹Œì§€ í•¸ë“œí°'}">
    </div>
    <div class="nds-field" style="display:flex;gap:10px">
      <div style="flex:0 0 72px">
        <div class="nds-field-label">ì´ëª¨ì§€</div>
        <input id="rwEmoji" class="nds-inp" value="${isCharge?'ğŸŒ¿':'ğŸ“±'}" style="text-align:center;font-size:20px;padding:10px">
      </div>
      <div style="flex:1">
        <div class="nds-field-label">${isCharge?'ì‹¤ì œë¡œ ì–´ë–¤ ëŠë‚Œ?':'ëë‚˜ê³  ì–´ë–¤ ê¸°ë¶„?'}</div>
        <input id="rwFeeling" class="nds-inp" placeholder="${isCharge?'ì˜ˆ: ë¨¸ë¦¬ ë§‘ì•„ì§, ê°œìš´í•¨':'ì˜ˆ: ëˆˆ ì•„í”„ê³  í”¼ê³¤í•¨, í›„íšŒë¨'}">
      </div>
    </div>
    <div class="nds-btn-row">
      <button class="nds-btn-primary ${type}" onclick="saveRewardItem('${type}')">ì¶”ê°€í•˜ê¸°</button>
      <button class="nds-btn-ghost" onclick="this.closest('.nds-modal').remove()">ì·¨ì†Œ</button>
    </div>
  `);
}

function saveRewardItem(type){
  const name=document.getElementById('rwName').value.trim();
  if(!name){showToast('ì´ë¦„ì„ ì…ë ¥í•´ì¤˜');return;}
  rewardData[type].push({
    name,
    emoji:document.getElementById('rwEmoji').value.trim()||(type==='charge'?'ğŸŒ¿':'ğŸ“±'),
    feeling:document.getElementById('rwFeeling').value.trim(),
    logs:[]
  });
  saveRewardData();
  document.querySelector('.nds-modal')?.remove();
  renderRewardList(type);showToast('ì¶”ê°€ëì–´!');
}

function deleteRewardItem(type,idx){
  if(!confirm('ì‚­ì œí• ê¹Œ? ê¸°ë¡ë„ í•¨ê»˜ ì‚¬ë¼ì ¸.'))return;
  rewardData[type].splice(idx,1);
  saveRewardData();renderRewardList(type);
}

function openRewardLogForm(type,idx){
  const item=rewardData[type][idx];if(!item)return;
  const isCharge=type==='charge';
  makeModal(`
    <div class="nds-modal-title">${item.emoji} ${esc(item.name)}</div>
    <div class="nds-field">
      <div class="nds-field-label">${isCharge?'ì˜¤ëŠ˜ ì–´ë• ì–´?':'ì†”ì§í•˜ê²Œ â€” ëë‚˜ê³  ì–´ë• ì–´?'}</div>
      <textarea id="rwLogNote" class="nds-ta" rows="3" placeholder="${isCharge?'ì˜ˆ: 30ë¶„ ì‚°ì±…í–ˆë”ë‹ˆ ë¨¸ë¦¬ê°€ ë§‘ì•„ì§€ê³  ê¸°ë¶„ì´ ì¢‹ì•„ì§':'ì˜ˆ: 2ì‹œê°„ ë´¤ëŠ”ë° ëˆˆ ì•„í”„ê³  ì‹œê°„ ì•„ê¹ë‹¤ëŠ” ìƒê°'}"></textarea>
    </div>
    ${isCharge?`<div class="nds-field">
      <div class="nds-field-label">ì‚¬ì§„ (ì„ íƒ)</div>
      <label class="nds-file-btn">
        ğŸ“· ì‚¬ì§„ ì„ íƒ
        <input type="file" id="rwLogPhoto" accept="image/*" style="display:none" onchange="previewLogPhoto(this)">
      </label>
      <img id="rwLogPhotoPreview" class="nds-photo-preview" alt="">
    </div>`:''}
    <div class="nds-btn-row">
      <button class="nds-btn-primary ${type}" onclick="saveRewardLog('${type}',${idx})">ê¸°ë¡í•˜ê¸°</button>
      <button class="nds-btn-ghost" onclick="this.closest('.nds-modal').remove()">ì·¨ì†Œ</button>
    </div>
  `);
}

function previewLogPhoto(inp){
  if(!inp.files[0])return;
  const prev=document.getElementById('rwLogPhotoPreview');
  const reader=new FileReader();
  reader.onload=e=>{prev.src=e.target.result;prev.style.display='block';};
  reader.readAsDataURL(inp.files[0]);
}

async function saveRewardLog(type,idx){
  const note=document.getElementById('rwLogNote')?.value.trim()||'';
  let photo='';
  const fileEl=document.getElementById('rwLogPhoto');
  if(fileEl&&fileEl.files[0]){
    const file=fileEl.files[0];
    photo=await new Promise(res=>{const r=new FileReader();r.onload=e=>res(e.target.result);r.readAsDataURL(file);});
  }
  if(!rewardData[type][idx].logs)rewardData[type][idx].logs=[];
  rewardData[type][idx].logs.push({note,photo,date:new Date().toLocaleDateString('ko-KR')});
  saveRewardData();
  document.querySelector('.nds-modal')?.remove();
  renderRewardList(type);showToast('ê¸°ë¡ëì–´!');
}

function deleteRewardLog(type,itemIdx,logIdx){
  rewardData[type][itemIdx].logs.splice(logIdx,1);
  saveRewardData();renderRewardList(type);
}

function viewPhoto(src){
  const overlay=document.createElement('div');
  overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:600;display:flex;align-items:center;justify-content:center;cursor:pointer';
  overlay.innerHTML=`<img src="${src}" style="max-width:90vw;max-height:90vh;border-radius:8px">`;
  overlay.onclick=()=>overlay.remove();
  document.body.appendChild(overlay);
}

function exportData(){
  const data={
    version:2,exportedAt:new Date().toISOString(),
    memos,philCards,questionSet,aiSettings,
    rewardData:JSON.parse(localStorage.getItem('reward_data')||'{"charge":[],"drain":[]}'),
    metricsV1:JSON.parse(localStorage.getItem('metrics_v1')||'[]')
  };
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;
  a.download=`ë‚˜ì˜ëŒì•„ì˜¤ëŠ”ì‹œìŠ¤í…œ_ë°±ì—…_${new Date().toLocaleDateString('ko-KR').replace(/\. /g,'-').replace('.','')}.json`;
  a.click();URL.revokeObjectURL(url);showToast('ë‚´ë³´ë‚´ê¸° ì™„ë£Œ!');
}

function importData(e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    try{
      const data=JSON.parse(ev.target.result);
      if(!data.version)throw new Error('ì˜¬ë°”ë¥¸ ë°±ì—… íŒŒì¼ì´ ì•„ë‹ˆì•¼.');
      if(!confirm(`${data.exportedAt?.slice(0,10)||'ì•Œ ìˆ˜ ì—†ëŠ” ë‚ ì§œ'} ë°±ì—…ì„ ë¶ˆëŸ¬ì˜¬ê¹Œ? í˜„ì¬ ë°ì´í„°ëŠ” ë®ì–´ì”Œì›Œì ¸.`))return;
      if(data.memos){memos=data.memos;localStorage.setItem('memos_v5',JSON.stringify(memos));renderMemos();renderResultList();}
      if(data.philCards){philCards=data.philCards;localStorage.setItem('phil_cards',JSON.stringify(philCards));renderPhil();renderPhilEdit();}
      if(data.questionSet){questionSet=data.questionSet;localStorage.setItem('question_set',JSON.stringify(questionSet));renderQEdit();}
      if(data.aiSettings){aiSettings=data.aiSettings;localStorage.setItem('ai_settings',JSON.stringify(aiSettings));loadAiSettings();}
      if(data.rewardData){localStorage.setItem('reward_data',JSON.stringify(data.rewardData));initRewardData();}
      if(data.metricsV1){localStorage.setItem('metrics_v1',JSON.stringify(data.metricsV1));}
      if(fbUser)fbSaveAll();
      showToast('ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ!');
    }catch(err){showToast('ì˜¤ë¥˜: '+err.message);}
  };
  reader.readAsText(file);e.target.value='';
}

// â”€â”€ Firebase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let fbApp=null,fbAuth=null,fbDb=null,fbUser=null;
let fbConfigSaved=JSON.parse(localStorage.getItem('fb_config')||'null');

function saveFbConfig(){
  const apiKey=document.getElementById('fbApiKey').value.trim();
  const authDomain=document.getElementById('fbAuthDomain').value.trim();
  const projectId=document.getElementById('fbProjectId').value.trim();
  if(!apiKey||!authDomain||!projectId){showToast('ì„¸ ì¹¸ ëª¨ë‘ ì…ë ¥í•´ì¤˜');return;}
  fbConfigSaved={apiKey,authDomain,projectId};
  localStorage.setItem('fb_config',JSON.stringify(fbConfigSaved));
  showToast('ì €ì¥ëì–´. Firebase ì—°ê²° ì¤‘...');
  initFirebase();
}

function clearFbConfig(){
  if(!confirm('Firebase ì—°ê²°ì„ í•´ì œí• ê¹Œ? ë°ì´í„°ëŠ” ì´ ê¸°ê¸°ì— ê·¸ëŒ€ë¡œ ë‚¨ì•„.'))return;
  localStorage.removeItem('fb_config');
  fbConfigSaved=null;fbUser=null;fbAuth=null;fbDb=null;fbApp=null;
  setSyncStatus('disconnected');
  document.getElementById('fbStatusArea').style.display='none';
  document.getElementById('fbLoginSection').style.display='none';
  document.getElementById('fbApiKey').value='';
  document.getElementById('fbAuthDomain').value='';
  document.getElementById('fbProjectId').value='';
  showToast('ì—°ê²° í•´ì œëì–´');
}

async function initFirebase(){
  if(!fbConfigSaved)return;
  try{
    // ë™ì ìœ¼ë¡œ Firebase SDK ë¡œë“œ
    if(!window.firebase){
      await loadScript('https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js');
      await loadScript('https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js');
      await loadScript('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js');
    }
    const cfg={...fbConfigSaved,storageBucket:'',messagingSenderId:'',appId:''};
    // ì´ë¯¸ ì•±ì´ ìˆìœ¼ë©´ ì¬ì‚¬ìš©
    try{fbApp=firebase.app();}catch{fbApp=firebase.initializeApp(cfg);}
    fbAuth=firebase.auth();
    fbDb=firebase.firestore();
    setSyncStatus('disconnected');
    document.getElementById('fbLoginSection').style.display='block';
    // ì €ì¥ëœ ì„¤ì •ê°’ í‘œì‹œ
    document.getElementById('fbApiKey').value=fbConfigSaved.apiKey;
    document.getElementById('fbAuthDomain').value=fbConfigSaved.authDomain;
    document.getElementById('fbProjectId').value=fbConfigSaved.projectId;
    fbAuth.onAuthStateChanged(user=>{
      if(user){
        fbUser=user;
        setSyncStatus('connected');
        document.getElementById('fbLoggedUser').textContent=user.email||user.displayName||'ë¡œê·¸ì¸ë¨';
        document.getElementById('fbStatusArea').style.display='block';
        document.getElementById('fbLoginSection').style.display='none';
        document.getElementById('fbUserLabel').textContent=user.email||user.displayName||'';
        fbLoadAll();
      } else {
        fbUser=null;
        setSyncStatus('disconnected');
        document.getElementById('fbStatusArea').style.display='none';
        document.getElementById('fbLoginSection').style.display='block';
        document.getElementById('fbUserLabel').textContent='';
      }
    });
  }catch(err){
    setSyncStatus('error');
    showToast('Firebase ì˜¤ë¥˜: '+err.message);
    console.error(err);
  }
}

function loadScript(src){
  return new Promise((res,rej)=>{
    const s=document.createElement('script');
    s.src=src;s.onload=res;s.onerror=rej;
    document.head.appendChild(s);
  });
}

function setSyncStatus(status){
  const dot=document.getElementById('syncDot');
  const label=document.getElementById('syncStatus');
  if(status==='connected'){
    dot.className='sync-dot connected';
    label.textContent='Firebase ì—°ê²°ë¨ â€” ìë™ ë™ê¸°í™” ì¤‘';
  } else if(status==='syncing'){
    dot.className='sync-dot syncing';
    label.textContent='ë™ê¸°í™” ì¤‘...';
  } else if(status==='error'){
    dot.className='sync-dot error';
    label.textContent='ë™ê¸°í™” ì˜¤ë¥˜ â€” ë¡œì»¬ì—ë§Œ ì €ì¥ë¨';
  } else {
    dot.className='sync-dot';
    label.textContent='Firebase ë¯¸ì—°ê²° â€” ê¸°ê¸° ê°„ ë™ê¸°í™” ì•ˆ ë¨';
  }
}

async function fbGoogleLogin(){
  if(!fbAuth){showToast('ë¨¼ì € Firebase ì„¤ì •ì„ ì €ì¥í•´ì¤˜');return;}
  try{
    const provider=new firebase.auth.GoogleAuthProvider();
    await fbAuth.signInWithPopup(provider);
  }catch(err){showToast('ë¡œê·¸ì¸ ì‹¤íŒ¨: '+err.message);}
}

async function fbLogout(){
  if(!fbAuth)return;
  await fbAuth.signOut();
  showToast('ë¡œê·¸ì•„ì›ƒëì–´');
}

async function fbSaveAll(){
  if(!fbUser||!fbDb)return;
  setSyncStatus('syncing');
  try{
    const uid=fbUser.uid;
    await fbDb.collection('users').doc(uid).set({
      memos:JSON.stringify(memos),
      philCards:JSON.stringify(philCards),
      questionSet:JSON.stringify(questionSet),
      aiSettings:JSON.stringify(aiSettings),
      rewardData:localStorage.getItem('reward_data')||'{"charge":[],"drain":[]}',
      metricsV1:localStorage.getItem('metrics_v1')||'[]',
      updatedAt:firebase.firestore.FieldValue.serverTimestamp()
    });
    setSyncStatus('connected');
  }catch(err){
    setSyncStatus('error');
    console.error('Firebase ì €ì¥ ì˜¤ë¥˜:',err);
  }
}

async function fbLoadAll(){
  if(!fbUser||!fbDb)return;
  setSyncStatus('syncing');
  try{
    const uid=fbUser.uid;
    const doc=await fbDb.collection('users').doc(uid).get();
    if(doc.exists){
      const d=doc.data();
      if(d.memos){memos=JSON.parse(d.memos);localStorage.setItem('memos_v5',d.memos);renderMemos();renderResultList();}
      if(d.philCards){philCards=JSON.parse(d.philCards);localStorage.setItem('phil_cards',d.philCards);renderPhil();renderPhilEdit();}
      if(d.questionSet){questionSet=JSON.parse(d.questionSet);localStorage.setItem('question_set',d.questionSet);renderQEdit();}
      if(d.aiSettings){aiSettings=JSON.parse(d.aiSettings);localStorage.setItem('ai_settings',d.aiSettings);loadAiSettings();}
      if(d.rewardData){localStorage.setItem('reward_data',d.rewardData);initRewardData();}
      if(d.metricsV1){localStorage.setItem('metrics_v1',d.metricsV1);}
    }
    setSyncStatus('connected');
  }catch(err){
    setSyncStatus('error');
    console.error('Firebase ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:',err);
  }
}

async function fbForceSync(){
  if(!fbUser){showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•´');return;}
  await fbSaveAll();
  showToast('ë™ê¸°í™” ì™„ë£Œ!');
}

// Firebase ì €ì¥ í›„í¬: ê¸°ì¡´ localStorage ì €ì¥ í•¨ìˆ˜ë“¤ì— Firebase ì €ì¥ ì¶”ê°€
const _origSaveResult=saveResult;
// memos ë³€ê²½ ì‹œ Firebaseë„ ì €ì¥ (addMemoFromId, deleteMemo, saveResultì— í›…)
const _fbHook=()=>{if(fbUser)fbSaveAll();};

// â”€â”€ window.onload í™•ì¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _origOnload=window.onload;
window.onload=()=>{
  initLock();
  _origOnload&&_origOnload();
  if(fbConfigSaved)initFirebase();
};
function esc(s){return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function showToast(msg){
  const el=document.getElementById('toast');
  el.textContent=msg;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),2200);
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>나의 돌아오는 시스템</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f5f2ed;--surface:#fff;--border:#e0dbd2;
  --accent:#7c5c38;--accentL:#b8956a;--accentDim:#ede7dc;--accentDim2:#f7f3ee;
  --text:#1e1a16;--textDim:#5a5048;--textF:#9e9288;
  --green:#4a7a50;--greenBg:#eaf2eb;--yellow:#7a6030;--red:#8a3a3a;--redBg:#f5eaea;
  --radius:12px;--shadow:0 2px 12px rgba(0,0,0,.07);
}
/* 잠금 화면 */
#lockScreen{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;align-items:center;justify-content:center;}
.lock-box{width:100%;max-width:340px;padding:0 24px;text-align:center;}
.lock-icon{font-size:36px;margin-bottom:20px;}
.lock-title{font-family:Georgia,serif;font-size:22px;font-weight:400;color:var(--text);margin-bottom:8px;}
.lock-sub{font-size:13px;color:var(--textF);margin-bottom:28px;line-height:1.7;}
.lock-inp{width:100%;padding:14px 16px;border:1px solid var(--border);border-radius:var(--radius);font-family:inherit;font-size:16px;background:var(--surface);color:var(--text);text-align:center;letter-spacing:4px;margin-bottom:10px;transition:border-color .2s;}
.lock-inp:focus{outline:none;border-color:var(--accentL);}
.lock-btn{width:100%;padding:15px;background:var(--accent);border:none;color:#fff;font-family:inherit;font-size:15px;border-radius:var(--radius);cursor:pointer;transition:opacity .2s;}
.lock-btn:hover{opacity:.88;}
.lock-err{font-size:13px;color:var(--red);margin-top:10px;min-height:20px;}
body{font-family:-apple-system,'Apple SD Gothic Neo','Noto Sans KR',system-ui,sans-serif;font-weight:300;background:var(--bg);color:var(--text);font-size:15px;min-height:100vh}
.tab-bar{display:flex;border-bottom:1px solid var(--border);background:var(--surface);position:sticky;top:0;z-index:100;box-shadow:0 1px 8px rgba(0,0,0,.06)}
.tab-btn{flex:1;padding:13px 2px;background:none;border:none;border-bottom:2px solid transparent;font-family:inherit;font-size:12px;font-weight:300;color:var(--textF);cursor:pointer;transition:all .2s}
.tab-btn.active{border-bottom-color:var(--accent);color:var(--accent);font-weight:500}
.inner{max-width:540px;margin:0 auto;padding-bottom:80px}
.inner-wide{max-width:1200px;margin:0 auto;padding:0 20px 80px}
.page{display:none}.page.active{display:block}

/* 홈 */
.hero{padding:44px 24px 28px;border-bottom:1px solid var(--border)}
.eyebrow{font-size:10px;letter-spacing:4px;color:var(--accentL);text-transform:uppercase;margin-bottom:14px}
.hero h1{font-family:Georgia,serif;font-size:26px;font-weight:400;line-height:1.5;margin-bottom:22px}
.motto{background:var(--accentDim);border-radius:var(--radius);padding:18px 20px;font-size:14px;color:var(--textDim);line-height:2.2}
.motto strong{color:var(--accent);font-weight:500}
.sec-lbl{font-size:10px;letter-spacing:4px;color:var(--textF);text-transform:uppercase;padding:28px 24px 12px}
.phil-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;padding:0 24px;margin-bottom:24px}
.phil-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px 18px;box-shadow:var(--shadow)}
.phil-tag{font-size:10px;color:var(--accentL);font-weight:600;margin-bottom:5px;letter-spacing:1px;text-transform:uppercase}
.phil-title{font-size:14px;font-weight:500;color:var(--text);margin-bottom:6px;line-height:1.4}
.phil-body{font-size:13px;color:var(--textDim);line-height:1.9}
.start-btn{display:block;margin:0 24px;padding:17px;background:var(--accent);border:none;color:#fff;font-family:inherit;font-size:15px;border-radius:var(--radius);cursor:pointer;text-align:center;width:calc(100% - 48px);transition:opacity .2s}
.start-btn:hover{opacity:.88}

/* 체크 시작 전 — 일정/할일 입력 */
.precheck-wrap{max-width:540px;margin:0 auto;padding:32px 24px 80px}
.precheck-title{font-family:Georgia,serif;font-size:22px;font-weight:400;margin-bottom:6px}
.precheck-sub{font-size:13px;color:var(--textF);line-height:1.75;margin-bottom:28px}
.precheck-section{margin-bottom:20px}
.precheck-lbl{font-size:10px;letter-spacing:3px;color:var(--accentL);text-transform:uppercase;font-weight:600;margin-bottom:10px}
.precheck-lbl-sub{font-size:12px;color:var(--textF);margin-bottom:8px;line-height:1.6;font-weight:300;letter-spacing:0;text-transform:none}
.task-list{display:flex;flex-direction:column;gap:7px;margin-bottom:8px}
.task-item{display:flex;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
.task-item input[type=text]{flex:1;border:none;background:transparent;font-family:inherit;font-size:13px;color:var(--text);outline:none}
.task-item input[type=text]::placeholder{color:var(--textF)}
.task-urgency{padding:4px 8px;border:1px solid var(--border);border-radius:6px;font-family:inherit;font-size:11px;background:var(--bg);color:var(--textDim);cursor:pointer}
.task-del{background:none;border:none;color:var(--textF);font-size:16px;cursor:pointer;padding:0 2px;flex-shrink:0}
.task-add-btn{padding:8px 14px;background:var(--accentDim);border:1px solid var(--accentL);color:var(--accent);font-family:inherit;font-size:12px;border-radius:8px;cursor:pointer}
.precheck-skip{font-size:12px;color:var(--textF);text-align:center;margin-top:16px;cursor:pointer;text-decoration:underline}

/* 결과 col1에 일정 표시 */
.schedule-block{margin-top:10px;padding-top:10px;border-top:1px solid var(--border)}
.schedule-lbl{font-size:10px;color:var(--textF);margin-bottom:6px;letter-spacing:1px;text-transform:uppercase}
.schedule-item{display:flex;align-items:flex-start;gap:7px;margin-bottom:5px;font-size:13px;color:var(--textDim);line-height:1.6}
.urgency-badge{font-size:10px;padding:1px 6px;border-radius:10px;flex-shrink:0;margin-top:2px}
.urgency-badge.high{background:#fce8e8;color:var(--red)}
.urgency-badge.mid{background:#fef3e2;color:#8a5a00}
.urgency-badge.low{background:var(--greenBg);color:var(--green)}
.q-header{padding:28px 24px 0}
.prog-row{display:flex;align-items:center;gap:12px;margin-bottom:24px}
.prog-bar{flex:1;height:3px;background:var(--border);border-radius:2px;overflow:hidden}
.prog-fill{height:100%;background:var(--accent);transition:width .5s cubic-bezier(.4,0,.2,1)}
.prog-lbl{font-size:11px;color:var(--textF);white-space:nowrap}
.q-cat{font-size:10px;color:var(--accentL);letter-spacing:3px;text-transform:uppercase;margin-bottom:8px;font-weight:600}
.q-text{font-family:Georgia,serif;font-size:21px;font-weight:400;line-height:1.5;margin-bottom:8px}
.q-sub{font-size:12px;color:var(--textF);line-height:1.9;margin-bottom:20px}
.opts{padding:0 24px;display:flex;flex-direction:column;gap:9px;margin-bottom:12px}
.opt-btn{padding:14px 17px;background:var(--surface);border:1px solid var(--border);color:var(--textDim);font-family:inherit;font-size:14px;font-weight:300;cursor:pointer;border-radius:var(--radius);text-align:left;transition:all .2s}
.opt-btn:hover{border-color:var(--accentL)}
.opt-btn.selected{background:var(--accentDim);border-color:var(--accent);color:var(--accent);font-weight:500}
.ta-wrap{padding:0 24px;margin-bottom:12px}
textarea{width:100%;background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:14px;font-weight:300;padding:14px 16px;resize:none;min-height:110px;border-radius:var(--radius);line-height:1.9;transition:border-color .2s}
textarea:focus{outline:none;border-color:var(--accentL)}
.insight-box{margin:0 24px 14px;border-radius:var(--radius);border:1px solid var(--border);overflow:hidden}
.insight-row{display:flex}
.insight-tag{background:var(--accentDim);padding:12px 14px;font-size:10px;color:var(--accent);font-weight:600;letter-spacing:1px;text-transform:uppercase;white-space:nowrap;border-right:1px solid var(--border);display:flex;align-items:center;writing-mode:vertical-rl}
.insight-txt{padding:12px 15px;font-size:13px;color:var(--textDim);line-height:1.9;flex:1}
.nav-row{display:flex;gap:10px;padding:14px 24px 0}
.btn-next{flex:1;padding:16px;background:var(--accent);border:none;color:#fff;font-family:inherit;font-size:14px;border-radius:var(--radius);cursor:pointer;transition:opacity .2s}
.btn-next:disabled{opacity:.35;cursor:not-allowed}
.btn-back{padding:16px 18px;background:var(--surface);border:1px solid var(--border);color:var(--textF);font-family:inherit;font-size:14px;cursor:pointer;border-radius:var(--radius)}
.loading-wrap{padding:70px 24px;text-align:center}
.spinner{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 14px}
.loading-txt{font-size:13px;color:var(--textF);line-height:1.9}
@keyframes spin{to{transform:rotate(360deg)}}

/* 결과 — 4단 */
.res-header{padding:32px 0 20px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px}
.res-header h2{font-family:Georgia,serif;font-size:24px;font-weight:400}
.res-time{font-size:12px;color:var(--textF);margin-top:3px}
.save-result-btn{padding:10px 18px;background:var(--accent);border:none;color:#fff;font-family:inherit;font-size:13px;border-radius:10px;cursor:pointer;transition:opacity .2s;white-space:nowrap}
.save-result-btn:hover{opacity:.85}
.res-grid{display:grid;grid-template-columns:1.6fr 1fr;gap:0;align-items:stretch;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow)}
@media(max-width:700px){.res-grid{grid-template-columns:1fr}}
.res-col{background:var(--surface);overflow:hidden;border-right:1px solid var(--border);display:flex;flex-direction:column}
.res-col:last-child{border-right:none}
.res-col-head{padding:12px 18px;border-bottom:1px solid var(--border);background:var(--accentDim2)}
.res-col-title{font-size:10px;letter-spacing:2.5px;color:var(--accent);text-transform:uppercase;font-weight:600}
.res-col-body{padding:18px;flex:1;overflow-y:auto}
.ans-item{margin-bottom:13px;padding-bottom:13px;border-bottom:1px solid var(--border)}
.ans-item:last-child{margin:0;padding:0;border:none}
.ans-q{font-size:11px;color:var(--textF);margin-bottom:4px}
.ans-dot-row{display:flex;align-items:flex-start;gap:8px}
.dot{width:7px;height:7px;border-radius:50%;margin-top:5px;flex-shrink:0}
.dot.ok{background:var(--green)}.dot.warn{background:var(--yellow)}.dot.bad{background:var(--red)}
.ans-v{font-size:13px;color:var(--text);line-height:1.8;white-space:pre-wrap}
.analysis-txt{font-size:13px;color:var(--textDim);line-height:2.1}

/* 행동강령 — 3단계 연결 구조 */
.act-card{margin-bottom:13px;padding-bottom:13px;border-bottom:1px solid var(--border)}
.act-card:last-child{margin:0;padding:0;border:none}
.act-step{font-size:9px;letter-spacing:2px;text-transform:uppercase;font-weight:700;margin-bottom:5px;padding:3px 8px;border-radius:20px;display:inline-block}
.act-step.s1{background:#e8f0fe;color:#3c5a9a}
.act-step.s2{background:#e8f4ea;color:#2d6a35}
.act-step.s3{background:#fef3e2;color:#8a5a00}
.act-title{font-size:14px;font-weight:500;color:var(--text);line-height:1.4;margin-bottom:5px}
.act-logic{font-size:12px;color:var(--accentL);line-height:1.7;margin-bottom:5px;font-style:italic}
.act-how{font-size:13px;color:var(--textDim);line-height:1.8;background:var(--accentDim2);padding:8px 12px;border-radius:8px}

/* 생각강령 */
.thought-item{margin-bottom:13px;padding-bottom:13px;border-bottom:1px solid var(--border)}
.thought-item:last-child{margin:0;padding:0;border:none}
.thought-tag{font-size:10px;color:var(--accentL);font-weight:600;letter-spacing:1px;text-transform:uppercase;margin-bottom:5px}
.thought-txt{font-size:13px;color:var(--textDim);line-height:1.9;margin-bottom:4px}
.thought-origin{font-size:11px;color:var(--textF);font-style:italic;line-height:1.6}

/* 결과 하단 */
.res-bottom{margin-top:16px}
.memo-save-area{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:14px}
.memo-save-lbl{font-size:10px;letter-spacing:2px;color:var(--accent);text-transform:uppercase;font-weight:600;margin-bottom:8px}
.memo-save-sub{font-size:13px;color:var(--textDim);margin-bottom:10px;line-height:1.75}
.save-m-btn{padding:11px 18px;background:var(--accentDim);border:1px solid var(--accentL);color:var(--accent);font-family:inherit;font-size:13px;font-weight:500;border-radius:10px;cursor:pointer;margin-top:10px}
.final-box{background:var(--accentDim);border-radius:var(--radius);padding:22px;text-align:center;margin-bottom:14px}
.final-box p{font-family:Georgia,serif;font-size:15px;color:var(--textDim);line-height:2.3}
.final-box strong{color:var(--accent)}
.restart-btn{display:block;padding:15px;background:transparent;border:1px solid var(--border);color:var(--textF);font-family:inherit;font-size:13px;cursor:pointer;border-radius:var(--radius);text-align:center;width:100%}
.restart-btn:hover{border-color:var(--accentL)}

/* 기록 */
.memo-h{padding:28px 24px 18px;border-bottom:1px solid var(--border)}
.memo-h h2{font-family:Georgia,serif;font-size:21px;font-weight:400;margin-bottom:5px}
.memo-sub{font-size:12px;color:var(--textF);line-height:1.75}
.memo-add{padding:18px 24px;border-bottom:1px solid var(--border)}
.memo-add-btn{padding:11px 18px;background:var(--accent);border:none;color:#fff;font-family:inherit;font-size:13px;border-radius:10px;cursor:pointer;margin-top:10px}
.memo-list{padding:16px 24px}
.memo-empty{font-size:13px;color:var(--textF);text-align:center;padding:48px 0;line-height:2.2}
.memo-item{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;margin-bottom:9px;position:relative}
.memo-item.result-item{border-left:3px solid var(--accent)}
.memo-date{font-size:11px;color:var(--textF);margin-bottom:5px}
.memo-type{font-size:10px;color:var(--accentL);font-weight:600;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px}
.memo-text{font-size:13px;color:var(--textDim);line-height:1.85;padding-right:28px;white-space:pre-wrap}
.memo-del{position:absolute;top:12px;right:14px;background:none;border:none;color:var(--textF);font-size:17px;cursor:pointer}
.memo-expand-btn{font-size:12px;color:var(--accentL);background:none;border:none;cursor:pointer;margin-top:6px;padding:0;font-family:inherit}

/* 설정 */
.settings-wrap{padding:24px}
.settings-title{font-family:Georgia,serif;font-size:20px;font-weight:400;margin-bottom:6px}
.settings-sub{font-size:13px;color:var(--textF);line-height:1.7;margin-bottom:24px}
.set-section{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:14px;overflow:hidden}
.set-section-head{padding:14px 18px;border-bottom:1px solid var(--border);background:var(--accentDim2);display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none}
.set-section-title{font-size:11px;letter-spacing:2px;color:var(--accent);text-transform:uppercase;font-weight:600}
.set-section-arrow{font-size:12px;color:var(--textF);transition:transform .2s}
.set-section-arrow.open{transform:rotate(180deg)}
.set-section-body{padding:18px;display:none}
.set-section-body.open{display:block}
.setting-lbl{font-size:11px;color:var(--textDim);font-weight:500;margin-bottom:8px;margin-top:16px;letter-spacing:.5px}
.setting-lbl:first-child{margin-top:0}
.setting-inp{width:100%;padding:11px 13px;border:1px solid var(--border);border-radius:10px;font-family:inherit;font-size:13px;background:var(--bg);color:var(--text);transition:border-color .2s}
.setting-inp:focus{outline:none;border-color:var(--accentL)}
.setting-ta{width:100%;padding:11px 13px;border:1px solid var(--border);border-radius:10px;font-family:inherit;font-size:13px;background:var(--bg);color:var(--text);resize:none;line-height:1.8;min-height:80px}
.setting-ta:focus{outline:none;border-color:var(--accentL)}
.setting-hint{font-size:12px;color:var(--textF);margin-top:5px;line-height:1.6}
.setting-hint a{color:var(--accentL);text-decoration:none}
.api-status{display:flex;align-items:center;gap:8px;margin-top:8px;font-size:12px}
.status-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.status-dot.ok{background:var(--green)}.status-dot.none{background:var(--textF)}
.btn-row{display:flex;gap:10px;margin-top:12px}
.btn-primary{flex:1;padding:11px;background:var(--accent);border:none;color:#fff;font-family:inherit;font-size:13px;border-radius:10px;cursor:pointer}
.btn-secondary{padding:11px 16px;background:var(--surface);border:1px solid var(--border);color:var(--textDim);font-family:inherit;font-size:13px;border-radius:10px;cursor:pointer}
.btn-ghost{padding:11px 16px;background:transparent;border:1px solid var(--border);color:var(--textF);font-family:inherit;font-size:13px;border-radius:10px;cursor:pointer}
.test-result{margin-top:10px;padding:11px 14px;border-radius:8px;font-size:13px;line-height:1.7;display:none}
.test-result.ok{background:var(--greenBg);color:#2d5a33}.test-result.err{background:var(--redBg);color:#6b2020}
.divider{height:1px;background:var(--border);margin:16px 0}
.danger-btn{padding:11px 16px;background:transparent;border:1px solid #d0a0a0;color:var(--red);font-family:inherit;font-size:13px;border-radius:10px;cursor:pointer}
.phil-edit-item{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:10px}
.phil-edit-row{display:flex;gap:8px;margin-bottom:8px}
.phil-edit-tag{width:110px;flex-shrink:0;padding:9px 10px;border:1px solid var(--border);border-radius:8px;font-family:inherit;font-size:12px;background:var(--surface);color:var(--accent)}
.phil-edit-title{flex:1;padding:9px 10px;border:1px solid var(--border);border-radius:8px;font-family:inherit;font-size:13px;background:var(--surface);color:var(--text)}
.phil-edit-body{width:100%;padding:9px 10px;border:1px solid var(--border);border-radius:8px;font-family:inherit;font-size:12px;background:var(--surface);color:var(--textDim);resize:none;min-height:70px;line-height:1.8}
.phil-edit-del{padding:6px 10px;background:transparent;border:1px solid #d0a0a0;color:var(--red);font-family:inherit;font-size:12px;border-radius:8px;cursor:pointer;margin-top:6px}
.q-edit-item{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:10px}
.q-edit-row{display:flex;gap:8px;margin-bottom:8px;align-items:center}
.q-edit-cat{width:90px;flex-shrink:0;padding:9px 10px;border:1px solid var(--border);border-radius:8px;font-family:inherit;font-size:12px;background:var(--surface);color:var(--accent)}
.q-edit-text{flex:1;padding:9px 10px;border:1px solid var(--border);border-radius:8px;font-family:inherit;font-size:13px;background:var(--surface);color:var(--text)}
.q-edit-sub{width:100%;padding:9px 10px;border:1px solid var(--border);border-radius:8px;font-family:inherit;font-size:12px;background:var(--surface);color:var(--textDim);resize:none;min-height:50px;line-height:1.7}
.sel{padding:9px 10px;border:1px solid var(--border);border-radius:8px;font-family:inherit;font-size:12px;background:var(--surface);color:var(--textDim)}
.q-edit-del{padding:6px 10px;background:transparent;border:1px solid #d0a0a0;color:var(--red);font-family:inherit;font-size:12px;border-radius:8px;cursor:pointer;margin-top:6px}
.add-item-btn{padding:10px 16px;background:var(--accentDim);border:1px solid var(--accentL);color:var(--accent);font-family:inherit;font-size:13px;border-radius:10px;cursor:pointer;margin-top:4px}

.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%);background:var(--text);color:#fff;font-size:13px;padding:11px 22px;border-radius:22px;z-index:999;opacity:0;transition:opacity .25s;pointer-events:none;white-space:nowrap}
.toast.show{opacity:1}
.sync-bar{display:flex;align-items:center;gap:8px;padding:8px 16px;background:var(--accentDim);border-bottom:1px solid var(--border);font-size:12px;color:var(--textDim)}
.sync-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;background:var(--textF)}
.sync-dot.connected{background:var(--green)}
.sync-dot.syncing{background:var(--yellow);animation:pulse 1s infinite}
.sync-dot.error{background:var(--red)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.firebase-user{margin-left:auto;font-size:11px;color:var(--textF)}
.fb-login-btn{padding:9px 16px;background:var(--surface);border:1px solid var(--border);color:var(--textDim);font-family:inherit;font-size:13px;border-radius:10px;cursor:pointer;width:100%;margin-bottom:8px;text-align:left;display:flex;align-items:center;gap:10px}
.fb-login-btn:hover{border-color:var(--accentL)}
.fb-login-btn svg{flex-shrink:0}
.btn-danger-outline{padding:11px 16px;background:transparent;border:1px solid #d0a0a0;color:var(--red);font-family:inherit;font-size:13px;border-radius:10px;cursor:pointer}
.export-import-row{display:flex;gap:10px;margin-top:8px}

/* ── 세그먼트 컨트롤 (기록 탭 상단) ─────────────────────── */
.seg-ctrl{display:flex;background:var(--accentDim);border-radius:10px;padding:3px;gap:2px;margin:16px 24px}
.seg-btn{flex:1;padding:8px;background:transparent;border:none;font-family:inherit;font-size:13px;color:var(--textF);cursor:pointer;border-radius:8px;transition:all .2s;font-weight:400}
.seg-btn.active{background:var(--surface);color:var(--accent);font-weight:500;box-shadow:0 1px 4px rgba(0,0,0,.1)}
.seg-panel{display:none}.seg-panel.active{display:block}

/* ── 보상 탭 ─────────────────────────────────────────────── */
.reward-wrap{max-width:640px;margin:0 auto;padding-bottom:80px}
.reward-header{padding:24px 20px 0}
.reward-header h2{font-family:Georgia,serif;font-size:20px;font-weight:400;margin-bottom:4px}
.reward-sub{font-size:12px;color:var(--textF);line-height:1.7;margin-bottom:0}

/* 충전/방전 섹션 헤더 */
.reward-section{margin:16px 0}
.reward-sec-head{
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 20px;cursor:pointer;user-select:none;
  border-radius:12px 12px 0 0;
}
.reward-sec-head.charge{background:linear-gradient(135deg,#e8f4ec,#d4edda);border:1px solid #b8ddc2;border-bottom:none}
.reward-sec-head.drain{background:linear-gradient(135deg,#fdecea,#fad5d2);border:1px solid #f0b8b4;border-bottom:none}
.reward-sec-icon{font-size:18px;margin-right:8px}
.reward-sec-title{font-size:14px;font-weight:600;color:var(--text);flex:1}
.reward-sec-count{font-size:11px;color:var(--textF);margin-right:10px}
.reward-add-btn{
  padding:5px 12px;border:none;font-family:inherit;font-size:12px;
  border-radius:8px;cursor:pointer;font-weight:500;transition:all .15s;
}
.reward-add-btn.charge{background:#4a7a50;color:#fff}
.reward-add-btn.drain{background:#8a3a3a;color:#fff}
.reward-add-btn:hover{opacity:.85}
.reward-sec-arrow{font-size:11px;color:var(--textF);margin-left:8px;transition:transform .2s}
.reward-sec-arrow.open{transform:rotate(180deg)}

/* 리스트 컨테이너 */
.reward-list{
  border:1px solid;border-top:none;border-radius:0 0 12px 12px;
  overflow:hidden;
}
.reward-list.charge{border-color:#b8ddc2;background:#f8fdf9}
.reward-list.drain{border-color:#f0b8b4;background:#fdf8f8}

/* 리스트 헤더 */
.reward-list-header{
  display:grid;padding:8px 14px;
  border-bottom:1px solid;font-size:10px;letter-spacing:1.5px;
  text-transform:uppercase;font-weight:600;
}
.reward-list-header.charge{color:#3a6040;border-color:#b8ddc2;grid-template-columns:1fr 2fr 80px}
.reward-list-header.drain{color:#7a2828;border-color:#f0b8b4;grid-template-columns:1fr 2fr 80px}

/* 리스트 아이템 */
.reward-item{
  display:grid;align-items:start;padding:12px 14px;
  border-bottom:1px solid;cursor:pointer;transition:background .15s;
}
.reward-item.charge{border-color:#d4edda;grid-template-columns:1fr 2fr 80px}
.reward-item.charge:hover{background:rgba(74,122,80,.05)}
.reward-item.drain{border-color:#fad5d2;grid-template-columns:1fr 2fr 80px}
.reward-item.drain:hover{background:rgba(138,58,58,.05)}
.reward-item:last-child{border-bottom:none}
.reward-item-name{display:flex;align-items:center;gap:6px}
.reward-item-emoji{font-size:16px;flex-shrink:0}
.reward-item-label{font-size:13px;font-weight:500;color:var(--text);line-height:1.4}
.reward-item-count{font-size:10px;color:var(--textF);margin-top:2px}
.reward-item-feeling{font-size:12px;color:var(--textDim);line-height:1.6;padding-right:8px}
.reward-item-feeling strong{font-weight:500}
.reward-item-actions{display:flex;flex-direction:column;align-items:flex-end;gap:5px}
.reward-log-btn{
  padding:4px 10px;border:none;font-family:inherit;font-size:11px;
  border-radius:6px;cursor:pointer;white-space:nowrap;font-weight:500;
}
.reward-log-btn.charge{background:#4a7a50;color:#fff}
.reward-log-btn.drain{background:rgba(138,58,58,.12);color:#8a3a3a;border:1px solid #f0b8b4}
.reward-del-btn{background:none;border:none;color:var(--textF);font-size:13px;cursor:pointer;padding:0}

/* 기록 모달 패널 (아이템 클릭 시 아래로 펼쳐짐) */
.reward-log-panel{
  border-top:1px dashed;padding:12px 14px;
  background:rgba(255,255,255,.8);
}
.reward-log-panel.charge{border-color:#b8ddc2}
.reward-log-panel.drain{border-color:#f0b8b4}
.reward-log-list{margin-bottom:8px}
.reward-log-entry{
  display:flex;align-items:flex-start;gap:8px;padding:6px 0;
  border-bottom:1px solid var(--border);font-size:12px;
}
.reward-log-entry:last-child{border-bottom:none}
.reward-log-date{color:var(--textF);white-space:nowrap;flex-shrink:0;padding-top:1px}
.reward-log-note{color:var(--textDim);line-height:1.6;flex:1}
.reward-log-photo{width:40px;height:40px;border-radius:6px;object-fit:cover;flex-shrink:0;cursor:pointer}
.reward-log-del{background:none;border:none;color:var(--textF);font-size:12px;cursor:pointer;flex-shrink:0}
.reward-log-add{display:flex;gap:6px;margin-top:6px}
.reward-log-inp{
  flex:1;padding:7px 10px;border:1px solid var(--border);
  border-radius:8px;font-family:inherit;font-size:12px;
  background:var(--surface);color:var(--text);
}
.reward-log-inp:focus{outline:none;border-color:var(--accentL)}
.reward-log-save{
  padding:7px 12px;border:none;font-family:inherit;font-size:12px;
  border-radius:8px;cursor:pointer;font-weight:500;white-space:nowrap;
}
.reward-log-save.charge{background:#4a7a50;color:#fff}
.reward-log-save.drain{background:#8a3a3a;color:#fff}
.reward-empty{padding:20px;text-align:center;font-size:13px;color:var(--textF)}

/* ── 성장 지표 그래프 ─────────────────────────────────────── */
.metric-graph-wrap{padding:4px 0}
.metric-graph-item{margin-bottom:18px}
.metric-graph-item:last-child{margin-bottom:0}
.metric-graph-header{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:6px}
.metric-graph-name{font-size:13px;font-weight:500;color:var(--text)}
.metric-graph-val{font-size:18px;font-weight:700;color:var(--accent);line-height:1}
.metric-graph-unit{font-size:11px;color:var(--textF);margin-left:2px}
.metric-graph-goal{font-size:11px;color:var(--textF)}
/* 캔버스 기반 스파크라인 */
.metric-sparkline{width:100%;height:36px;display:block;margin-bottom:4px}
/* 막대 기반 히스토리 */
.metric-bar-chart{display:flex;align-items:flex-end;gap:3px;height:40px;margin-bottom:4px}
.metric-bar-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px}
.metric-bar-fill-wrap{width:100%;flex:1;display:flex;align-items:flex-end}
.metric-bar-seg{width:100%;border-radius:2px 2px 0 0;transition:height .5s cubic-bezier(.4,0,.2,1);min-height:2px}
.metric-bar-seg.charge-bar{background:linear-gradient(180deg,#6aaa72,#4a7a50)}
.metric-bar-seg.neutral-bar{background:linear-gradient(180deg,var(--accentL),var(--accent))}
.metric-bar-lbl{font-size:9px;color:var(--textF);white-space:nowrap}
.metric-progress-wrap{position:relative}
.metric-progress-bg{height:6px;background:var(--border);border-radius:3px;overflow:hidden}
.metric-progress-fill{height:100%;background:linear-gradient(90deg,var(--accentL),var(--accent));border-radius:3px;transition:width .8s cubic-bezier(.4,0,.2,1)}
.metric-progress-pct{font-size:11px;color:var(--textF);margin-top:3px;text-align:right}
.metric-note-row{display:flex;justify-content:space-between;align-items:center;margin-top:2px}
.metric-note{font-size:11px;color:var(--textF)}
.metric-edit-btn{background:none;border:none;font-size:11px;color:var(--accentL);cursor:pointer;font-family:inherit;padding:0}

/* ── 결과지 4컬럼 ─────────────────────────────────────── */
.result-sheet{border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:14px;box-shadow:var(--shadow)}
.result-sheet-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--accentDim2);border-bottom:1px solid var(--border);gap:10px}
.result-sheet-date{font-size:11px;color:var(--textF)}
.result-sheet-title{font-family:Georgia,serif;font-size:13px;color:var(--text)}
.result-sheet-toggle{background:none;border:1px solid var(--border);color:var(--textDim);font-family:inherit;font-size:11px;padding:4px 10px;border-radius:6px;cursor:pointer}
.result-sheet-grid{display:grid;grid-template-columns:1.5fr 1fr;gap:0;border-top:1px solid var(--border)}
@media(max-width:600px){.result-sheet-grid{grid-template-columns:1fr}}
.result-sheet-col{padding:14px;border-right:1px solid var(--border)}
.result-sheet-col:last-child{border-right:none}
.result-sheet-col-head{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--accent);font-weight:600;margin-bottom:10px}
.result-sheet-ans{margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.result-sheet-ans:last-child{margin:0;padding:0;border:none}
.result-sheet-q{font-size:10px;color:var(--textF);margin-bottom:3px}
.result-sheet-v{font-size:12px;color:var(--text);line-height:1.7;white-space:pre-wrap}
.result-sheet-txt{font-size:12px;color:var(--textDim);line-height:1.9}
.result-sheet-card{margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.result-sheet-card:last-child{margin:0;padding:0;border:none}
.result-sheet-card-tag{font-size:10px;color:var(--accentL);font-weight:600;margin-bottom:3px}
.result-sheet-card-title{font-size:12px;font-weight:500;color:var(--text);margin-bottom:3px}
.result-sheet-card-sub{font-size:11px;color:var(--textF);line-height:1.6}
.result-sheet-choice{margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.result-sheet-choice:last-child{margin:0;padding:0;border:none}
.result-sheet-choice-title{font-size:12px;font-weight:500;color:var(--text);margin-bottom:3px}
.result-sheet-choice-how{font-size:11px;color:var(--textDim);line-height:1.7;background:var(--accentDim2);padding:6px 8px;border-radius:6px}

/* ── 기록 탭 메모 del 버튼 위치 고정 ─── */
#memoList .memo-item{position:relative}

/* ════════════════════════════════════════
   나 탭 — 와이드 풀화면 레이아웃
════════════════════════════════════════ */

/* 프로필 헤더 */
.me-header{
  background:linear-gradient(160deg,#1e1a16 0%,#2a1f12 60%,#1a1208 100%);
  padding:20px 28px 18px;
}
.me-header-inner{
  max-width:1400px;margin:0 auto;
  display:flex;align-items:center;gap:20px;
}
.me-avatar-zone{position:relative;flex-shrink:0}
.me-avatar-ring{
  width:84px;height:84px;border-radius:50%;
  background:linear-gradient(135deg,#c9a84c,#8a6520);
  padding:3px;cursor:pointer;box-shadow:0 0 20px rgba(201,168,76,.35);
}
.me-avatar-ring canvas,.me-avatar-ring img{border-radius:50%;display:block}
.me-level{
  position:absolute;bottom:-6px;left:50%;transform:translateX(-50%);
  background:#c9a84c;color:#1e1a16;
  font-size:9px;font-weight:700;letter-spacing:1.5px;padding:2px 8px;
  border-radius:20px;white-space:nowrap;
}
.me-identity{flex:1;min-width:0}
.me-class{
  display:inline-block;font-size:10px;letter-spacing:3px;text-transform:uppercase;
  color:#c9a84c;border:1px solid rgba(201,168,76,.3);padding:2px 10px;
  border-radius:20px;margin-bottom:5px;
}
.me-name-inp{
  display:block;width:100%;background:transparent;border:none;outline:none;
  font-family:Georgia,serif;font-size:22px;color:#f5f0e8;margin-bottom:1px;
}
.me-name-inp::placeholder{color:rgba(245,240,232,.25)}
.me-name-inp:focus{border-bottom:1px solid rgba(201,168,76,.4)}
.me-tagline-inp{
  display:block;width:100%;background:transparent;border:none;outline:none;
  font-family:inherit;font-size:12px;color:rgba(245,240,232,.5);resize:none;line-height:1.5;
}
.me-tagline-inp:focus{border-bottom:1px solid rgba(201,168,76,.25)}
.me-stat-row{display:flex;gap:20px;margin-top:10px}
.me-stat{display:flex;flex-direction:column;align-items:center}
.me-stat-v{font-size:16px;font-weight:700;color:#c9a84c;line-height:1}
.me-stat-l{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:rgba(245,240,232,.35);margin-top:2px}
.me-check-btn{
  padding:12px 22px;background:#c9a84c;border:none;
  color:#1e1a16;font-family:inherit;font-size:13px;font-weight:700;
  border-radius:12px;cursor:pointer;flex-shrink:0;transition:opacity .15s;
  letter-spacing:1px;
}
.me-check-btn:hover{opacity:.85}

/* 메인 그리드 */
.me-grid{
  display:grid;
  grid-template-columns:1fr 1.4fr 1fr;
  /* 상단 3칸은 고정 높이, 하단 가치관은 내용 높이 */
  grid-template-rows:calc(100vh - 260px) auto;
  gap:0;
}
@media(max-width:900px){
  .me-grid{grid-template-columns:1fr 1fr;grid-template-rows:auto;}
  .me-phil-card{grid-column:1/-1;}
}
@media(max-width:560px){
  .me-grid{grid-template-columns:1fr;}
}

/* 카드 공통 */
.me-card{
  border-right:1px solid var(--border);
  border-bottom:1px solid var(--border);
  overflow:hidden;
  display:flex;flex-direction:column;
  min-height:0;
}
.me-card:last-child,.me-phil-card{border-right:none}
.me-card-head{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 16px;
  background:var(--accentDim2);border-bottom:1px solid var(--border);
  font-size:11px;font-weight:600;color:var(--accent);letter-spacing:1.5px;
  text-transform:uppercase;flex-shrink:0;
}
.me-card-action{
  background:none;border:1px solid var(--border);color:var(--accent);
  font-family:inherit;font-size:11px;padding:3px 10px;border-radius:6px;cursor:pointer;
}
.me-card-action:hover{background:var(--accentDim)}

/* 가치관 카드 — 하단 전체 너비 */
.me-phil-card{grid-column:1/-1;border-bottom:none;overflow:visible}
.me-phil-mini-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:10px;padding:14px 16px;
}
.me-phil-mini{
  padding:12px 14px;
  border:1px solid var(--border);border-radius:10px;
  background:var(--surface);
}
.me-phil-mini-tag{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--accentL);font-weight:600;margin-bottom:3px}
.me-phil-mini-title{font-size:12px;font-weight:600;color:var(--text);margin-bottom:4px;line-height:1.4}
.me-phil-mini-body{font-size:11px;color:var(--textF);line-height:1.7}

/* Todo 리스트 */
.me-todo-list{flex:1;overflow-y:auto;padding:8px 12px}
.me-todo-item{
  display:flex;align-items:flex-start;gap:10px;padding:9px 10px;
  border-radius:8px;margin-bottom:4px;cursor:pointer;transition:background .1s;
  background:var(--surface);border:1px solid var(--border);
}
.me-todo-item:hover{border-color:var(--accentL)}
.me-todo-item.done{opacity:.45}
.me-todo-check{
  width:18px;height:18px;border-radius:4px;border:2px solid var(--border);
  flex-shrink:0;display:flex;align-items:center;justify-content:center;
  font-size:11px;transition:all .15s;margin-top:1px;
}
.me-todo-item.done .me-todo-check{background:var(--accent);border-color:var(--accent);color:#fff}
.me-todo-text{font-size:13px;color:var(--text);flex:1;line-height:1.5}
.me-todo-item.done .me-todo-text{text-decoration:line-through;color:var(--textF)}
.me-todo-del{background:none;border:none;color:var(--textF);font-size:14px;cursor:pointer;flex-shrink:0;padding:0 2px}
.me-todo-empty{padding:20px;text-align:center;font-size:13px;color:var(--textF);line-height:1.9}
.me-todo-tag{
  font-size:9px;padding:1px 6px;border-radius:10px;flex-shrink:0;margin-top:2px;font-weight:600;
}
.me-todo-tag.high{background:#fce8e8;color:var(--red)}
.me-todo-tag.mid{background:#fef3e2;color:#8a5a00}
.me-todo-tag.low{background:var(--greenBg);color:var(--green)}

/* 성장 지표 미니 */
.me-metrics-list{flex:1;overflow-y:auto;padding:8px 12px;display:flex;flex-direction:column;gap:8px}
.me-metric-mini{
  background:var(--surface);border:1px solid var(--border);
  border-radius:10px;padding:10px 12px;
}
.me-metric-mini-header{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:6px}
.me-metric-mini-name{font-size:12px;font-weight:500;color:var(--text)}
.me-metric-mini-val{font-size:20px;font-weight:800;color:var(--accent);line-height:1}
.me-metric-mini-unit{font-size:10px;color:var(--textF);margin-left:2px}
.me-metric-mini-goal{font-size:10px;color:var(--textF)}
/* 바 차트 */
.me-bar-chart{
  display:flex;align-items:flex-end;gap:3px;
  height:52px;margin-bottom:6px;padding:0 2px;
}
.me-bar-col{
  flex:1;display:flex;flex-direction:column;
  align-items:center;justify-content:flex-end;gap:3px;min-width:0;height:100%;
}
.me-bar-seg{
  width:100%;border-radius:3px 3px 0 0;flex-shrink:0;
  background:linear-gradient(180deg,var(--accentL),var(--accent));
  min-height:3px;
  transition:height .45s cubic-bezier(.4,0,.2,1);
}
.me-bar-lbl{
  font-size:8px;color:var(--textF);flex-shrink:0;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  width:100%;text-align:center;line-height:1;
}
/* 프로그레스 바 */
.me-prog-bg{height:5px;background:var(--border);border-radius:3px;overflow:hidden}
.me-prog-fill{height:100%;background:linear-gradient(90deg,var(--accentL),var(--accent));border-radius:3px;transition:width .8s cubic-bezier(.4,0,.2,1)}
.me-prog-info{display:flex;justify-content:space-between;font-size:10px;color:var(--textF);margin-top:2px}
.me-metric-mini-actions{display:flex;gap:6px;margin-top:6px}
.me-metric-log-btn{
  padding:4px 10px;background:var(--accent);border:none;color:#fff;
  font-family:inherit;font-size:10px;border-radius:6px;cursor:pointer;
}
.me-metric-edit-btn{
  padding:4px 8px;background:none;border:1px solid var(--border);color:var(--textF);
  font-family:inherit;font-size:10px;border-radius:6px;cursor:pointer;
}
.me-metrics-empty{padding:20px;text-align:center;font-size:13px;color:var(--textF);line-height:1.9}

/* 결과지 미니 */
.me-result-list{flex:1;overflow-y:auto;padding:8px 12px;display:flex;flex-direction:column;gap:6px}
.me-result-mini{
  background:var(--surface);border:1px solid var(--border);border-radius:10px;
  padding:10px 12px;cursor:pointer;transition:border-color .15s;
}
.me-result-mini:hover{border-color:var(--accentL)}
.me-result-mini-date{font-size:10px;color:var(--textF);margin-bottom:3px}
.me-result-mini-title{font-size:12px;font-weight:500;color:var(--text);margin-bottom:3px}
.me-result-mini-preview{font-size:11px;color:var(--textDim);line-height:1.6;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
.me-result-empty{padding:20px;text-align:center;font-size:13px;color:var(--textF);line-height:1.9}

/* ════════════════════════════════════════
   보상 탭 — 카드형
════════════════════════════════════════ */
.reward-wrap{max-width:560px;margin:0 auto;padding-bottom:80px}
.reward-page-header{padding:24px 20px 16px}
.reward-page-header h2{font-family:Georgia,serif;font-size:20px;font-weight:400;margin-bottom:4px}
.reward-page-header p{font-size:12px;color:var(--textF);line-height:1.7}

.rw-section{margin-bottom:8px}
.rw-sec-title{
  display:flex;align-items:center;gap:8px;
  padding:12px 20px;
  font-size:13px;font-weight:600;color:var(--text);
}
.rw-sec-title.charge{border-left:3px solid #4a7a50;background:linear-gradient(90deg,#eaf4ed,transparent)}
.rw-sec-title.drain{border-left:3px solid #8a3a3a;background:linear-gradient(90deg,#f5eaea,transparent)}
.rw-sec-sub{font-size:11px;color:var(--textF);font-weight:400;flex:1}
.rw-new-btn{
  padding:5px 12px;border:none;font-family:inherit;font-size:12px;
  border-radius:8px;cursor:pointer;font-weight:500;flex-shrink:0;
}
.rw-new-btn.charge{background:#4a7a50;color:#fff}
.rw-new-btn.drain{background:#8a3a3a;color:#fff}

/* 카드 그리드 */
.rw-cards{padding:0 16px 12px;display:flex;flex-direction:column;gap:8px}

/* 개별 카드 */
.rw-card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:12px;overflow:hidden;box-shadow:0 1px 6px rgba(0,0,0,.05);
}
.rw-card.charge{border-left:3px solid #4a7a50}
.rw-card.drain{border-left:3px solid #c87070}

.rw-card-main{
  display:flex;align-items:center;gap:12px;padding:12px 14px;cursor:pointer;
  transition:background .15s;
}
.rw-card-main:hover{background:var(--accentDim2)}
.rw-card-emoji{font-size:22px;flex-shrink:0;line-height:1}
.rw-card-info{flex:1;min-width:0}
.rw-card-name{font-size:14px;font-weight:500;color:var(--text);margin-bottom:3px}
.rw-card-feeling{font-size:12px;color:var(--textDim);line-height:1.5}
.rw-card-meta{font-size:10px;color:var(--textF);margin-top:3px}
.rw-card-actions{display:flex;gap:6px;flex-shrink:0}
.rw-log-btn{
  padding:6px 12px;border:none;font-family:inherit;font-size:11px;
  border-radius:8px;cursor:pointer;font-weight:500;
}
.rw-log-btn.charge{background:#4a7a50;color:#fff}
.rw-log-btn.drain{background:rgba(138,58,58,.1);color:#8a3a3a;border:1px solid #e8c0c0}
.rw-del-btn{
  background:none;border:1px solid var(--border);color:var(--textF);
  font-size:12px;cursor:pointer;padding:6px 8px;border-radius:8px;
}

/* 로그 패널 */
.rw-log-panel{
  border-top:1px solid var(--border);padding:12px 14px;
  background:var(--accentDim2);
}
.rw-log-empty{font-size:12px;color:var(--textF);margin-bottom:8px}
.rw-log-entry{
  display:flex;align-items:flex-start;gap:8px;padding:6px 0;
  border-bottom:1px solid var(--border);
}
.rw-log-entry:last-child{border-bottom:none}
.rw-log-date{font-size:11px;color:var(--textF);white-space:nowrap;flex-shrink:0;padding-top:1px}
.rw-log-note{font-size:12px;color:var(--textDim);line-height:1.6;flex:1}
.rw-log-photo{width:40px;height:40px;border-radius:6px;object-fit:cover;cursor:pointer;flex-shrink:0}
.rw-log-del{background:none;border:none;color:var(--textF);font-size:13px;cursor:pointer;flex-shrink:0}

.rw-empty{
  padding:24px;text-align:center;font-size:13px;color:var(--textF);
  background:var(--surface);border:1px dashed var(--border);border-radius:12px;line-height:1.8;
}

/* ════════════════════════════════════════
   공통 모달 (바텀시트)
════════════════════════════════════════ */
.nds-modal{
  position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:500;
  display:flex;align-items:flex-end;justify-content:center;
}
.nds-modal-box{
  background:var(--surface);border-radius:20px 20px 0 0;
  padding:0;width:100%;max-width:560px;max-height:88vh;
  overflow-y:auto;box-shadow:0 -4px 24px rgba(0,0,0,.15);
}
.nds-modal-handle{
  width:36px;height:4px;background:var(--border);border-radius:2px;
  margin:12px auto 0;
}
.nds-modal-inner{padding:20px 24px 40px}
.nds-modal-title{
  font-size:16px;font-weight:600;color:var(--text);
  margin-bottom:20px;padding-top:4px;
}
.nds-field{margin-bottom:14px}
.nds-field-label{
  font-size:11px;font-weight:600;color:var(--textDim);
  letter-spacing:.5px;margin-bottom:6px;
}
.nds-inp{
  width:100%;padding:12px 14px;border:1.5px solid var(--border);
  border-radius:10px;font-family:inherit;font-size:14px;
  background:var(--bg);color:var(--text);transition:border-color .2s;
}
.nds-inp:focus{outline:none;border-color:var(--accentL);background:var(--surface)}
.nds-inp::placeholder{color:var(--textF)}
.nds-ta{
  width:100%;padding:12px 14px;border:1.5px solid var(--border);
  border-radius:10px;font-family:inherit;font-size:14px;
  background:var(--bg);color:var(--text);resize:none;min-height:80px;
  line-height:1.7;transition:border-color .2s;
}
.nds-ta:focus{outline:none;border-color:var(--accentL);background:var(--surface)}
.nds-file-btn{
  display:block;width:100%;padding:11px;border:1.5px dashed var(--border);
  border-radius:10px;font-family:inherit;font-size:13px;color:var(--textDim);
  background:var(--bg);cursor:pointer;text-align:center;transition:border-color .2s;
}
.nds-file-btn:hover{border-color:var(--accentL);color:var(--accent)}
.nds-btn-row{display:flex;gap:10px;margin-top:20px}
.nds-btn-primary{
  flex:1;padding:14px;background:var(--accent);border:none;
  color:#fff;font-family:inherit;font-size:14px;font-weight:500;
  border-radius:12px;cursor:pointer;transition:opacity .15s;
}
.nds-btn-primary.charge{background:#4a7a50}
.nds-btn-primary.drain{background:#8a3a3a}
.nds-btn-primary:hover{opacity:.88}
.nds-btn-ghost{
  padding:14px 18px;background:transparent;border:1.5px solid var(--border);
  color:var(--textF);font-family:inherit;font-size:14px;
  border-radius:12px;cursor:pointer;transition:border-color .2s;
}
.nds-btn-ghost:hover{border-color:var(--accentL);color:var(--textDim)}
.nds-btn-danger{
  padding:14px 18px;background:transparent;border:1.5px solid #d0a0a0;
  color:var(--red);font-family:inherit;font-size:14px;border-radius:12px;cursor:pointer;
}
.nds-photo-preview{
  width:60px;height:60px;border-radius:8px;object-fit:cover;
  margin-top:8px;display:none;
}

/* ════════════════════════════════════════
   체크 워크시트
════════════════════════════════════════ */
.ws-wrap{
  max-width:560px;margin:0 auto;padding:24px 20px 100px;
}
.ws-prog-row{
  display:flex;align-items:center;gap:12px;margin-bottom:28px;
}
.ws-prog-bg{
  flex:1;height:4px;background:var(--border);border-radius:2px;overflow:hidden;
}
.ws-prog-fill{
  height:100%;background:var(--accent);border-radius:2px;transition:width .35s ease;
}
.ws-prog-lbl{
  font-size:11px;color:var(--textF);white-space:nowrap;flex-shrink:0;
}
.ws-page-header{
  display:flex;align-items:flex-start;gap:14px;margin-bottom:28px;
}
.ws-page-icon{
  font-size:28px;line-height:1;flex-shrink:0;margin-top:2px;
}
.ws-page-title{
  font-family:Georgia,serif;font-size:20px;font-weight:400;
  color:var(--text);margin-bottom:4px;line-height:1.3;
}
.ws-page-sub{
  font-size:12px;color:var(--textF);line-height:1.7;
}
.ws-fields{
  display:flex;flex-direction:column;gap:18px;
}
.ws-field{
  display:flex;flex-direction:column;gap:6px;
}
.ws-field-label{
  font-size:12px;font-weight:600;color:var(--textDim);letter-spacing:.3px;
}
.ws-field-hint{
  font-size:11px;color:var(--textF);font-weight:400;
}
.ws-inp{
  padding:12px 14px;
  border:1.5px solid var(--border);border-radius:10px;
  font-family:inherit;font-size:14px;color:var(--text);
  background:var(--surface);transition:border-color .2s;
  outline:none;
}
.ws-inp:focus{border-color:var(--accentL);background:var(--bg);}
.ws-inp::placeholder{color:var(--textF);}
.ws-opts-row{
  display:flex;flex-wrap:wrap;gap:8px;
}
.ws-opt{
  padding:9px 16px;
  border:1.5px solid var(--border);border-radius:20px;
  background:var(--surface);color:var(--textDim);
  font-family:inherit;font-size:13px;cursor:pointer;
  transition:all .15s;white-space:nowrap;
}
.ws-opt:hover{border-color:var(--accentL);color:var(--accent);}
.ws-opt.sel{
  background:var(--accent);border-color:var(--accent);
  color:#fff;font-weight:500;
}
.ws-reward-opt{
  padding:8px 14px;border-radius:10px;font-size:13px;
}
.ws-reward-empty{
  font-size:12px;color:var(--textF);padding:10px 0;
}
.ws-nav{
  display:flex;gap:10px;margin-top:32px;
}
.ws-btn-next{
  flex:1;padding:15px;
  background:var(--accent);border:none;color:#fff;
  font-family:inherit;font-size:15px;font-weight:600;
  border-radius:14px;cursor:pointer;transition:opacity .15s;letter-spacing:.3px;
}
.ws-btn-next:hover{opacity:.88;}
.ws-btn-back{
  padding:15px 20px;
  background:transparent;border:1.5px solid var(--border);color:var(--textF);
  font-family:inherit;font-size:14px;border-radius:14px;cursor:pointer;
  transition:border-color .15s;
}
.ws-btn-back:hover{border-color:var(--accentL);color:var(--textDim);}

/* ════════════════════════════════════════
   성장 지표 꺾은선 그래프
════════════════════════════════════════ */
.me-linechart-wrap{
  width:100%;margin-bottom:8px;
}
.me-linechart-wrap svg{
  width:100%;display:block;overflow:visible;
}

/* 결과지 — 체크 입력 표시 */
.res-ws-section{margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid var(--border)}
.res-ws-section:last-child{margin:0;padding:0;border:none}
.res-ws-section-title{
  display:flex;align-items:center;gap:8px;
  font-size:10px;letter-spacing:2px;text-transform:uppercase;
  color:var(--accent);font-weight:600;margin-bottom:12px;
}
.res-ws-section-icon{font-size:14px}
.res-ws-field{margin-bottom:10px}
.res-ws-field:last-child{margin:0}
.res-ws-label{font-size:10px;color:var(--textF);font-weight:500;margin-bottom:3px;letter-spacing:.3px}
.res-ws-val{font-size:13px;color:var(--text);line-height:1.7;white-space:pre-wrap}
.res-ws-opts{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px}
.res-ws-opt-chip{
  padding:4px 12px;border-radius:20px;font-size:12px;font-weight:500;
  background:var(--accentDim);color:var(--accent);border:1px solid var(--border);
}

/* AI 분석 패널 */
.res-ai-panel{background:linear-gradient(180deg,var(--bg) 0%,var(--surface) 100%)}
.res-ai-loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;gap:12px}
.res-ai-loading .spinner{width:20px;height:20px}
.res-ai-loading-txt{font-size:12px;color:var(--textF)}
.res-ai-summary{font-size:13px;color:var(--textDim);line-height:1.9;margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid var(--border)}
.res-ai-phil-label{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--accent);font-weight:600;margin-bottom:12px}
.res-ai-phil-item{margin-bottom:14px;padding-bottom:14px;border-bottom:1px solid var(--border)}
.res-ai-phil-item:last-child{margin:0;padding:0;border:none}
.res-ai-phil-tag{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--accentL);font-weight:600;margin-bottom:3px}
.res-ai-phil-content{font-size:13px;color:var(--text);line-height:1.8;font-weight:500;margin-bottom:3px}
.res-ai-phil-why{font-size:11px;color:var(--textF);line-height:1.7}

/* Task 항목 */
.ws-task-field{}
.ws-task-meta{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-top:6px}
.ws-task-toggle{
  padding:5px 12px;border-radius:20px;font-size:12px;font-family:inherit;cursor:pointer;
  background:var(--surface);border:1.5px solid var(--border);color:var(--textF);
  transition:all .15s;
}
.ws-task-toggle:hover{border-color:var(--accentL);color:var(--textDim)}
.ws-task-toggle.active{background:var(--accentDim);border-color:var(--accent);color:var(--accent);font-weight:500}
.ws-task-long-badge{font-size:11px;color:var(--accent);background:var(--accentDim);padding:3px 8px;border-radius:10px}
.ws-ai-sort-row{margin-top:18px;padding-top:16px;border-top:1px solid var(--border)}
.ws-ai-sort-btn{
  width:100%;padding:12px;
  background:var(--accentDim);border:1.5px solid var(--accentL);
  color:var(--accent);font-family:inherit;font-size:13px;font-weight:600;
  border-radius:12px;cursor:pointer;transition:all .15s;
}
.ws-ai-sort-btn:hover{background:var(--accentDim2)}
.ws-ai-sorted{
  margin-top:12px;padding:14px;
  background:var(--surface);border:1px solid var(--border);border-radius:12px;
}
.ws-ai-sorted-title{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--accent);font-weight:600;margin-bottom:10px}
.ws-ai-task-order{display:flex;flex-direction:column;gap:6px}
.ws-ai-task-item{display:flex;align-items:flex-start;gap:10px;padding:8px 10px;background:var(--bg);border-radius:8px;border:1px solid var(--border)}
.ws-ai-task-num{
  width:20px;height:20px;border-radius:50%;flex-shrink:0;
  background:var(--accent);color:#fff;font-size:11px;font-weight:700;
  display:flex;align-items:center;justify-content:center;margin-top:1px;
}
.ws-ai-task-text{font-size:13px;color:var(--text);flex:1;line-height:1.5}
.ws-ai-task-reason{font-size:11px;color:var(--textF);line-height:1.6;margin-top:2px}
.ws-ai-task-tag{font-size:9px;padding:2px 7px;border-radius:10px;flex-shrink:0;margin-top:2px}
.ws-ai-task-tag.long{background:var(--accentDim);color:var(--accent)}
.ws-ai-task-tag.short{background:var(--greenBg,#eaf4ed);color:var(--green,#4a7a50)}

/* 다짐/생각 */
.res-commitment-area{
  margin-top:16px;padding-top:16px;
  border-top:1px solid var(--border);
}
.res-commitment-lbl{
  font-size:10px;letter-spacing:2px;text-transform:uppercase;
  color:var(--accent);font-weight:600;margin-bottom:8px;
}
.res-commitment-ta{
  width:100%;padding:10px 12px;
  background:var(--accentDim);
  border:1.5px solid var(--accentL);
  border-radius:10px;
  font-family:inherit;font-size:13px;color:var(--text);
  resize:vertical;min-height:60px;line-height:1.7;
  box-sizing:border-box;
}
.res-commitment-ta:focus{outline:none;border-color:var(--accent);}
.res-commitment-save{
  margin-top:8px;padding:8px 16px;
  background:var(--accent);color:#fff;
  border:none;border-radius:8px;
  font-family:inherit;font-size:12px;font-weight:600;
  cursor:pointer;
}
.res-commitment-saved{
  margin-top:8px;font-size:12px;color:var(--textF);
  display:flex;align-items:center;gap:6px;
}
/* 나탭 다짐 */
.me-commitment-box{
  margin-top:10px;padding:10px 12px;
  background:var(--accentDim);
  border-left:3px solid var(--accent);
  border-radius:0 8px 8px 0;
}
.me-commitment-label{
  font-size:9px;letter-spacing:2px;text-transform:uppercase;
  color:var(--accent);font-weight:600;margin-bottom:4px;
}
.me-commitment-text{
  font-size:12px;color:var(--text);line-height:1.7;
  font-style:italic;
}
.me-commitment-date{font-size:10px;color:var(--textF);margin-top:3px;}
/* 저장된 결과지 다짐 */
.rs-commitment{
  margin:10px 14px;padding:10px 12px;
  background:var(--accentDim);border-left:3px solid var(--accent);
  border-radius:0 8px 8px 0;
}
.rs-commitment-label{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--accent);font-weight:600;margin-bottom:4px;}
.rs-commitment-text{font-size:12px;color:var(--text);line-height:1.7;font-style:italic;}
.rs-commitment-input{
  display:flex;gap:6px;margin-top:6px;
}
.rs-commitment-ta{
  flex:1;padding:8px 10px;
  background:var(--bg);border:1px solid var(--border);
  border-radius:8px;font-family:inherit;font-size:12px;color:var(--text);
  resize:none;height:44px;line-height:1.6;box-sizing:border-box;
}
.rs-commitment-btn{
  padding:0 12px;background:var(--accent);color:#fff;
  border:none;border-radius:8px;font-family:inherit;font-size:11px;
  font-weight:600;cursor:pointer;white-space:nowrap;
}

/* Todo 카드 확장 */
.me-todo-item{position:relative;}
.me-todo-item.expanded{border-color:var(--accentL);background:var(--accentDim);}
.me-todo-edit-btn{
  background:none;border:none;color:var(--textF);font-size:11px;
  cursor:pointer;flex-shrink:0;padding:0 3px;opacity:0;transition:opacity .15s;
}
.me-todo-item:hover .me-todo-edit-btn{opacity:1}
.me-todo-meta{
  display:flex;flex-wrap:wrap;gap:4px;margin-top:5px;
}
.me-todo-trigger{
  font-size:11px;color:var(--textF);margin-top:4px;
  padding-left:2px;font-style:italic;line-height:1.5;
}
.me-todo-block-tag{
  font-size:9px;padding:2px 7px;border-radius:10px;font-weight:600;
  background:#f0eaff;color:#6b3fa0;
}
.me-todo-energy-tag{
  font-size:9px;padding:2px 7px;border-radius:10px;font-weight:600;
}
.me-todo-energy-tag.high{background:#fce8e8;color:var(--red)}
.me-todo-energy-tag.mid{background:#fef3e2;color:#8a5a00}
.me-todo-energy-tag.low{background:var(--greenBg);color:var(--green)}
.me-todo-retro{
  margin-top:5px;padding:5px 8px;
  background:var(--surface);border-radius:6px;border:1px solid var(--border);
  font-size:11px;color:var(--textDim);line-height:1.6;font-style:italic;
}

/* Todo 편집 모달 */
.todo-edit-section{margin-bottom:14px}
.todo-edit-section-title{
  font-size:9px;letter-spacing:2px;text-transform:uppercase;
  color:var(--accent);font-weight:600;margin-bottom:8px;
}
.todo-block-opts,.todo-energy-opts{display:flex;flex-wrap:wrap;gap:6px}
.todo-block-opt,.todo-energy-opt{
  padding:5px 12px;border-radius:20px;font-size:12px;font-family:inherit;
  cursor:pointer;background:var(--surface);border:1.5px solid var(--border);
  color:var(--textDim);transition:all .15s;
}
.todo-block-opt.sel{background:#f0eaff;border-color:#b39dda;color:#6b3fa0;font-weight:500}
.todo-energy-opt.sel.high{background:#fce8e8;border-color:#e8aaaa;color:var(--red);font-weight:500}
.todo-energy-opt.sel.mid{background:#fef3e2;border-color:#f0c070;color:#8a5a00;font-weight:500}
.todo-energy-opt.sel.low{background:var(--greenBg);border-color:#9acc9a;color:var(--green);font-weight:500}

/* 완료 회고 팝업 */
.retro-modal-title{font-size:15px;font-weight:600;color:var(--text);margin-bottom:4px}
.retro-modal-task{font-size:12px;color:var(--textF);margin-bottom:16px;font-style:italic}

/* Todo AI 분석 */
.todo-ai-btn{
  width:100%;padding:10px;margin-top:4px;
  background:var(--accentDim);border:1.5px solid var(--accentL);
  color:var(--accent);font-family:inherit;font-size:12px;font-weight:600;
  border-radius:10px;cursor:pointer;transition:all .15s;
  display:flex;align-items:center;justify-content:center;gap:6px;
}
.todo-ai-btn:hover{background:var(--accentDim2,var(--accentDim));border-color:var(--accent);}
.todo-ai-result{
  margin-top:10px;padding:12px 14px;
  background:var(--bg);border:1px solid var(--border);
  border-radius:10px;
}
.todo-ai-result-loading{
  display:flex;align-items:center;gap:8px;
  font-size:12px;color:var(--textF);padding:4px 0;
}
.todo-ai-block{margin-bottom:10px;}
.todo-ai-block:last-child{margin-bottom:0}
.todo-ai-block-label{
  font-size:9px;letter-spacing:2px;text-transform:uppercase;
  color:var(--accent);font-weight:600;margin-bottom:5px;
}
.todo-ai-block-text{
  font-size:12px;color:var(--text);line-height:1.8;
}
.todo-ai-step{
  display:flex;align-items:flex-start;gap:8px;
  padding:6px 0;border-bottom:1px solid var(--border);
}
.todo-ai-step:last-child{border-bottom:none}
.todo-ai-step-num{
  width:18px;height:18px;border-radius:50%;flex-shrink:0;
  background:var(--accent);color:#fff;font-size:10px;font-weight:700;
  display:flex;align-items:center;justify-content:center;
}
.todo-ai-step-text{font-size:12px;color:var(--text);line-height:1.6;flex:1;}
.todo-ai-apply-btn{
  margin-top:8px;padding:6px 14px;
  background:var(--accent);color:#fff;border:none;border-radius:6px;
  font-family:inherit;font-size:11px;font-weight:600;cursor:pointer;
}

/* ── 충전탭 — 진짜 원하는 것 ─────────────────────────────── */
.rw-sec-title.real-need{
  background:linear-gradient(135deg,#f5f0ff,#ede5ff);
  border:1px solid #c9b8f0;
  display:flex;align-items:center;gap:10px;
  padding:12px 14px;border-radius:12px 12px 0 0;flex-wrap:wrap;
}
.rw-sec-title.real-need span{font-size:13px;font-weight:600;color:#4a2d8a;flex:1}
.rw-new-btn.real-need{
  padding:6px 14px;background:#6b3fa0;color:#fff;
  border:none;border-radius:20px;font-family:inherit;font-size:12px;
  font-weight:600;cursor:pointer;
}
.real-need-area{
  background:#faf8ff;border:1px solid #c9b8f0;border-top:none;
  border-radius:0 0 12px 12px;min-height:60px;padding:12px 14px;
}
.real-need-hint{font-size:12px;color:#7a6aaa;line-height:1.9;text-align:center;padding:8px 0}
.real-need-hint em{font-style:normal;color:#6b3fa0;font-weight:600}
.real-need-entry{
  display:flex;gap:8px;align-items:flex-start;
  padding:8px 0;border-bottom:1px solid #ede5ff;
}
.real-need-entry:last-child{border-bottom:none}
.real-need-entry-text{flex:1;font-size:13px;color:#3a2060;line-height:1.7}
.real-need-entry-date{font-size:10px;color:#9a8abf;white-space:nowrap;margin-top:2px}
.real-need-del{background:none;border:none;color:#c9b8f0;font-size:14px;cursor:pointer;padding:0}
.real-need-del:hover{color:#8a3a8a}

/* 충전/방전 카드 편집 버튼 */
.rw-edit-btn{
  padding:4px 10px;background:transparent;
  border:1px solid var(--border);border-radius:6px;
  font-family:inherit;font-size:11px;color:var(--textF);
  cursor:pointer;transition:all .15s;
}
.rw-edit-btn:hover{border-color:var(--accent);color:var(--accent)}

/* ── 인박스 탭 ───────────────────────────────────────────── */
.inbox-wrap{
  display:flex;flex-direction:column;height:100vh;max-width:640px;
  margin:0 auto;padding-bottom:0;
}
.inbox-header{
  display:flex;justify-content:space-between;align-items:flex-start;
  padding:20px 20px 12px;flex-shrink:0;
}
.inbox-header h2{font-family:Georgia,serif;font-size:20px;font-weight:400;margin-bottom:3px}
.inbox-sub{font-size:12px;color:var(--textF);line-height:1.7}
.inbox-ai-btn{
  padding:8px 16px;background:var(--accent);color:#fff;
  border:none;border-radius:20px;font-family:inherit;font-size:12px;
  font-weight:600;cursor:pointer;white-space:nowrap;flex-shrink:0;margin-top:4px;
}
/* 카테고리 필터 탭 */
.inbox-cat-tabs{
  display:flex;gap:6px;padding:0 16px 10px;
  overflow-x:auto;flex-shrink:0;
}
.inbox-cat-tabs::-webkit-scrollbar{display:none}
.inbox-cat-tab{
  padding:5px 14px;border-radius:20px;font-family:inherit;font-size:12px;
  border:1.5px solid var(--border);background:var(--surface);
  color:var(--textF);cursor:pointer;white-space:nowrap;transition:all .15s;
}
.inbox-cat-tab.active{
  background:var(--accent);border-color:var(--accent);color:#fff;font-weight:500;
}
/* 메시지 영역 */
.inbox-messages{
  flex:1;overflow-y:auto;padding:8px 16px 16px;
  display:flex;flex-direction:column;gap:8px;
}
.inbox-msg{
  display:flex;flex-direction:column;align-items:flex-end;
  animation:msgIn .2s ease;
}
@keyframes msgIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
.inbox-bubble{
  max-width:82%;padding:10px 14px;
  background:var(--accent);color:#fff;
  border-radius:18px 18px 4px 18px;
  font-size:13px;line-height:1.7;word-break:break-word;
}
.inbox-bubble.processed{background:var(--surface);color:var(--text);border:1px solid var(--border);border-radius:18px 18px 4px 18px}
.inbox-bubble.high-prio{border-left:3px solid #e05;border-radius:4px 18px 18px 4px}
.inbox-msg-meta{
  display:flex;align-items:center;gap:8px;margin-top:3px;
}
.inbox-msg-time{font-size:10px;color:var(--textF)}
.inbox-msg-cat{
  font-size:9px;padding:1px 7px;border-radius:10px;font-weight:500;
  background:var(--accentDim);color:var(--accent);
}
.inbox-msg-actions{
  display:flex;gap:4px;margin-top:4px;
}
.inbox-action-btn{
  padding:3px 10px;border-radius:12px;font-family:inherit;font-size:10px;
  border:1px solid var(--border);background:var(--surface);
  color:var(--textDim);cursor:pointer;transition:all .15s;
}
.inbox-action-btn:hover{border-color:var(--accent);color:var(--accent)}
.inbox-action-btn.done{background:var(--accentDim);border-color:var(--accentL);color:var(--accent);text-decoration:line-through}
.inbox-priority-badge{
  font-size:9px;padding:1px 6px;border-radius:10px;font-weight:600;
}
.inbox-priority-badge.high{background:#fce8e8;color:var(--red)}
.inbox-priority-badge.mid{background:#fef3e2;color:#8a5a00}
.inbox-priority-badge.low{background:var(--greenBg);color:var(--green)}
.inbox-ai-result{
  align-self:flex-start;max-width:90%;
  padding:12px 14px;background:var(--surface);
  border:1px solid var(--accentL);border-radius:4px 18px 18px 18px;
  font-size:12px;color:var(--textDim);line-height:1.8;
}
.inbox-empty{
  flex:1;display:flex;flex-direction:column;align-items:center;
  justify-content:center;text-align:center;color:var(--textF);
  font-size:13px;line-height:2;padding:40px;
}
/* 입력바 */
.inbox-input-bar{
  display:flex;align-items:flex-end;gap:6px;
  padding:10px 12px;background:var(--bg);
  border-top:1px solid var(--border);flex-shrink:0;
  position:sticky;bottom:0;
}
.inbox-cat-select-wrap{flex-shrink:0}
.inbox-cat-select{
  padding:8px 8px;background:var(--surface);border:1.5px solid var(--border);
  border-radius:10px;font-family:inherit;font-size:11px;color:var(--textDim);
  cursor:pointer;max-width:80px;
}
.inbox-input-ta{
  flex:1;padding:9px 12px;background:var(--surface);
  border:1.5px solid var(--border);border-radius:18px;
  font-family:inherit;font-size:13px;color:var(--text);
  resize:none;line-height:1.6;max-height:120px;overflow-y:auto;
  transition:border-color .15s;
}
.inbox-input-ta:focus{outline:none;border-color:var(--accent)}
.inbox-send-btn{
  width:38px;height:38px;background:var(--accent);color:#fff;
  border:none;border-radius:50%;font-size:16px;cursor:pointer;
  flex-shrink:0;display:flex;align-items:center;justify-content:center;
  transition:transform .1s;
}
.inbox-send-btn:active{transform:scale(.9)}
</style>
</head>
<body>
<!-- 잠금 화면 -->
<div id="lockScreen">
  <div class="lock-box">
    <div class="lock-icon">🔒</div>
    <div class="lock-title">나의 돌아오는 시스템</div>
    <div class="lock-sub">비밀번호를 입력해야 들어올 수 있어.</div>
    <input id="lockInp" class="lock-inp" type="password" placeholder="••••••" maxlength="20"
      onkeydown="if(event.key==='Enter')tryUnlock()">
    <button class="lock-btn" onclick="tryUnlock()">들어가기</button>
    <div class="lock-err" id="lockErr"></div>
  </div>
</div>

<div class="tab-bar">
  <button class="tab-btn active" onclick="goTab('me')">나</button>
  <button class="tab-btn" onclick="goTab('memo')">기록</button>
  <button class="tab-btn" onclick="goTab('inbox')">인박스</button>
  <button class="tab-btn" onclick="goTab('reward')">충전</button>
  <button class="tab-btn" onclick="startCheck()">체크</button>
  <button class="tab-btn" onclick="goTab('settings')">설정</button>
</div>
<div class="sync-bar" id="syncBar">
  <div class="sync-dot" id="syncDot"></div>
  <span id="syncStatus">Firebase 미연결 — 기기 간 동기화 안 됨</span>
  <span class="firebase-user" id="fbUserLabel"></span>
</div>

<!-- 나 탭 (홈 겸용, active) -->
<div id="page-me" class="page active">
  <!-- 프로필 헤더 — 풀 화면 너비 -->
  <div class="me-header">
    <div class="me-header-inner">
      <div class="me-avatar-zone">
        <div class="me-avatar-ring" onclick="document.getElementById('avatarInp').click()">
          <canvas id="meAvatarCanvas" width="80" height="80"></canvas>
          <img id="meAvatarImg" style="display:none;width:80px;height:80px;border-radius:50%;object-fit:cover" alt="">
        </div>
        <input type="file" id="avatarInp" accept="image/*" style="display:none" onchange="onAvatarUpload(event)">
        <div class="me-level" id="meLevelBadge">Lv.1</div>
      </div>
      <div class="me-identity">
        <div class="me-class" id="meClassTag">관찰자</div>
        <input id="meNameInp" class="me-name-inp" placeholder="이름" oninput="saveProfileData()">
        <textarea id="meTaglineInp" class="me-tagline-inp" rows="1" placeholder="나를 한 줄로..." oninput="saveProfileData()"></textarea>
        <div class="me-stat-row" id="meStatRow"></div>
      </div>
      <button class="me-check-btn" onclick="startCheck()">체크 →</button>
    </div>
  </div>

  <!-- 메인 그리드 -->
  <div class="me-grid">

    <!-- 왼쪽: 집중할일 Todo -->
    <div class="me-card me-todo-card">
      <div class="me-card-head">
        <span>◎ 지금 집중할 것</span>
        <button class="me-card-action" onclick="openTodoModal()">+ 추가</button>
      </div>
      <div id="meTodoList" class="me-todo-list"></div>
    </div>

    <!-- 중간: 성장 지표 그래프 -->
    <div class="me-card me-metrics-card">
      <div class="me-card-head">
        <span>◆ 성장 지표</span>
        <button class="me-card-action" onclick="openMetricModal(-1)">+ 추가</button>
      </div>
      <div id="meMiniMetrics" class="me-metrics-list"></div>
    </div>

    <!-- 오른쪽: 최근 결과지 + 가치관 -->
    <div class="me-card me-results-card">
      <div class="me-card-head">
        <span>▣ 최근 체크 결과</span>
        <button class="me-card-action" onclick="goTab('memo');switchSeg('seg-results',document.querySelectorAll('.seg-btn')[1])">전체 →</button>
      </div>
      <div id="meResultPreview" class="me-result-list"></div>
    </div>

    <!-- 가치관 카드들 -->
    <div class="me-card me-phil-card">
      <div class="me-card-head"><span>◈ 내 가치관</span></div>
      <div id="mePhilGrid" class="me-phil-mini-grid"></div>
    </div>

  </div>
</div>

<!-- 기록 — 세그먼트 컨트롤 -->
<div id="page-memo" class="page">
  <div class="inner">
    <div class="memo-h">
      <h2>나의 기록</h2>
      <p class="memo-sub">가치관, 깨달음, 오늘 느낀 것을 메모하는 곳.<br>기록이 매번 AI 분석에 반영된다.</p>
    </div>
    <!-- 세그먼트 -->
    <div class="seg-ctrl">
      <button class="seg-btn active" onclick="switchSeg('seg-notes',this)">메모</button>
      <button class="seg-btn" onclick="switchSeg('seg-results',this)">결과지</button>
      <button class="seg-btn" onclick="switchSeg('seg-metrics',this)">성장 지표</button>
    </div>

    <!-- 메모 패널 -->
    <div class="seg-panel active" id="seg-notes">
      <div class="memo-add">
        <textarea id="newMemoTa" style="min-height:80px" placeholder="오늘 새롭게 알게 된 것, 가치관, 깨달음..."></textarea>
        <button class="memo-add-btn" onclick="addMemoFromId('newMemoTa')">저장</button>
      </div>
      <div class="memo-list" id="memoList"></div>
    </div>

    <!-- 결과지 패널 -->
    <div class="seg-panel" id="seg-results">
      <div class="memo-list" id="resultList" style="padding-top:8px"></div>
    </div>

    <!-- 성장 지표 패널 -->
    <div class="seg-panel" id="seg-metrics">
      <div style="padding:16px 0 8px;display:flex;justify-content:flex-end">
        <button class="memo-add-btn" style="margin-top:0" onclick="openMetricModal(-1)">+ 지표 추가</button>
      </div>
      <div id="metricsPanel"></div>
    </div>
  </div>
</div>

<!-- 충전 탭 -->
<div id="page-reward" class="page">
  <div class="reward-wrap">
    <div class="reward-page-header">
      <h2>충전 시스템</h2>
      <p>직접 해보고 알게 된 것들. 끝이 어땠는지가 기준이야.</p>
    </div>

    <!-- 진짜 원하는 것 섹션 -->
    <div class="rw-section">
      <div class="rw-sec-title real-need">
        <span>✦ 지금 진짜 필요한 게 뭐야?</span>
        <button class="rw-new-btn real-need" onclick="openRealNeedPrompt()">성찰하기</button>
      </div>
      <div id="real-need-area" class="real-need-area">
        <div class="real-need-hint">
          끌린다고 원하는 게 아닐 수 있어.<br>
          지금 내가/내 몸이 <em>진짜로</em> 필요한 게 뭔지 물어봐.
        </div>
      </div>
    </div>

    <!-- 충전 섹션 -->
    <div class="rw-section">
      <div class="rw-sec-title charge">
        <span>💙 충전 LIST</span>
        <span class="rw-sec-sub">해보니 실제로 좋았던 것</span>
        <button class="rw-new-btn charge" onclick="openRewardModal('charge')">+ 추가</button>
      </div>
      <div class="rw-cards" id="charge-items"></div>
    </div>

    <!-- 방전 섹션 -->
    <div class="rw-section">
      <div class="rw-sec-title drain">
        <span>🔴 방전 LIST</span>
        <span class="rw-sec-sub">끝이 안 좋았던 것</span>
        <button class="rw-new-btn drain" onclick="openRewardModal('drain')">+ 추가</button>
      </div>
      <div class="rw-cards" id="drain-items"></div>
    </div>
  </div>
</div>

<!-- 인박스 탭 -->
<div id="page-inbox" class="page">
  <div class="inbox-wrap">
    <div class="inbox-header">
      <div>
        <h2>인박스</h2>
        <p class="inbox-sub">머릿속에 넘치는 것들을 던져두는 곳.<br>나중에 정리하면 돼.</p>
      </div>
      <button class="inbox-ai-btn" onclick="runInboxAI()">✦ AI 정리</button>
    </div>

    <!-- 카테고리 필터 탭 -->
    <div class="inbox-cat-tabs" id="inboxCatTabs"></div>

    <!-- 메시지 리스트 -->
    <div class="inbox-messages" id="inboxMessages"></div>

    <!-- 입력창 — 카톡형 -->
    <div class="inbox-input-bar">
      <div class="inbox-cat-select-wrap">
        <select id="inboxCatSelect" class="inbox-cat-select"></select>
      </div>
      <textarea id="inboxInputTa" class="inbox-input-ta" rows="1"
        placeholder="지금 머릿속에 있는 것..."
        oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"
        onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendInboxItem();}"></textarea>
      <button class="inbox-send-btn" onclick="sendInboxItem()">→</button>
    </div>
  </div>
</div>

<!-- 체크 -->
<div id="page-check" class="page">
  <div class="q-outer" id="checkContent"></div>
</div>

<!-- 결과 -->
<div id="page-result" class="page">
  <div class="inner-wide" id="resultContent"></div>
</div>

<!-- 설정 -->
<div id="page-settings" class="page">
  <div class="inner" style="padding-top:8px">
    <div class="settings-wrap">
      <h2 class="settings-title">설정</h2>
      <p class="settings-sub">시스템의 모든 부분을 직접 수정할 수 있어.</p>

      <!-- API -->
      <div class="set-section">
        <div class="set-section-head" onclick="toggleSection('sec-api')">
          <div class="set-section-title">API 키</div>
          <div class="set-section-arrow open" id="arr-sec-api">▼</div>
        </div>
        <div class="set-section-body open" id="sec-api">
          <div class="setting-lbl">Groq API 키</div>
          <input id="apiKeyInp" class="setting-inp" type="password" placeholder="gsk_...로 시작하는 키">
          <div class="setting-hint">
            <a href="https://console.groq.com" target="_blank">console.groq.com</a>에서 무료로 발급받을 수 있어. 키는 이 기기에만 저장돼.
          </div>
          <div class="api-status" id="apiStatus"></div>
          <div class="btn-row">
            <button class="btn-primary" onclick="saveApiKey()">저장</button>
            <button class="btn-secondary" onclick="testApiKey()">연결 테스트</button>
          </div>
          <div class="test-result" id="testResult"></div>
        </div>
      </div>

      <!-- AI 스타일 -->
      <div class="set-section">
        <div class="set-section-head" onclick="toggleSection('sec-ai')">
          <div class="set-section-title">AI 응답 스타일</div>
          <div class="set-section-arrow" id="arr-sec-ai">▼</div>
        </div>
        <div class="set-section-body" id="sec-ai">
          <div class="setting-lbl">분석 스타일</div>
          <select id="setAnalysisStyle" class="sel setting-inp" onchange="saveSettings()">
            <option value="pattern">패턴 분석 (답변들 사이의 연결고리 짚기)</option>
            <option value="direct">직접적 (보이는 것 그대로)</option>
            <option value="gentle">부드럽게 (따뜻한 톤으로)</option>
          </select>
          <div class="setting-lbl">행동강령 스타일</div>
          <select id="setActionStyle" class="sel setting-inp" onchange="saveSettings()">
            <option value="step">3단계 연결 (인지→행동→습관)</option>
            <option value="simple">단순 명확 (바로 할 것만)</option>
            <option value="why">이유 중심 (왜 해야 하는지 먼저)</option>
          </select>
          <div class="setting-lbl">추가 프롬프트 (선택)</div>
          <textarea id="setExtraPrompt" class="setting-ta" placeholder="AI에게 추가로 지시하고 싶은 내용. 예: '항상 구체적인 시간을 포함해줘'" oninput="saveSettings()"></textarea>
        </div>
      </div>

      <!-- 가치관 카드 편집 -->
      <div class="set-section">
        <div class="set-section-head" onclick="toggleSection('sec-phil')">
          <div class="set-section-title">가치관 카드 편집</div>
          <div class="set-section-arrow" id="arr-sec-phil">▼</div>
        </div>
        <div class="set-section-body" id="sec-phil">
          <div id="philEditList"></div>
          <button class="add-item-btn" onclick="addPhilCard()">+ 가치관 추가</button>
          <div class="btn-row" style="margin-top:14px">
            <button class="btn-primary" onclick="savePhilCards()">저장</button>
            <button class="btn-ghost" onclick="resetPhilCards()">기본값으로</button>
          </div>
        </div>
      </div>

      <!-- 질문 편집 -->
      <div class="set-section">
        <div class="set-section-head" onclick="toggleSection('sec-q')">
          <div class="set-section-title">질문 편집</div>
          <div class="set-section-arrow" id="arr-sec-q">▼</div>
        </div>
        <div class="set-section-body" id="sec-q">
          <div id="qEditList"></div>
          <button class="add-item-btn" onclick="addQuestion()">+ 질문 추가</button>
          <div class="btn-row" style="margin-top:14px">
            <button class="btn-primary" onclick="saveQuestionSet()">저장</button>
            <button class="btn-ghost" onclick="resetQuestions()">기본값으로</button>
          </div>
        </div>
      </div>

      <!-- 비밀번호 -->
      <div class="set-section">
        <div class="set-section-head" onclick="toggleSection('sec-pw')">
          <div class="set-section-title">🔒 비밀번호 변경</div>
          <div class="set-section-arrow" id="arr-sec-pw">▼</div>
        </div>
        <div class="set-section-body" id="sec-pw">
          <div class="setting-lbl">새 비밀번호</div>
          <input id="newPwInp" class="setting-inp" type="password" placeholder="새 비밀번호 입력">
          <div class="setting-lbl" style="margin-top:12px">새 비밀번호 확인</div>
          <input id="newPwInp2" class="setting-inp" type="password" placeholder="한 번 더 입력">
          <div class="btn-row" style="margin-top:12px">
            <button class="btn-primary" onclick="changePassword()">변경</button>
          </div>
          <div class="setting-hint" style="margin-top:10px">비밀번호는 이 기기 브라우저에 저장돼. 잊어버리면 아래 방법으로 초기화할 수 있어.<br><br>
          초기화: 브라우저 콘솔(F12)에서 <code style="background:var(--bg);padding:2px 6px;border-radius:4px;font-size:11px">localStorage.removeItem('app_pw')</code> 실행</div>
        </div>
      </div>

      <!-- Firebase 동기화 -->
      <div class="set-section">
        <div class="set-section-head" onclick="toggleSection('sec-firebase')">
          <div class="set-section-title">☁️ Firebase 동기화 (기기 연동)</div>
          <div class="set-section-arrow" id="arr-sec-firebase">▼</div>
        </div>
        <div class="set-section-body" id="sec-firebase">
          <p class="setting-hint" style="margin-bottom:14px;line-height:1.75">Firebase를 연결하면 폰·패드·컴퓨터 어디서든 같은 데이터를 볼 수 있어. 구글 계정으로 로그인하면 자동으로 동기화돼. <a href="https://console.firebase.google.com" target="_blank" style="color:var(--accentL)">Firebase 콘솔</a>에서 프로젝트를 만들고 아래에 설정값을 넣어줘.</p>

          <div id="fbConfigForm">
            <div class="setting-lbl">Firebase 설정값</div>
            <div class="setting-hint" style="margin-bottom:10px">Firebase 콘솔 → 프로젝트 설정 → 내 앱 → 웹 앱 추가 → firebaseConfig 안의 값들</div>
            <input id="fbApiKey" class="setting-inp" type="password" placeholder="apiKey" style="margin-bottom:6px">
            <input id="fbAuthDomain" class="setting-inp" type="text" placeholder="authDomain (예: myapp.firebaseapp.com)" style="margin-bottom:6px">
            <input id="fbProjectId" class="setting-inp" type="text" placeholder="projectId" style="margin-bottom:6px">
            <div class="btn-row" style="margin-top:10px">
              <button class="btn-primary" onclick="saveFbConfig()">저장 및 연결</button>
              <button class="btn-ghost" onclick="clearFbConfig()">연결 해제</button>
            </div>
          </div>

          <div style="margin-top:16px" id="fbLoginSection" style="display:none">
            <div class="setting-lbl">로그인</div>
            <div id="fbLoginArea">
              <button class="fb-login-btn" onclick="fbGoogleLogin()">
                <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.5 0 6.6 1.2 9.1 3.2l6.8-6.8C35.8 2.5 30.2 0 24 0 14.7 0 6.8 5.4 3.1 13.4l7.9 6.2C12.9 13.2 18 9.5 24 9.5z"/><path fill="#4285F4" d="M46.5 24.5c0-1.6-.1-3.1-.4-4.5H24v8.5h12.7c-.6 3-2.3 5.5-4.8 7.2l7.5 5.8C43.6 37.4 46.5 31.4 46.5 24.5z"/><path fill="#FBBC05" d="M11 28.6C10.3 26.8 10 24.9 10 23s.4-3.8 1-5.6L3.1 11.2C1.1 15 0 19.4 0 24s1.1 9 3.1 12.8l7.9-6.2z"/><path fill="#34A853" d="M24 48c6.2 0 11.4-2 15.2-5.5l-7.5-5.8c-2 1.4-4.6 2.2-7.7 2.2-6 0-11.1-3.7-13-9.1L3.1 36.1C6.8 43.6 14.7 48 24 48z"/></svg>
                Google 계정으로 로그인
              </button>
            </div>
          </div>

          <div id="fbStatusArea" style="display:none;margin-top:12px">
            <div class="api-status">
              <div class="status-dot ok"></div>
              <span id="fbLoggedUser" style="color:var(--green)"></span>
            </div>
            <div class="btn-row" style="margin-top:10px">
              <button class="btn-secondary" onclick="fbForceSync()">지금 동기화</button>
              <button class="btn-ghost" onclick="fbLogout()">로그아웃</button>
            </div>
          </div>

          <div style="margin-top:14px;padding:12px 14px;background:var(--accentDim2);border-radius:10px">
            <div style="font-size:11px;color:var(--accentL);font-weight:600;margin-bottom:6px;letter-spacing:1px">설정 방법 요약</div>
            <div style="font-size:12px;color:var(--textDim);line-height:2">
              1. <a href="https://console.firebase.google.com" target="_blank" style="color:var(--accentL)">Firebase 콘솔</a>에서 프로젝트 새로 만들기<br>
              2. Authentication → Google 로그인 활성화<br>
              3. Firestore Database 만들기 (테스트 모드)<br>
              4. 프로젝트 설정 → 웹 앱 추가 → apiKey, authDomain, projectId 복사<br>
              5. 위 칸에 붙여넣기 후 저장 → Google 로그인
            </div>
          </div>
        </div>
      </div>

      <!-- 데이터 -->
      <div class="set-section">
        <div class="set-section-head" onclick="toggleSection('sec-data')">
          <div class="set-section-title">데이터 관리 · 백업</div>
          <div class="set-section-arrow" id="arr-sec-data">▼</div>
        </div>
        <div class="set-section-body" id="sec-data">
          <p class="setting-hint" style="margin-bottom:14px">기록을 파일로 내보내거나, 다른 기기에서 가져올 수 있어. Firebase 없이 수동 백업할 때 유용해.</p>
          <div class="export-import-row">
            <button class="btn-primary" onclick="exportData()">📥 내보내기 (JSON)</button>
            <label class="btn-secondary" style="cursor:pointer;padding:11px 16px;display:inline-block">
              📤 가져오기
              <input type="file" accept=".json" onchange="importData(event)" style="display:none">
            </label>
          </div>
          <div class="divider"></div>
          <button class="btn-danger-outline" onclick="clearAllData()">모든 기록 삭제</button>
        </div>
      </div>

    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ── 비밀번호 잠금 ─────────────────────────────────────────
const DEFAULT_PW = 'myreturn2024'; // ← 여기서 기본 비밀번호 변경 가능
const SALT = 'nds_v1_';

async function hashPw(pw){
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(SALT+pw));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

async function initLock(){
  // 저장된 해시가 없으면 기본 비밀번호로 초기화
  if(!localStorage.getItem('app_pw')){
    localStorage.setItem('app_pw', await hashPw(DEFAULT_PW));
  }
  // 세션 중 이미 인증됐으면 바로 통과
  if(sessionStorage.getItem('unlocked')==='1'){
    document.getElementById('lockScreen').style.display='none';
    return;
  }
  document.getElementById('lockInp').focus();
}

async function tryUnlock(){
  const val = document.getElementById('lockInp').value;
  const err = document.getElementById('lockErr');
  if(!val){err.textContent='비밀번호를 입력해줘';return;}
  const hash = await hashPw(val);
  const saved = localStorage.getItem('app_pw');
  if(hash === saved){
    sessionStorage.setItem('unlocked','1');
    document.getElementById('lockScreen').style.display='none';
    err.textContent='';
  } else {
    err.textContent='비밀번호가 틀렸어';
    document.getElementById('lockInp').value='';
    document.getElementById('lockInp').focus();
  }
}

async function changePassword(){
  const p1 = document.getElementById('newPwInp').value;
  const p2 = document.getElementById('newPwInp2').value;
  if(!p1){showToast('새 비밀번호를 입력해줘');return;}
  if(p1 !== p2){showToast('두 비밀번호가 달라');return;}
  if(p1.length < 4){showToast('4자 이상으로 해줘');return;}
  localStorage.setItem('app_pw', await hashPw(p1));
  document.getElementById('newPwInp').value='';
  document.getElementById('newPwInp2').value='';
  showToast('비밀번호 변경됐어!');
}

// ── 기본 데이터 ───────────────────────────────────────────
const BASE_PHIL=[
  {tag:"중심 가치",title:"행복하게 살자",body:"원하는 대로만 살아봤더니 행복하지 않았다. 한두 달 해보니 나가는 일이 없을수록 몸이 망가지고 피곤해졌다. 어차피 살 거라면 행복하게 살겠다."},
  {tag:"가짜 보상",title:"끌린다고 진짜 원하는 게 아닐 수 있다",body:"전자기기를 오래 해봤다. 끝은 항상 몸이 아프거나 더 우울했다. 하지 말라고 하니까 스트레스·회피·보상 심리로 하고 있었던 것이다. 직접 해봤을 때 끝이 어땠는지가 기준이다."},
  {tag:"생각의 실체",title:"꺼내야 실체가 생긴다",body:"머릿속에서 논문처럼 느껴지는 생각도 꺼내보면 두 줄이 된다. 실망이 아니다. 실체가 생긴 것이다. 실체가 있어야 다룰 수 있다."},
  {tag:"불안",title:"불안은 미래에 있고, 나는 지금 여기 있다",body:"걱정의 99%는 일어나지 않는다. 미래 걱정에 쓰는 에너지를 차라리 지금 할 수 있는 것에 쓰는 게 낫다."},
  {tag:"나를 대하는 방식",title:"나는 평생 나와 함께 산다",body:"아이돌 매니저처럼 냉철하게 파악하되, 그 정보는 나를 발전시키는 데 쓴다. 부족한 점은 나를 공격하기 위한 게 아니라 성장시키기 위해 있는 것이다."},
  {tag:"노력",title:"노력은 배신하지 않는다",body:"안 좋은 일이 생기거나 당장 변화가 없어도 쌓이고 있다. 치열하게 1분 1초 고민하는 것도 나를 성장시키고 있다."},
];
const BASE_QUESTIONS=[
  {id:'mood',cat:'지금 상태',text:'지금 기분이나 상태를 솔직하게 표현하면?',sub:'좋다, 무기력하다, 불안하다, 모르겠다 — 뭐든 괜찮아.',type:'ta'},
  {id:'body',cat:'몸 상태',text:'지금 몸은 어때?',sub:'잠, 피로도, 아픈 곳, 밥은 먹었는지.',type:'opts',opts:['괜찮아','좀 피곤하거나 찌뿌둥해','확실히 안 좋아']},
  {id:'reality',cat:'현실 상황',text:'지금 현실에서 내 상황은 어때?',sub:'요즘 어떻게 지내고 있는지. 생활 루틴, 사람들과의 관계, 학교나 일, 돈, 뭐든. 지금 내 포지션이 어디쯤인지 꺼내봐.',type:'ta'},
  {id:'tasks',cat:'해야 할 것들',text:'지금 해야 하는데 못 하고 있거나 다가오는 일이 있어?',sub:'급한 것, 미루고 있는 것, 곧 닥칠 일정. 작은 거라도 머릿속에 걸려 있으면 꺼내봐.',type:'ta'},
  {id:'avoidance',cat:'행동 패턴',text:'지금 피하거나 오래 붙잡고 있는 게 있어?',sub:'전자기기, 유튜브, 게임, 해야 할 일 미루기 등. 있으면 뭔지, 얼마나 했는지도.',type:'ta'},
  {id:'anxiety',cat:'불안·걱정',text:'지금 머릿속을 맴도는 걱정이나 생각이 있어?',sub:'있다면 꺼내봐. 머릿속에 두면 계속 커진다.',type:'ta'},
  {id:'compare',cat:'비교·자책',text:'요즘 타인과 비교하거나 스스로를 자책하는 일이 있어?',sub:'어떤 상황에서 그런 생각이 드는지.',type:'ta'},
];
const Q_INSIGHTS={
  mood:{tag:"생각의 실체",text:"머릿속에서 논문처럼 느껴지는 것도 꺼내보면 두 줄이 된다. 지금 상태를 말로 꺼낸 것 자체가 이미 절반이다."},
  body:{
    ok:{tag:"중심 가치",text:"몸이 받쳐줄 때 할 수 있는 것들이 다르다. 지금이 그 때다."},
    warn:{tag:"중심 가치",text:"지금 느끼는 것의 일부가 몸에서 오는 것일 수 있다. 몸과 마음은 이어져 있다."},
    bad:{tag:"중심 가치",text:"몸이 먼저다. 몸이 망가진 채로 억지로 하는 건 효율이 없다는 걸 경험으로 알잖아."}
  },
  reality:{tag:"생각의 실체",text:"지금 내 상황을 꺼내보는 것 자체가 이미 현실을 직시하는 거야. 머릿속에서 흐릿하게 두면 실체가 없다."},
  tasks:{tag:"불안",text:"머릿속에 걸려 있는 것들은 꺼내야 크기가 보인다. 해야 할 일은 생각 속에선 항상 실제보다 크게 느껴져."},
  avoidance:{tag:"가짜 보상",text:"끌린다고 원하는 게 아닐 수 있다. 직접 해봤을 때 끝이 어땠는지 기억하면 답이 나온다."},
  anxiety:{tag:"불안",text:"걱정의 99%는 일어나지 않는다. 꺼내보면 생각보다 단순한 경우가 많아."},
  compare:{tag:"나를 대하는 방식",text:"비교할 때 내가 왜 지금 이 노력을 하고 있는지 근본적인 이유를 다시 떠올려봐."},
};

// ── 상태 ─────────────────────────────────────────────────
let API_KEY=localStorage.getItem('groq_key')||'';
let memos=JSON.parse(localStorage.getItem('memos_v5')||'[]');
let philCards=JSON.parse(localStorage.getItem('phil_cards')||'null')||JSON.parse(JSON.stringify(BASE_PHIL));
let questionSet=JSON.parse(localStorage.getItem('question_set')||'null')||JSON.parse(JSON.stringify(BASE_QUESTIONS));
let aiSettings=JSON.parse(localStorage.getItem('ai_settings')||'{}');
let questions=[],curQ=0,answers={};
let lastResult=null; // 결과 저장용

window.onload=()=>{renderMemos();renderResultList();renderApiStatus();loadSavedKey();loadAiSettings();renderPhilEdit();renderQEdit();initRewardData();renderRewards();renderMetricsPanel();initMeTab();renderMeTab();renderInboxCatSelect&&renderInboxCatSelect();};

// ── 탭 ───────────────────────────────────────────────────
function goTab(t){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+t).classList.add('active');
  ['me','memo','inbox','reward','check','settings'].forEach((n,i)=>{
    if(n===t)document.querySelectorAll('.tab-btn')[i].classList.add('active');
  });
  if(t==='me'){
    // todoItems 최신화 후 렌더
    todoItems=JSON.parse(localStorage.getItem('todo_items')||'[]');
    renderMeTab();
  }
  if(t==='memo'){renderMemos();renderResultList();renderMetricsPanel();}
  if(t==='reward')renderRewards();
  if(t==='inbox'){renderInbox();}
}

// ── 나 탭 ────────────────────────────────────────────────
let profileData=JSON.parse(localStorage.getItem('profile_data')||'{}');

function initMeTab(){
  profileData=JSON.parse(localStorage.getItem('profile_data')||'{}');
  const nameInp=document.getElementById('meNameInp');
  const tagInp=document.getElementById('meTaglineInp');
  if(nameInp)nameInp.value=profileData.name||'';
  if(tagInp)tagInp.value=profileData.tagline||'';
  // todoItems 최신화
  todoItems=JSON.parse(localStorage.getItem('todo_items')||'[]');
  if(profileData.avatar){
    const img=document.getElementById('meAvatarImg');
    const canvas=document.getElementById('meAvatarCanvas');
    if(img){img.src=profileData.avatar;img.style.display='block';}
    if(canvas)canvas.style.display='none';
  } else {
    drawMeAvatar(profileData.name||'나');
  }
}

function drawMeAvatar(name){
  const canvas=document.getElementById('meAvatarCanvas');
  if(!canvas)return;
  const ctx=canvas.getContext('2d');
  const colors=['#c9a84c','#b8956a','#a07850','#8a6040'];
  const bg=colors[(name.charCodeAt(0)||65)%colors.length];
  ctx.clearRect(0,0,72,72);
  ctx.fillStyle=bg;ctx.beginPath();ctx.arc(36,36,36,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='rgba(255,255,255,.15)';ctx.beginPath();ctx.arc(36,36,36,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#fff';ctx.font='bold 28px Georgia,serif';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText((name||'나')[0],36,37);
}

function saveProfileData(){
  const nameEl=document.getElementById('meNameInp');
  const tagEl=document.getElementById('meTaglineInp');
  profileData.name=(nameEl?nameEl.value:'')||'나';
  profileData.tagline=tagEl?tagEl.value:'';
  localStorage.setItem('profile_data',JSON.stringify(profileData));
  // 아바타 이름 글자 즉시 갱신 (사진 없을 때만)
  if(!profileData.avatar) drawMeAvatar(profileData.name);
}

function onAvatarUpload(e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    profileData.avatar=ev.target.result;
    localStorage.setItem('profile_data',JSON.stringify(profileData));
    const img=document.getElementById('meAvatarImg');
    const canvas=document.getElementById('meAvatarCanvas');
    if(img){img.src=ev.target.result;img.style.display='block';}
    if(canvas)canvas.style.display='none';
  };
  reader.readAsDataURL(file);
}

function renderMeTab(){
  profileData=JSON.parse(localStorage.getItem('profile_data')||'{}');
  const results=memos.filter(m=>m.type==='result');
  const checkCount=results.length;

  // 레벨 & 직책
  const lv=Math.max(1,Math.floor(checkCount/5)+1);
  const lvEl=document.getElementById('meLevelBadge');
  if(lvEl)lvEl.textContent=`Lv.${lv}`;
  const titles=['관찰자','기록자','탐색자','각성자','귀환자'];
  const classEl=document.getElementById('meClassTag');
  if(classEl)classEl.textContent=titles[Math.min(Math.floor(checkCount/5),titles.length-1)];

  // 이름/태그라인 — 항상 저장된 값으로 동기화 (포커스 중인 필드 제외)
  const nameInp=document.getElementById('meNameInp');
  const tagInp=document.getElementById('meTaglineInp');
  if(nameInp&&document.activeElement!==nameInp)nameInp.value=profileData.name||'';
  if(tagInp&&document.activeElement!==tagInp)tagInp.value=profileData.tagline||'';

  // 아바타
  if(profileData.avatar){
    const img=document.getElementById('meAvatarImg');
    const canvas=document.getElementById('meAvatarCanvas');
    if(img){img.src=profileData.avatar;img.style.display='block';}
    if(canvas)canvas.style.display='none';
  } else {
    drawMeAvatar(profileData.name||'나');
  }

  // 스탯
  const statEl=document.getElementById('meStatRow');
  if(statEl){
    const md=JSON.parse(localStorage.getItem('metrics_v1')||'[]');
    const rd=JSON.parse(localStorage.getItem('reward_data')||'{"charge":[],"drain":[]}');
    const td=JSON.parse(localStorage.getItem('todo_items')||'[]');
    statEl.innerHTML=[
      {v:checkCount,l:'체크인'},
      {v:td.filter(t=>!t.done).length,l:'할 일'},
      {v:(rd.charge||[]).length,l:'충전'},
      {v:md.length,l:'지표'},
    ].map(s=>`<div class="me-stat"><div class="me-stat-v">${s.v}</div><div class="me-stat-l">${s.l}</div></div>`).join('');
  }

  renderMeTodo();
  renderMeMetrics();
  renderMeResults();
  renderMePhil();
}

// ── Todo ────────────────────────────────────────────────
let todoItems=JSON.parse(localStorage.getItem('todo_items')||'[]');

function saveTodos(){
  localStorage.setItem('todo_items',JSON.stringify(todoItems));
}

function renderMeTodo(){
  const el=document.getElementById('meTodoList');if(!el)return;
  const active=todoItems.filter(t=>!t.done);
  const done=todoItems.filter(t=>t.done);
  const all=[...active,...done];
  if(all.length===0){
    el.innerHTML=`<div class="me-todo-empty">집중할 일이 없어.<br>체크 탭에서 Task를 입력하면<br>여기 자동으로 올라와.</div>`;
    return;
  }
  el.innerHTML=all.map(t=>{
    const realIdx=todoItems.indexOf(t);
    const tagClass=t.priority==='high'?'high':t.priority==='mid'?'mid':'low';
    const tagLabel=t.priority==='high'?'🔴 핵심':t.priority==='mid'?'🟡 일반':'🟢 여유';

    // 막힌 이유 태그
    const blockLabels={fear:'😨 두려움',boring:'😑 귀찮음',unclear:'❓ 불명확',energy:'🔋 에너지 없음',waiting:'⏸ 기다리는 것 있음'};
    const blockTag=t.blockReason?`<span class="me-todo-block-tag">${blockLabels[t.blockReason]||t.blockReason}</span>`:'';

    // 에너지 요구도
    const energyLabels={high:'⚡ 고집중',mid:'🔆 중간',low:'☁ 루틴'};
    const energyClass=t.energyReq||'';
    const energyTag=t.energyReq?`<span class="me-todo-energy-tag ${energyClass}">${energyLabels[t.energyReq]||''}</span>`:'';

    // 실행 트리거
    const triggerHtml=t.trigger?`<div class="me-todo-trigger">▷ ${esc(t.trigger)}</div>`:'';

    // 완료 회고
    const retroHtml=t.done&&t.retro?`<div class="me-todo-retro">💬 ${esc(t.retro)}</div>`:'';

    const metaHtml=(blockTag||energyTag)?`<div class="me-todo-meta">${blockTag}${energyTag}</div>`:'';

    return `<div class="me-todo-item${t.done?' done':''}" onclick="toggleTodo(${realIdx})">
      <div class="me-todo-check">${t.done?'✓':''}</div>
      <div style="flex:1;min-width:0">
        <div style="display:flex;align-items:flex-start;gap:6px">
          <div class="me-todo-text" style="flex:1">${esc(t.text)}${t.longTask?'<span style="font-size:9px;margin-left:5px;opacity:.6">⏳</span>':''}</div>
          ${t.priority?`<span class="me-todo-tag ${tagClass}">${tagLabel}</span>`:''}
        </div>
        ${metaHtml}
        ${triggerHtml}
        ${retroHtml}
      </div>
      <button class="me-todo-edit-btn" onclick="event.stopPropagation();openTodoEdit(${realIdx})">✎</button>
      <button class="me-todo-del" onclick="event.stopPropagation();deleteTodo(${realIdx})">×</button>
    </div>`;
  }).join('');
}

function toggleTodo(idx){
  const t=todoItems[idx];
  if(!t)return;
  const wasActive=!t.done;
  t.done=!t.done;
  saveTodos();
  renderMeTodo();
  // 완료 전환 시 회고 팝업 (짧게)
  if(wasActive&&t.done){
    openRetroModal(idx);
  }
  // 스탯 갱신
  const statEl=document.getElementById('meStatRow');
  if(statEl){
    const activeCount=todoItems.filter(t=>!t.done).length;
    const vEls=statEl.querySelectorAll('.me-stat-v');
    if(vEls[1])vEls[1].textContent=activeCount;
  }
}

function openRetroModal(idx){
  const t=todoItems[idx];if(!t)return;
  makeModal(`
    <div class="retro-modal-title">✓ 완료!</div>
    <div class="retro-modal-task">${esc(t.text)}</div>
    <div class="todo-edit-section">
      <div class="todo-edit-section-title">어떻게 됐어?</div>
      <textarea id="retroTa" class="nds-ta" rows="2" placeholder="짧게 한 줄 — 어떻게 됐는지, 얼마나 걸렸는지..."></textarea>
    </div>
    <div class="nds-btn-row">
      <button class="nds-btn-primary" onclick="saveRetro(${idx})">기록하기</button>
      <button class="nds-btn-ghost" onclick="this.closest('.nds-modal').remove()">넘어가기</button>
    </div>
  `);
}

function saveRetro(idx){
  const val=document.getElementById('retroTa')?.value.trim();
  if(val&&todoItems[idx]){
    todoItems[idx].retro=val;
    saveTodos();
    renderMeTodo();
  }
  document.querySelector('.nds-modal')?.remove();
}

function deleteTodo(idx){
  todoItems.splice(idx,1);
  saveTodos();
  renderMeTodo();
}

function _todoModalHtml(t, isEdit){
  const p=t.priority||'high';
  const br=t.blockReason||'';
  const er=t.energyReq||'';
  const blockOpts=[
    {k:'fear',l:'😨 두려움'},
    {k:'boring',l:'😑 귀찮음'},
    {k:'unclear',l:'❓ 불명확'},
    {k:'energy',l:'🔋 에너지 없음'},
    {k:'waiting',l:'⏸ 기다리는 것 있음'},
  ];
  const energyOpts=[
    {k:'high',l:'⚡ 고집중'},
    {k:'mid',l:'🔆 중간'},
    {k:'low',l:'☁ 루틴'},
  ];
  return `
    <div class="nds-modal-title">${isEdit?'할 일 편집':'할 일 추가'}</div>
    <div class="nds-field">
      <div class="nds-field-label">할 일</div>
      <input id="todoText" class="nds-inp" placeholder="오늘 해야 할 것" value="${esc(t.text||'')}">
    </div>
    <div class="todo-edit-section">
      <div class="todo-edit-section-title">우선순위</div>
      <div style="display:flex;gap:8px">
        <button class="ws-opt${p==='high'?' sel':''}" id="prio-high" onclick="selectPrio('high')">🔴 핵심</button>
        <button class="ws-opt${p==='mid'?' sel':''}" id="prio-mid" onclick="selectPrio('mid')">🟡 일반</button>
        <button class="ws-opt${p==='low'?' sel':''}" id="prio-low" onclick="selectPrio('low')">🟢 여유</button>
      </div>
    </div>
    <div class="todo-edit-section">
      <div class="todo-edit-section-title">에너지 요구도</div>
      <div class="todo-energy-opts">
        ${energyOpts.map(o=>`<button class="todo-energy-opt${er===o.k?' sel '+o.k:''}" data-energy="${o.k}" onclick="selectTodoOpt('todoEnergyReq','${o.k}',this,'todo-energy-opt','sel '+this.dataset.energy)">${o.l}</button>`).join('')}
      </div>
      <input type="hidden" id="todoEnergyReq" value="${er}">
    </div>
    <div class="todo-edit-section">
      <div class="todo-edit-section-title">막힌 이유 (선택)</div>
      <div class="todo-block-opts">
        ${blockOpts.map(o=>`<button class="todo-block-opt${br===o.k?' sel':''}" data-block="${o.k}" onclick="selectTodoOpt('todoBlockReason','${o.k}',this,'todo-block-opt','sel')">${o.l}</button>`).join('')}
      </div>
      <input type="hidden" id="todoBlockReason" value="${br}">
    </div>
    <div class="todo-edit-section">
      <div class="todo-edit-section-title">실행 트리거 — 지금 당장 시작하면 뭐부터?</div>
      <input id="todoTrigger" class="nds-inp" placeholder="예: 노션 열기 / 이메일 초안 작성 / 전화 한 통" value="${esc(t.trigger||'')}">
    </div>
    <div class="nds-field">
      <div style="display:flex;align-items:center;gap:8px;margin-top:2px">
        <input type="checkbox" id="todoLongTask"${t.longTask?' checked':''} style="width:16px;height:16px;accent-color:var(--accent)">
        <label for="todoLongTask" style="font-size:13px;color:var(--textDim);cursor:pointer">⏳ 시간이 많이 필요한 일</label>
      </div>
    </div>
    ${isEdit&&(t.blockReason||t.energyReq||t.text)?`
    <div class="todo-edit-section" style="padding-top:2px">
      <button class="todo-ai-btn" onclick="runTodoAI(${t._editIdx},this)">
        ✦ AI 돌파구 제안
      </button>
      <div id="todoAiResult_${t._editIdx}" class="todo-ai-result" style="display:none"></div>
    </div>`:''}
    <div class="nds-btn-row">
      <button class="nds-btn-primary" onclick="${isEdit?`saveTodoEdit(${t._editIdx})`:'saveTodoFromModal()'}">${isEdit?'저장':'추가'}</button>
      <button class="nds-btn-ghost" onclick="this.closest('.nds-modal').remove()">취소</button>
    </div>
  `;
}

function selectTodoOpt(inputId, val, btn, btnClass, selClass){
  const cur=document.getElementById(inputId)?.value;
  // 같은 거 다시 누르면 해제 (토글)
  const next=cur===val?'':val;
  if(document.getElementById(inputId))document.getElementById(inputId).value=next;
  btn.closest('.'+btnClass+'s, .todo-block-opts, .todo-energy-opts').querySelectorAll('.'+btnClass).forEach(b=>{
    b.classList.remove('sel');
    ['high','mid','low'].forEach(k=>b.classList.remove(k));
  });
  if(next){
    btn.classList.add('sel');
    if(next==='high'||next==='mid'||next==='low') btn.classList.add(next);
  }
}

function openTodoModal(){
  makeModal(_todoModalHtml({text:'',priority:'high',trigger:'',blockReason:'',energyReq:'',longTask:false}, false));
  window._selectedPrio='high';
}

function openTodoEdit(idx){
  const t=todoItems[idx];if(!t)return;
  t._editIdx=idx;
  makeModal(_todoModalHtml(t, true));
  window._selectedPrio=t.priority||'high';
}

function saveTodoEdit(idx){
  const text=document.getElementById('todoText')?.value.trim();
  if(!text){showToast('내용을 입력해줘');return;}
  const t=todoItems[idx];if(!t)return;
  t.text=text;
  t.priority=window._selectedPrio||t.priority||'mid';
  t.trigger=document.getElementById('todoTrigger')?.value.trim()||'';
  t.blockReason=document.getElementById('todoBlockReason')?.value||'';
  t.energyReq=document.getElementById('todoEnergyReq')?.value||'';
  t.longTask=document.getElementById('todoLongTask')?.checked||false;
  saveTodos();
  document.querySelector('.nds-modal')?.remove();
  renderMeTodo();showToast('수정됐어!');
}

// ── Todo AI 돌파구 분석 ─────────────────────────────────────
async function runTodoAI(idx, btnEl){
  if(!API_KEY){
    const res=document.getElementById('todoAiResult_'+idx);
    if(res){res.style.display='block';res.innerHTML='<div style="font-size:12px;color:var(--textF)">API 키가 없어. 설정 탭에서 추가해줘.</div>';}
    return;
  }
  const t=todoItems[idx];
  if(!t)return;

  const resEl=document.getElementById('todoAiResult_'+idx);
  if(!resEl)return;
  resEl.style.display='block';
  resEl.innerHTML=`<div class="todo-ai-result-loading"><div class="spinner" style="width:14px;height:14px"></div>분석 중...</div>`;
  if(btnEl){btnEl.disabled=true;btnEl.textContent='분석 중...';}

  // 오늘 체크인 상태 (있으면)
  const stateCtx=['mood','body','energy','avoidance']
    .map(k=>wsAnswers[k]?`${k}: ${wsAnswers[k]}`:'')
    .filter(Boolean).join(', ');

  const blockLabels={fear:'두려움 (하기 싫거나 결과가 무서워)',boring:'귀찮음 (동기 부족)',unclear:'불명확 (뭘 해야 할지 모르겠음)',energy:'에너지 없음 (몸·정신이 지쳐있음)',waiting:'기다리는 것 있음 (외부 의존)'};
  const energyLabels={high:'고집중 필요',mid:'보통',low:'루틴·저에너지 가능'};

  const taskInfo=`할 일: "${t.text}"
우선순위: ${t.priority==='high'?'핵심':t.priority==='mid'?'일반':'여유'}
에너지 요구도: ${energyLabels[t.energyReq]||'미입력'}
막힌 이유: ${blockLabels[t.blockReason]||'미입력'}
실행 트리거(기존): ${t.trigger||'없음'}
장기 작업: ${t.longTask?'예':'아니오'}`;

  const retroCtx=todoItems
    .filter(ti=>ti.done&&ti.retro&&ti.text)
    .slice(0,5)
    .map(ti=>`- "${ti.text}" → ${ti.retro}`)
    .join('\n');

  const prompt=`${stateCtx?`오늘 상태: ${stateCtx}\n\n`:''}${taskInfo}

${retroCtx?`[이 사람의 최근 완료 회고]\n${retroCtx}\n\n`:''}이 할 일을 지금 실행에 옮기도록 도와줘.

출력 형식 — JSON만:
{
  "diagnosis": "막힌 이유를 한 줄로 짚어줘. 구체적으로, 일반론 금지.",
  "approach": "이 상황에서 가장 현실적인 돌파 전략 1~2문장.",
  "steps": ["지금 당장 할 수 있는 첫 물리적 행동", "두 번째 스텝", "세 번째 스텝"],
  "trigger": "실행 트리거 한 줄 (기존 것 있으면 개선, 없으면 새로 제안)"
}

특수문자(**,#,*) 금지. 구어체. JSON만.`;

  try{
    const raw=await callAI(prompt,500);
    const clean=raw.replace(/```json|```/g,'').trim();
    const data=JSON.parse(clean.slice(clean.indexOf('{'),clean.lastIndexOf('}')+1));

    resEl.innerHTML=`
      <div class="todo-ai-block">
        <div class="todo-ai-block-label">진단</div>
        <div class="todo-ai-block-text">${esc(data.diagnosis||'')}</div>
      </div>
      <div class="todo-ai-block">
        <div class="todo-ai-block-label">돌파 전략</div>
        <div class="todo-ai-block-text">${esc(data.approach||'')}</div>
      </div>
      <div class="todo-ai-block">
        <div class="todo-ai-block-label">지금 바로 할 것</div>
        ${(data.steps||[]).map((s,i)=>`<div class="todo-ai-step">
          <div class="todo-ai-step-num">${i+1}</div>
          <div class="todo-ai-step-text">${esc(s)}</div>
        </div>`).join('')}
      </div>
      ${data.trigger?`<div class="todo-ai-block">
        <div class="todo-ai-block-label">실행 트리거 제안</div>
        <div class="todo-ai-block-text">${esc(data.trigger)}</div>
        <button class="todo-ai-apply-btn" onclick="applyAiTrigger(${idx},'${esc(data.trigger).replace(/'/g,'&#39;')}')">트리거로 저장</button>
      </div>`:''}`;

    if(btnEl){btnEl.disabled=false;btnEl.innerHTML='✦ AI 돌파구 제안';}
  }catch(e){
    resEl.innerHTML=`<div style="font-size:12px;color:var(--red)">${esc(e.message)}</div>`;
    if(btnEl){btnEl.disabled=false;btnEl.innerHTML='✦ AI 돌파구 제안';}
  }
}

function applyAiTrigger(idx, triggerText){
  // 트리거 input에 값 채워주기
  const inp=document.getElementById('todoTrigger');
  if(inp)inp.value=triggerText;
  // 즉시 저장하지 않고 사용자가 확인 후 저장하도록
  showToast('트리거 입력란에 채워줬어. 저장 버튼 눌러줘!');
}

function selectPrio(p){
  window._selectedPrio=p;
  ['high','mid','low'].forEach(k=>{
    const btn=document.getElementById('prio-'+k);
    if(btn)btn.classList.toggle('sel',k===p);
  });
}

function saveTodoFromModal(){
  const text=document.getElementById('todoText')?.value.trim();
  if(!text){showToast('내용을 입력해줘');return;}
  todoItems.unshift({
    id:Date.now(),text,
    priority:window._selectedPrio||'mid',
    trigger:document.getElementById('todoTrigger')?.value.trim()||'',
    blockReason:document.getElementById('todoBlockReason')?.value||'',
    energyReq:document.getElementById('todoEnergyReq')?.value||'',
    longTask:document.getElementById('todoLongTask')?.checked||false,
    done:false,date:new Date().toLocaleDateString('ko-KR')
  });
  saveTodos();
  document.querySelector('.nds-modal')?.remove();
  renderMeTodo();showToast('추가됐어!');
}

// 체크 워크시트에서 task 가져오기
function importTasksFromWs(wsAns){
  const taskKeys=['task1','task2','task3'];
  let added=0;
  taskKeys.forEach((key,ki)=>{
    const raw=wsAns[key];
    if(!raw)return;
    // task_item 객체 or 구버전 문자열 처리
    const text=typeof raw==='object'?(raw.text||'').trim():raw.trim();
    const longTask=typeof raw==='object'?!!raw.longTask:false;
    if(!text)return;
    if(todoItems.find(t=>t.text===text))return;
    const priority=ki===0?'high':ki===1?'high':'mid';
    todoItems.unshift({
      id:Date.now()+Math.random(),
      text,priority,longTask,done:false,
      date:new Date().toLocaleDateString('ko-KR')
    });
    added++;
  });
  if(added>0){
    saveTodos();
    // 나 탭이 현재 활성화된 경우에만 즉시 갱신
    if(document.getElementById('page-me')?.classList.contains('active')){
      renderMeTodo();
    }
    showToast(`${added}개 할 일이 나 탭에 추가됐어!`);
  }
}

// ── Task AI 정렬 ─────────────────────────────────────────
async function runTaskSort(){
  const resEl=document.getElementById('ws-ai-sorted-result');
  if(!API_KEY){resEl.innerHTML=`<div style="font-size:12px;color:var(--textF);margin-top:8px">API 키가 없어. 설정 탭에서 추가해줘.</div>`;return;}

  // 입력된 task 수집
  const tasks=[];
  ['task1','task2','task3'].forEach((key,i)=>{
    const raw=wsAnswers[key];
    const text=typeof raw==='object'?(raw.text||'').trim():((raw||'').trim());
    const longTask=typeof raw==='object'?!!raw.longTask:false;
    if(text)tasks.push({text,longTask,idx:i+1});
  });
  if(tasks.length===0){resEl.innerHTML=`<div style="font-size:12px;color:var(--textF);margin-top:8px">Task를 먼저 입력해줘.</div>`;return;}

  resEl.innerHTML=`<div style="font-size:12px;color:var(--textF);margin-top:10px;display:flex;align-items:center;gap:8px"><div class="spinner" style="width:14px;height:14px"></div>순서 분석 중...</div>`;

  // 상황 컨텍스트
  const stateCtx=['mood','body','energy','avoidance'].map(k=>wsAnswers[k]?`${k}: ${wsAnswers[k]}`:'').filter(Boolean).join(', ');
  const energyLabel={high:'고집중',mid:'중간',low:'루틴'};
  const blockLabel={fear:'두려움',boring:'귀찮음',unclear:'불명확',energy:'에너지 없음',waiting:'기다리는 것 있음'};
  const taskList=tasks.map((t,i)=>{
    const extras=[];
    if(t.longTask)extras.push('장기 작업');
    if(t.energyReq)extras.push(`에너지:${energyLabel[t.energyReq]||t.energyReq}`);
    if(t.blockReason)extras.push(`막힌이유:${blockLabel[t.blockReason]||t.blockReason}`);
    return `${i+1}. "${t.text}"${extras.length?' ['+extras.join(', ')+']':''}`;
  }).join('\n');

  const prompt=`지금 이 사람의 상태: ${stateCtx||'정보 없음'}

오늘 해야 할 Task:
${taskList}

Task 순서를 최적으로 정렬해라.
정렬 기준:
1. 장기 작업은 반드시 짧게 끝나는 작업 뒤에 배치해라. (질질 끌릴 위험 차단)
2. 단, 장기 작업은 가능한 한 이른 시간에 시작할 수 있도록 앞에 배치된 짧은 작업과 묶어라.
3. 에너지 상태에 따라 — 방전 상태면 쉬운 것 먼저, 충전 상태면 핵심부터
4. 인지 부하 순서 — 집중이 필요한 것은 앞에, 루틴적인 것은 뒤에
5. 각 순서마다 이유를 한 줄로 설명해라.

특수문자 금지. JSON만 출력:
[{"text":"task 내용","reason":"순서 이유 한 줄","tag":"long 또는 short"}]`;

  try{
    const raw=await callAI(prompt,500);
    const clean=raw.replace(/\`\`\`json|\`\`\`/g,'').trim();
    const arr=JSON.parse(clean.slice(clean.indexOf('['),clean.lastIndexOf(']')+1));
    resEl.innerHTML=`<div class="ws-ai-sorted">
      <div class="ws-ai-sorted-title">✦ AI 추천 순서</div>
      <div class="ws-ai-task-order">${arr.map((t,i)=>`<div class="ws-ai-task-item">
        <div class="ws-ai-task-num">${i+1}</div>
        <div style="flex:1">
          <div class="ws-ai-task-text">${esc(t.text||'')}</div>
          <div class="ws-ai-task-reason">${esc(t.reason||'')}</div>
        </div>
        ${t.tag?`<span class="ws-ai-task-tag ${t.tag==='long'?'long':'short'}">${t.tag==='long'?'⏳ 장기':'⚡ 단기'}</span>`:''}
      </div>`).join('')}
      </div>
    </div>`;
  }catch(e){
    resEl.innerHTML=`<div style="font-size:12px;color:var(--red);margin-top:8px">오류: ${esc(e.message)}</div>`;
  }
}

// ── 나 탭 — 미니 지표 그래프 ─────────────────────────────
function renderMeMetrics(){
  const el=document.getElementById('meMiniMetrics');if(!el)return;
  metricsData=JSON.parse(localStorage.getItem('metrics_v1')||'[]');
  if(metricsData.length===0){
    el.innerHTML=`<div class="me-metrics-empty">성장 지표가 없어.<br>기록 탭 → 성장 지표에서 추가해봐.</div>`;
    return;
  }
  el.innerHTML=metricsData.map((m,i)=>{
    const h=m.history||[];
    const curr=m.current||0;
    const goal=m.goal||0;
    const pct=goal>0?Math.min(100,Math.round((curr/goal)*100)):0;
    const chartHtml=h.length>=1?renderMetricChart(h,m.chartType,m.chartStyle,goal):'';
    const trend=h.length>=2?getTrend(h):'';
    return `<div class="me-metric-mini">
      <div class="me-metric-mini-header">
        <div>
          <div class="me-metric-mini-name">${esc(m.name)}</div>
          ${m.note?`<div style="font-size:10px;color:var(--textF);margin-top:1px">${esc(m.note)}</div>`:''}
        </div>
        <div style="text-align:right">
          <div>
            <span class="me-metric-mini-val">${curr}</span>
            <span class="me-metric-mini-unit"> ${esc(m.unit)}</span>
          </div>
          ${goal>0?`<div style="font-size:10px;color:var(--textF)">목표 ${goal} ${esc(m.unit)}</div>`:''}
          ${trend?`<div style="font-size:10px;color:${trend.color};margin-top:1px">${trend.label}</div>`:''}
        </div>
      </div>
      ${chartHtml}
      ${goal>0?`<div class="me-prog-bg" style="margin-top:6px"><div class="me-prog-fill" style="width:${pct}%"></div></div>
      <div class="me-prog-info" style="margin-top:3px"><span></span><span>${pct}% 달성</span></div>`:''}
      <div class="me-metric-mini-actions">
        <button class="me-metric-log-btn" onclick="openMetricLogModal(${i})">+ 기록</button>
        <button class="me-metric-edit-btn" onclick="openMetricModal(${i})">편집</button>
      </div>
    </div>`;
  }).join('');
}

function getTrend(history){
  if(history.length<2)return null;
  const last=history[history.length-1].val;
  const prev=history[history.length-2].val;
  const rawDiff=last-prev;
  if(rawDiff===0)return{label:'→ 유지',color:'var(--textF)'};
  // 부동소수점 오차 제거
  const diff=parseFloat(rawDiff.toPrecision(10));
  const sign=diff>0?'+':'';
  return diff>0
    ?{label:`▲ ${sign}${diff}`,color:'#4a7a50'}
    :{label:`▼ ${diff}`,color:'#c87070'};
}

function renderLineChart(history, goal, chartType, chartStyle){
  const type=chartType||'line';
  const style=chartStyle||'default';
  const pts=history.slice(-12);
  if(pts.length===0)return'';
  // 데이터 1개면 막대처럼 단일 점으로 표시
  if(pts.length===1){
    const isBold=style==='bold';
    const W=260,H=60,PAD_L=style==='minimal'?4:28;
    const unit=pts[0].unit||'';
    return `<div class="me-linechart-wrap"><svg viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">
      <circle cx="${PAD_L+10}" cy="${H/2}" r="${isBold?6:4}" fill="var(--accent)" stroke="var(--surface)" stroke-width="2"/>
      <text x="${PAD_L+22}" y="${H/2+4}" font-size="11" fill="var(--textDim)">${pts[0].val} ${unit}</text>
      <text x="${PAD_L+22}" y="${H/2+15}" font-size="9" fill="var(--textF)">${(pts[0].date||'').replace(/^\d{4}\./,'').replace(/\.$/,'')}</text>
    </svg></div>`;
  }
  const vals=pts.map(p=>p.val);
  const minV=Math.min(...vals);
  const maxV=Math.max(...vals,goal||0);
  const range=maxV-minV||1;

  // 스타일별 파라미터
  const isBold=style==='bold';
  const isMin=style==='minimal';
  const isGrad=style==='gradient';
  const strokeW=isBold?3:2;
  const dotR=isBold?3.5:2.5;
  const lastR=isBold?5:4;
  const PAD_L=isMin?4:28;

  const W=260, H=60, PAD_R=8, PAD_T=8, PAD_B=20;
  const iW=W-PAD_L-PAD_R;
  const iH=H-PAD_T-PAD_B;
  const n=pts.length;

  const cx=i=>PAD_L+Math.round((i/(n-1||1))*iW);
  const cy=v=>PAD_T+Math.round((1-(v-minV)/range)*iH);

  const lineD=pts.map((p,i)=>`${i===0?'M':'L'}${cx(i)},${cy(p.val)}`).join(' ');
  const fillD=`${lineD} L${cx(n-1)},${PAD_T+iH} L${cx(0)},${PAD_T+iH} Z`;

  // 목표선
  const goalLine=goal>0&&goal>=minV&&goal<=maxV
    ?`<line x1="${PAD_L}" y1="${cy(goal)}" x2="${W-PAD_R}" y2="${cy(goal)}" stroke="var(--accentL)" stroke-width="1" stroke-dasharray="4,3" opacity=".6"/>
      <text x="${W-PAD_R-2}" y="${cy(goal)-3}" text-anchor="end" font-size="8" fill="var(--accentL)" opacity=".8">목표</text>`
    :'';

  // Y축 레이블 (minimal 제외)
  const yLabels=!isMin?`
    <text x="${PAD_L-4}" y="${PAD_T+4}" text-anchor="end" font-size="8" fill="var(--textF)">${maxV}</text>
    <text x="${PAD_L-4}" y="${PAD_T+iH+4}" text-anchor="end" font-size="8" fill="var(--textF)">${minV}</text>`:'';

  // X축 레이블
  const d0=(pts[0].date||'').replace(/^\d{4}\./,'').replace(/\.$/,'');
  const d1=(pts[n-1].date||'').replace(/^\d{4}\./,'').replace(/\.$/,'');
  const xLabels=n>=2&&!isMin?`
    <text x="${cx(0)}" y="${H}" text-anchor="middle" font-size="8" fill="var(--textF)">${d0}</text>
    <text x="${cx(n-1)}" y="${H}" text-anchor="middle" font-size="8" fill="var(--textF)">${d1}</text>`:'';

  const gradId=`g${Math.random().toString(36).slice(2,7)}`;

  // 그래프 타입별 렌더
  let chartEl='';
  if(type==='dot'){
    // 점 전용 — 선 없음
    const allDots=pts.map((p,i)=>`<circle cx="${cx(i)}" cy="${cy(p.val)}" r="${dotR}" fill="var(--accent)" stroke="var(--surface)" stroke-width="1.5"/>`).join('');
    chartEl=`${allDots}<circle cx="${cx(n-1)}" cy="${cy(pts[n-1].val)}" r="${lastR}" fill="var(--accent)" stroke="var(--surface)" stroke-width="2"/>`;
  } else if(type==='area'){
    // 채움 강조 (영역)
    const fillOp=isGrad?'url(#'+gradId+'_area)':'var(--accentDim)';
    const areaGrad=`<linearGradient id="${gradId}_area" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="var(--accent)" stop-opacity="${isBold?'.5':'.3'}"/>
      <stop offset="100%" stop-color="var(--accent)" stop-opacity="0.05"/>
    </linearGradient>`;
    chartEl=`<defs><linearGradient id="${gradId}" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="var(--accent)" stop-opacity=".25"/><stop offset="100%" stop-color="var(--accent)" stop-opacity="0"/></linearGradient>${areaGrad}</defs>
      <path d="${fillD}" fill="${fillOp}"/>
      <path d="${lineD}" fill="none" stroke="var(--accent)" stroke-width="${strokeW}" stroke-linejoin="round" stroke-linecap="round"/>
      <circle cx="${cx(n-1)}" cy="${cy(pts[n-1].val)}" r="${lastR}" fill="var(--accent)" stroke="var(--surface)" stroke-width="2"/>`;
  } else {
    // line (기본)
    const fillOp=isGrad
      ?'url(#'+gradId+')'
      :isMin?'none':'url(#'+gradId+')';
    chartEl=`<defs><linearGradient id="${gradId}" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="var(--accent)" stop-opacity="${isBold?'.35':'.2'}"/><stop offset="100%" stop-color="var(--accent)" stop-opacity="0"/></linearGradient></defs>
      ${fillOp!=='none'?`<path d="${fillD}" fill="${fillOp}"/>` :''}
      <path d="${lineD}" fill="none" stroke="var(--accent)" stroke-width="${strokeW}" stroke-linejoin="round" stroke-linecap="round"/>
      ${isMin?'':`${pts.map((p,i)=>`<circle cx="${cx(i)}" cy="${cy(p.val)}" r="${dotR}" fill="var(--accent)" stroke="var(--surface)" stroke-width="1.5"/>`).join('')}`}
      <circle cx="${cx(n-1)}" cy="${cy(pts[n-1].val)}" r="${lastR}" fill="var(--accent)" stroke="var(--surface)" stroke-width="2"/>`;
  }

  return `<div class="me-linechart-wrap">
    <svg viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">
      <line x1="${PAD_L}" y1="${PAD_T}" x2="${PAD_L}" y2="${PAD_T+iH}" stroke="var(--border)" stroke-width="1"/>
      <line x1="${PAD_L}" y1="${PAD_T+iH}" x2="${W-PAD_R}" y2="${PAD_T+iH}" stroke="var(--border)" stroke-width="1"/>
      ${yLabels}${goalLine}${chartEl}${xLabels}
    </svg>
  </div>`;
}

// ── 나 탭 — 결과지 미니 ──────────────────────────────────
function renderMeResults(){
  const el=document.getElementById('meResultPreview');if(!el)return;
  const results=memos.filter(m=>m.type==='result');
  if(results.length===0){
    el.innerHTML=`<div class="me-metrics-empty">저장된 결과지가 없어.<br>체크 후 저장해봐.</div>`;
    return;
  }
  // 가장 최근 다짐 찾기 (나탭 상단에 강조)
  const latestCommit=results.find(m=>m.commitment);
  let commitBox='';
  if(latestCommit){
    commitBox=`<div class="me-commitment-box">
      <div class="me-commitment-label">✦ 나의 다짐</div>
      <div class="me-commitment-text">${esc(latestCommit.commitment)}</div>
      <div class="me-commitment-date">${latestCommit.ts||latestCommit.date}</div>
    </div>`;
  }

  el.innerHTML=commitBox+results.slice(0,4).map(m=>`
    <div class="me-result-mini" onclick="goTab('memo');setTimeout(()=>switchSeg('seg-results',document.querySelectorAll('.seg-btn')[1]),100)">
      <div class="me-result-mini-date">${m.ts||m.date}</div>
      <div class="me-result-mini-title">${esc((m.short||'').slice(0,50))}${(m.short||'').length>50?'…':''}</div>
      ${m.commitment?`<div style="font-size:10px;color:var(--accent);margin-top:2px">✦ 다짐 있음</div>`:''}    </div>`).join('');
}

// ── 나 탭 — 가치관 미니 그리드 ──────────────────────────
function renderMePhil(){
  const el=document.getElementById('mePhilGrid');if(!el)return;
  el.innerHTML=philCards.map(p=>`
    <div class="me-phil-mini">
      <div class="me-phil-mini-tag">${esc(p.tag)}</div>
      <div class="me-phil-mini-title">${esc(p.title)}</div>
      <div class="me-phil-mini-body">${esc(p.body)}</div>
    </div>`).join('');
}


function switchSeg(id,btn){
  document.querySelectorAll('.seg-panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.seg-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  btn.classList.add('active');
  if(id==='seg-metrics')renderMetricsPanel();
}

// ── 설정 섹션 토글 ────────────────────────────────────────
function toggleSection(id){
  const body=document.getElementById(id);
  const arr=document.getElementById('arr-'+id);
  body.classList.toggle('open');
  arr.classList.toggle('open');
}

// ── 홈 ───────────────────────────────────────────────────
function renderPhil(){
  // philEditList와 동일하게 처리 (philList DOM 없음)
  renderPhilEdit();
}

// ── API ───────────────────────────────────────────────────
function loadSavedKey(){const i=document.getElementById('apiKeyInp');if(i&&API_KEY)i.value=API_KEY;}
function renderApiStatus(){
  const el=document.getElementById('apiStatus');if(!el)return;
  el.innerHTML=API_KEY
    ?`<div class="status-dot ok"></div><span style="color:var(--green)">키 저장됨</span>`
    :`<div class="status-dot none"></div><span style="color:var(--textF)">키 없음</span>`;
}
function saveApiKey(){
  const v=document.getElementById('apiKeyInp').value.trim();
  if(!v){showToast('키를 입력해줘');return;}
  if(!v.startsWith('gsk_')){showToast('gsk_...로 시작하는 키를 입력해줘');return;}
  API_KEY=v;localStorage.setItem('groq_key',v);renderApiStatus();showToast('저장됐어');
}
async function testApiKey(){
  const inp=document.getElementById('apiKeyInp').value.trim()||API_KEY;
  const resEl=document.getElementById('testResult');resEl.style.display='none';
  if(!inp){showToast('먼저 키를 입력해줘');return;}
  showToast('테스트 중...');
  try{
    const txt=await callAI('안녕. 한 문장으로만 답해줘.',200,inp);
    resEl.className='test-result ok';resEl.textContent='✓ 연결 성공: '+txt.trim().slice(0,80);resEl.style.display='block';
  }catch(e){resEl.className='test-result err';resEl.textContent='✗ 오류: '+e.message;resEl.style.display='block';}
}

// ── AI 설정 ───────────────────────────────────────────────
function loadAiSettings(){
  const s=aiSettings;
  const aStyle=document.getElementById('setAnalysisStyle');
  const acStyle=document.getElementById('setActionStyle');
  const extra=document.getElementById('setExtraPrompt');
  if(aStyle&&s.analysisStyle)aStyle.value=s.analysisStyle;
  if(acStyle&&s.actionStyle)acStyle.value=s.actionStyle;
  if(extra&&s.extraPrompt)extra.value=s.extraPrompt;
}
function saveSettings(){
  aiSettings={
    analysisStyle:document.getElementById('setAnalysisStyle')?.value||'pattern',
    actionStyle:document.getElementById('setActionStyle')?.value||'step',
    extraPrompt:document.getElementById('setExtraPrompt')?.value||''
  };
  localStorage.setItem('ai_settings',JSON.stringify(aiSettings));
  if(fbUser)fbSaveAll();
}

// ── 가치관 편집 ───────────────────────────────────────────
function renderPhilEdit(){
  document.getElementById('philEditList').innerHTML=philCards.map((p,i)=>`
    <div class="phil-edit-item">
      <div class="phil-edit-row">
        <input class="phil-edit-tag" value="${esc(p.tag)}" oninput="philCards[${i}].tag=this.value" placeholder="태그">
        <input class="phil-edit-title" value="${esc(p.title)}" oninput="philCards[${i}].title=this.value" placeholder="제목">
      </div>
      <textarea class="phil-edit-body" oninput="philCards[${i}].body=this.value" placeholder="내용">${esc(p.body)}</textarea>
      <button class="phil-edit-del" onclick="delPhilCard(${i})">삭제</button>
    </div>`).join('');
}
function addPhilCard(){
  philCards.push({tag:'새 가치관',title:'',body:''});
  renderPhilEdit();
}
function delPhilCard(i){philCards.splice(i,1);renderPhilEdit();}
function savePhilCards(){
  localStorage.setItem('phil_cards',JSON.stringify(philCards));
  renderPhil();showToast('가치관 저장됐어');
  if(fbUser)fbSaveAll();
}
function resetPhilCards(){
  philCards=JSON.parse(JSON.stringify(BASE_PHIL));
  localStorage.setItem('phil_cards',JSON.stringify(philCards));
  renderPhil();renderPhilEdit();showToast('기본값으로 되돌렸어');
}

// ── 질문 편집 ─────────────────────────────────────────────
function renderQEdit(){
  document.getElementById('qEditList').innerHTML=questionSet.map((q,i)=>`
    <div class="q-edit-item">
      <div class="q-edit-row">
        <input class="q-edit-cat" value="${esc(q.cat)}" oninput="questionSet[${i}].cat=this.value" placeholder="카테고리">
        <input class="q-edit-text" value="${esc(q.text)}" oninput="questionSet[${i}].text=this.value" placeholder="질문">
      </div>
      <textarea class="q-edit-sub" oninput="questionSet[${i}].sub=this.value" placeholder="보조 설명">${esc(q.sub||'')}</textarea>
      <button class="q-edit-del" onclick="delQuestion(${i})">삭제</button>
    </div>`).join('');
}
function addQuestion(){
  questionSet.push({id:'q'+Date.now(),cat:'새 카테고리',text:'',sub:'',type:'ta'});
  renderQEdit();
}
function delQuestion(i){questionSet.splice(i,1);renderQEdit();}
function saveQuestionSet(){
  localStorage.setItem('question_set',JSON.stringify(questionSet));
  showToast('질문 저장됐어');
  if(fbUser)fbSaveAll();
}
function resetQuestions(){
  questionSet=JSON.parse(JSON.stringify(BASE_QUESTIONS));
  localStorage.setItem('question_set',JSON.stringify(questionSet));
  renderQEdit();showToast('기본값으로 되돌렸어');
}

// ── 데이터 ───────────────────────────────────────────────
function clearAllData(){
  if(!confirm('모든 기록을 삭제할까? 되돌릴 수 없어.'))return;
  localStorage.removeItem('memos_v5');
  memos=[];renderMemos();showToast('삭제됐어');
}

// ── 체크 ─────────────────────────────────────────────────
// ── 체크 워크시트 ────────────────────────────────────────
// 워크시트 페이지 정의
const WS_PAGES=[
  {id:'ws_situation', title:'현실 상황 파악', sub:'지금 내 환경과 맥락을 정리해봐.', icon:'📍',
   fields:[
     {key:'relations', label:'인간관계', hint:'최근 신경 쓰이는 관계나 상황', type:'text'},
     {key:'schedule',  label:'다가오는 일정', hint:'이번 주, 이번 달 주요 일정', type:'text'},
     {key:'money',     label:'돈/생활', hint:'재정 상태, 생활 환경', type:'text'},
     {key:'work',      label:'일/학업', hint:'현재 진행 중인 것, 막힌 것', type:'text'},
     {key:'body_env',  label:'몸/환경', hint:'수면, 식사, 운동, 공간 상태', type:'text'},
   ]
  },
  {id:'ws_state', title:'지금 내 상태', sub:'지금 이 순간 나의 상태를 체크해봐.', icon:'🌡',
   fields:[
     {key:'mood',      label:'지금 기분', hint:'', type:'opts', opts:['좋아','보통','별로','모르겠어']},
     {key:'body',      label:'몸 상태', hint:'', type:'opts', opts:['괜찮아','좀 피곤해','확실히 안 좋아']},
     {key:'energy',    label:'에너지 레벨', hint:'', type:'opts', opts:['충전 완료','반정도','방전 직전']},
     {key:'mind',      label:'지금 머릿속', hint:'지금 맴도는 생각, 걱정, 감정을 짧게', type:'text'},
     {key:'avoidance', label:'피하고 있는 것', hint:'지금 안 하고 있는데 해야 할 것, 붙잡고 있는 것', type:'text'},
   ]
  },
  {id:'ws_tasks', title:'오늘 집중할 것', sub:'할 일을 꺼내고, 순서를 잡아봐.', icon:'✔',
   fields:[
     {key:'task1', label:'Task 1', hint:'오늘 해야 하는 것', type:'task_item'},
     {key:'task2', label:'Task 2', hint:'', type:'task_item'},
     {key:'task3', label:'Task 3', hint:'여유 있으면 하는 것', type:'task_item'},
     {key:'stuck', label:'막혀 있는 것', hint:'어디서 멈췄는지, 뭐가 막혔는지', type:'text'},
     {key:'reward_pick', label:'진짜 보상으로 뭘 할 거야?', hint:'', type:'reward_pick'},
   ]
  },
  {id:'ws_anxiety', title:'불안 · 비교 · 자책', sub:'머릿속에 두면 계속 커진다. 꺼내봐.', icon:'💭',
   fields:[
     {key:'anxiety',   label:'지금 걱정되는 것', hint:'일어날 것 같은 나쁜 일, 막연한 불안', type:'text'},
     {key:'compare',   label:'비교하고 있는 것', hint:'누구와, 무엇을 비교하고 있는지', type:'text'},
     {key:'self_crit', label:'자책하고 있는 것', hint:'스스로를 어떻게 공격하고 있는지', type:'text'},
     {key:'reality_check', label:'실제로 지금 일어나고 있는가?', hint:'아니라면 — 지금 당장 할 수 있는 것 한 가지', type:'text'},
   ]
  },
];

let wsAnswers={};
let wsPage=0;

function startCheck(){
  if(!API_KEY){goTab('settings');showToast('먼저 API 키를 설정해줘');return;}
  wsAnswers={};wsPage=0;
  goTab('check');renderWsPage();
}

function renderWsPage(){
  const page=WS_PAGES[wsPage];
  const isLast=wsPage===WS_PAGES.length-1;
  const pct=Math.round((wsPage/WS_PAGES.length)*100);

  const fieldsHtml=page.fields.map(f=>{
    const val=wsAnswers[f.key]||'';
    if(f.type==='opts'){
      return `<div class="ws-field">
        <div class="ws-field-label">${f.label}</div>
        <div class="ws-opts-row" id="opts_${f.key}">
          ${f.opts.map(o=>`<button class="ws-opt${val===o?' sel':''}"
            onclick="wsSelectOpt('${f.key}','${o.replace(/'/g,"&#39;")}')">${o}</button>`).join('')}
        </div>
      </div>`;
    }
    if(f.type==='task_item'){
      // task_item: 텍스트 입력 + 시간이 많이 필요한가 토글
      const taskData=wsAnswers[f.key]||{text:'',longTask:false};
      const taskText=typeof taskData==='string'?taskData:(taskData.text||'');
      const longTask=typeof taskData==='object'&&taskData.longTask;
      return `<div class="ws-field ws-task-field" id="tf_${f.key}">
        <div class="ws-field-label">${f.label}${f.hint?`<span class="ws-field-hint"> — ${f.hint}</span>`:''}</div>
        <input class="ws-inp" id="wsinp_${f.key}" value="${esc(taskText)}"
          placeholder="할 일 입력..."
          oninput="wsSetTask('${f.key}','text',this.value)">
        <div class="ws-task-meta">
          <button class="ws-task-toggle${longTask?' active':''}" onclick="wsToggleLong('${f.key}')">
            ⏳ 시간이 많이 필요한 일
          </button>
          ${longTask?'<span class="ws-task-long-badge">장기 작업 — 최대한 빨리 시작할수록 좋아</span>':''}
        </div>
      </div>`;
    }
    if(f.type==='reward_pick'){
      const rd=JSON.parse(localStorage.getItem('reward_data')||'{"charge":[],"drain":[]}');
      const charges=rd.charge||[];
      return `<div class="ws-field">
        <div class="ws-field-label">${f.label}</div>
        <div class="ws-field-hint">충전 LIST에서 선택해봐</div>
        ${charges.length===0
          ?`<div class="ws-reward-empty">보상 탭에서 충전 활동을 먼저 추가해줘</div>`
          :`<div class="ws-opts-row" id="opts_${f.key}">
            ${charges.map(c=>`<button class="ws-opt ws-reward-opt${val===c.name?' sel':''}"
              onclick="wsSelectOpt('${f.key}','${c.name.replace(/'/g,"&#39;")}')">${c.emoji||'🌿'} ${c.name}</button>`).join('')}
          </div>`
        }
      </div>`;
    }
    // text
    return `<div class="ws-field">
      <div class="ws-field-label">${f.label}${f.hint?`<span class="ws-field-hint"> — ${f.hint}</span>`:''}</div>
      <input class="ws-inp" id="wsinp_${f.key}" value="${esc(val)}"
        placeholder=""
        oninput="wsAnswers['${f.key}']=this.value">
    </div>`;
  }).join('');

  document.getElementById('checkContent').innerHTML=`
    <div class="ws-wrap">
      <div class="ws-prog-row">
        <div class="ws-prog-bg"><div class="ws-prog-fill" style="width:${pct}%"></div></div>
        <span class="ws-prog-lbl">${wsPage+1} / ${WS_PAGES.length}</span>
      </div>
      <div class="ws-page-header">
        <span class="ws-page-icon">${page.icon}</span>
        <div>
          <div class="ws-page-title">${page.title}</div>
          <div class="ws-page-sub">${page.sub}</div>
        </div>
      </div>
      <div class="ws-fields">${fieldsHtml}</div>
      ${page.id==='ws_tasks'?`<div class="ws-ai-sort-row">
        <button class="ws-ai-sort-btn" onclick="runTaskSort()">✦ AI 추천 순서 정렬</button>
        <div id="ws-ai-sorted-result"></div>
      </div>`:''}
      <div class="ws-nav">
        ${wsPage>0?`<button class="ws-btn-back" onclick="wsPrev()">← 이전</button>`:''}
        <button class="ws-btn-next" onclick="wsNext()">${isLast?'결과 보기 →':'다음 →'}</button>
      </div>
    </div>`;
}

function wsSelectOpt(key,val){
  wsAnswers[key]=val;
  // 버튼 상태 업데이트
  document.querySelectorAll(`#opts_${key} .ws-opt`).forEach(b=>{
    b.classList.toggle('sel', b.textContent.trim()===val||b.getAttribute('onclick')?.includes(val));
  });
}

function wsSetTask(key,field,val){
  if(!wsAnswers[key]||typeof wsAnswers[key]==='string'){
    wsAnswers[key]={text:typeof wsAnswers[key]==='string'?wsAnswers[key]:'',longTask:false};
  }
  wsAnswers[key][field]=val;
}
function wsToggleLong(key){
  if(!wsAnswers[key]||typeof wsAnswers[key]==='string'){
    wsAnswers[key]={text:typeof wsAnswers[key]==='string'?wsAnswers[key]:'',longTask:false};
  }
  wsAnswers[key].longTask=!wsAnswers[key].longTask;
  renderWsPage();
}
function wsPrev(){if(wsPage>0){wsPage--;renderWsPage();}}
function wsNext(){
  wsPage++;
  if(wsPage>=WS_PAGES.length){
    todoItems=JSON.parse(localStorage.getItem('todo_items')||'[]');
    importTasksFromWs(wsAnswers);
    showResult();
  }
  else renderWsPage();
}

// 구버전 호환 (renderQ 등 외부 참조 방어)
function renderQ(){}
function onTaInput(){}
function selectOpt(){}
function prevQ(){wsPrev();}
function nextQ(){wsNext();}



// ── 결과 ─────────────────────────────────────────────────
function showResult(){
  const now=new Date();
  const ts=`${now.getFullYear()}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-result').classList.add('active');

  document.getElementById('resultContent').innerHTML=`
    <div class="res-header">
      <div><h2>지금 나의 상태</h2><div class="res-time">${ts}</div></div>
      <button class="save-result-btn" onclick="saveResult()">결과지 저장</button>
    </div>
    <div class="res-grid">
      <!-- 왼쪽: 입력 내용 -->
      <div class="res-col">
        <div class="res-col-head"><div class="res-col-title">내가 입력한 것</div></div>
        <div class="res-col-body" id="col1"></div>
      </div>
      <!-- 오른쪽: AI 요약 -->
      <div class="res-col res-ai-panel">
        <div class="res-col-head"><div class="res-col-title">AI 읽기</div></div>
        <div class="res-col-body" id="col-ai">
          <div class="res-ai-loading">
            <div class="spinner"></div>
            <div class="res-ai-loading-txt">분석 중...</div>
          </div>
        </div>
      </div>
    </div>
    <div class="res-bottom">
      <div class="res-commitment-area">
        <div class="res-commitment-lbl">✦ 오늘의 다짐 · 생각</div>
        <textarea id="resCommitTa" class="res-commitment-ta" placeholder="이 결과를 읽고 나서 드는 생각, 오늘 다짐하고 싶은 것..."></textarea>
        <button class="res-commitment-save" onclick="saveCommitment()">저장</button>
      </div>
      <div class="memo-save-area" style="margin-top:16px">
        <div class="memo-save-lbl">오늘의 메모</div>
        <div class="memo-save-sub">오늘 새롭게 알게 된 것이나 느낀 점.<br>이 기록이 다음 분석에 반영된다.</div>
        <textarea id="resMemoTa" style="min-height:70px;margin-top:4px" placeholder="오늘의 깨달음..."></textarea>
        <button class="save-m-btn" onclick="addMemoFromId('resMemoTa')">기록에 저장</button>
      </div>
      <div class="final-box" style="margin-top:14px">
        <p>완벽하지 않아도 된다.<br><strong>이걸 열었다는 것 자체가 이미 돌아오는 중이다.</strong></p>
      </div>
      <button class="restart-btn" style="margin-top:12px" onclick="startCheck()">처음부터 다시</button>
    </div>`;

  renderWsResult();
  runAnalysis();
}

// 워크시트 입력 내용을 결과지 왼쪽에 표시
function renderWsResult(){
  const el=document.getElementById('col1');if(!el)return;

  // WS_PAGES 순서대로 섹션 렌더
  const html=WS_PAGES.map(page=>{
    const fields=page.fields;
    // 이 페이지에 입력된 내용이 하나라도 있는지 확인
    const hasAny=fields.some(f=>{
      const v=wsAnswers[f.key]||'';
      return f.type==='reward_pick'?!!v:v.trim()!=='';
    });
    if(!hasAny)return'';

    const fieldsHtml=fields.map(f=>{
      const val=wsAnswers[f.key]||'';
      if(f.type==='opts'){
        if(!val)return'';
        return `<div class="res-ws-field">
          <div class="res-ws-label">${esc(f.label)}</div>
          <div class="res-ws-opts"><span class="res-ws-opt-chip">${esc(val)}</span></div>
        </div>`;
      }
      if(f.type==='task_item'){
      // task_item: 텍스트 입력 + 시간이 많이 필요한가 토글
      const taskData=wsAnswers[f.key]||{text:'',longTask:false};
      const taskText=typeof taskData==='string'?taskData:(taskData.text||'');
      const longTask=typeof taskData==='object'&&taskData.longTask;
      return `<div class="ws-field ws-task-field" id="tf_${f.key}">
        <div class="ws-field-label">${f.label}${f.hint?`<span class="ws-field-hint"> — ${f.hint}</span>`:''}</div>
        <input class="ws-inp" id="wsinp_${f.key}" value="${esc(taskText)}"
          placeholder="할 일 입력..."
          oninput="wsSetTask('${f.key}','text',this.value)">
        <div class="ws-task-meta">
          <button class="ws-task-toggle${longTask?' active':''}" onclick="wsToggleLong('${f.key}')">
            ⏳ 시간이 많이 필요한 일
          </button>
          ${longTask?'<span class="ws-task-long-badge">장기 작업 — 최대한 빨리 시작할수록 좋아</span>':''}
        </div>
      </div>`;
    }
    if(f.type==='reward_pick'){
        if(!val)return'';
        return `<div class="res-ws-field">
          <div class="res-ws-label">${esc(f.label)}</div>
          <div class="res-ws-opts"><span class="res-ws-opt-chip">🌿 ${esc(val)}</span></div>
        </div>`;
      }
      // task_item 객체 처리
      const displayVal=typeof val==='object'?(val.text||'').trim():val.trim();
      const isLong=typeof val==='object'&&val.longTask;
      if(!displayVal)return'';
      return `<div class="res-ws-field">
        <div class="res-ws-label">${esc(f.label)}${isLong?' <span style="font-size:9px;color:var(--accent)">⏳ 장기</span>':''}</div>
        <div class="res-ws-val">${esc(displayVal)}</div>
      </div>`;
    }).filter(Boolean).join('');

    if(!fieldsHtml)return'';
    return `<div class="res-ws-section">
      <div class="res-ws-section-title">
        <span class="res-ws-section-icon">${page.icon}</span>
        <span>${page.title}</span>
      </div>
      ${fieldsHtml}
    </div>`;
  }).filter(Boolean).join('');

  el.innerHTML=html||'<div style="color:var(--textF);font-size:13px">입력된 내용이 없어.</div>';
}

// AI 분석 — 요약 + 관련 가치관만
async function runAnalysis(){
  // wsAnswers를 읽기 좋게 텍스트로 변환
  const ctx=WS_PAGES.map(page=>{
    const lines=page.fields
      .filter(f=>{
        const v=wsAnswers[f.key];
        if(!v)return false;
        if(typeof v==='object')return(v.text||'').trim()!=='';
        return v.toString().trim()!=='';
      })
      .map(f=>{
        const v=wsAnswers[f.key];
        const txt=typeof v==='object'?(v.text||''):v;
        const suffix=typeof v==='object'&&v.longTask?' [시간이 많이 필요한 장기 작업]':'';
        return `${f.label}: ${txt}${suffix}`;
      });
    if(!lines.length)return'';
    return `[${page.title}]\n${lines.join('\n')}`;
  }).filter(Boolean).join('\n\n');

  const memCtx=memos.filter(m=>m.type==='memo').length>0
    ?`\n\n[이 사람의 이전 기록]\n${memos.filter(m=>m.type==='memo').slice(0,5).map(m=>m.text).join('\n')}`:'';

  const philCtx=philCards.length>0
    ?`\n\n[이 사람의 가치관]\n${philCards.map(p=>`- ${p.tag}: ${p.title} — ${p.body}`).join('\n')}`:'';

  // aiSettings 반영
  const aStyle=aiSettings.analysisStyle||'pattern';
  const analysisInstr=aStyle==='pattern'
    ?'답변들 사이의 패턴·연결고리·숨겨진 맥락을 짚어라. 단순 요약 금지.'
    :aStyle==='direct'?'보이는 것 그대로 직접적으로 써라.'
    :'따뜻한 톤으로, 이 사람 편에서 써라.';
  const extraInstr=aiSettings.extraPrompt?`\n추가 지시: ${aiSettings.extraPrompt}`:'';

  const prompt=`이 사람이 오늘 체크인에서 입력한 내용이다:

${ctx}${memCtx}${philCtx}

할 일:
1. 지금 상태를 3~4문장으로 요약해라. ${analysisInstr} 일반론 금지.
2. 위 가치관 중 지금 상태에 가장 관련 있는 것 2~3개를 골라라. 가치관의 표현을 그대로 살려서, 각각 왜 지금 필요한지 한 줄로 써라.${extraInstr}

특수문자(**,#,*,_,\`) 절대 금지. 구어체.

JSON만 출력:
{"summary":"요약 3~4문장","phil":[{"tag":"가치관이름","content":"가치관 핵심 한 줄","why":"지금 왜 이게 필요한지"}]}`;

  try{
    const raw=await callAI(prompt,600);
    const clean=raw.replace(/[`]/g,'').replace(/```json|```/g,'').trim();
    const data=JSON.parse(clean.slice(clean.indexOf('{'),clean.lastIndexOf('}')+1));
    lastResult={ts:new Date().toLocaleString('ko-KR'),wsAnswers:{...wsAnswers},aiData:data};

    document.getElementById('col-ai').innerHTML=`
      <div class="res-ai-summary">${esc(data.summary||'').replace(/\n/g,'<br>')}</div>
      <div class="res-ai-phil-label">꺼내볼 가치관</div>
      ${(data.phil||[]).map(p=>`<div class="res-ai-phil-item">
        <div class="res-ai-phil-tag">${esc(p.tag||'')}</div>
        <div class="res-ai-phil-content">${esc(p.content||'')}</div>
        <div class="res-ai-phil-why">↳ ${esc(p.why||'')}</div>
      </div>`).join('')}`;
  }catch(e){
    document.getElementById('col-ai').innerHTML=`<div class="res-col-body"><div style="color:var(--red);font-size:13px">${esc(e.message)}</div></div>`;
  }
}
// saveResult — 아래 4컬럼 구조 버전 사용

// ── AI 호출 (Groq) ────────────────────────────────────────
async function callAI(prompt,maxTokens=800,keyOverride=null){
  const key=keyOverride||API_KEY;
  if(!key)throw new Error('API 키가 없어. 설정 탭에서 입력해줘.');
  const res=await fetch('https://api.groq.com/openai/v1/chat/completions',{
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':`Bearer ${key}`},
    body:JSON.stringify({
      model:'llama-3.3-70b-versatile',
      max_tokens:maxTokens,
      temperature:0.7,
      messages:[{role:'system',content:'한국어로 답하라. 구어체. 특수문자(**,#,*,_,`) 금지.'},{role:'user',content:prompt}]
    })
  });
  const d=await res.json();
  if(d.error)throw new Error(d.error.message||JSON.stringify(d.error));
  return d.choices?.[0]?.message?.content||'';
}

// ── 메모 ─────────────────────────────────────────────────
function addMemoFromId(taId){
  const el=document.getElementById(taId);if(!el||!el.value.trim())return;
  memos=[{id:Date.now(),type:'memo',text:el.value.trim(),date:new Date().toLocaleDateString('ko-KR')},...memos];
  localStorage.setItem('memos_v5',JSON.stringify(memos));
  el.value='';renderMemos();showToast('저장됐어');
  if(fbUser)fbSaveAll();
}
function deleteMemo(id){
  memos=memos.filter(m=>m.id!==id);
  localStorage.setItem('memos_v5',JSON.stringify(memos));
  renderMemos();renderResultList();
  if(fbUser)fbSaveAll();
}
function renderMemos(){
  const el=document.getElementById('memoList');if(!el)return;
  const notes=memos.filter(m=>m.type==='memo');
  if(notes.length===0){el.innerHTML=`<div class="memo-empty">아직 메모가 없어.<br>오늘 깨달은 것 한 줄이라도 남겨두자.</div>`;return;}
  el.innerHTML=notes.map(m=>`<div class="memo-item">
    <div class="memo-date">${m.date}</div>
    <div class="memo-text">${esc(m.text)}</div>
    <button class="memo-del" onclick="deleteMemo(${m.id})">×</button>
  </div>`).join('');
}

function renderResultList(){
  const el=document.getElementById('resultList');if(!el)return;
  const results=memos.filter(m=>m.type==='result');
  if(results.length===0){el.innerHTML=`<div class="memo-empty">저장된 결과지가 없어.<br>체크 탭에서 결과지를 저장해봐.</div>`;return;}
  el.innerHTML=results.map(m=>{
    const id='rs_'+m.id;
    const ws=m.wsAnswers||{};
    const hasWs=Object.keys(ws).length>0;

    // 왼쪽: 입력 내용 (새 구조) or 구버전 fallback
    let leftHtml='';
    if(hasWs){
      leftHtml=WS_PAGES.map(page=>{
        const lines=page.fields.filter(f=>{
          const v=ws[f.key]||'';
          return v.toString().trim()!=='';
        });
        if(!lines.length)return'';
        return `<div class="res-ws-section">
          <div class="res-ws-section-title">
            <span class="res-ws-section-icon">${page.icon}</span>
            <span>${page.title}</span>
          </div>
          ${lines.map(f=>{
            const v=ws[f.key]||'';
            if(f.type==='opts'||f.type==='reward_pick'){
              return `<div class="res-ws-field">
                <div class="res-ws-label">${esc(f.label)}</div>
                <div class="res-ws-opts"><span class="res-ws-opt-chip">${esc(v)}</span></div>
              </div>`;
            }
            return `<div class="res-ws-field">
              <div class="res-ws-label">${esc(f.label)}</div>
              <div class="res-ws-val">${esc(v)}</div>
            </div>`;
          }).join('')}
        </div>`;
      }).filter(Boolean).join('');
    } else {
      // 구버전 호환
      const ansData=m.ansData||[];
      leftHtml=ansData.map(a=>`<div class="res-ws-field">
        <div class="res-ws-label">${esc(a.cat||a.text||'')}</div>
        <div class="res-ws-val">${esc(a.val||'')}</div>
      </div>`).join('') || `<div class="res-ws-val">${esc(m.short||m.text||'')}</div>`;
    }

    // 오른쪽: AI 요약 (새 구조) or 구버전 fallback
    let rightHtml='';
    if(m.aiSummary){
      rightHtml=`<div class="res-ai-summary">${esc(m.aiSummary).replace(/\n/g,'<br>')}</div>
        ${m.aiPhil&&m.aiPhil.length?`<div class="res-ai-phil-label">꺼내볼 가치관</div>
        ${m.aiPhil.map(p=>`<div class="res-ai-phil-item">
          <div class="res-ai-phil-tag">${esc(p.tag||'')}</div>
          <div class="res-ai-phil-content">${esc(p.content||'')}</div>
          <div class="res-ai-phil-why">↳ ${esc(p.why||'')}</div>
        </div>`).join('')}`:''}`;
    } else {
      // 구버전
      rightHtml=`<div class="res-ai-summary">${esc(m.col2||m.analysis||'').replace(/\n/g,'<br>')}</div>`;
    }

    // 다짐 영역
    const commitHtml=m.commitment
      ?`<div class="rs-commitment">
          <div class="rs-commitment-label">✦ 나의 다짐</div>
          <div class="rs-commitment-text">${esc(m.commitment)}</div>
          <div class="rs-commitment-input" style="margin-top:8px">
            <textarea id="rsc_${m.id}" class="rs-commitment-ta" placeholder="수정...">${esc(m.commitment)}</textarea>
            <button class="rs-commitment-btn" onclick="saveResultCommitment(${m.id})">저장</button>
          </div>
        </div>`
      :`<div class="rs-commitment">
          <div class="rs-commitment-label">✦ 다짐 · 생각</div>
          <div class="rs-commitment-input">
            <textarea id="rsc_${m.id}" class="rs-commitment-ta" placeholder="이 결과를 읽고 드는 생각이나 다짐을 남겨봐..."></textarea>
            <button class="rs-commitment-btn" onclick="saveResultCommitment(${m.id})">저장</button>
          </div>
        </div>`;

    return `<div class="result-sheet" id="${id}">
      <div class="result-sheet-header">
        <div>
          <div class="result-sheet-date">${m.ts||m.date}</div>
          <div class="result-sheet-title">${esc((m.short||'').slice(0,50))}${(m.short||'').length>50?'…':''}</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="result-sheet-toggle" onclick="toggleResultSheet('${id}')">접기 ▲</button>
          <button class="memo-del" style="position:static" onclick="deleteMemo(${m.id})">×</button>
        </div>
      </div>
      <div class="result-sheet-grid" id="${id}_grid">
        <div class="result-sheet-col"><div class="result-sheet-col-head">내가 입력한 것</div>
          <div style="padding:14px">${leftHtml}</div>
        </div>
        <div class="result-sheet-col res-ai-panel"><div class="result-sheet-col-head">AI 읽기</div>
          <div style="padding:14px">${rightHtml}</div>
        </div>
      </div>
      ${commitHtml}
    </div>`;
  }).join('');
}

function toggleResultSheet(id){
  const grid=document.getElementById(id+'_grid');
  const btn=document.querySelector('#'+id+' .result-sheet-toggle');
  if(!grid)return;
  const isOpen=grid.style.display!=='none';
  grid.style.display=isOpen?'none':'grid';
  if(btn)btn.textContent=isOpen?'펼치기 ▼':'접기 ▲';
}

// ── 결과지 저장 (4컬럼 구조 저장) ────────────────────────
function saveResult(){
  if(!lastResult){showToast('저장할 결과가 없어');return;}
  const ws=lastResult.wsAnswers||{};
  const aiData=lastResult.aiData||{};
  // 제목: AI summary 첫 문장 (없으면 task1 텍스트)
  const summaryFirst=(aiData.summary||'').split(/[.。！!?？]/)[0].trim().slice(0,60);
  const task1Raw=ws['task1'];
  const task1Txt=typeof task1Raw==='object'?(task1Raw.text||''):task1Raw||'';
  const short=summaryFirst||task1Txt.slice(0,60)||'오늘의 체크인';
  const commitment=document.getElementById('resCommitTa')?.value.trim()||'';
  memos=[{
    id:Date.now(),type:'result',
    date:new Date().toLocaleDateString('ko-KR'),
    ts:lastResult.ts,short,
    wsAnswers:ws,
    aiSummary:aiData.summary||'',
    aiPhil:aiData.phil||[],
    commitment
  },...memos];
  localStorage.setItem('memos_v5',JSON.stringify(memos));
  renderMemos();renderResultList();renderMeResults();renderMeTab();
  showToast('결과지 저장됐어!');
  if(fbUser)fbSaveAll();
}

// 결과지 다짐 저장 (현재 결과지 페이지에서 바로 저장)
function saveCommitment(){
  const val=document.getElementById('resCommitTa')?.value.trim();
  if(!val){showToast('다짐을 입력해줘');return;}
  if(!lastResult){showToast('먼저 결과지를 저장해줘');return;}
  // 이미 저장된 결과지가 있으면 거기에 반영, 없으면 lastResult에만
  if(memos.length>0&&memos[0].type==='result'&&memos[0].ts===lastResult.ts){
    memos[0].commitment=val;
    localStorage.setItem('memos_v5',JSON.stringify(memos));
    renderResultList();renderMeResults();renderMeTab();
    if(fbUser)fbSaveAll();
    showToast('다짐 저장됐어!');
  } else {
    lastResult.commitment=val;
    showToast('다짐 메모됐어 (결과지 저장 시 함께 저장됨)');
  }
}

// 저장된 결과지에서 다짐 수정
function saveResultCommitment(memoId){
  const ta=document.getElementById('rsc_'+memoId);
  if(!ta)return;
  const val=ta.value.trim();
  const idx=memos.findIndex(m=>m.id===memoId);
  if(idx<0)return;
  memos[idx].commitment=val;
  localStorage.setItem('memos_v5',JSON.stringify(memos));
  renderResultList();renderMeResults();renderMeTab();
  if(fbUser)fbSaveAll();
  showToast('다짐 저장됐어!');
}

// ── 성장 지표 ─────────────────────────────────────────────
let metricsData=JSON.parse(localStorage.getItem('metrics_v1')||'[]');

function renderMetricsPanel(){
  metricsData=JSON.parse(localStorage.getItem('metrics_v1')||'[]');
  const el=document.getElementById('metricsPanel');if(!el)return;
  if(metricsData.length===0){
    el.innerHTML=`<div class="memo-empty">달리기 거리, 체중, 운동 횟수 같은<br>숫자 지표를 추가해봐. 성장이 보여.</div>`;
    return;
  }
  el.innerHTML=`<div class="metric-graph-wrap">${metricsData.map((m,i)=>{
    const history=m.history||[];
    const curr=m.current||0;
    const goal=m.goal||0;
    const pct=goal>0?Math.min(100,Math.round((curr/goal)*100)):0;
    // 히스토리 바 차트
    const barHtml=history.length>=1?renderMetricChart(history,m.chartType,m.chartStyle,goal):'';
    const goalHtml=goal>0?`
      <div class="metric-progress-wrap" style="margin-top:6px">
        <div class="metric-progress-bg"><div class="metric-progress-fill" style="width:${pct}%"></div></div>
        <div class="metric-progress-pct">${pct}% 달성</div>
      </div>`:'';
    return `<div class="metric-graph-item" style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px 16px">
      <div class="metric-graph-header">
        <span class="metric-graph-name">${esc(m.name)}</span>
        <span><span class="metric-graph-val">${curr}</span><span class="metric-graph-unit">${esc(m.unit)}</span>${goal>0?`<span class="metric-graph-goal"> / 목표 ${goal}${esc(m.unit)}</span>`:''}</span>
      </div>
      ${barHtml}
      ${goalHtml}
      <div class="metric-note-row" style="margin-top:6px">
        <span class="metric-note">${esc(m.note||'')}</span>
        <div style="display:flex;gap:8px">
          <button class="metric-edit-btn" onclick="openMetricLogModal(${i})">+ 기록</button>
          <button class="metric-edit-btn" onclick="openMetricModal(${i})">편집 ✎</button>
        </div>
      </div>
    </div>`;
  }).join('')}</div>`;
}

// ── 통합 그래프 렌더러 ────────────────────────────────────
function renderMetricChart(history, chartType, chartStyle, goal){
  if(!history||history.length<1)return'';
  const type=chartType||'line';
  const style=chartStyle||'default';
  if(type==='bar') return renderBarChart(history, style, goal);
  return renderLineChart(history, goal, type, style);
}

function renderBarChart(history, style, goal){
  if(!history||history.length<1)return'';
  if(history.length===1){
    const p=history[0];
    const W=260,H=52,PAD_L=style==='minimal'?4:28;
    const d=(p.date||'').replace(/^\d{4}\./,'').replace(/\.$/,'');
    const barH=Math.max(8,Math.round((p.val/(goal||p.val||1))*40));
    return `<div class="me-linechart-wrap" style="margin-bottom:6px"><svg viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">
      <rect x="${PAD_L}" y="${H-barH-12}" width="24" height="${barH}" rx="3" fill="var(--accent)" opacity=".85"/>
      <text x="${PAD_L+12}" y="${H-1}" text-anchor="middle" font-size="8" fill="var(--textF)">${d}</text>
      <text x="${PAD_L+36}" y="${H-12}" font-size="11" fill="var(--textDim)">${p.val}</text>
    </svg></div>`;
  }
  const pts=history.slice(-10);
  const maxV=Math.max(...pts.map(h=>h.val),goal||0,0.1);
  const H=52; // 차트 높이 px
  const isBold=style==='bold';
  const isMin=style==='minimal';
  const isGrad=style==='gradient';

  const barColor=isGrad?'url(#bg_'+style+')':'var(--accent)';
  const gradDef=isGrad?`<defs><linearGradient id="bg_${style}" x1="0" y1="0" x2="0" y2="1">
    <stop offset="0%" stop-color="var(--accentL)" stop-opacity="1"/>
    <stop offset="100%" stop-color="var(--accent)" stop-opacity=".6"/>
  </linearGradient></defs>`:'';

  const W=260, PAD_L=isMin?4:28, PAD_R=8, PAD_T=6, PAD_B=18;
  const iW=W-PAD_L-PAD_R;
  const n=pts.length;
  const colW=Math.floor(iW/n);
  const barW=Math.max(4, colW-(isBold?2:6));
  const iH=H-PAD_T-PAD_B;

  const bars=pts.map((p,i)=>{
    const bh=Math.max(2,Math.round((p.val/maxV)*iH));
    const x=PAD_L+i*colW+(colW-barW)/2;
    const y=PAD_T+iH-bh;
    const d=(p.date||'').replace(/^\d{4}\./,'').replace(/\.$/,'');
    const r=isBold?3:2;
    return `<rect x="${x}" y="${y}" width="${barW}" height="${bh}" rx="${r}" fill="${barColor}" opacity="${isMin?'.6':'1'}"/>
      ${!isMin?`<text x="${x+barW/2}" y="${H}" text-anchor="middle" font-size="8" fill="var(--textF)">${d}</text>`:''}`;
  }).join('');

  // 목표선
  const goalY=goal>0?PAD_T+iH-Math.round((goal/maxV)*iH):null;
  const goalLine=goalY!==null?`<line x1="${PAD_L}" y1="${goalY}" x2="${W-PAD_R}" y2="${goalY}" stroke="var(--accentL)" stroke-width="1" stroke-dasharray="4,3" opacity=".7"/>
    <text x="${W-PAD_R-2}" y="${goalY-3}" text-anchor="end" font-size="8" fill="var(--accentL)">목표</text>`:'';

  // Y축 (minimal 제외)
  const yAxis=!isMin?`<line x1="${PAD_L}" y1="${PAD_T}" x2="${PAD_L}" y2="${PAD_T+iH}" stroke="var(--border)" stroke-width="1"/>
    <text x="${PAD_L-3}" y="${PAD_T+5}" text-anchor="end" font-size="8" fill="var(--textF)">${maxV}</text>`:'';

  return `<div class="me-linechart-wrap" style="margin-bottom:6px">
    <svg viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">
      ${gradDef}${yAxis}${goalLine}${bars}
    </svg>
  </div>`;
}

function openMetricModal(editIdx){
  const isEdit=typeof editIdx==='number'&&editIdx>=0;
  const m=isEdit?metricsData[editIdx]:{name:'',unit:'',current:0,goal:0,note:''};
  const curChart=m.chartType||'line';
  const curStyle=m.chartStyle||'default';
  makeModal(`
    <div class="nds-modal-title">${isEdit?'지표 편집':'새 지표 추가'}</div>
    <div class="nds-field">
      <div class="nds-field-label">이름</div>
      <input id="mName" class="nds-inp" placeholder="예: 달리기 거리, 체중, 운동 횟수" value="${esc(m.name)}">
    </div>
    <div class="nds-field" style="display:flex;gap:10px">
      <div style="flex:1">
        <div class="nds-field-label">단위</div>
        <input id="mUnit" class="nds-inp" placeholder="km, kg, 회" value="${esc(m.unit)}">
      </div>
      <div style="flex:1">
        <div class="nds-field-label">현재 값</div>
        <input id="mCurrent" class="nds-inp" type="number" value="${m.current||0}">
      </div>
      <div style="flex:1">
        <div class="nds-field-label">목표 (0=없음)</div>
        <input id="mGoal" class="nds-inp" type="number" value="${m.goal||0}">
      </div>
    </div>
    <div class="nds-field">
      <div class="nds-field-label">메모 (선택)</div>
      <input id="mNote" class="nds-inp" value="${esc(m.note||'')}" placeholder="짧은 메모">
    </div>
    <div class="nds-field">
      <div class="nds-field-label">그래프 유형</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="ws-opt${curChart==='line'?' sel':''}" onclick="selectChartOpt('mChartType','line',this)">📈 꺾은선</button>
        <button class="ws-opt${curChart==='bar'?' sel':''}" onclick="selectChartOpt('mChartType','bar',this)">📊 막대</button>
        <button class="ws-opt${curChart==='area'?' sel':''}" onclick="selectChartOpt('mChartType','area',this)">🏔 영역</button>
        <button class="ws-opt${curChart==='dot'?' sel':''}" onclick="selectChartOpt('mChartType','dot',this)">⚬ 점</button>
      </div>
      <input type="hidden" id="mChartType" value="${curChart}">
    </div>
    <div class="nds-field">
      <div class="nds-field-label">스타일</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="ws-opt${curStyle==='default'?' sel':''}" onclick="selectChartOpt('mChartStyle','default',this)">기본</button>
        <button class="ws-opt${curStyle==='bold'?' sel':''}" onclick="selectChartOpt('mChartStyle','bold',this)">굵게</button>
        <button class="ws-opt${curStyle==='minimal'?' sel':''}" onclick="selectChartOpt('mChartStyle','minimal',this)">미니멀</button>
        <button class="ws-opt${curStyle==='gradient'?' sel':''}" onclick="selectChartOpt('mChartStyle','gradient',this)">그라디언트</button>
      </div>
      <input type="hidden" id="mChartStyle" value="${curStyle}">
    </div>
    <div class="nds-btn-row">
      <button class="nds-btn-primary" onclick="saveMetricItem(${isEdit?editIdx:-1})">저장</button>
      ${isEdit?`<button class="nds-btn-danger" onclick="deleteMetricItem(${editIdx})">삭제</button>`:''}
      <button class="nds-btn-ghost" onclick="this.closest('.nds-modal').remove()">취소</button>
    </div>
  `);
}

function openMetricLogModal(idx){
  const m=metricsData[idx];if(!m)return;
  makeModal(`
    <div class="nds-modal-title">${esc(m.name)} 기록</div>
    <div class="nds-field">
      <div class="nds-field-label">오늘 값 (${esc(m.unit)})</div>
      <input id="logVal" class="nds-inp" type="number" placeholder="숫자 입력" style="font-size:22px;font-weight:700;text-align:center;color:var(--accent)">
    </div>
    ${m.goal>0?`<div style="font-size:12px;color:var(--textF);text-align:center;margin-top:-4px;margin-bottom:8px">현재 ${m.current}${esc(m.unit)} / 목표 ${m.goal}${esc(m.unit)}</div>`:''}
    <div class="nds-btn-row">
      <button class="nds-btn-primary" onclick="saveMetricLog(${idx})">기록하기</button>
      <button class="nds-btn-ghost" onclick="this.closest('.nds-modal').remove()">취소</button>
    </div>
  `);
}

function selectChartOpt(inputId, val, btn){
  document.getElementById(inputId).value=val;
  const row=btn.closest('div');
  row.querySelectorAll('.ws-opt').forEach(b=>b.classList.remove('sel'));
  btn.classList.add('sel');
}

function saveMetricItem(editIdx){
  const item={
    name:document.getElementById('mName').value.trim(),
    unit:document.getElementById('mUnit').value.trim(),
    current:parseFloat(document.getElementById('mCurrent').value)||0,
    goal:parseFloat(document.getElementById('mGoal').value)||0,
    note:document.getElementById('mNote').value.trim(),
    chartType:document.getElementById('mChartType')?.value||'line',
    chartStyle:document.getElementById('mChartStyle')?.value||'default',
    history:editIdx>=0?(metricsData[editIdx].history||[]):[]
  };
  if(!item.name){showToast('이름을 입력해줘');return;}
  if(editIdx>=0)metricsData[editIdx]=item;
  else metricsData.push(item);
  localStorage.setItem('metrics_v1',JSON.stringify(metricsData));
  document.querySelector('.nds-modal')?.remove();
  renderMetricsPanel();
  if(fbUser)fbSaveAll();
}

function saveMetricLog(idx){
  const val=parseFloat(document.getElementById('logVal').value);
  if(isNaN(val)){showToast('값을 입력해줘');return;}
  metricsData[idx].current=val;
  if(!metricsData[idx].history)metricsData[idx].history=[];
  metricsData[idx].history.push({val,date:new Date().toLocaleDateString('ko-KR')});
  if(metricsData[idx].history.length>30)metricsData[idx].history=metricsData[idx].history.slice(-30);
  localStorage.setItem('metrics_v1',JSON.stringify(metricsData));
  document.querySelector('.nds-modal')?.remove();
  renderMetricsPanel();renderMeMetrics();showToast('기록됐어!');
  if(fbUser)fbSaveAll();
}

function deleteMetricItem(idx){
  metricsData.splice(idx,1);
  localStorage.setItem('metrics_v1',JSON.stringify(metricsData));
  document.querySelector('.nds-modal')?.remove();
  renderMetricsPanel();
}

// ── 보상 탭 — 충전/방전 LIST ──────────────────────────────
let rewardData={charge:[],drain:[]};

function initRewardData(){
  rewardData=JSON.parse(localStorage.getItem('reward_data')||'{"charge":[],"drain":[]}');
}

function saveRewardData(){
  localStorage.setItem('reward_data',JSON.stringify(rewardData));
  if(fbUser)fbSaveAll();
}

function toggleRewardSec(type){
  const list=document.getElementById(type+'-list');
  const arr=document.getElementById('arr-'+type);
  const isOpen=arr.classList.contains('open');
  list.style.display=isOpen?'none':'block';
  arr.classList.toggle('open');
}

function renderRewards(){
  initRewardData();
  renderRewardList('charge');
  renderRewardList('drain');
  renderRealNeed();
}

function renderRewardList(type){
  const items=rewardData[type]||[];
  const el=document.getElementById(type+'-items');if(!el)return;
  if(items.length===0){
    el.innerHTML=`<div class="rw-empty">${type==='charge'
      ?'직접 해보고 좋았던 것들을 추가해봐.<br>산책, 반신욕, 운동, 좋아하는 음악 등.'
      :'끝이 안 좋았던 것들을 기록해봐.<br>유튜브 과다, 늦게까지 전자기기 등.'}</div>`;
    return;
  }
  el.innerHTML=items.map((item,i)=>{
    const logs=item.logs||[];
    const logPanelId=`${type}-log-${i}`;
    const logHtml=logs.length>0
      ?logs.slice(-5).reverse().map((l,li)=>`
        <div class="rw-log-entry">
          <span class="rw-log-date">${l.date||''}</span>
          ${l.photo?`<img class="rw-log-photo" src="${l.photo}" data-idx="${logs.length-1-li}" data-type="${type}" data-item="${i}" onclick="viewLogPhoto(this)" alt="">`:''}
          <span class="rw-log-note">${esc(l.note||'')}</span>
          <button class="rw-log-del" onclick="event.stopPropagation();deleteRewardLog('${type}',${i},${logs.length-1-li})">×</button>
        </div>`).join('')
      :`<div class="rw-log-empty">아직 기록이 없어. 오늘 해봤으면 기록해봐.</div>`;
    return `<div class="rw-card ${type}">
      <div class="rw-card-main" onclick="toggleLogPanel('${logPanelId}')">
        <span class="rw-card-emoji">${item.emoji||'·'}</span>
        <div class="rw-card-info">
          <div class="rw-card-name">${esc(item.name)}</div>
          ${item.feeling?`<div class="rw-card-feeling">${esc(item.feeling)}</div>`:''}
          ${logs.length>0?`<div class="rw-card-meta">${logs.length}회 기록됨 · 마지막 ${logs[logs.length-1].date||''}</div>`:''}
        </div>
        <div class="rw-card-actions" onclick="event.stopPropagation()">
          <button class="rw-log-btn ${type}" onclick="openRewardLogForm('${type}',${i})">+ 기록</button>
          <button class="rw-edit-btn" onclick="openRewardEditModal('${type}',${i})">✎</button>
          <button class="rw-del-btn" onclick="deleteRewardItem('${type}',${i})">삭제</button>
        </div>
      </div>
      <div class="rw-log-panel" id="${logPanelId}" style="display:none">
        ${logHtml}
      </div>
    </div>`;
  }).join('');
}

function toggleLogPanel(id){
  const el=document.getElementById(id);if(!el)return;
  el.style.display=el.style.display==='none'?'block':'none';
}

// ── 바텀시트 모달 생성 헬퍼 ──────────────────────────────
function makeModal(innerHtml){
  const modal=document.createElement('div');
  modal.className='nds-modal';
  modal.innerHTML=`<div class="nds-modal-box">
    <div class="nds-modal-handle"></div>
    <div class="nds-modal-inner">${innerHtml}</div>
  </div>`;
  document.body.appendChild(modal);
  modal.addEventListener('click',e=>{if(e.target===modal)modal.remove();});
  setTimeout(()=>modal.querySelector('input,textarea')?.focus(),100);
  return modal;
}

function openRewardModal(type){
  const isCharge=type==='charge';
  makeModal(`
    <div class="nds-modal-title">${isCharge?'💙 충전 활동 추가':'🔴 방전 활동 추가'}</div>
    <div class="nds-field">
      <div class="nds-field-label">활동 이름</div>
      <input id="rwName" class="nds-inp" placeholder="${isCharge?'예: 산책, 반신욕, 운동':'예: 유튜브 과다, 늦게까지 핸드폰'}">
    </div>
    <div class="nds-field" style="display:flex;gap:10px">
      <div style="flex:0 0 72px">
        <div class="nds-field-label">이모지</div>
        <input id="rwEmoji" class="nds-inp" value="${isCharge?'🌿':'📱'}" style="text-align:center;font-size:20px;padding:10px">
      </div>
      <div style="flex:1">
        <div class="nds-field-label">${isCharge?'실제로 어떤 느낌?':'끝나고 어떤 기분?'}</div>
        <input id="rwFeeling" class="nds-inp" placeholder="${isCharge?'예: 머리 맑아짐, 개운함':'예: 눈 아프고 피곤함, 후회됨'}">
      </div>
    </div>
    <div class="nds-btn-row">
      <button class="nds-btn-primary ${type}" onclick="saveRewardItem('${type}')">추가하기</button>
      <button class="nds-btn-ghost" onclick="this.closest('.nds-modal').remove()">취소</button>
    </div>
  `);
}

function saveRewardItem(type){
  const name=document.getElementById('rwName').value.trim();
  if(!name){showToast('이름을 입력해줘');return;}
  rewardData[type].push({
    name,
    emoji:document.getElementById('rwEmoji').value.trim()||(type==='charge'?'🌿':'📱'),
    feeling:document.getElementById('rwFeeling').value.trim(),
    logs:[]
  });
  saveRewardData();
  document.querySelector('.nds-modal')?.remove();
  renderRewardList(type);showToast('추가됐어!');
}


// ═══════════════════════════════════════════════════════════
// ── 충전탭 — 항목 편집 ─────────────────────────────────────
// ═══════════════════════════════════════════════════════════

function openRewardEditModal(type, idx){
  const item=rewardData[type][idx];if(!item)return;
  const isCharge=type==='charge';
  makeModal(`
    <div class="nds-modal-title">${isCharge?'💙 충전 활동 편집':'🔴 방전 활동 편집'}</div>
    <div class="nds-field">
      <div class="nds-field-label">활동 이름</div>
      <input id="rwEditName" class="nds-inp" value="${esc(item.name)}">
    </div>
    <div class="nds-field" style="display:flex;gap:10px">
      <div style="flex:0 0 72px">
        <div class="nds-field-label">이모지</div>
        <input id="rwEditEmoji" class="nds-inp" value="${esc(item.emoji||'')}" style="text-align:center;font-size:20px;padding:10px">
      </div>
      <div style="flex:1">
        <div class="nds-field-label">${isCharge?'실제로 어떤 느낌?':'끝나고 어떤 기분?'}</div>
        <input id="rwEditFeeling" class="nds-inp" value="${esc(item.feeling||'')}" placeholder="${isCharge?'예: 머리 맑아짐, 개운함':'예: 눈 아프고 피곤함'}">
      </div>
    </div>
    <div class="nds-btn-row">
      <button class="nds-btn-primary" onclick="saveRewardEdit('${type}',${idx})">저장</button>
      <button class="nds-btn-ghost" onclick="this.closest('.nds-modal').remove()">취소</button>
    </div>
  `);
}

function saveRewardEdit(type, idx){
  const name=document.getElementById('rwEditName')?.value.trim();
  if(!name){showToast('이름을 입력해줘');return;}
  rewardData[type][idx].name=name;
  rewardData[type][idx].emoji=document.getElementById('rwEditEmoji')?.value.trim()||(type==='charge'?'🌿':'📱');
  rewardData[type][idx].feeling=document.getElementById('rwEditFeeling')?.value.trim()||'';
  saveRewardData();
  document.querySelector('.nds-modal')?.remove();
  renderRewardList(type);showToast('수정됐어!');
}

// ── 진짜 원하는 것 ────────────────────────────────────────
let realNeedData=JSON.parse(localStorage.getItem('real_need_v1')||'[]');

function saveRealNeedData(){
  localStorage.setItem('real_need_v1',JSON.stringify(realNeedData));
}

function renderRealNeed(){
  const el=document.getElementById('real-need-area');if(!el)return;
  if(realNeedData.length===0){
    el.innerHTML=`<div class="real-need-hint">끌린다고 원하는 게 아닐 수 있어.<br>지금 내가/내 몸이 <em>진짜로</em> 필요한 게 뭔지 물어봐.</div>`;
    return;
  }
  el.innerHTML=realNeedData.slice().reverse().map((r,i)=>{
    const realIdx=realNeedData.length-1-i;
    return `<div class="real-need-entry">
      <div class="real-need-entry-text">${esc(r.text)}</div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:3px;flex-shrink:0">
        <div class="real-need-entry-date">${r.date||''}</div>
        <button class="real-need-del" onclick="deleteRealNeed(${realIdx})">×</button>
      </div>
    </div>`;
  }).join('');
}

function openRealNeedPrompt(){
  makeModal(`
    <div class="nds-modal-title">✦ 지금 진짜 필요한 게 뭐야?</div>
    <div style="font-size:12px;color:var(--textF);line-height:1.9;margin-bottom:14px">
      지금 끌리는 것 말고 —<br>
      지금 내 몸/마음이 <strong>실제로 필요로 하는 것</strong>을 생각해봐.<br>
      <span style="color:var(--accent)">피곤함? 외로움? 인정? 고요함? 움직임?</span>
    </div>
    <div class="nds-field">
      <div class="nds-field-label">지금 진짜 필요한 것</div>
      <textarea id="realNeedTa" class="nds-ta" rows="3" placeholder="예: 눈을 쉬게 하는 것 / 조용히 누워있기 / 따뜻한 것 먹기 / 산책 5분..."></textarea>
    </div>
    <div class="nds-btn-row">
      <button class="nds-btn-primary" onclick="saveRealNeed()">기록하기</button>
      <button class="nds-btn-ghost" onclick="this.closest('.nds-modal').remove()">닫기</button>
    </div>
  `);
}

function saveRealNeed(){
  const val=document.getElementById('realNeedTa')?.value.trim();
  if(!val){showToast('내용을 입력해줘');return;}
  realNeedData.push({text:val,date:new Date().toLocaleDateString('ko-KR')});
  saveRealNeedData();
  document.querySelector('.nds-modal')?.remove();
  renderRealNeed();showToast('기록됐어!');
}

function deleteRealNeed(idx){
  realNeedData.splice(idx,1);
  saveRealNeedData();renderRealNeed();
}

// renderRealNeed는 renderRewards에 직접 통합됨

// ═══════════════════════════════════════════════════════════
// ── 인박스 시스템 ──────────────────────────────────────────
// ═══════════════════════════════════════════════════════════

const INBOX_DEFAULT_CATS=[
  {id:'todo',   label:'할 일',  color:'#4a7a50'},
  {id:'idea',   label:'아이디어', color:'#8a50a0'},
  {id:'feel',   label:'감정·생각', color:'#5080a0'},
  {id:'later',  label:'나중에',  color:'#a07040'},
  {id:'misc',   label:'기타',   color:'#808080'},
];

let inboxItems=JSON.parse(localStorage.getItem('inbox_v1')||'[]');
let inboxCats=JSON.parse(localStorage.getItem('inbox_cats_v1')||JSON.stringify(INBOX_DEFAULT_CATS));
let inboxActiveCat='all';

function saveInboxData(){
  localStorage.setItem('inbox_v1',JSON.stringify(inboxItems));
  if(fbUser)fbSaveAll();
}

function renderInbox(){
  renderInboxCatTabs();
  renderInboxMessages();
  renderInboxCatSelect();
}

function renderInboxCatTabs(){
  const el=document.getElementById('inboxCatTabs');if(!el)return;
  const allCount=inboxItems.filter(m=>!m.done).length;
  let html=`<button class="inbox-cat-tab${inboxActiveCat==='all'?' active':''}" onclick="setInboxCat('all')">전체 ${allCount>0?allCount:''}</button>`;
  inboxCats.forEach(cat=>{
    const n=inboxItems.filter(m=>m.catId===cat.id&&!m.done).length;
    html+=`<button class="inbox-cat-tab${inboxActiveCat===cat.id?' active':''}" onclick="setInboxCat('${cat.id}')" style="${inboxActiveCat===cat.id?'background:'+cat.color+';border-color:'+cat.color:''}">${cat.label}${n>0?' '+n:''}</button>`;
  });
  html+=`<button class="inbox-cat-tab" onclick="openInboxCatManager()" style="opacity:.6">+ 카테고리</button>`;
  el.innerHTML=html;
}

function renderInboxCatSelect(){
  const el=document.getElementById('inboxCatSelect');if(!el)return;
  el.innerHTML=inboxCats.map(cat=>`<option value="${cat.id}">${cat.label}</option>`).join('');
}

function renderInboxMessages(){
  const el=document.getElementById('inboxMessages');if(!el)return;
  let items=inboxActiveCat==='all'?[...inboxItems]:inboxItems.filter(m=>m.catId===inboxActiveCat);
  // 미완료 최신순 → 완료 순
  const active=items.filter(m=>!m.done).sort((a,b)=>b.id-a.id);
  const done=items.filter(m=>m.done).sort((a,b)=>b.id-a.id);
  items=[...active,...done];

  if(items.length===0){
    el.innerHTML=`<div class="inbox-empty">아직 비어있어.<br>머릿속에 있는 것을 아래에 던져봐.</div>`;
    return;
  }
  const prioLabel={high:'🔴 핵심',mid:'🟡 일반',low:'🟢 여유'};
  const cat=id=>inboxCats.find(c=>c.id===id)||{label:'기타',color:'#808080'};
  el.innerHTML=items.map(m=>{
    const c=cat(m.catId);
    const realIdx=inboxItems.findIndex(x=>x.id===m.id);
    return `<div class="inbox-msg">
      <div class="inbox-bubble${m.done?' processed':''}${m.priority==='high'?' high-prio':''}">${esc(m.text)}</div>
      <div class="inbox-msg-meta">
        <span class="inbox-msg-time">${m.time||''}</span>
        <span class="inbox-msg-cat" style="background:${c.color}22;color:${c.color}">${c.label}</span>
        ${m.priority?`<span class="inbox-priority-badge ${m.priority}">${prioLabel[m.priority]||''}</span>`:''}
      </div>
      <div class="inbox-msg-actions">
        <button class="inbox-action-btn${m.done?' done':''}" onclick="toggleInboxDone(${realIdx})">${m.done?'✓ 완료':'완료'}</button>
        <button class="inbox-action-btn" onclick="openInboxItemEdit(${realIdx})">우선순위·분류</button>
        <button class="inbox-action-btn" onclick="sendToTodo(${realIdx})" title="나 탭 할일로">→ 할일</button>
        <button class="inbox-action-btn" onclick="deleteInboxItem(${realIdx})">삭제</button>
      </div>
    </div>`;
  }).join('');
  // 스크롤 최하단 (새 메시지 쪽)
  el.scrollTop=0;
}

function setInboxCat(catId){
  inboxActiveCat=catId;
  renderInboxCatTabs();
  renderInboxMessages();
}

function sendInboxItem(){
  const ta=document.getElementById('inboxInputTa');
  const text=ta?.value.trim();
  if(!text)return;
  const catId=document.getElementById('inboxCatSelect')?.value||'misc';
  const now=new Date();
  const time=`${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  inboxItems.unshift({id:Date.now(),text,catId,time,priority:'',done:false});
  saveInboxData();
  if(ta)ta.value='';
  if(ta)ta.style.height='auto';
  renderInboxMessages();
  renderInboxCatTabs();
}

function toggleInboxDone(idx){
  if(!inboxItems[idx])return;
  inboxItems[idx].done=!inboxItems[idx].done;
  saveInboxData();renderInboxMessages();renderInboxCatTabs();
}

function deleteInboxItem(idx){
  inboxItems.splice(idx,1);
  saveInboxData();renderInboxMessages();renderInboxCatTabs();
}

function sendToTodo(idx){
  const m=inboxItems[idx];if(!m)return;
  todoItems=JSON.parse(localStorage.getItem('todo_items')||'[]');
  if(todoItems.find(t=>t.text===m.text)){showToast('이미 할일에 있어');return;}
  todoItems.unshift({
    id:Date.now(),text:m.text,
    priority:m.priority||'mid',
    done:false,date:new Date().toLocaleDateString('ko-KR')
  });
  localStorage.setItem('todo_items',JSON.stringify(todoItems));
  inboxItems[idx].done=true;
  saveInboxData();renderInboxMessages();renderInboxCatTabs();
  showToast('할일 탭으로 이동됐어!');
}

function openInboxItemEdit(idx){
  const m=inboxItems[idx];if(!m)return;
  const catOpts=inboxCats.map(c=>`<option value="${c.id}"${m.catId===c.id?' selected':''}>${c.label}</option>`).join('');
  makeModal(`
    <div class="nds-modal-title">항목 설정</div>
    <div class="nds-field">
      <div class="nds-field-label">내용 (수정 불가)</div>
      <div style="font-size:13px;color:var(--text);padding:8px 0;line-height:1.7">${esc(m.text)}</div>
    </div>
    <div class="nds-field">
      <div class="nds-field-label">카테고리</div>
      <select id="ibEditCat" class="nds-inp">${catOpts}</select>
    </div>
    <div class="nds-field">
      <div class="nds-field-label">우선순위</div>
      <div style="display:flex;gap:8px">
        <button class="ws-opt${m.priority==='high'?' sel':''}" onclick="setInboxPrio('high',this)">🔴 핵심</button>
        <button class="ws-opt${m.priority==='mid'?' sel':''}" onclick="setInboxPrio('mid',this)">🟡 일반</button>
        <button class="ws-opt${m.priority==='low'?' sel':''}" onclick="setInboxPrio('low',this)">🟢 여유</button>
        <button class="ws-opt${!m.priority?' sel':''}" onclick="setInboxPrio('',this)">없음</button>
      </div>
      <input type="hidden" id="ibEditPrio" value="${m.priority||''}">
    </div>
    <div class="nds-btn-row">
      <button class="nds-btn-primary" onclick="saveInboxItemEdit(${idx})">저장</button>
      <button class="nds-btn-ghost" onclick="this.closest('.nds-modal').remove()">취소</button>
    </div>
  `);
}

function setInboxPrio(val, btn){
  document.getElementById('ibEditPrio').value=val;
  btn.closest('div').querySelectorAll('.ws-opt').forEach(b=>b.classList.remove('sel'));
  btn.classList.add('sel');
}

function saveInboxItemEdit(idx){
  inboxItems[idx].catId=document.getElementById('ibEditCat')?.value||inboxItems[idx].catId;
  inboxItems[idx].priority=document.getElementById('ibEditPrio')?.value||'';
  saveInboxData();
  document.querySelector('.nds-modal')?.remove();
  renderInboxMessages();renderInboxCatTabs();showToast('저장됐어!');
}

function openInboxCatManager(){
  const catList=inboxCats.map((c,i)=>`
    <div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border)">
      <span style="font-size:16px;width:20px;text-align:center;background:${c.color}22;border-radius:4px;padding:2px">${c.label[0]}</span>
      <span style="flex:1;font-size:13px">${esc(c.label)}</span>
      <button class="inbox-action-btn" onclick="deleteInboxCat(${i})">삭제</button>
    </div>`).join('');
  makeModal(`
    <div class="nds-modal-title">카테고리 관리</div>
    <div style="margin-bottom:14px">${catList}</div>
    <div class="nds-field">
      <div class="nds-field-label">새 카테고리</div>
      <input id="newCatName" class="nds-inp" placeholder="이름">
    </div>
    <div class="nds-btn-row">
      <button class="nds-btn-primary" onclick="addInboxCat()">추가</button>
      <button class="nds-btn-ghost" onclick="this.closest('.nds-modal').remove()">닫기</button>
    </div>
  `);
}

function addInboxCat(){
  const name=document.getElementById('newCatName')?.value.trim();
  if(!name){showToast('이름을 입력해줘');return;}
  const colors=['#4a7a50','#8a50a0','#5080a0','#a07040','#c05050','#4070c0'];
  const color=colors[inboxCats.length%colors.length];
  inboxCats.push({id:'cat_'+Date.now(),label:name,color});
  localStorage.setItem('inbox_cats_v1',JSON.stringify(inboxCats));
  document.querySelector('.nds-modal')?.remove();
  renderInbox();showToast('카테고리 추가됐어!');
}

function deleteInboxCat(i){
  const cat=inboxCats[i];
  if(['todo','idea','feel','later','misc'].includes(cat?.id)){showToast('기본 카테고리는 삭제 불가');return;}
  inboxCats.splice(i,1);
  localStorage.setItem('inbox_cats_v1',JSON.stringify(inboxCats));
  document.querySelector('.nds-modal')?.remove();
  renderInbox();
}

// ── AI 자동 분류/정리 ─────────────────────────────────────
async function runInboxAI(){
  const unprocessed=inboxItems.filter(m=>!m.done&&!m.priority);
  if(unprocessed.length===0){showToast('분류할 항목이 없어 (미완료 + 우선순위 없는 것 대상)');return;}
  if(!API_KEY){showToast('API 키가 없어. 설정 탭에서 추가해줘');return;}

  const el=document.getElementById('inboxMessages');
  const aiDiv=document.createElement('div');
  aiDiv.className='inbox-ai-result';
  aiDiv.textContent='분류 중...';
  el.prepend(aiDiv);

  const catNames=inboxCats.map(c=>`${c.id}(${c.label})`).join(', ');
  const items=unprocessed.map((m,i)=>`${i+1}. [id:${m.id}] "${m.text}"`).join('\n');

  const prompt=`다음 인박스 항목들을 분류해줘.

카테고리 목록: ${catNames}
우선순위: high(핵심), mid(일반), low(여유)

항목들:
${items}

규칙:
- 내용은 절대 변경하지 마
- 항목 관리(카테고리 지정, 우선순위 지정)만 해
- catId는 위 카테고리 목록의 id 중 하나를 사용

JSON 배열만 출력 (다른 텍스트 없이):
[{"id":항목id,"catId":"카테고리id","priority":"high|mid|low"}]`;

  try{
    const raw=await callAI(prompt,600);
    const clean=raw.replace(/```json|```/g,'').trim();
    const arr=JSON.parse(clean.slice(clean.indexOf('['),clean.lastIndexOf(']')+1));
    let changed=0;
    arr.forEach(r=>{
      const idx=inboxItems.findIndex(m=>m.id===r.id);
      if(idx>=0){
        if(r.catId)inboxItems[idx].catId=r.catId;
        if(r.priority)inboxItems[idx].priority=r.priority;
        changed++;
      }
    });
    saveInboxData();
    aiDiv.textContent=`✦ AI가 ${changed}개 항목을 분류했어. 확인해봐.`;
    setTimeout(()=>aiDiv.remove(),3000);
    renderInboxMessages();renderInboxCatTabs();
  }catch(e){
    aiDiv.textContent='AI 오류: '+e.message;
    setTimeout(()=>aiDiv.remove(),3000);
  }
}

function deleteRewardItem(type,idx){
  if(!confirm('삭제할까? 기록도 함께 사라져.'))return;
  rewardData[type].splice(idx,1);
  saveRewardData();renderRewardList(type);
}

function openRewardLogForm(type,idx){
  const item=rewardData[type][idx];if(!item)return;
  const isCharge=type==='charge';
  makeModal(`
    <div class="nds-modal-title">${item.emoji} ${esc(item.name)}</div>
    <div class="nds-field">
      <div class="nds-field-label">${isCharge?'오늘 어땠어?':'솔직하게 — 끝나고 어땠어?'}</div>
      <textarea id="rwLogNote" class="nds-ta" rows="3" placeholder="${isCharge?'예: 30분 산책했더니 머리가 맑아지고 기분이 좋아짐':'예: 2시간 봤는데 눈 아프고 시간 아깝다는 생각'}"></textarea>
    </div>
    ${isCharge?`<div class="nds-field">
      <div class="nds-field-label">사진 (선택)</div>
      <label class="nds-file-btn">
        📷 사진 선택
        <input type="file" id="rwLogPhoto" accept="image/*" style="display:none" onchange="previewLogPhoto(this)">
      </label>
      <img id="rwLogPhotoPreview" class="nds-photo-preview" alt="">
    </div>`:''}
    <div class="nds-btn-row">
      <button class="nds-btn-primary ${type}" onclick="saveRewardLog('${type}',${idx})">기록하기</button>
      <button class="nds-btn-ghost" onclick="this.closest('.nds-modal').remove()">취소</button>
    </div>
  `);
}

function previewLogPhoto(inp){
  if(!inp.files[0])return;
  const prev=document.getElementById('rwLogPhotoPreview');
  const reader=new FileReader();
  reader.onload=e=>{prev.src=e.target.result;prev.style.display='block';};
  reader.readAsDataURL(inp.files[0]);
}

async function saveRewardLog(type,idx){
  const note=document.getElementById('rwLogNote')?.value.trim()||'';
  let photo='';
  const fileEl=document.getElementById('rwLogPhoto');
  if(fileEl&&fileEl.files[0]){
    const file=fileEl.files[0];
    photo=await new Promise(res=>{const r=new FileReader();r.onload=e=>res(e.target.result);r.readAsDataURL(file);});
  }
  if(!rewardData[type][idx].logs)rewardData[type][idx].logs=[];
  rewardData[type][idx].logs.push({note,photo,date:new Date().toLocaleDateString('ko-KR')});
  saveRewardData();
  document.querySelector('.nds-modal')?.remove();
  renderRewardList(type);showToast('기록됐어!');
}

function deleteRewardLog(type,itemIdx,logIdx){
  rewardData[type][itemIdx].logs.splice(logIdx,1);
  saveRewardData();renderRewardList(type);
}

function viewLogPhoto(imgEl){
  const src=imgEl.src;
  const overlay=document.createElement('div');
  overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:600;display:flex;align-items:center;justify-content:center;cursor:pointer';
  const img=document.createElement('img');
  img.src=src;
  img.style.cssText='max-width:90vw;max-height:90vh;border-radius:8px';
  overlay.appendChild(img);
  overlay.onclick=()=>overlay.remove();
  document.body.appendChild(overlay);
}
function viewPhoto(src){
  const overlay=document.createElement('div');
  overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:600;display:flex;align-items:center;justify-content:center;cursor:pointer';
  const img=document.createElement('img');
  img.src=src;
  img.style.cssText='max-width:90vw;max-height:90vh;border-radius:8px';
  overlay.appendChild(img);
  overlay.onclick=()=>overlay.remove();
  document.body.appendChild(overlay);
}

function exportData(){
  const data={
    version:2,exportedAt:new Date().toISOString(),
    memos,philCards,questionSet,aiSettings,
    rewardData:JSON.parse(localStorage.getItem('reward_data')||'{"charge":[],"drain":[]}'),
    metricsV1:JSON.parse(localStorage.getItem('metrics_v1')||'[]')
  };
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;
  a.download=`나의돌아오는시스템_백업_${new Date().toLocaleDateString('ko-KR').replace(/\. /g,'-').replace('.','')}.json`;
  a.click();URL.revokeObjectURL(url);showToast('내보내기 완료!');
}

function importData(e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    try{
      const data=JSON.parse(ev.target.result);
      if(!data.version)throw new Error('올바른 백업 파일이 아니야.');
      if(!confirm(`${data.exportedAt?.slice(0,10)||'알 수 없는 날짜'} 백업을 불러올까? 현재 데이터는 덮어씌워져.`))return;
      if(data.memos){memos=data.memos;localStorage.setItem('memos_v5',JSON.stringify(memos));renderMemos();renderResultList();}
      if(data.philCards){philCards=data.philCards;localStorage.setItem('phil_cards',JSON.stringify(philCards));renderPhil();renderPhilEdit();}
      if(data.questionSet){questionSet=data.questionSet;localStorage.setItem('question_set',JSON.stringify(questionSet));renderQEdit();}
      if(data.aiSettings){aiSettings=data.aiSettings;localStorage.setItem('ai_settings',JSON.stringify(aiSettings));loadAiSettings();}
      if(data.rewardData){localStorage.setItem('reward_data',JSON.stringify(data.rewardData));initRewardData();}
      if(data.metricsV1){localStorage.setItem('metrics_v1',JSON.stringify(data.metricsV1));}
      if(fbUser)fbSaveAll();
      showToast('가져오기 완료!');
    }catch(err){showToast('오류: '+err.message);}
  };
  reader.readAsText(file);e.target.value='';
}

// ── Firebase ──────────────────────────────────────────────
let fbApp=null,fbAuth=null,fbDb=null,fbUser=null;
let fbConfigSaved=JSON.parse(localStorage.getItem('fb_config')||'null');

function saveFbConfig(){
  const apiKey=document.getElementById('fbApiKey').value.trim();
  const authDomain=document.getElementById('fbAuthDomain').value.trim();
  const projectId=document.getElementById('fbProjectId').value.trim();
  if(!apiKey||!authDomain||!projectId){showToast('세 칸 모두 입력해줘');return;}
  fbConfigSaved={apiKey,authDomain,projectId};
  localStorage.setItem('fb_config',JSON.stringify(fbConfigSaved));
  showToast('저장됐어. Firebase 연결 중...');
  initFirebase();
}

function clearFbConfig(){
  if(!confirm('Firebase 연결을 해제할까? 데이터는 이 기기에 그대로 남아.'))return;
  localStorage.removeItem('fb_config');
  fbConfigSaved=null;fbUser=null;fbAuth=null;fbDb=null;fbApp=null;
  setSyncStatus('disconnected');
  document.getElementById('fbStatusArea').style.display='none';
  document.getElementById('fbLoginSection').style.display='none';
  document.getElementById('fbApiKey').value='';
  document.getElementById('fbAuthDomain').value='';
  document.getElementById('fbProjectId').value='';
  showToast('연결 해제됐어');
}

async function initFirebase(){
  if(!fbConfigSaved)return;
  try{
    // 동적으로 Firebase SDK 로드
    if(!window.firebase){
      await loadScript('https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js');
      await loadScript('https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js');
      await loadScript('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js');
    }
    const cfg={...fbConfigSaved,storageBucket:'',messagingSenderId:'',appId:''};
    // 이미 앱이 있으면 재사용
    try{fbApp=firebase.app();}catch{fbApp=firebase.initializeApp(cfg);}
    fbAuth=firebase.auth();
    fbDb=firebase.firestore();
    setSyncStatus('disconnected');
    document.getElementById('fbLoginSection').style.display='block';
    // 저장된 설정값 표시
    document.getElementById('fbApiKey').value=fbConfigSaved.apiKey;
    document.getElementById('fbAuthDomain').value=fbConfigSaved.authDomain;
    document.getElementById('fbProjectId').value=fbConfigSaved.projectId;
    fbAuth.onAuthStateChanged(user=>{
      if(user){
        fbUser=user;
        setSyncStatus('connected');
        document.getElementById('fbLoggedUser').textContent=user.email||user.displayName||'로그인됨';
        document.getElementById('fbStatusArea').style.display='block';
        document.getElementById('fbLoginSection').style.display='none';
        document.getElementById('fbUserLabel').textContent=user.email||user.displayName||'';
        fbLoadAll();
      } else {
        fbUser=null;
        setSyncStatus('disconnected');
        document.getElementById('fbStatusArea').style.display='none';
        document.getElementById('fbLoginSection').style.display='block';
        document.getElementById('fbUserLabel').textContent='';
      }
    });
  }catch(err){
    setSyncStatus('error');
    showToast('Firebase 오류: '+err.message);
    console.error(err);
  }
}

function loadScript(src){
  return new Promise((res,rej)=>{
    const s=document.createElement('script');
    s.src=src;s.onload=res;s.onerror=rej;
    document.head.appendChild(s);
  });
}

function setSyncStatus(status){
  const dot=document.getElementById('syncDot');
  const label=document.getElementById('syncStatus');
  if(status==='connected'){
    dot.className='sync-dot connected';
    label.textContent='Firebase 연결됨 — 자동 동기화 중';
  } else if(status==='syncing'){
    dot.className='sync-dot syncing';
    label.textContent='동기화 중...';
  } else if(status==='error'){
    dot.className='sync-dot error';
    label.textContent='동기화 오류 — 로컬에만 저장됨';
  } else {
    dot.className='sync-dot';
    label.textContent='Firebase 미연결 — 기기 간 동기화 안 됨';
  }
}

async function fbGoogleLogin(){
  if(!fbAuth){showToast('먼저 Firebase 설정을 저장해줘');return;}
  try{
    const provider=new firebase.auth.GoogleAuthProvider();
    await fbAuth.signInWithPopup(provider);
  }catch(err){showToast('로그인 실패: '+err.message);}
}

async function fbLogout(){
  if(!fbAuth)return;
  await fbAuth.signOut();
  showToast('로그아웃됐어');
}

async function fbSaveAll(){
  if(!fbUser||!fbDb)return;
  setSyncStatus('syncing');
  try{
    const uid=fbUser.uid;
    await fbDb.collection('users').doc(uid).set({
      memos:JSON.stringify(memos),
      philCards:JSON.stringify(philCards),
      questionSet:JSON.stringify(questionSet),
      aiSettings:JSON.stringify(aiSettings),
      rewardData:localStorage.getItem('reward_data')||'{"charge":[],"drain":[]}',
      metricsV1:localStorage.getItem('metrics_v1')||'[]',
      inboxV1:localStorage.getItem('inbox_v1')||'[]',
      realNeedV1:localStorage.getItem('real_need_v1')||'[]',
      updatedAt:firebase.firestore.FieldValue.serverTimestamp()
    });
    setSyncStatus('connected');
  }catch(err){
    setSyncStatus('error');
    console.error('Firebase 저장 오류:',err);
  }
}

async function fbLoadAll(){
  if(!fbUser||!fbDb)return;
  setSyncStatus('syncing');
  try{
    const uid=fbUser.uid;
    const doc=await fbDb.collection('users').doc(uid).get();
    if(doc.exists){
      const d=doc.data();
      if(d.memos){memos=JSON.parse(d.memos);localStorage.setItem('memos_v5',d.memos);renderMemos();renderResultList();}
      if(d.philCards){philCards=JSON.parse(d.philCards);localStorage.setItem('phil_cards',d.philCards);renderPhil();renderPhilEdit();}
      if(d.questionSet){questionSet=JSON.parse(d.questionSet);localStorage.setItem('question_set',d.questionSet);renderQEdit();}
      if(d.aiSettings){aiSettings=JSON.parse(d.aiSettings);localStorage.setItem('ai_settings',d.aiSettings);loadAiSettings();}
      if(d.rewardData){localStorage.setItem('reward_data',d.rewardData);initRewardData();}
      if(d.metricsV1){localStorage.setItem('metrics_v1',d.metricsV1);}
      if(d.inboxV1){inboxItems=JSON.parse(d.inboxV1);localStorage.setItem('inbox_v1',d.inboxV1);}
      if(d.realNeedV1){realNeedData=JSON.parse(d.realNeedV1);localStorage.setItem('real_need_v1',d.realNeedV1);}
    }
    setSyncStatus('connected');
  }catch(err){
    setSyncStatus('error');
    console.error('Firebase 불러오기 오류:',err);
  }
}

async function fbForceSync(){
  if(!fbUser){showToast('로그인이 필요해');return;}
  await fbSaveAll();
  showToast('동기화 완료!');
}

// Firebase 저장 후크: 기존 localStorage 저장 함수들에 Firebase 저장 추가
const _origSaveResult=saveResult;
// memos 변경 시 Firebase도 저장 (addMemoFromId, deleteMemo, saveResult에 훅)
const _fbHook=()=>{if(fbUser)fbSaveAll();};

// ── window.onload 확장 ────────────────────────────────────
const _origOnload=window.onload;
window.onload=()=>{
  initLock();
  _origOnload&&_origOnload();
  if(fbConfigSaved)initFirebase();
};
function esc(s){return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function showToast(msg){
  const el=document.getElementById('toast');
  el.textContent=msg;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),2200);
}
</script>
</body>
</html>
